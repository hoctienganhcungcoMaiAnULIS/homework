<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ms Mai An ULIS - English Master Test</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --text-color: #2c3e50;
            --bg-glass: rgba(255, 255, 255, 0.95);
            --correct-color: #00D26A;
            --wrong-color: #FF4757;
            --shadow-color: rgba(0,0,0,0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none; /* Prevent cheating by copy paste */
        }

        body {
            font-family: 'Quicksand', sans-serif;
            height: 100vh;
            overflow: hidden;
            background-color: #f0f2f5;
            transition: background 0.5s ease;
        }

        /* --- Dynamic Themes --- */
        /* Theme 1: Snake (Nature/Danger) */
        body.theme-snake {
            --primary-color: #2ecc71;
            --secondary-color: #1e8449;
            background-image: radial-gradient(circle at 50% 50%, rgba(46, 204, 113, 0.2), rgba(30, 132, 73, 0.4)), 
                              url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='10' y='30' font-size='20'%3Eüêç%3C/text%3E%3Ctext x='60' y='70' font-size='20'%3Eüåø%3C/text%3E%3C/svg%3E");
        }

        /* Theme 2: History (Old Paper/Royal) */
        body.theme-history {
            --primary-color: #e74c3c;
            --secondary-color: #2c3e50;
            background-image: radial-gradient(circle at 50% 50%, rgba(231, 76, 60, 0.2), rgba(44, 62, 80, 0.4)), 
                              url("data:image/svg+xml,%3Csvg width='120' height='120' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='20' y='40' font-size='24'%3EüìÆ%3C/text%3E%3Ctext x='70' y='80' font-size='24'%3Eüëë%3C/text%3E%3C/svg%3E");
        }

        /* --- Header --- */
        header {
            height: 60px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            z-index: 100;
            position: relative;
        }

        .teacher-name {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 700;
        }

        .timer-container {
            background: #333;
            color: #fff;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 800;
            font-family: 'Nunito', sans-serif;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .timer-container:hover {
            transform: scale(1.05);
        }

        .nav-controls button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transition: all 0.1s;
        }

        .nav-controls button:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* --- Main Layout --- */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .panel {
            width: 50%;
            padding: 30px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.4); }

        /* --- Left Panel (Reading) --- */
        .reading-card {
            background: var(--bg-glass);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid white;
        }

        .reading-title {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        .reading-text {
            font-size: 1.15rem;
            line-height: 1.8;
            color: #34495e;
            text-align: justify;
        }

        .gap-marker {
            font-weight: bold;
            color: var(--primary-color);
            background: rgba(255,255,255,0.8);
            padding: 2px 8px;
            border-radius: 6px;
            border: 1px dashed var(--primary-color);
        }

        .tools-section {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .translate-btn {
            background: linear-gradient(45deg, #FFC312, #EE5A24);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 5px 0 #b33939;
            transition: all 0.2s;
        }

        .translate-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        .translation-box {
            display: none;
            background: #fff8e1;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #FFC312;
            margin-top: 10px;
            font-style: italic;
        }

        .glossary-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-top: 20px;
        }

        .glossary-table th {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: left;
        }

        .glossary-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            color: #555;
        }

        /* --- Right Panel (Exercises) --- */
        .question-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .q-number {
            background: var(--secondary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.2rem;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .option-btn {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #555;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 0 #dcdcdc;
        }

        .option-btn:hover:not(.disabled) {
            transform: scale(1.02);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .option-btn:active:not(.disabled) {
            transform: translateY(4px);
            box-shadow: none;
        }

        .option-btn.correct {
            background: var(--correct-color);
            color: white;
            border-color: var(--correct-color);
            box-shadow: 0 4px 0 #00a352;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .option-btn.wrong {
            background: var(--wrong-color);
            color: white;
            border-color: var(--wrong-color);
            box-shadow: 0 4px 0 #d63031;
            animation: shake 0.5s;
        }

        .option-btn.disabled {
            cursor: default;
            opacity: 0.7;
            transform: none !important;
            box-shadow: none !important;
        }

        .explanation-box {
            display: none;
            margin-top: 20px;
            background: #f1f9ff;
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            padding: 20px;
            animation: slideDown 0.5s ease;
        }

        .teacher-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }

        .exp-header {
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .exp-detail {
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .exp-detail strong {
            color: #d63031;
        }

        /* --- Animations --- */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px) rotate(-5deg); }
            50% { transform: translateX(10px) rotate(5deg); }
            75% { transform: translateX(-10px) rotate(-5deg); }
            100% { transform: translateX(0); }
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Overlay/Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .modal-card {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-overlay.active .modal-card {
            transform: scale(1);
        }

        .modal-title {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: 800;
        }

        .score-display {
            font-size: 4rem;
            font-weight: 900;
            color: var(--correct-color);
            margin: 20px 0;
            text-shadow: 4px 4px 0 rgba(0,0,0,0.1);
        }

        .big-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 800;
            box-shadow: 0 8px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }

        .big-btn:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        
        /* Submit Button */
        #finish-btn {
            width: 100%;
            margin-top: 20px;
            background: #2c3e50;
        }

    </style>
</head>
<body>

    <header>
        <div class="teacher-name">
            <i class="fas fa-graduation-cap"></i> TEST CREATED BY: MS MAI AN ULIS
        </div>
        
        <div class="timer-container" id="timer-btn" onclick="toggleTimer()">
            <i class="fas fa-clock"></i> <span id="time-display">10:00</span>
        </div>

        <div class="nav-controls">
            <button id="switch-part-btn" onclick="switchPart()">
                Next Passage <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </header>

    <div class="main-container">
        <div class="panel left-panel" id="reading-panel">
            </div>

        <div class="panel right-panel" id="exercise-panel">
            <button id="finish-btn" class="big-btn" onclick="finishTest()" style="display:none">N·ªòP B√ÄI <i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="modal-overlay" id="score-modal">
        <div class="modal-card">
            <div class="modal-title">K·∫æT QU·∫¢ C·ª¶A B·∫†N</div>
            <div id="score-message" style="font-size: 1.2rem; color: #555; margin-bottom: 10px;"></div>
            <div class="score-display" id="final-score">0/12</div>
            <button class="big-btn" onclick="closeModal()">Xem l·∫°i b√†i l√†m</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="timeout-modal">
        <div class="modal-card">
            <div class="modal-title">‚è∞ H·∫æT GI·ªú!</div>
            <p style="margin-bottom: 20px; font-size: 1.1rem; line-height: 1.5;">
                ƒê√£ h·∫øt th·ªùi gian l√†m b√†i chu·∫©n (10 ph√∫t).<br>
                B·∫°n v·∫´n c√≥ th·ªÉ ti·∫øp t·ª•c l√†m, nh∆∞ng h√£y nh·ªõ luy·ªán t·∫≠p t·ªëc ƒë·ªô nh√©!
            </p>
            <button class="big-btn" onclick="closeTimeoutModal()">Ti·∫øp t·ª•c l√†m b√†i</button>
        </div>
    </div>

    <canvas id="confetti" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999;"></canvas>

    <script>
        // --- DATA ---
        const quizData = [
            {
                id: "part1",
                title: "The Black Mamba",
                themeClass: "theme-snake",
                text: `
                    <p>A bite from the Black Mamba is <span class="gap-marker">(1)</span> 'the kiss of death' in South Africa and it is <span class="gap-marker">(2)</span> a very dangerous snake.</p>
                    <p>The venom can kill a person within 30 minutes to a few hours <span class="gap-marker">(3)</span> medical help. It is one of the world‚Äôs fastest snakes as well and can travel at up to 16 kilometres an hour, though it uses this speed to <span class="gap-marker">(4)</span> danger rather than to attack. In fact, the Black Mamba is a rather <span class="gap-marker">(5)</span> creature and will avoid people if possible. It can measure anywhere between two and four metres long and, <span class="gap-marker">(6)</span> on the area where it lives, can be a different colour, from brown to green to grey. It gets its name from the inside of its mouth, which is ink black.</p>
                `,
                translation: `
                    <p><strong>D·ªãch:</strong> M·ªôt v·∫øt c·∫Øn t·ª´ r·∫Øn Mamba ƒëen ƒë∆∞·ª£c <strong>g·ªçi l√†</strong> 'n·ª• h√¥n c·ªßa t·ª≠ th·∫ßn' ·ªü Nam Phi v√† n√≥ <strong>ch·∫Øc ch·∫Øn</strong> l√† m·ªôt lo√†i r·∫Øn r·∫•t nguy hi·ªÉm.</p>
                    <p>N·ªçc ƒë·ªôc c√≥ th·ªÉ gi·∫øt ch·∫øt m·ªôt ng∆∞·ªùi trong v√≤ng 30 ph√∫t ƒë·∫øn v√†i gi·ªù <strong>n·∫øu kh√¥ng c√≥</strong> s·ª± tr·ª£ gi√∫p y t·∫ø. N√≥ c≈©ng l√† m·ªôt trong nh·ªØng lo√†i r·∫Øn nhanh nh·∫•t th·∫ø gi·ªõi v√† c√≥ th·ªÉ di chuy·ªÉn v·ªõi t·ªëc ƒë·ªô l√™n ƒë·∫øn 16 km/h, m·∫∑c d√π n√≥ s·ª≠ d·ª•ng t·ªëc ƒë·ªô n√†y ƒë·ªÉ <strong>tho√°t kh·ªèi</strong> nguy hi·ªÉm h∆°n l√† ƒë·ªÉ t·∫•n c√¥ng. Tr√™n th·ª±c t·∫ø, Mamba ƒëen l√† m·ªôt sinh v·∫≠t kh√° <strong>nh√∫t nh√°t</strong> v√† s·∫Ω tr√°nh con ng∆∞·ªùi n·∫øu c√≥ th·ªÉ. N√≥ c√≥ th·ªÉ d√†i t·ª´ hai ƒë·∫øn b·ªën m√©t v√†, <strong>t√πy thu·ªôc v√†o</strong> khu v·ª±c n∆°i n√≥ s·ªëng, c√≥ th·ªÉ c√≥ m√†u kh√°c nhau, t·ª´ n√¢u ƒë·∫øn xanh l√° c√¢y ƒë·∫øn x√°m. N√≥ ƒë∆∞·ª£c ƒë·∫∑t t√™n theo m√†u b√™n trong mi·ªáng c·ªßa n√≥, m√†u ƒëen nh∆∞ m·ª±c.</p>
                `,
                glossary: [
                    { word: "Venom", type: "n", meaning: "N·ªçc ƒë·ªôc" },
                    { word: "Creature", type: "n", meaning: "Sinh v·∫≠t" },
                    { word: "Medical help", type: "n.phr", meaning: "S·ª± tr·ª£ gi√∫p y t·∫ø" },
                    { word: "Avoid", type: "v", meaning: "Tr√°nh xa" },
                    { word: "Attack", type: "v", meaning: "T·∫•n c√¥ng" },
                    { word: "Measure", type: "v", meaning: "ƒêo l∆∞·ªùng / C√≥ k√≠ch th∆∞·ªõc" }
                ],
                questions: [
                    {
                        id: 1,
                        options: ["A. said", "B. made", "C. called", "D. titled"],
                        correct: 2, // C
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: C. called</strong><br>
                            - C·∫•u tr√∫c: <em>be called + Noun</em> (ƒë∆∞·ª£c g·ªçi l√†...).<br>
                            - <em>Said</em> th∆∞·ªùng ƒëi v·ªõi 'to be' ho·∫∑c m·ªánh ƒë·ªÅ that.<br>
                            - <em>Titled</em> d√πng cho t∆∞·ªõc hi·ªáu ho·∫∑c t√™n s√°ch/phim.<br>
                            -> D·ªãch: V·∫øt c·∫Øn ƒë∆∞·ª£c g·ªçi l√† 'n·ª• h√¥n t·ª≠ th·∫ßn'.
                        `
                    },
                    {
                        id: 2,
                        options: ["A. certainly", "B. exactly", "C. just", "D. fairly"],
                        correct: 0, // A
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: A. certainly</strong><br>
                            - <em>Certainly</em> (ch·∫Øc ch·∫Øn): Nh·∫•n m·∫°nh s·ª± th·∫≠t hi·ªÉn nhi√™n.<br>
                            - <em>Exactly</em> (ch√≠nh x√°c): D√πng cho ƒë·ªô ch√≠nh x√°c c·ªßa s·ªë li·ªáu/v·ªã tr√≠.<br>
                            - <em>Fairly</em> (kh√°): M·ª©c ƒë·ªô nh·∫π h∆°n, kh√¥ng h·ª£p ng·ªØ c·∫£nh nguy hi·ªÉm ch·∫øt ng∆∞·ªùi.<br>
                            -> D·ªãch: N√≥ ch·∫Øc ch·∫Øn l√† m·ªôt lo√†i r·∫Øn r·∫•t nguy hi·ªÉm.
                        `
                    },
                    {
                        id: 3,
                        options: ["A. outside", "B. besides", "C. away", "D. without"],
                        correct: 3, // D
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: D. without</strong><br>
                            - Ng·ªØ c·∫£nh: Ch·∫øt trong 30 ph√∫t n·∫øu <strong>kh√¥ng c√≥</strong> s·ª± tr·ª£ gi√∫p y t·∫ø.<br>
                            - <em>Without</em>: Kh√¥ng c√≥.<br>
                            - <em>Besides</em>: B√™n c·∫°nh ƒë√≥/Ngo√†i ra.<br>
                            - <em>Outside</em>: B√™n ngo√†i.
                        `
                    },
                    {
                        id: 4,
                        options: ["A. break", "B. escape", "C. lose", "D. run"],
                        correct: 1, // B
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: B. escape</strong><br>
                            - C·ª•m t·ª´: <em>escape danger</em> (tho√°t kh·ªèi nguy hi·ªÉm).<br>
                            - <em>Run</em> ph·∫£i ƒëi v·ªõi 'away from'.<br>
                            - <em>Lose</em> (thua/m·∫•t).<br>
                            -> R·∫Øn d√πng t·ªëc ƒë·ªô ƒë·ªÉ ch·∫°y tr·ªën ch·ª© kh√¥ng ph·∫£i t·∫•n c√¥ng.
                        `
                    },
                    {
                        id: 5,
                        options: ["A. shy", "B. brave", "C. afraid", "D. soft"],
                        correct: 0, // A
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: A. shy</strong><br>
                            - D·ª±a v√†o c√¢u sau: "will avoid people if possible" (s·∫Ω tr√°nh ng∆∞·ªùi n·∫øu c√≥ th·ªÉ).<br>
                            -> ƒê√¢y l√† ƒë·∫∑c ƒëi·ªÉm c·ªßa sinh v·∫≠t <em>nh√∫t nh√°t</em> (shy).<br>
                            - <em>Brave</em> (d≈©ng c·∫£m) >< Avoid people.<br>
                            - <em>Afraid</em> (s·ª£ h√£i) th∆∞·ªùng l√† 'afraid OF something'.
                        `
                    },
                    {
                        id: 6,
                        options: ["A. relying", "B. choosing", "C. depending", "D. taking"],
                        correct: 2, // C
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: C. depending</strong><br>
                            - C·ª•m t·ª´ c·ªë ƒë·ªãnh (Collocation): <em>Depending on</em> (T√πy thu·ªôc v√†o).<br>
                            - <em>Relying on</em>: D·ª±a d·∫´m v√†o (mang t√≠nh tin t∆∞·ªüng/nh·ªù v·∫£).<br>
                            -> M√†u s·∫Øc thay ƒë·ªïi t√πy thu·ªôc v√†o khu v·ª±c s·ªëng.
                        `
                    }
                ]
            },
            {
                id: "part2",
                title: "The Penny Black",
                themeClass: "theme-history",
                text: `
                    <p>In 1840, The Penny Black became the <span class="gap-marker">(1)</span> sticky postage stamp in the world. Before this the <span class="gap-marker">(2)</span> of posting something in the UK was very expensive. This depended on distance and how many sheets of paper were being sent and was paid by the person receiving the post. The idea of paying in advance was <span class="gap-marker">(3)</span> to parliament and in 1839 this became law.</p>
                    <p>A <span class="gap-marker">(4)</span> was held to find the best way of sending post. The first suggestion attempted was a special envelope or ‚Äòlettersheet‚Äô with a stamp attached, but this wasn‚Äôt <span class="gap-marker">(5)</span> and in the end the stamp itself was used with a picture of Queen Victoria and the price ‚Äì one penny. However, the colour was a problem as it was difficult to cancel the stamp after it had been <span class="gap-marker">(6)</span>. This was eventually changed to red and black ink was used to cancel it.</p>
                `,
                translation: `
                    <p><strong>D·ªãch:</strong> NƒÉm 1840, Penny Black tr·ªü th√†nh con tem b∆∞u ch√≠nh d√≠nh <strong>ƒë·∫ßu ti√™n</strong> tr√™n th·∫ø gi·ªõi. Tr∆∞·ªõc ƒë√≥, <strong>chi ph√≠</strong> g·ª≠i b∆∞u ki·ªán ·ªü Anh r·∫•t ƒë·∫Øt ƒë·ªè. ƒêi·ªÅu n√†y ph·ª• thu·ªôc v√†o kho·∫£ng c√°ch v√† s·ªë l∆∞·ª£ng t·ªù gi·∫•y ƒë∆∞·ª£c g·ª≠i v√† ƒë∆∞·ª£c tr·∫£ b·ªüi ng∆∞·ªùi nh·∫≠n th∆∞. √ù t∆∞·ªüng tr·∫£ tr∆∞·ªõc ƒë√£ ƒë∆∞·ª£c <strong>ƒë·ªÅ xu·∫•t</strong> l√™n qu·ªëc h·ªôi v√† nƒÉm 1839 ƒëi·ªÅu n√†y ƒë√£ tr·ªü th√†nh lu·∫≠t.</p>
                    <p>M·ªôt <strong>cu·ªôc thi</strong> ƒë√£ ƒë∆∞·ª£c t·ªï ch·ª©c ƒë·ªÉ t√¨m ra c√°ch g·ª≠i th∆∞ t·ªët nh·∫•t. G·ª£i √Ω ƒë·∫ßu ti√™n ƒë∆∞·ª£c th·ª≠ nghi·ªám l√† m·ªôt phong b√¨ ƒë·∫∑c bi·ªát ho·∫∑c 't·ªù th∆∞' c√≥ d√°n tem, nh∆∞ng n√≥ kh√¥ng <strong>ph·ªï bi·∫øn</strong> v√† cu·ªëi c√πng con tem ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng v·ªõi h√¨nh ·∫£nh N·ªØ ho√†ng Victoria v√† gi√° ‚Äì m·ªôt xu. Tuy nhi√™n, m√†u s·∫Øc l√† m·ªôt v·∫•n ƒë·ªÅ v√¨ r·∫•t kh√≥ ƒë·ªÉ h·ªßy con tem sau khi n√≥ ƒë√£ ƒë∆∞·ª£c <strong>s·ª≠ d·ª•ng</strong>. Cu·ªëi c√πng, n√≥ ƒë√£ ƒë∆∞·ª£c ƒë·ªïi th√†nh m√†u ƒë·ªè v√† m·ª±c ƒëen ƒë∆∞·ª£c d√πng ƒë·ªÉ h·ªßy n√≥.</p>
                `,
                glossary: [
                    { word: "Postage stamp", type: "n.phr", meaning: "Tem th∆∞" },
                    { word: "Parliament", type: "n", meaning: "Qu·ªëc h·ªôi / Ngh·ªã vi·ªán" },
                    { word: "In advance", type: "idiom", meaning: "Tr∆∞·ªõc (tr·∫£ tr∆∞·ªõc)" },
                    { word: "Attempt", type: "v", meaning: "C·ªë g·∫Øng / Th·ª≠ nghi·ªám" },
                    { word: "Cancel", type: "v", meaning: "H·ªßy b·ªè (ƒë√≥ng d·∫•u h·ªßy tem)" },
                    { word: "Eventually", type: "adv", meaning: "Cu·ªëi c√πng th√¨" }
                ],
                questions: [
                    {
                        id: 1,
                        options: ["A. basic", "B. first", "C. beginning", "D. start"],
                        correct: 1, // B
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: B. first</strong><br>
                            - Penny Black l√† con tem <em>ƒë·∫ßu ti√™n</em> tr√™n th·∫ø gi·ªõi.<br>
                            - <em>Basic</em>: C∆° b·∫£n.<br>
                            - <em>Beginning/Start</em>: S·ª± b·∫Øt ƒë·∫ßu (Danh t·ª´/Ving), kh√¥ng ƒë·ª©ng tr∆∞·ªõc t√≠nh t·ª´ 'sticky' nh∆∞ m·ªôt t√≠nh t·ª´ ch·ªâ th·ª© t·ª± h·ª£p l√Ω ·ªü ƒë√¢y.
                        `
                    },
                    {
                        id: 2,
                        options: ["A. money", "B. amount", "C. cost", "D. payment"],
                        correct: 2, // C
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: C. cost</strong><br>
                            - <em>The cost of V-ing</em>: Chi ph√≠ l√†m vi·ªác g√¨ ƒë√≥.<br>
                            - <em>Money</em>: Ti·ªÅn (chung chung).<br>
                            - <em>Payment</em>: S·ª± thanh to√°n.<br>
                            -> Chi ph√≠ g·ª≠i th∆∞ r·∫•t ƒë·∫Øt.
                        `
                    },
                    {
                        id: 3,
                        options: ["A. recommended", "B. said", "C. played", "D. ordered"],
                        correct: 0, // A
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: A. recommended</strong><br>
                            - <em>Recommended to Parliament</em>: ƒê∆∞·ª£c ƒë·ªÅ xu·∫•t/ti·∫øn c·ª≠ l√™n Qu·ªëc h·ªôi.<br>
                            - <em>Ordered</em>: Ra l·ªánh (kh√¥ng ph√π h·ª£p ng·ªØ c·∫£nh ƒë·ªÅ xu·∫•t √Ω t∆∞·ªüng m·ªõi).<br>
                            - <em>Said</em>: N√≥i.
                        `
                    },
                    {
                        id: 4,
                        options: ["A. match", "B. prize", "C. competition", "D. race"],
                        correct: 2, // C
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: C. competition</strong><br>
                            - Ng·ªØ c·∫£nh: T·ªï ch·ª©c ƒë·ªÉ "t√¨m ra c√°ch t·ªët nh·∫•t" -> ƒê√¢y l√† m·ª•c ƒë√≠ch c·ªßa m·ªôt cu·ªôc thi thi·∫øt k·∫ø.<br>
                            - <em>Race</em>: Cu·ªôc ƒëua (t·ªëc ƒë·ªô).<br>
                            - <em>Match</em>: Tr·∫≠n ƒë·∫•u (th·ªÉ thao).
                        `
                    },
                    {
                        id: 5,
                        options: ["A. dear", "B. popular", "C. famous", "D. common"],
                        correct: 1, // B
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: B. popular</strong><br>
                            - Ng·ªØ c·∫£nh: √ù t∆∞·ªüng phong b√¨ ƒë·∫∑c bi·ªát kh√¥ng ƒë∆∞·ª£c ng∆∞·ªùi d√¢n y√™u th√≠ch/ƒë√≥n nh·∫≠n.<br>
                            - <em>Popular</em>: Ph·ªï bi·∫øn, ƒë∆∞·ª£c y√™u th√≠ch.<br>
                            - <em>Common</em>: Th√¥ng th∆∞·ªùng.<br>
                            - <em>Famous</em>: N·ªïi ti·∫øng (d√πng cho ng∆∞·ªùi/ƒë·ªãa danh).
                        `
                    },
                    {
                        id: 6,
                        options: ["A. near", "B. worn", "C. passed", "D. used"],
                        correct: 3, // D
                        explanation: `
                            <strong>ƒê√°p √°n ƒë√∫ng: D. used</strong><br>
                            - Tem c·∫ßn ƒë∆∞·ª£c h·ªßy (ƒë√≥ng d·∫•u) sau khi ƒë√£ ƒë∆∞·ª£c <em>s·ª≠ d·ª•ng</em> (ƒë·ªÉ g·ª≠i th∆∞) ƒë·ªÉ tr√°nh d√πng l·∫°i.<br>
                            - <em>Passed</em>: Tr√¥i qua.<br>
                            - <em>Worn</em>: M√≤n/M·∫∑c.
                        `
                    }
                ]
            }
        ];

        // --- STATE ---
        let currentPartIndex = 0;
        let scores = new Array(12).fill(null); // Null = not answered, 0 = wrong, 1 = correct
        let timerInterval;
        let timeLeft = 600; // 10 minutes
        let isTimerRunning = false;

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'correct') {
                // High pitch Ding
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            } else {
                // Low pitch Buzz
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            renderPart(0);
        };

        function renderPart(index) {
            const data = quizData[index];
            const body = document.body;
            
            // Set Theme
            body.className = data.themeClass;
            
            // Render Reading Text
            const readingPanel = document.getElementById('reading-panel');
            let glossaryHtml = '<table class="glossary-table"><thead><tr><th>Word</th><th>Type</th><th>Meaning</th></tr></thead><tbody>';
            data.glossary.forEach(g => {
                glossaryHtml += `<tr><td><strong>${g.word}</strong></td><td><em>${g.type}</em></td><td>${g.meaning}</td></tr>`;
            });
            glossaryHtml += '</tbody></table>';

            readingPanel.innerHTML = `
                <div class="reading-card">
                    <h2 class="reading-title">${data.title}</h2>
                    <div class="reading-text">${data.text}</div>
                    <div class="tools-section">
                        <button class="translate-btn" onclick="toggleTranslation()">
                            <i class="fas fa-language"></i> HI·ªÜN B·∫¢N D·ªäCH ƒê·∫¶Y ƒê·ª¶
                        </button>
                        <div class="translation-box" id="trans-box">${data.translation}</div>
                    </div>
                </div>
                <h3 style="color:var(--primary-color); margin-bottom:10px;"><i class="fas fa-book"></i> GLOSSARY (T·ª™ V·ª∞NG)</h3>
                ${glossaryHtml}
            `;

            // Render Questions
            const exercisePanel = document.getElementById('exercise-panel');
            let questionsHtml = '';
            
            data.questions.forEach((q, qIdx) => {
                // Adjust global index based on part
                const globalQIdx = index === 0 ? qIdx : qIdx + 6; 
                const alreadyAnswered = scores[globalQIdx] !== null;
                
                let optionsHtml = '';
                q.options.forEach((opt, oIdx) => {
                    let btnClass = 'option-btn';
                    let onclick = `checkAnswer(${index}, ${qIdx}, ${oIdx}, this)`;
                    
                    if (alreadyAnswered) {
                        onclick = '';
                        btnClass += ' disabled';
                        if (oIdx === q.correct) btnClass += ' correct';
                        // if user chose wrong previously, we don't strictly save WHICH wrong one, but usually we just show correct one if revisiting.
                    }
                    
                    optionsHtml += `<button class="${btnClass}" onclick="${onclick}">${opt}</button>`;
                });

                let explanationDisplay = alreadyAnswered ? 'block' : 'none';

                questionsHtml += `
                    <div class="question-card" id="q-card-${index}-${qIdx}">
                        <div class="question-header">
                            <div class="q-number">${globalQIdx + 1}</div>
                        </div>
                        <div class="options-grid">
                            ${optionsHtml}
                        </div>
                        <div class="explanation-box" id="exp-${index}-${qIdx}" style="display: ${explanationDisplay}">
                            <div class="exp-header">
                                <img src="https://ui-avatars.com/api/?name=Mai+An&background=random" class="teacher-avatar" alt="Teacher">
                                Ms Mai An gi·∫£i th√≠ch:
                            </div>
                            <div class="exp-detail">${q.explanation}</div>
                        </div>
                    </div>
                `;
            });

            // Handle "Next" or "Finish" button visibility
            const btnHtml = index === 0 
                ? `<div style="height:50px"></div>` // Spacer
                : `<button id="finish-btn" class="big-btn" onclick="finishTest()">N·ªòP B√ÄI <i class="fas fa-paper-plane"></i></button>`;

            exercisePanel.innerHTML = questionsHtml + btnHtml;
            exercisePanel.scrollTop = 0; // Reset scroll
            
            // Update Top Button
            const switchBtn = document.getElementById('switch-part-btn');
            if (index === 0) {
                switchBtn.innerHTML = `Next Passage <i class="fas fa-arrow-right"></i>`;
                switchBtn.onclick = switchPart;
            } else {
                switchBtn.innerHTML = `<i class="fas fa-arrow-left"></i> Previous Passage`;
                switchBtn.onclick = prevPart;
            }
        }

        function toggleTranslation() {
            const box = document.getElementById('trans-box');
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
        }

        function switchPart() {
            currentPartIndex = 1;
            renderPart(1);
        }

        function prevPart() {
            currentPartIndex = 0;
            renderPart(0);
        }

        function checkAnswer(partIdx, qIdx, selectedOptIdx, btnElement) {
            // Prevent multiple clicks
            const parent = btnElement.parentElement;
            if (parent.querySelectorAll('.disabled').length > 0) return;

            const globalQIdx = partIdx === 0 ? qIdx : qIdx + 6;
            const questionData = quizData[partIdx].questions[qIdx];
            const isCorrect = selectedOptIdx === questionData.correct;

            // Update UI
            const buttons = parent.querySelectorAll('.option-btn');
            buttons.forEach(b => b.classList.add('disabled')); // Disable all

            if (isCorrect) {
                btnElement.classList.add('correct');
                playSound('correct');
                fireConfetti(btnElement);
                scores[globalQIdx] = 1;
            } else {
                btnElement.classList.add('wrong');
                playSound('wrong');
                scores[globalQIdx] = 0;
                // Highlight correct answer
                buttons[questionData.correct].classList.add('correct');
            }

            // Show explanation
            const expBox = document.getElementById(`exp-${partIdx}-${qIdx}`);
            expBox.style.display = 'block';
        }

        function startTimer() {
            if (isTimerRunning) return;
            isTimerRunning = true;
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    document.getElementById('timeout-modal').classList.add('active');
                    playSound('wrong');
                }
            }, 1000);
        }

        function toggleTimer() {
            if (timeLeft <= 0) return; // Finished
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                document.getElementById('time-display').style.opacity = '0.5';
            } else {
                startTimer();
                document.getElementById('time-display').style.opacity = '1';
            }
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            document.getElementById('time-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function closeTimeoutModal() {
            document.getElementById('timeout-modal').classList.remove('active');
        }

        function finishTest() {
            // Calculate Score
            let correctCount = scores.filter(s => s === 1).length;
            const total = 12;
            
            const modal = document.getElementById('score-modal');
            const scoreMsg = document.getElementById('score-message');
            const finalScore = document.getElementById('final-score');
            
            let msg = "";
            const percentage = (correctCount / total) * 100;
            
            if (percentage === 100) msg = "üèÜ THI√äN T√ÄI! B·∫°n ƒë√£ l√†m ƒë√∫ng tuy·ªát ƒë·ªëi!";
            else if (percentage >= 80) msg = "üåü XU·∫§T S·∫ÆC! B·∫°n n·∫Øm r·∫•t ch·∫Øc ki·∫øn th·ª©c.";
            else if (percentage >= 50) msg = "üëç L√ÄM T·ªêT L·∫ÆM! C·ªë g·∫Øng th√™m ch√∫t n·ªØa nh√©.";
            else msg = "üí™ C·ªê L√äN NH√â! H√£y xem k·ªπ l·∫°i ph·∫ßn gi·∫£i th√≠ch.";

            scoreMsg.innerText = msg;
            finalScore.innerText = `${correctCount}/${total}`;
            
            modal.classList.add('active');
            
            if (percentage >= 50) {
                // Big celebration confetti
                const duration = 3000;
                const end = Date.now() + duration;
                (function frame() {
                    confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                    confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                    if (Date.now() < end) requestAnimationFrame(frame);
                }());
            }
        }

        function closeModal() {
            document.getElementById('score-modal').classList.remove('active');
        }

        // --- CONFETTI LOGIC (Mini Library) ---
        // Simple manual canvas confetti for single-file requirement
        const canvas = document.getElementById("confetti");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particles = [];

        function fireConfetti(element) {
            const rect = element.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            
            for (let i = 0; i < 30; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10 - 5,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    life: 100
                });
            }
        }

        function updateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2; // Gravity
                p.life--;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 5, 5);
                if (p.life <= 0) particles.splice(i, 1);
            });
            requestAnimationFrame(updateConfetti);
        }
        updateConfetti();
        
        // External confetti lib simulation for the "Big Finish"
        // Since we can't link external scripts easily in prompt, the finishTest() logic calls a placeholder.
        // The fireConfetti above handles the button clicks locally.
        var confetti = function() {}; // Placeholder if needed

    </script>
</body>
</html>