<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ms Mai An ULIS - ƒê·ªÄ S·ªê 4 (TEST 3)</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #8854C0; /* M√†u t√≠m h·ªìng ch·ªß ƒë·∫°o */
            --secondary: #00C9A7; /* M√†u xanh ng·ªçc */
            --correct: #00D26A; /* Xanh l√° ƒë√∫ng */
            --wrong: #FF4757; /* ƒê·ªè sai */
            --bg-pattern: #f0f4f8;
            --text-dark: #2f3542;
            --white: #ffffff;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #E6E6FA;
            background-image: radial-gradient(#8854C0 1.5px, transparent 1.5px), radial-gradient(#8854C0 1.5px, #E6E6FA 1.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        /* HEADER */
        header {
            text-align: center;
            background: var(--white);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border: 3px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        h1 {
            color: var(--primary);
            font-family: 'Quicksand', sans-serif;
            font-weight: 800;
            margin: 0;
            font-size: 1.8rem;
            text-transform: uppercase;
        }

        h2 {
            color: var(--secondary);
            font-size: 1.2rem;
            margin-top: 5px;
        }

        /* CARD STYLE */
        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 0 #d1d8e0;
            border: 2px solid #fff;
            position: relative;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .part-title {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            display: inline-block;
            font-weight: 700;
            margin-bottom: 15px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* BUTTONS & OPTIONS */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .btn-option {
            background: white;
            border: 2px solid #e1e1e1;
            border-bottom: 5px solid #e1e1e1;
            border-radius: 15px;
            padding: 12px 15px;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            width: 100%;
        }

        .btn-option:hover {
            transform: scale(1.03);
            background-color: #f9f9f9;
        }

        .btn-option:active {
            transform: translateY(4px);
            border-bottom-width: 0;
        }

        .btn-option.correct {
            background-color: var(--correct) !important;
            color: white !important;
            border-color: #00b85c !important;
            border-bottom-color: #008f47 !important;
        }

        .btn-option.wrong {
            background-color: var(--wrong) !important;
            color: white !important;
            border-color: #ff2e40 !important;
            border-bottom-color: #d61c2d !important;
            animation: shake 0.5s;
        }

        /* BINARY CHOICE (PART 1) */
        .binary-container {
            display: inline-block;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 10px;
            margin: 0 5px;
        }
        
        .binary-btn {
            border: none;
            background: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 0 #ccc;
            transition: all 0.2s;
        }
        
        .binary-btn:hover { background: #eef; }
        .binary-btn.correct { background: var(--correct); color: white; box-shadow: 0 2px 0 #008f47; }
        .binary-btn.wrong { background: var(--wrong); color: white; box-shadow: 0 2px 0 #d61c2d; animation: shake 0.4s; }

        /* GAP FILL POPUP (PART 2 & 3) */
        .gap-fill-btn {
            display: inline-block;
            min-width: 80px;
            padding: 5px 15px;
            border: 2px dashed var(--primary);
            border-radius: 10px;
            background: #f8f0ff;
            color: var(--primary);
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            margin: 0 5px;
        }

        .gap-fill-btn.filled-correct {
            background: var(--correct);
            color: white;
            border: 2px solid var(--correct);
        }

        .gap-fill-btn.filled-wrong {
            background: var(--wrong);
            color: white;
            border: 2px solid var(--wrong);
        }

        /* POPUP MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border: 4px solid var(--secondary);
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .modal h3 { color: var(--primary); margin-top: 0; }

        /* EXPLANATION BOX */
        .explanation {
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            background-color: #f1f9ff;
            border-left: 5px solid var(--secondary);
            padding: 15px;
            margin-top: 15px;
            border-radius: 10px;
            font-size: 0.95rem;
            animation: slideDown 0.4s ease-out;
        }

        .explanation.show {
            display: block;
        }

        .teacher-avatar {
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .teacher-avatar i { font-size: 1.5rem; }

        .expl-step { margin-bottom: 8px; }
        .expl-label { font-weight: 700; color: #555; text-decoration: underline; }
        .expl-correct { color: var(--correct); font-weight: bold; }
        .expl-wrong { color: var(--wrong); }

        /* GLOSSARY TABLE */
        .glossary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 0 #ccc;
        }
        .glossary-table th { background: var(--primary); color: white; padding: 10px; }
        .glossary-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .glossary-table tr:last-child td { border-bottom: none; }

        /* ANIMATIONS */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-5deg); }
            75% { transform: translateX(5px) rotate(5deg); }
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* TEXTAREA PART 5 */
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 15px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 10px;
        }

        /* FOOTER BTN */
        .submit-all-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto;
            padding: 15px;
            background: var(--primary);
            color: white;
            font-size: 1.5rem;
            font-weight: 800;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 0 #5e338a;
            transition: all 0.3s;
        }

        .submit-all-btn:hover { transform: scale(1.05); }
        .submit-all-btn:active { transform: translateY(5px); box-shadow: 0 3px 0 #5e338a; }

        /* FOOTER POPUP */
        #resultPopup {
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .result-content {
            background: white; padding: 40px; border-radius: 30px; text-align: center;
            width: 90%; max-width: 500px; border: 5px solid var(--secondary);
            animation: popIn 0.5s;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Ms Mai An ULIS</h1>
        <h2>ƒê·ªÄ S·ªê 4 (TEST 3) - GRADE 5-6 REVIEW</h2>
        <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">
            <i class="fas fa-gamepad"></i> Ch·∫ø ƒë·ªô Gamification: B·∫≠t | <i class="fas fa-volume-up"></i> √Çm thanh: B·∫≠t
        </div>
    </header>

    <div class="card">
        <div class="part-title">PART 1: PAST SIMPLE & PAST CONTINUOUS</div>
        <p style="margin-bottom: 20px;"><i>Circle the correct answer. (Khoanh tr√≤n ƒë√°p √°n ƒë√∫ng)</i></p>

        <div class="question-block" id="q1">
            <div class="question-text">
                1. The bird 
                <div class="binary-container">
                    <button class="binary-btn" onclick="checkBinary(this, false, 'exp1')">was flying</button> / 
                    <button class="binary-btn" onclick="checkBinary(this, true, 'exp1')">flew</button>
                </div>
                into the room while we 
                <div class="binary-container">
                    <button class="binary-btn" onclick="checkBinary(this, true, 'exp1')">were studying</button> / 
                    <button class="binary-btn" onclick="checkBinary(this, false, 'exp1')">studied</button>
                </div>.
            </div>
            <div id="exp1" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> C√¥ Mai An gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> M·ªôt con chim <u>bay</u> v√†o ph√≤ng khi ch√∫ng t√¥i <u>ƒëang h·ªçc</u>.</div>
                <div class="expl-step"><b>‚úÖ T·∫°i sao ch·ªçn 'flew' & 'were studying':</b> ƒê√¢y l√† c·∫•u tr√∫c h√†nh ƒë·ªông chen ngang trong qu√° kh·ª©.
                    <ul>
                        <li>H√†nh ƒë·ªông "ƒëang h·ªçc" (k√©o d√†i) -> D√πng <b>Past Continuous</b> (were studying).</li>
                        <li>H√†nh ƒë·ªông "con chim bay v√†o" (ng·∫Øn, chen ngang) -> D√πng <b>Past Simple</b> (flew).</li>
                    </ul>
                </div>
            </div>
        </div>

        <hr>

        <div class="question-block" id="q2">
            <div class="question-text">
                2. I 
                <div class="binary-container">
                    <button class="binary-btn" onclick="checkBinary(this, true, 'exp2')">was looking</button> / 
                    <button class="binary-btn" onclick="checkBinary(this, false, 'exp2')">looked</button>
                </div>
                for my keys when I 
                <div class="binary-container">
                    <button class="binary-btn" onclick="checkBinary(this, true, 'exp2')">found</button> / 
                    <button class="binary-btn" onclick="checkBinary(this, false, 'exp2')">was finding</button>
                </div>
                an old photo.
            </div>
            <div id="exp2" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> C√¥ Mai An gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> T√¥i <u>ƒëang t√¨m</u> ch√¨a kh√≥a th√¨ t√¥i <u>t√¨m th·∫•y</u> m·ªôt b·ª©c ·∫£nh c≈©.</div>
                <div class="expl-step"><b>‚úÖ Ph√¢n t√≠ch:</b>
                    <ul>
                        <li>H√†nh ƒë·ªông "t√¨m ki·∫øm" l√† qu√° tr√¨nh ƒëang di·ªÖn ra -> <b>was looking</b>.</li>
                        <li>H√†nh ƒë·ªông "t√¨m th·∫•y" x·∫£y ra b·∫•t ch·ª£t ch·∫•m d·ª©t vi·ªác t√¨m ki·∫øm -> <b>found</b>.</li>
                    </ul>
                </div>
            </div>
        </div>

        <hr>

        <div class="question-block" id="q3">
            <div class="question-text">
                3. She 
                <div class="binary-container">
                    <button class="binary-btn" onclick="checkBinary(this, true, 'exp3')">was dancing</button> / 
                    <button class="binary-btn" onclick="checkBinary(this, false, 'exp3')">danced</button>
                </div>
                while her brother 
                <div class="binary-container">
                    <button class="binary-btn" onclick="checkBinary(this, true, 'exp3')">was singing</button> / 
                    <button class="binary-btn" onclick="checkBinary(this, false, 'exp3')">sang</button>
                </div>.
            </div>
            <div id="exp3" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> C√¥ Mai An gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> C√¥ ·∫•y <u>ƒëang nh·∫£y</u> trong khi em trai <u>ƒëang h√°t</u>.</div>
                <div class="expl-step"><b>‚úÖ T·∫°i sao ƒê√öNG:</b> C√≥ t·ª´ n·ªëi <b>"while"</b> (trong khi) n·ªëi hai h√†nh ƒë·ªông x·∫£y ra song song c√πng m·ªôt l√∫c trong qu√° kh·ª© -> C·∫£ hai v·∫ø ƒë·ªÅu chia <b>Past Continuous</b>.</div>
            </div>
        </div>

        <hr>

        <div class="question-block" id="q4">
            <div class="question-text">
                4. We 
                <div class="binary-container">
                    <button class="binary-btn" onclick="checkBinary(this, true, 'exp4')">were driving</button> / 
                    <button class="binary-btn" onclick="checkBinary(this, false, 'exp4')">drove</button>
                </div>
                to the beach when the car 
                <div class="binary-container">
                    <button class="binary-btn" onclick="checkBinary(this, true, 'exp4')">stopped</button> / 
                    <button class="binary-btn" onclick="checkBinary(this, false, 'exp4')">was stopping</button>
                </div>.
            </div>
            <div id="exp4" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> C√¥ Mai An gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> Ch√∫ng t√¥i <u>ƒëang l√°i xe</u> t·ªõi b√£i bi·ªÉn th√¨ chi·∫øc xe <u>d·ª´ng l·∫°i</u>.</div>
                <div class="expl-step"><b>‚úÖ Ph√¢n t√≠ch:</b> H√†nh ƒë·ªông l√°i xe ƒëang di·ªÖn ra (were driving) th√¨ b·ªã h√†nh ƒë·ªông xe h·ªèng/d·ª´ng l·∫°i (stopped) chen ngang.</div>
            </div>
        </div>

        <hr>

        <div class="question-block" id="q5">
            <div class="question-text">
                5. My dad 
                <div class="binary-container">
                    <button class="binary-btn" onclick="checkBinary(this, true, 'exp5')">was washing</button> / 
                    <button class="binary-btn" onclick="checkBinary(this, false, 'exp5')">washed</button>
                </div>
                the car when it 
                <div class="binary-container">
                    <button class="binary-btn" onclick="checkBinary(this, true, 'exp5')">began</button> / 
                    <button class="binary-btn" onclick="checkBinary(this, false, 'exp5')">was beginning</button>
                </div>
                to rain.
            </div>
            <div id="exp5" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> C√¥ Mai An gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> B·ªë t√¥i <u>ƒëang r·ª≠a</u> xe th√¨ tr·ªùi <u>b·∫Øt ƒë·∫ßu</u> m∆∞a.</div>
                <div class="expl-step"><b>‚úÖ Ph√¢n t√≠ch:</b> C·∫•u tr√∫c kinh ƒëi·ªÉn: <i>Past Continuous + WHEN + Past Simple</i>. B·ªë ƒëang r·ª≠a (vi·ªác d√†i) th√¨ m∆∞a (vi·ªác b·∫•t ng·ªù ·∫≠p ƒë·∫øn).</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="part-title">PART 2: FILL IN THE BLANKS (VERB FORMS)</div>
        <p><i>Click on the blank to choose the correct verb form. (B·∫•m v√†o ch·ªó tr·ªëng ƒë·ªÉ ch·ªçn)</i></p>

        <div class="question-block">
            <div class="question-text">
                1. While my mom <span class="gap-fill-btn" onclick="openGapModal(this, 'p2q1', 'was shopping')">__________</span> (shop), I <span class="gap-fill-btn" onclick="openGapModal(this, 'p2q1b', 'was looking')">__________</span> (look) at the toys.
            </div>
            <div id="exp-p2q1" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> Gi·∫£i th√≠ch chi ti·∫øt:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> Trong khi m·∫π t√¥i ƒëang mua s·∫Øm, t√¥i ƒëang ng·∫Øm ƒë·ªì ch∆°i.</div>
                <div class="expl-step"><b>‚úÖ ƒê√°p √°n: was shopping / was looking</b></div>
                <div class="expl-step">V√¨ c√≥ t·ª´ "While" v√† ng·ªØ c·∫£nh hai ng∆∞·ªùi l√†m hai vi·ªác kh√°c nhau c√πng l√∫c -> H√†nh ƒë·ªông song song (Parallel Actions) -> C·∫£ hai d√πng Past Continuous.</div>
            </div>
        </div>

        <div class="question-block">
            <div class="question-text">
                2. The boys <span class="gap-fill-btn" onclick="openGapModal(this, 'p2q2', 'were playing')">__________</span> (play) football when the ball <span class="gap-fill-btn" onclick="openGapModal(this, 'p2q2b', 'hit')">__________</span> (hit) a window.
            </div>
            <div id="exp-p2q2" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> Gi·∫£i th√≠ch chi ti·∫øt:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> Nh·ªØng c·∫≠u b√© ƒëang ƒë√° b√≥ng th√¨ qu·∫£ b√≥ng ƒë·∫≠p v√†o c·ª≠a s·ªï.</div>
                <div class="expl-step"><b>‚úÖ ƒê√°p √°n: were playing / hit</b></div>
                <div class="expl-step">ƒêang ƒë√° b√≥ng (h√†nh ƒë·ªông d√†i) -> <b>were playing</b> (boys s·ªë nhi·ªÅu). B√≥ng ƒë·∫≠p v√†o (h√†nh ƒë·ªông ng·∫Øn) -> <b>hit</b> (V2 c·ªßa hit v·∫´n l√† hit).</div>
            </div>
        </div>

        <div class="question-block">
            <div class="question-text">
                3. She <span class="gap-fill-btn" onclick="openGapModal(this, 'p2q3', 'was cooking')">__________</span> (cook) lunch when she <span class="gap-fill-btn" onclick="openGapModal(this, 'p2q3b', 'cut')">__________</span> (cut) her finger.
            </div>
            <div id="exp-p2q3" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> Gi·∫£i th√≠ch chi ti·∫øt:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> C√¥ ·∫•y ƒëang n·∫•u b·ªØa tr∆∞a th√¨ b·ªã ƒë·ª©t tay.</div>
                <div class="expl-step"><b>‚úÖ ƒê√°p √°n: was cooking / cut</b></div>
                <div class="expl-step">N·∫•u ƒÉn b·ªã gi√°n ƒëo·∫°n b·ªüi vi·ªác ƒë·ª©t tay. L∆∞u √Ω: <b>cut</b> l√† ƒë·ªông t·ª´ b·∫•t quy t·∫Øc (cut - cut - cut).</div>
            </div>
        </div>

        <div class="question-block">
            <div class="question-text">
                4. He <span class="gap-fill-btn" onclick="openGapModal(this, 'p2q4', 'was doing')">__________</span> (do) a puzzle while his sister <span class="gap-fill-btn" onclick="openGapModal(this, 'p2q4b', 'was drawing')">__________</span> (draw).
            </div>
            <div id="exp-p2q4" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> Gi·∫£i th√≠ch chi ti·∫øt:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> C·∫≠u ·∫•y ƒëang x·∫øp h√¨nh trong khi em g√°i ƒëang v·∫Ω.</div>
                <div class="expl-step"><b>‚úÖ ƒê√°p √°n: was doing / was drawing</b></div>
                <div class="expl-step">H√†nh ƒë·ªông song song (While) -> D√πng Past Continuous cho c·∫£ hai.</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="part-title">PART 3: PRESENT PERFECT (HAVE/HAS + V3)</div>
        <p><i>Complete the sentences using Present Perfect.</i></p>

        <div class="question-block">
            <div class="question-text">
                1. We <span class="gap-fill-btn" onclick="openGapModal(this, 'p3q1', 'have seen')">__________</span> (see) this cartoon three times.
            </div>
            <div id="exp-p3q1" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> Gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>‚úÖ have seen:</b> Ch·ªß ng·ªØ "We" (s·ªë nhi·ªÅu) + have + V3 (see -> seen). D·∫•u hi·ªáu: "three times" (l·∫∑p l·∫°i nhi·ªÅu l·∫ßn).</div>
            </div>
        </div>

        <div class="question-block">
            <div class="question-text">
                2. I <span class="gap-fill-btn" onclick="openGapModal(this, 'p3q2', 'have never been')">__________</span> (never / be) to America.
            </div>
            <div id="exp-p3q2" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> Gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>‚úÖ have never been:</b> Ch·ªß ng·ªØ "I" + have. V·ªã tr√≠ "never" ƒë·ª©ng gi·ªØa have v√† V3 (be -> been).</div>
            </div>
        </div>

        <div class="question-block">
            <div class="question-text">
                3. <span class="gap-fill-btn" onclick="openGapModal(this, 'p3q3a', 'Has')">__________</span> she <span class="gap-fill-btn" onclick="openGapModal(this, 'p3q3b', 'met')">__________</span> (meet) your brother?
            </div>
            <div id="exp-p3q3b" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> Gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>‚úÖ Has ... met:</b> C√¢u h·ªèi v·ªõi ch·ªß ng·ªØ "She" -> ƒê·∫£o Has l√™n ƒë·∫ßu. V3 c·ªßa meet l√† met.</div>
            </div>
        </div>

        <div class="question-block">
            <div class="question-text">
                4. They <span class="gap-fill-btn" onclick="openGapModal(this, 'p3q4', 'haven\'t bought')">__________</span> (not / buy) the tickets yet.
            </div>
            <div id="exp-p3q4" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> Gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>‚úÖ haven't bought:</b> "not buy" -> haven't (s·ªë nhi·ªÅu). V3 c·ªßa buy l√† bought. D·∫•u hi·ªáu: "yet" (ch∆∞a).</div>
            </div>
        </div>

        <div class="question-block">
            <div class="question-text">
                5. He <span class="gap-fill-btn" onclick="openGapModal(this, 'p3q5', 'has read')">__________</span> (read) five books this month.
            </div>
            <div id="exp-p3q5" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> Gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>‚úÖ has read:</b> Ch·ªß ng·ªØ "He" -> has. V3 c·ªßa read vi·∫øt gi·ªëng h·ªát nh∆∞ng ƒë·ªçc l√† /red/.</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="part-title">PART 4: MULTIPLE CHOICE</div>
        <p><i>Choose the correct word.</i></p>

        <div class="question-block" id="p4q1">
            <div class="question-text">1. We haven‚Äôt visited our cousins __________ last summer.</div>
            <div class="options-grid">
                <button class="btn-option" onclick="checkMCQ(this, true, 'exp-p4q1')">A. since</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q1')">B. for</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q1')">C. in</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q1')">D. about</button>
            </div>
            <div id="exp-p4q1" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> C√¥ Mai An gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> Ch√∫ng t√¥i ch∆∞a thƒÉm anh h·ªç <u>k·ªÉ t·ª´</u> m√πa h√® nƒÉm ngo√°i.</div>
                <div class="expl-step"><b>A. Since (k·ªÉ t·ª´):</b> M·ªëc th·ªùi gian c·ª• th·ªÉ (last summer). -> <b>ƒê√öNG</b></div>
                <div class="expl-step"><b>B. For (kho·∫£ng):</b> D√πng cho kho·∫£ng th·ªùi gian (v√≠ d·ª•: for 2 months). -> <b>SAI</b></div>
            </div>
        </div>

        <hr style="margin: 20px 0;">

        <div class="question-block" id="p4q2">
            <div class="question-text">2. She has __________ finished her test. (C√¥ ·∫•y v·ª´a m·ªõi l√†m xong)</div>
            <div class="options-grid">
                <button class="btn-option" onclick="checkMCQ(this, true, 'exp-p4q2')">A. just</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q2')">B. yet</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q2')">C. ever</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q2')">D. since</button>
            </div>
            <div id="exp-p4q2" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> C√¥ Mai An gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>A. Just (v·ª´a m·ªõi):</b> ƒê·ª©ng gi·ªØa has/have v√† V3, ch·ªâ h√†nh ƒë·ªông v·ª´a xong. -> <b>ƒê√öNG</b></div>
                <div class="expl-step"><b>B. Yet (ch∆∞a):</b> Th∆∞·ªùng ƒë·ª©ng cu·ªëi c√¢u ph·ªß ƒë·ªãnh/nghi v·∫•n. -> <b>SAI</b></div>
            </div>
        </div>

        <hr style="margin: 20px 0;">

        <div class="question-block" id="p4q3">
            <div class="question-text">3. I have learned to swim __________ three months.</div>
            <div class="options-grid">
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q3')">A. since</button>
                <button class="btn-option" onclick="checkMCQ(this, true, 'exp-p4q3')">B. for</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q3')">C. at</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q3')">D. in</button>
            </div>
            <div id="exp-p4q3" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> C√¥ Mai An gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>A. Since:</b> C·∫ßn m·ªëc th·ªùi gian. -> <b>SAI</b></div>
                <div class="expl-step"><b>B. For:</b> C·ªông v·ªõi m·ªôt kho·∫£ng th·ªùi gian (three months - 3 th√°ng). -> <b>ƒê√öNG</b></div>
            </div>
        </div>

        <hr style="margin: 20px 0;">

        <div class="question-block" id="p4q4">
            <div class="question-text">4. Have you __________ been on a plane?</div>
            <div class="options-grid">
                <button class="btn-option" onclick="checkMCQ(this, true, 'exp-p4q4')">A. ever</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q4')">B. never</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q4')">C. yet</button>
                <button class="btn-option" onclick="checkMCQ(this, false, 'exp-p4q4')">D. just</button>
            </div>
            <div id="exp-p4q4" class="explanation">
                <div class="teacher-avatar"><i class="fas fa-chalkboard-teacher"></i> C√¥ Mai An gi·∫£i th√≠ch:</div>
                <div class="expl-step"><b>üáªüá≥ D·ªãch:</b> B·∫°n <u>ƒë√£ t·ª´ng</u> ƒëi m√°y bay ch∆∞a?</div>
                <div class="expl-step"><b>A. Ever (ƒë√£ t·ª´ng):</b> D√πng trong c√¢u h·ªèi tr·∫£i nghi·ªám. -> <b>ƒê√öNG</b></div>
                <div class="expl-step"><b>B. Never:</b> Mang nghƒ©a ph·ªß ƒë·ªãnh, hi·∫øm khi d√πng trong c√¢u h·ªèi d·∫°ng n√†y tr·ª´ khi ng·∫°c nhi√™n. -> <b>SAI</b></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="part-title">PART 5: WRITE YOUR OWN SENTENCES</div>
        <p><i>H√£y t·∫≠p vi·∫øt c√¢u (Ph·∫ßn n√†y em t·ª± ch·∫•m ho·∫∑c nh·ªù gi√°o vi√™n xem nh√©!)</i></p>
        
        <div style="margin-bottom: 20px;">
            <label style="font-weight:bold; display:block; margin-bottom:5px;">1. Write one sentence using PAST CONTINUOUS + PAST SIMPLE:</label>
            <textarea rows="3" placeholder="V√≠ d·ª•: I was sleeping when the phone rang..."></textarea>
            <button class="binary-btn" onclick="toggleHint('hint1')"><i class="fas fa-lightbulb"></i> Xem g·ª£i √Ω m·∫´u</button>
            <div id="hint1" class="explanation">
                <b>G·ª£i √Ω c·ªßa c√¥ Mai An:</b>
                <br> - I was doing homework when my mom came home.
                <br> - We were playing games when the lights went out.
            </div>
        </div>

        <div>
            <label style="font-weight:bold; display:block; margin-bottom:5px;">2. Write one sentence using PRESENT PERFECT:</label>
            <textarea rows="3" placeholder="V√≠ d·ª•: I have lived here for 10 years..."></textarea>
            <button class="binary-btn" onclick="toggleHint('hint2')"><i class="fas fa-lightbulb"></i> Xem g·ª£i √Ω m·∫´u</button>
            <div id="hint2" class="explanation">
                <b>G·ª£i √Ω c·ªßa c√¥ Mai An:</b>
                <br> - I have studied English since 2020.
                <br> - She has just finished her dinner.
            </div>
        </div>
    </div>
    
    <div class="card">
        <h3 style="color: var(--primary);"><i class="fas fa-book"></i> GLOSSARY (T·ª™ V·ª∞NG TRONG B√ÄI)</h3>
        <table class="glossary-table">
            <thead>
                <tr>
                    <th>Word</th>
                    <th>Type</th>
                    <th>Meaning (Vietnamese)</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>Puzzle</td><td>(n)</td><td>Tr√≤ ch∆°i x·∫øp h√¨nh/c√¢u ƒë·ªë</td></tr>
                <tr><td>Decorate</td><td>(v)</td><td>Trang tr√≠</td></tr>
                <tr><td>Cartoon</td><td>(n)</td><td>Phim ho·∫°t h√¨nh</td></tr>
                <tr><td>Interrupt</td><td>(v)</td><td>Chen ngang, l√†m gi√°n ƒëo·∫°n</td></tr>
                <tr><td>While</td><td>(conj)</td><td>Trong khi (d·∫•u hi·ªáu Past Cont.)</td></tr>
                <tr><td>Recently</td><td>(adv)</td><td>G·∫ßn ƒë√¢y</td></tr>
            </tbody>
        </table>
    </div>

    <button class="submit-all-btn" onclick="finishTest()">
        <i class="fas fa-check-circle"></i> N·ªòP B√ÄI
    </button>
</div>

<div id="gapModal" class="modal">
    <div class="modal-content">
        <h3>Ch·ªçn ƒë√°p √°n ƒë√∫ng</h3>
        <div id="modalOptions" class="options-grid" style="grid-template-columns: 1fr;">
            </div>
        <button onclick="closeModal()" style="margin-top:15px; padding: 10px; border:none; background:transparent; color:#666; cursor:pointer;">ƒê√≥ng</button>
    </div>
</div>

<div id="resultPopup">
    <div class="result-content">
        <i class="fas fa-trophy" style="font-size: 4rem; color: #f1c40f; margin-bottom: 20px;"></i>
        <h2 id="resultTitle">HO√ÄN TH√ÄNH!</h2>
        <p id="resultMessage" style="font-size: 1.2rem;">B·∫°n ƒë√£ l√†m r·∫•t t·ªët!</p>
        <button class="submit-all-btn" onclick="document.getElementById('resultPopup').style.display='none'">Xem l·∫°i b√†i</button>
    </div>
</div>

<script>
    // SOUND EFFECTS
    const soundCorrect = new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3'); // Ding sound
    const soundWrong = new Audio('https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3'); // Cartoon boing/error

    // GLOBAL VARIABLES
    let currentGapBtn = null;
    let currentExpId = null;
    let currentCorrectVal = null;

    // --- FUNCTION: PART 1 BINARY CHOICE ---
    function checkBinary(btn, isCorrect, expId) {
        // Reset siblings
        let parent = btn.parentElement;
        let siblings = parent.getElementsByClassName('binary-btn');
        for(let s of siblings) {
            s.classList.remove('correct', 'wrong');
        }

        if (isCorrect) {
            btn.classList.add('correct');
            playSound(true);
            triggerConfetti();
        } else {
            btn.classList.add('wrong');
            playSound(false);
        }

        // Show explanation immediately
        document.getElementById(expId).classList.add('show');
    }

    // --- FUNCTION: PART 4 MCQ ---
    function checkMCQ(btn, isCorrect, expId) {
        // Disable other buttons in same group to prevent spamming
        let parent = btn.parentElement;
        let siblings = parent.getElementsByClassName('btn-option');
        
        // Remove old classes if re-selecting
        for(let s of siblings) {
            s.classList.remove('correct', 'wrong');
        }

        if (isCorrect) {
            btn.classList.add('correct');
            playSound(true);
            triggerConfetti();
        } else {
            btn.classList.add('wrong');
            playSound(false);
        }

        document.getElementById(expId).classList.add('show');
    }

    // --- FUNCTION: PART 2 & 3 GAP FILL MODAL ---
    function openGapModal(btn, qId, correctVal) {
        currentGapBtn = btn;
        currentExpId = 'exp-' + qId.split(/[ab]/)[0]; // Logic to find explanation ID even for split parts like p2q1b
        currentCorrectVal = correctVal;

        // Generate distractors based on the correct answer to make it smart
        let options = generateDistractors(correctVal);
        
        let modalOpts = document.getElementById('modalOptions');
        modalOpts.innerHTML = '';

        options.forEach(opt => {
            let b = document.createElement('button');
            b.className = 'btn-option';
            b.innerText = opt;
            b.onclick = function() { selectGapAnswer(opt, correctVal); };
            modalOpts.appendChild(b);
        });

        document.getElementById('gapModal').style.display = 'flex';
    }

    function selectGapAnswer(selected, correct) {
        closeModal();
        currentGapBtn.innerText = selected;
        
        // Normalize for checking
        if (selected.toLowerCase() === correct.toLowerCase()) {
            currentGapBtn.className = 'gap-fill-btn filled-correct';
            playSound(true);
            triggerConfetti();
        } else {
            currentGapBtn.className = 'gap-fill-btn filled-wrong';
            playSound(false);
        }

        // Show Explanation
        let expDiv = document.getElementById(currentExpId);
        if(expDiv) expDiv.classList.add('show');
    }

    function closeModal() {
        document.getElementById('gapModal').style.display = 'none';
    }

    // Helper to create fake options
    function generateDistractors(correct) {
        let list = [correct];
        // Simple logic to create fake grammar errors
        if(correct.includes('was')) list.push(correct.replace('was', 'were'), correct.replace('was', 'is'));
        else if(correct.includes('were')) list.push(correct.replace('were', 'was'), correct.replace('were', 'are'));
        else if(correct.includes('have')) list.push(correct.replace('have', 'has'), correct.replace('have', 'had'));
        else if(correct.includes('has')) list.push(correct.replace('has', 'have'), correct.replace('has', 'having'));
        else if(correct.endsWith('ed')) list.push(correct.substring(0, correct.length-2), correct + 'ing');
        else list.push(correct + 's', correct + 'ed'); // generic
        
        // Add random distractor if list is short
        if(list.length < 3) list.push('did ' + correct);

        // Deduplicate and Shuffle
        list = [...new Set(list)]; 
        return list.sort(() => Math.random() - 0.5).slice(0,3);
    }

    // --- UTILS ---
    function playSound(isCorrect) {
        if(isCorrect) {
            soundCorrect.currentTime = 0;
            soundCorrect.play().catch(e => console.log('Audio blocked'));
        } else {
            soundWrong.currentTime = 0;
            soundWrong.play().catch(e => console.log('Audio blocked'));
        }
    }

    function triggerConfetti() {
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#8854C0', '#00C9A7', '#FF4757']
        });
    }

    function toggleHint(id) {
        let el = document.getElementById(id);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function finishTest() {
        let popup = document.getElementById('resultPopup');
        popup.style.display = 'flex';
        triggerConfetti();
        setTimeout(triggerConfetti, 500);
    }

    // Close modal if clicking outside
    window.onclick = function(event) {
        let modal = document.getElementById('gapModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>

</body>
</html>