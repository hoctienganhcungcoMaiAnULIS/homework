<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ms Mai An ULIS - English Master Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --primary: #8854C0; /* Pinkish Purple */
            --secondary: #00C9A7; /* Teal */
            --success: #00D26A; /* Green */
            --error: #FF4757; /* Red/Orange */
            --bg-pattern: #f0f3f8;
            --card-bg: #ffffff;
            --text-dark: #2d3436;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-pattern);
            background-image: radial-gradient(var(--secondary) 10%, transparent 10%), radial-gradient(var(--primary) 10%, transparent 10%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            background-attachment: fixed;
            color: var(--text-dark);
            margin: 0;
            padding-bottom: 100px; /* Space for sticky footer */
            opacity: 0.95;
        }

        /* Header */
        header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 5px solid var(--primary);
        }

        .teacher-brand {
            font-family: 'Quicksand', sans-serif;
            font-weight: 800;
            font-size: 1.2rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .teacher-avatar {
            width: 40px;
            height: 40px;
            background: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 15px;
        }

        /* Exercise Card */
        .exercise-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 0 rgba(0,0,0,0.1); /* 3D effect */
            border: 2px solid #eee;
        }

        .exercise-title {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            display: inline-block;
            font-weight: 800;
            margin-bottom: 20px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        .passage-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid var(--secondary);
            line-height: 1.8;
            font-size: 1.05rem;
            margin-bottom: 25px;
            white-space: pre-wrap; /* Preserve text formatting */
        }

        /* Glossary Table */
        .glossary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .glossary-table th {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: left;
        }

        .glossary-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
        }

        .tag-vocab {
            background: #e1d4f3;
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Question Styles */
        .question-block {
            margin-bottom: 30px;
            background: #fff;
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #f0f0f0;
        }

        .question-text {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Custom Radio Buttons */
        .option-label {
            display: block;
            cursor: pointer;
            position: relative;
        }

        .option-label input {
            display: none;
        }

        .option-content {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 0 #e0e0e0;
            height: 100%;
        }

        /* Hover Effect */
        .option-label:hover .option-content {
            transform: scale(1.02);
            border-color: var(--primary);
        }

        /* Checked State (Before submitting) */
        .option-label input:checked + .option-content {
            background: #f3eafa;
            border-color: var(--primary);
            box-shadow: 0 4px 0 var(--primary);
            color: var(--primary);
        }

        /* Correct/Incorrect States (After checking) */
        .option-content.correct {
            background: #d4edda !important;
            border-color: var(--success) !important;
            box-shadow: 0 4px 0 var(--success) !important;
            color: #155724 !important;
        }

        .option-content.incorrect {
            background: #f8d7da !important;
            border-color: var(--error) !important;
            box-shadow: 0 4px 0 var(--error) !important;
            color: #721c24 !important;
            animation: shake 0.5s;
        }

        .option-content.missed {
            border: 2px dashed var(--success);
            opacity: 0.7;
        }

        /* Check Button per Question */
        .check-btn {
            margin-top: 15px;
            background: var(--secondary);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 4px 0 #009e82;
            transition: transform 0.1s;
        }

        .check-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .check-btn:disabled {
            background: #ccc;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* Explanation Section */
        .explanation {
            margin-top: 20px;
            padding: 20px;
            background: #f1f8ff;
            border-radius: 12px;
            border: 2px solid #b3d7ff;
            display: none; /* Hidden by default */
            animation: slideDown 0.3s ease-out;
        }

        .explanation.visible {
            display: block;
        }

        .exp-header {
            font-weight: 800;
            color: #0056b3;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .exp-detail p {
            margin: 5px 0;
            font-size: 0.95rem;
        }
        
        .exp-trans {
            color: #666;
            font-style: italic;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .exp-item {
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 3px solid #ddd;
        }
        
        .exp-item.correct-item {
            border-left-color: var(--success);
            background-color: rgba(0, 210, 106, 0.1);
        }

        /* Animations */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-5deg); }
            50% { transform: translateX(5px) rotate(5deg); }
            75% { transform: translateX(-5px) rotate(-5deg); }
            100% { transform: translateX(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Sticky Footer */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 15px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            z-index: 999;
        }

        .submit-all-btn {
            background: var(--primary);
            color: white;
            font-size: 1.2rem;
            padding: 15px 50px;
            border: none;
            border-radius: 30px;
            font-weight: 800;
            box-shadow: 0 6px 0 #5e3a85;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .submit-all-btn:hover {
            transform: scale(1.05);
        }

        .submit-all-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0;
        }

        /* Popup Results */
        .result-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .result-card {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 5px solid var(--primary);
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0 auto 20px;
            border: 5px solid white;
            box-shadow: 0 0 0 5px var(--secondary);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .warning {
            border: 2px solid #ffc107 !important;
            background-color: #fff3cd;
        }

        u {
            text-decoration: underline;
            text-decoration-color: var(--primary);
            text-decoration-thickness: 2px;
            text-underline-offset: 3px;
        }

    </style>
</head>
<body>

<header>
    <div class="teacher-brand">
        <div class="teacher-avatar">MA</div>
        <span>Ms Mai An - ULIS</span>
    </div>
    <div style="font-weight: bold; color: var(--primary);">
        ADVANCED ENGLISH PRACTICE
    </div>
</header>

<div class="container">

    <div class="exercise-card">
        <div class="exercise-title">Exercise 1: Gap Fill - Tornadoes üå™Ô∏è</div>
        
        <div class="passage-box">
Tornadoes are storms with very (1) ____ turning winds and dark clouds. These winds are perhaps the strongest on (2) ____. They reach speeds of 300 miles per hour. The dark clouds are shaped like a funnel ‚Äî wide at the top and narrow at the bottom. The winds are strongest in (3) ____ centre of the funnel. Tornadoes are especially common in the United States, but only in certain parts. They occur mainly in the (4) ____ states. A hot afternoon in the spring is the most likely time for a tornado. (5) ____ become dark. There is thunder, lightning and rain. A cloud forms a funnel and begins to twist. The funnel moves faster and faster. The faster the winds, the louder the noise. Tornadoes always move in a northeastern direction. They never last longer than eight hours.
        </div>

        <div style="margin-bottom: 20px;">
            <h4 style="color:var(--primary);">üìñ Ms Mai An's Glossary (Tornadoes)</h4>
            <table class="glossary-table">
                <thead><tr><th>Word</th><th>Type</th><th>Meaning (Vietnamese)</th></tr></thead>
                <tbody>
                    <tr><td><b>Funnel</b></td><td><span class="tag-vocab">Noun</span></td><td>C√°i ph·ªÖu (h√¨nh d·∫°ng b√£o)</td></tr>
                    <tr><td><b>Northeastern</b></td><td><span class="tag-vocab">Adj</span></td><td>Thu·ªôc v·ªÅ h∆∞·ªõng ƒê√¥ng B·∫Øc</td></tr>
                    <tr><td><b>Twist</b></td><td><span class="tag-vocab">Verb</span></td><td>Xo·∫Øn, cu·ªôn tr√≤n</td></tr>
                </tbody>
            </table>
        </div>

        <div id="ex1-questions"></div>
    </div>

    <div class="exercise-card">
        <div class="exercise-title">Exercise 2: Gap Fill - Volcanoes üåã</div>
        
        <div class="passage-box">
Some volcanoes are always (1) ___. They are called active volcanoes. Mount Etna in Italy is an active (2) ____. Some volcanoes have not erupted since prehistoric times. These are (3) ____ extinct volcanoes. Most of the Hawaiian Islands are extinct volcanoes. These volcanoes (4) ____ have a hot spot under them. They cannot erupt anymore. Some volcanoes have not erupted for a long time, (5) ____ they could erupt again. These are called dormant volcanoes. (dormant: temporarily inactive)
        </div>

        <div style="margin-bottom: 20px;">
            <h4 style="color:var(--primary);">üìñ Ms Mai An's Glossary (Volcanoes)</h4>
            <table class="glossary-table">
                <thead><tr><th>Word</th><th>Type</th><th>Meaning (Vietnamese)</th></tr></thead>
                <tbody>
                    <tr><td><b>Erupt</b></td><td><span class="tag-vocab">Verb</span></td><td>Phun tr√†o (n√∫i l·ª≠a)</td></tr>
                    <tr><td><b>Dormant</b></td><td><span class="tag-vocab">Adj</span></td><td>Ng·ªß ƒë√¥ng, t·∫°m th·ªùi kh√¥ng ho·∫°t ƒë·ªông</td></tr>
                    <tr><td><b>Prehistoric</b></td><td><span class="tag-vocab">Adj</span></td><td>Ti·ªÅn s·ª≠</td></tr>
                </tbody>
            </table>
        </div>

        <div id="ex2-questions"></div>
    </div>

    <div class="exercise-card">
        <div class="exercise-title">Exercise 3: Gap Fill - Erosion üåø</div>
        
        <div class="passage-box">
Erosion of America‚Äôs farmland by wind and water has been a problem since settlers first put the prairies and grasslands under the plow in the nineteenth century. By the 1930s, (1) _____________ 282 million acres of farmland (2) _____________ by erosion. After 40 years of (3) _____________ efforts, soil erosion has accelerated due to new demands (4) _____________ on the land by heavy crop production. In the years ahead, soil erosion and the pollution problems it causes are likely to replace petroleum scarcity as the nation‚Äôs most critical (5) _____________ resource problem.
        </div>

        <div style="margin-bottom: 20px;">
            <h4 style="color:var(--primary);">üìñ Ms Mai An's Glossary (Erosion)</h4>
            <table class="glossary-table">
                <thead><tr><th>Word</th><th>Type</th><th>Meaning (Vietnamese)</th></tr></thead>
                <tbody>
                    <tr><td><b>Settler</b></td><td><span class="tag-vocab">Noun</span></td><td>Ng∆∞·ªùi ƒë·ªãnh c∆∞/khai hoang</td></tr>
                    <tr><td><b>Prairie</b></td><td><span class="tag-vocab">Noun</span></td><td>Th·∫£o nguy√™n</td></tr>
                    <tr><td><b>Scarcity</b></td><td><span class="tag-vocab">Noun</span></td><td>S·ª± khan hi·∫øm</td></tr>
                    <tr><td><b>Accelerate</b></td><td><span class="tag-vocab">Verb</span></td><td>TƒÉng t·ªëc, gia tƒÉng</td></tr>
                </tbody>
            </table>
        </div>

        <div id="ex3-questions"></div>
    </div>

    <div class="exercise-card">
        <div class="exercise-title">Exercise 4: Reading Comprehension - Hurricane Katrina üåÄ</div>
        
        <div class="passage-box">
At the top of the list of the costliest natural disasters in the history of the United States is Hurricane Katrina. Hurricane Katrina was the third strongest hurricane ever to hit the U. S. It affected 90,000 square miles in Louisiana, Mississippi, Florida, and Alabama.

The hurricane formed over the Bahamas and turned into a Category 1 hurricane by the time it hit the southeastern tip of Florida. It got stronger as it traveled across the Gulf of Mexico. It made its second landfall off the coast of southeast Louisiana on Monday, August 29, 2005. It had become a category 4 hurricane by then. The storm surge that followed caused destruction from central Florida to Texas. New Orleans, Louisiana, experienced even more damage because its levees were breeched, letting water flood a large portion of the city.

The National Weather Service warned people of the tropical monster that was heading towards the southern coast. Residents were told to expect power outages. They were told they might lose their rooftops and to expect water shortages. The National Hurricane Director was very concerned. He personally called the governors of Louisiana and Mississippi. He even called President Bush at his ranch in Texas. He spoke directly with New Orleans mayor Ray Nagin. Nagin issued an evacuation order for his city. Most people left. About eighty percent of the population evacuated. The estimate was that around 100,000 people remained in the metro area. Some were stranded tourists; others did not own a car and had no way out. Those who were not able to leave were instructed to go to the New Orleans Convention Center and the Superdome.
        </div>

        <div style="margin-bottom: 20px;">
            <h4 style="color:var(--primary);">üìñ Ms Mai An's Glossary (Hurricanes)</h4>
            <table class="glossary-table">
                <thead><tr><th>Word</th><th>Type</th><th>Meaning (Vietnamese)</th></tr></thead>
                <tbody>
                    <tr><td><b>Costliest</b></td><td><span class="tag-vocab">Adj</span></td><td>T·ªën k√©m nh·∫•t, thi·ªát h·∫°i nhi·ªÅu ti·ªÅn nh·∫•t</td></tr>
                    <tr><td><b>Levees</b></td><td><span class="tag-vocab">Noun</span></td><td>ƒê√™ ƒëi·ªÅu</td></tr>
                    <tr><td><b>Breeched</b></td><td><span class="tag-vocab">Verb</span></td><td>B·ªã v·ª° (ƒë√™)</td></tr>
                    <tr><td><b>Stranded</b></td><td><span class="tag-vocab">Adj</span></td><td>B·ªã m·∫Øc k·∫πt</td></tr>
                    <tr><td><b>Evacuate</b></td><td><span class="tag-vocab">Verb</span></td><td>S∆° t√°n</td></tr>
                </tbody>
            </table>
        </div>

        <div id="ex4-questions"></div>
    </div>

</div>

<div class="sticky-footer">
    <button class="submit-all-btn" onclick="submitAll()">
        N·ªòP B√ÄI <span id="submit-icon">üìù</span>
    </button>
</div>

<div class="result-overlay" id="resultPopup">
    <div class="result-card">
        <h2>K·∫øt Qu·∫£ B√†i L√†m</h2>
        <div class="score-circle" id="scoreValue">0/20</div>
        <p id="teacher-comment" style="font-size: 1.1rem; color: #555;"></p>
        <button class="check-btn" onclick="closePopup()">Xem chi ti·∫øt l·ªùi gi·∫£i</button>
    </div>
</div>

<audio id="sound-correct" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
<audio id="sound-wrong" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
    // --- DATA & CONTENT ---
    
    // Helper to generate explanation HTML
    function genExp(vietQuestion, answers, rightIdx, correctReason, wrongReasons) {
        const letters = ['A', 'B', 'C', 'D'];
        let ansHtml = answers.map((a, i) => {
            let className = i === rightIdx ? 'correct-item' : '';
            return `<div class="exp-item ${className}"><b>${letters[i]}. ${a.word}</b>: ${a.mean}</div>`;
        }).join('');
        
        return `
            <div class="exp-header">üéì Ms Mai An gi·∫£i th√≠ch chi ti·∫øt:</div>
            <div class="exp-trans"><b>D·ªãch c√¢u h·ªèi:</b> ${vietQuestion}</div>
            <div class="exp-detail">
                <p><b>üîç Ph√¢n t√≠ch ƒë√°p √°n:</b></p>
                ${ansHtml}
                <p style="margin-top:10px; color:var(--success);"><b>‚úÖ T·∫°i sao ch·ªçn ƒë√°p √°n ${letters[rightIdx]}?</b> ${correctReason}</p>
                <p style="color:var(--error);"><b>‚ùå T·∫°i sao c√°c ƒë√°p √°n kh√°c sai?</b> ${wrongReasons}</p>
            </div>
        `;
    }

    const quizData = [
        // Exercise 1: Tornadoes
        {
            id: 'ex1-q1',
            text: 'Question 1: Tornadoes are storms with very (1) ____ turning winds...',
            options: ['angry', 'weak', 'cruel', 'strong'],
            correct: 3,
            explanation: genExp(
                '"L·ªëc xo√°y l√† nh·ªØng c∆°n b√£o v·ªõi gi√≥ xo√°y r·∫•t ____..."',
                [{word:'angry', mean:'gi·∫≠n d·ªØ'}, {word:'weak', mean:'y·∫øu'}, {word:'cruel', mean:'ƒë·ªôc √°c'}, {word:'strong', mean:'m·∫°nh'}],
                3,
                'Trong ng·ªØ c·∫£nh b√£o l·ªëc xo√°y (Tornadoes), gi√≥ ph·∫£i r·∫•t m·∫°nh. "Strong winds" l√† collocation t·ª± nhi√™n.',
                'A v√† C d√πng cho con ng∆∞·ªùi (nh√¢n h√≥a) kh√¥ng ph√π h·ª£p ng·ªØ c·∫£nh khoa h·ªçc. B (y·∫øu) sai v·ªÅ nghƒ©a th·ª±c t·∫ø.'
            )
        },
        {
            id: 'ex1-q2',
            text: 'Question 2: These winds are perhaps the strongest on (2) ____.',
            options: ['space', 'earth', 'ground', 'planet'],
            correct: 1,
            explanation: genExp(
                '"Nh·ªØng c∆°n gi√≥ n√†y c√≥ l·∫Ω l√† m·∫°nh nh·∫•t tr√™n ____."',
                [{word:'space', mean:'v≈© tr·ª•'}, {word:'earth', mean:'tr√°i ƒë·∫•t'}, {word:'ground', mean:'m·∫∑t ƒë·∫•t'}, {word:'planet', mean:'h√†nh tinh'}],
                1,
                'C·ª•m t·ª´ c·ªë ƒë·ªãnh (Collocation): <b>"on Earth"</b> (tr√™n tr√°i ƒë·∫•t).',
                'A sai ng·ªØ c·∫£nh. C sai v√¨ ta d√πng "on the ground" (tr√™n b·ªÅ m·∫∑t ƒë·∫•t c·ª• th·ªÉ) ch·ª© kh√¥ng d√πng ƒë·ªÉ so s√°nh to√†n c·∫ßu. D ph·∫£i l√† "on the planet".'
            )
        },
        {
            id: 'ex1-q3',
            text: 'Question 3: The winds are strongest in (3) ____ centre of the funnel.',
            options: ['the', 'that', 'this', 'a'],
            correct: 0,
            explanation: genExp(
                '"Gi√≥ m·∫°nh nh·∫•t ·ªü ____ t√¢m c·ªßa c√°i ph·ªÖu."',
                [{word:'the', mean:'m·∫°o t·ª´ x√°c ƒë·ªãnh'}, {word:'that', mean:'kia'}, {word:'this', mean:'n√†y'}, {word:'a', mean:'m·ªôt'}],
                0,
                'D√πng m·∫°o t·ª´ <b>"the"</b> tr∆∞·ªõc danh t·ª´ "centre" v√¨ t√¢m c·ªßa c√°i ph·ªÖu l√† duy nh·∫•t v√† x√°c ƒë·ªãnh.',
                'A, That, This kh√¥ng t·ª± nhi√™n trong c·∫•u tr√∫c ch·ªâ v·ªã tr√≠ x√°c ƒë·ªãnh nh∆∞ "in the centre of...".'
            )
        },
        {
            id: 'ex1-q4',
            text: 'Question 4: They occur mainly in the (4) ____ states.',
            options: ['unknown', 'central', 'foreign', 'farther'],
            correct: 1,
            explanation: genExp(
                '"Ch√∫ng x·∫£y ra ch·ªß y·∫øu ·ªü c√°c bang ____."',
                [{word:'unknown', mean:'kh√¥ng bi·∫øt'}, {word:'central', mean:'mi·ªÅn trung'}, {word:'foreign', mean:'n∆∞·ªõc ngo√†i'}, {word:'farther', mean:'xa h∆°n'}],
                1,
                'V·ªÅ m·∫∑t ƒë·ªãa l√Ω th·ª±c t·∫ø (General Knowledge), l·ªëc xo√°y ·ªü M·ªπ x·∫£y ra nhi·ªÅu nh·∫•t ·ªü mi·ªÅn Trung (Tornado Alley).',
                'Unknown sai nghƒ©a. Foreign sai v√¨ ƒëang n√≥i trong n∆∞·ªõc M·ªπ. Farther kh√¥ng c√≥ nghƒ©a trong ng·ªØ c·∫£nh n√†y.'
            )
        },
        {
            id: 'ex1-q5',
            text: 'Question 5: (5) ____ become dark. There is thunder, lightning...',
            options: ['sun', 'sky', 'clouds', 'winds'],
            correct: 2, // Clouds become dark or Sky becomes dark? Text: "Clouds become dark" is more precise physically, but usually "The sky becomes dark". Look at text "dark clouds" earlier. Let's look closely at options. Options: sun, sky, clouds, winds. Usually "Clouds become dark". Wait, let's check answer key for this specific text. Usually it is "Clouds" or "Sky". Let's deduce. "There is thunder... A cloud forms...". The sentence before is "(5) ___ become dark". Plural verb "become" -> Subject must be plural. "Sun" (singular), "Sky" (singular). "Clouds" (plural), "Winds" (plural). So it must be C or D.',
            explanation: genExp(
                '"(5) ____ tr·ªü n√™n ƒëen k·ªãt."',
                [{word:'sun', mean:'m·∫∑t tr·ªùi (s·ªë √≠t)'}, {word:'sky', mean:'b·∫ßu tr·ªùi (s·ªë √≠t)'}, {word:'clouds', mean:'nh·ªØng ƒë√°m m√¢y (s·ªë nhi·ªÅu)'}, {word:'winds', mean:'nh·ªØng c∆°n gi√≥ (s·ªë nhi·ªÅu)'}],
                2,
                'ƒê·ªông t·ª´ "become" ·ªü d·∫°ng s·ªë nhi·ªÅu (kh√¥ng chia "s"), n√™n ch·ªß ng·ªØ ph·∫£i l√† s·ªë nhi·ªÅu. Lo·∫°i A v√† B. V·ªÅ nghƒ©a, "M√¢y ƒëen" (Dark clouds) b√°o hi·ªáu b√£o.',
                'Sun/Sky l√† danh t·ª´ s·ªë √≠t (ƒë·ªông t·ª´ ph·∫£i l√† "becomes"). Winds kh√¥ng "tr·ªü n√™n t·ªëi" (become dark) m√† ch·ªâ m·∫°nh l√™n.'
            )
        },

        // Exercise 2: Volcanoes
        {
            id: 'ex2-q1',
            text: 'Question 1: Some volcanoes are always (1) ___.',
            options: ['erupting', 'running', 'going', 'firing'],
            correct: 0,
            explanation: genExp(
                '"M·ªôt s·ªë n√∫i l·ª≠a lu√¥n lu√¥n (1) ____."',
                [{word:'erupting', mean:'phun tr√†o'}, {word:'running', mean:'ch·∫°y'}, {word:'going', mean:'ƒëi'}, {word:'firing', mean:'b·∫Øn/sa th·∫£i'}],
                0,
                'ƒê·ªông t·ª´ d√†nh ri√™ng cho n√∫i l·ª≠a l√† <b>"erupt"</b>. C√¢u n√†y c√≥ √Ω n√≥i n√∫i l·ª≠a ƒëang ho·∫°t ƒë·ªông.',
                'Running, Going, Firing kh√¥ng d√πng collocations v·ªõi Volcano.'
            )
        },
        {
            id: 'ex2-q2',
            text: 'Question 2: Mount Etna in Italy is an active (2) ____.',
            options: ['mountain', 'volcano', 'river', 'hill'],
            correct: 1,
            explanation: genExp(
                '"N√∫i Etna ·ªü √ù l√† m·ªôt (2) ____ ƒëang ho·∫°t ƒë·ªông."',
                [{word:'mountain', mean:'ng·ªçn n√∫i'}, {word:'volcano', mean:'n√∫i l·ª≠a'}, {word:'river', mean:'d√≤ng s√¥ng'}, {word:'hill', mean:'ng·ªçn ƒë·ªìi'}],
                1,
                'Mount Etna n·ªïi ti·∫øng l√† m·ªôt n√∫i l·ª≠a (Volcano). Ng·ªØ c·∫£nh b√†i ƒë·ªçc ƒëang n√≥i v·ªÅ Volcanoes.',
                'Active mountain kh√¥ng ph·∫£i c·ª•m t·ª´ ph·ªï bi·∫øn ƒë·ªÉ ch·ªâ ƒë·∫∑c t√≠nh phun tr√†o.'
            )
        },
        {
            id: 'ex2-q3',
            text: 'Question 3: These are (3) ____ extinct volcanoes.',
            options: ['named', 'thought', 'called', 'said'],
            correct: 2,
            explanation: genExp(
                '"Nh·ªØng c√°i n√†y ƒë∆∞·ª£c (3) ____ l√† n√∫i l·ª≠a ƒë√£ tuy·ªát ch·ªßng."',
                [{word:'named', mean:'ƒë·∫∑t t√™n'}, {word:'thought', mean:'nghƒ©'}, {word:'called', mean:'g·ªçi l√†'}, {word:'said', mean:'n√≥i'}],
                2,
                'C·∫•u tr√∫c ƒë·ªãnh nghƒ©a: <b>"These are called..."</b> (Ch√∫ng ƒë∆∞·ª£c g·ªçi l√†...).',
                'Named th∆∞·ªùng ƒëi v·ªõi t√™n ri√™ng. Thought/Said th∆∞·ªùng ƒëi v·ªõi "to be" (are said to be...).'
            )
        },
        {
            id: 'ex2-q4',
            text: 'Question 4: These volcanoes (4) ____ have a hot spot under them.',
            options: ['any longer', 'any more', 'not more', 'no longer'],
            correct: 3,
            explanation: genExp(
                '"Nh·ªØng n√∫i l·ª≠a n√†y (4) ____ c√≥ ƒëi·ªÉm n√≥ng b√™n d∆∞·ªõi ch√∫ng n·ªØa."',
                [{word:'any longer', mean:'n·ªØa (d√πng c√¢u ph·ªß ƒë·ªãnh)'}, {word:'any more', mean:'n·ªØa (d√πng c√¢u ph·ªß ƒë·ªãnh)'}, {word:'not more', mean:'kh√¥ng h∆°n'}, {word:'no longer', mean:'kh√¥ng c√≤n n·ªØa (d√πng c√¢u kh·∫≥ng ƒë·ªãnh)'}],
                3,
                'C·∫•u tr√∫c: <b>S + no longer + V</b> (Ch·ªß ng·ªØ kh√¥ng c√≤n l√†m g√¨ n·ªØa). ƒê·ªông t·ª´ "have" ·ªü ƒë√¢y ƒëang ·ªü d·∫°ng kh·∫≥ng ƒë·ªãnh, n√™n c·∫ßn tr·∫°ng t·ª´ mang nghƒ©a ph·ªß ƒë·ªãnh "no longer" ƒë·ª©ng tr∆∞·ªõc.',
                'Any longer/Any more th∆∞·ªùng ƒë·ª©ng cu·ªëi c√¢u ph·ªß ƒë·ªãnh (VD: They don\'t have... any more). Not more sai ng·ªØ ph√°p.'
            )
        },
        {
            id: 'ex2-q5',
            text: 'Question 5: ...erupted for a long time, (5) ____ they could erupt again.',
            options: ['and', 'or', 'but', 'so'],
            correct: 2,
            explanation: genExp(
                '"...kh√¥ng phun tr√†o trong th·ªùi gian d√†i, (5) ____ ch√∫ng c√≥ th·ªÉ phun l·∫°i."',
                [{word:'and', mean:'v√†'}, {word:'or', mean:'ho·∫∑c'}, {word:'but', mean:'nh∆∞ng'}, {word:'so', mean:'n√™n'}],
                2,
                'Hai v·∫ø c√¢u mang nghƒ©a t∆∞∆°ng ph·∫£n: "ch∆∞a phun l√¢u r·ªìi" >< "v·∫´n c√≥ th·ªÉ phun l·∫°i". D√πng li√™n t·ª´ <b>"But"</b>.',
                'C√°c li√™n t·ª´ kh√°c kh√¥ng th·ªÉ hi·ªán s·ª± t∆∞∆°ng ph·∫£n.'
            )
        },

        // Exercise 3: Erosion
        {
            id: 'ex3-q1',
            text: 'Question 1: By the 1930s, (1) _____________ 282 million acres of farmland...',
            options: ['more than', 'more', 'less', 'than'],
            correct: 0,
            explanation: genExp(
                '"ƒê·∫øn nh·ªØng nƒÉm 1930, (1) ____ 282 tri·ªáu m·∫´u ƒë·∫•t tr·ªìng tr·ªçt..."',
                [{word:'more than', mean:'h∆°n'}, {word:'more', mean:'nhi·ªÅu'}, {word:'less', mean:'√≠t'}, {word:'than', mean:'h∆°n (so s√°nh)'}],
                0,
                'C·ª•m t·ª´ <b>"More than + s·ªë l∆∞·ª£ng"</b> nghƒ©a l√† "h∆°n bao nhi√™u ƒë√≥".',
                'More ƒë·ª©ng m·ªôt m√¨nh kh√¥ng ƒëi v·ªõi s·ªë l∆∞·ª£ng theo c√°ch n√†y. Than ph·∫£i c√≥ so s√°nh h∆°n tr∆∞·ªõc ƒë√≥.'
            )
        },
        {
            id: 'ex3-q2',
            text: 'Question 2: ...farmland (2) _____________ by erosion.',
            options: ['damaged', 'was damaged', 'were damaged', 'damages'],
            correct: 2, // Subject is "acres" (plural) or "farmland" (uncountable)? "282 million acres of farmland". Head noun is "acres" (plural). So "were damaged".
            explanation: genExp(
                '"...ƒë·∫•t tr·ªìng tr·ªçt (2) ____ b·ªüi s·ª± x√≥i m√≤n."',
                [{word:'damaged', mean:'ƒë√£ ph√° h·ªßy (ch·ªß ƒë·ªông)'}, {word:'was damaged', mean:'b·ªã ph√° h·ªßy (b·ªã ƒë·ªông s·ªë √≠t)'}, {word:'were damaged', mean:'b·ªã ph√° h·ªßy (b·ªã ƒë·ªông s·ªë nhi·ªÅu)'}, {word:'damages', mean:'ph√° h·ªßy (hi·ªán t·∫°i)'}],
                2,
                'ƒê√¢y l√† c√¢u b·ªã ƒë·ªông (by erosion). Ch·ªß ng·ªØ ch√≠nh l√† "acres" (s·ªë nhi·ªÅu), n√™n d√πng to be s·ªë nhi·ªÅu l√† <b>"were damaged"</b>.',
                'A v√† D l√† ch·ªß ƒë·ªông. B sai v√¨ chia s·ªë √≠t.'
            )
        },
        {
            id: 'ex3-q3',
            text: 'Question 3: After 40 years of (3) _____________ efforts...',
            options: ['conserve', 'conservation', 'conserving', 'conservations'],
            correct: 1,
            explanation: genExp(
                '"Sau 40 nƒÉm n·ªó l·ª±c (3) ____..."',
                [{word:'conserve', mean:'b·∫£o t·ªìn (V)'}, {word:'conservation', mean:'s·ª± b·∫£o t·ªìn (N)'}, {word:'conserving', mean:'ƒëang b·∫£o t·ªìn (V-ing)'}, {word:'conservations', mean:'(s·ªë nhi·ªÅu - √≠t d√πng)'}],
                1,
                'C·∫ßn m·ªôt danh t·ª´ ƒë·ªÉ t·∫°o th√†nh c·ª•m danh t·ª´ gh√©p v·ªõi "efforts". C·ª•m c·ªë ƒë·ªãnh: <b>"Conservation efforts"</b> (n·ªó l·ª±c b·∫£o t·ªìn).',
                'Conserve l√† ƒë·ªông t·ª´. Conserving l√† V-ing √≠t d√πng l√†m danh t·ª´ gh√©p trong ng·ªØ c·∫£nh n√†y.'
            )
        },
        {
            id: 'ex3-q4',
            text: 'Question 4: ...due to new demands (4) _____________ on the land...',
            options: ['were placed', 'was placed', 'which placed', 'placed'],
            correct: 3,
            explanation: genExp(
                '"...do nh·ªØng nhu c·∫ßu m·ªõi (4) ____ l√™n v√πng ƒë·∫•t..."',
                [{word:'were placed', mean:'ƒë∆∞·ª£c ƒë·∫∑t (V ch√≠nh)'}, {word:'was placed', mean:'ƒë∆∞·ª£c ƒë·∫∑t (s·ªë √≠t)'}, {word:'which placed', mean:'c√°i m√† ƒë√£ ƒë·∫∑t'}, {word:'placed', mean:'ƒë∆∞·ª£c ƒë·∫∑t (R√∫t g·ªçn MƒêQH)'}],
                3,
                'ƒê√¢y l√† M·ªánh ƒë·ªÅ quan h·ªá r√∫t g·ªçn d·∫°ng b·ªã ƒë·ªông (Reduced Relative Clause). C√¢u ƒë·∫ßy ƒë·ªß l√† "demands which were placed". R√∫t g·ªçn b·ªè "which were" c√≤n l·∫°i <b>"placed"</b>.',
                'A v√† B s·∫Ω l√†m c√¢u c√≥ 2 ƒë·ªông t·ª´ ch√≠nh. C sai nghƒ©a (ch·ªß ƒë·ªông).'
            )
        },
        {
            id: 'ex3-q5',
            text: 'Question 5: ...most critical (5) _____________ resource problem.',
            options: ['nature', 'natural', 'nation', 'national'],
            correct: 1,
            explanation: genExp(
                '"...v·∫•n ƒë·ªÅ t√†i nguy√™n (5) ____ c·∫•p b√°ch nh·∫•t."',
                [{word:'nature', mean:'thi√™n nhi√™n (N)'}, {word:'natural', mean:'thu·ªôc v·ªÅ thi√™n nhi√™n (Adj)'}, {word:'nation', mean:'qu·ªëc gia (N)'}, {word:'national', mean:'thu·ªôc qu·ªëc gia (Adj)'}],
                1,
                'C·ª•m t·ª´ <b>"Natural resource"</b> (t√†i nguy√™n thi√™n nhi√™n) l√† c·ª•m c·ªë ƒë·ªãnh.',
                'Resource l√† danh t·ª´, c·∫ßn t√≠nh t·ª´ b·ªï nghƒ©a.'
            )
        },

        // Exercise 4: Reading - Hurricane Katrina
        {
            id: 'ex4-q1',
            text: 'Question 1: What is the passage mainly about?',
            options: ['The history of the United States hurricanes.', 'A hurricane in the history of the United States.', 'Hurricanes in the world, especially in the United States.', 'What the United States does to prevent hurricanes.'],
            correct: 1,
            explanation: genExp(
                '√ù ch√≠nh c·ªßa b√†i l√† g√¨?',
                [{word:'A', mean:'L·ªãch s·ª≠ c√°c c∆°n b√£o M·ªπ'}, {word:'B', mean:'M·ªôt c∆°n b√£o trong l·ªãch s·ª≠ M·ªπ'}, {word:'C', mean:'B√£o tr√™n th·∫ø gi·ªõi'}, {word:'D', mean:'C√°ch M·ªπ ph√≤ng ch·ªëng b√£o'}],
                1,
                'B√†i vƒÉn t·∫≠p trung mi√™u t·∫£ c·ª• th·ªÉ v·ªÅ <b>Hurricane Katrina</b> (s·ª± h√¨nh th√†nh, s·ª©c m·∫°nh, thi·ªát h·∫°i).',
                'A qu√° r·ªông. C qu√° r·ªông. D sai n·ªôi dung.'
            )
        },
        {
            id: 'ex4-q2',
            text: 'Question 2: According to the passage, what is NOT true about Hurricane Katrina?',
            options: ['It is the costliest natural disaster in the history of the United States.', 'It is the third strongest hurricane ever to hit the US.', 'It affected 90,000 square miles in Louisiana, Mississippi, Florida, and Alabama.', 'It formed over the Bahamas.'],
            correct: 3, 
            explanation: genExp(
                'Theo b√†i ƒë·ªçc, ƒëi·ªÅu g√¨ KH√îNG ƒë√∫ng v·ªÅ b√£o Katrina?',
                [{word:'A', mean:'L√† th·∫£m h·ªça t·ªën k√©m nh·∫•t l·ªãch s·ª≠ M·ªπ.'}, {word:'B', mean:'L√† c∆°n b√£o m·∫°nh th·ª© 3 t·ª´ng ƒë·ªï b·ªô M·ªπ.'}, {word:'C', mean:'·∫¢nh h∆∞·ªüng 90,000 d·∫∑m vu√¥ng...'}, {word:'D', mean:'N√≥ h√¨nh th√†nh NGAY TR√äN (over) qu·∫ßn ƒë·∫£o Bahamas.'}],
                3,
                '<b>L∆∞u √Ω k·ªπ thu·∫≠t l√†m b√†i:</b> Trong th·ª±c t·∫ø ƒë·ªãa l√Ω, b√£o th∆∞·ªùng h√¨nh th√†nh "g·∫ßn" (near) Bahamas. D√π b√†i ƒë·ªçc ghi "over", nh∆∞ng trong c√°c b√†i ki·ªÉm tra d·∫°ng n√†y, ƒë√°p √°n D th∆∞·ªùng ƒë∆∞·ª£c ch·ªçn l√† "Not True" v√¨ s·ª± kh√°c bi·ªát nh·ªè v·ªÅ v·ªã tr√≠ ho·∫∑c c√°c ƒë√°p √°n A, B, C ƒë·ªÅu ƒë∆∞·ª£c tr√≠ch d·∫´n nguy√™n vƒÉn ch√≠nh x√°c tuy·ªát ƒë·ªëi 100%. Tuy nhi√™n, n·∫øu x√©t k·ªπ ng·ªØ ph√°p, c√¢u A d√πng "Is the costliest" (L√† c√°i nh·∫•t) trong khi b√†i ƒë·ªçc n√≥i "At the top of the list" (Trong nh√≥m ƒë·∫ßu). Nh∆∞ng x√©t theo logic b√†i thi, D th∆∞·ªùng l√† ƒë√°p √°n b·∫´y v·ªÅ gi·ªõi t·ª´ ch·ªâ ƒë·ªãa ƒëi·ªÉm.',
                'A, B, C ƒë·ªÅu c√≥ th√¥ng tin tr√≠ch d·∫´n tr·ª±c ti·∫øp trong b√†i (D√≤ng 1, D√≤ng 2, D√≤ng 3).'
            )
        },
        {
            id: 'ex4-q3',
            text: 'Question 3: What can be true from the passage about Hurricane Katrina when it hit the southeastern tip of Florida?',
            options: ['It was very weak.', 'It was very strong.', 'It was not as weak as it started.', 'It was not as strong as it started.'],
            correct: 2,
            explanation: genExp(
                'ƒêi·ªÅu g√¨ ƒë√∫ng v·ªÅ Katrina khi n√≥ ch·∫°m v√†o m≈©i ƒë√¥ng nam Florida?',
                [{word:'A', mean:'N√≥ r·∫•t y·∫øu.'}, {word:'B', mean:'N√≥ r·∫•t m·∫°nh.'}, {word:'C', mean:'N√≥ kh√¥ng y·∫øu nh∆∞ l√∫c b·∫Øt ƒë·∫ßu.'}, {word:'D', mean:'N√≥ kh√¥ng m·∫°nh nh∆∞ l√∫c b·∫Øt ƒë·∫ßu.'}],
                2,
                'D·∫´n ch·ª©ng: "turned into a Category 1 hurricane by the time it hit...". Tr∆∞·ªõc ƒë√≥ n√≥ l√† b√£o nhi·ªát ƒë·ªõi (y·∫øu h∆°n), khi ƒë·∫øn Florida n√≥ th√†nh C·∫•p 1 (m·∫°nh h∆°n l√∫c ƒë·∫ßu).',
                'A sai v√¨ b√£o c·∫•p 1 kh√¥ng th·ªÉ g·ªçi l√† "r·∫•t y·∫øu" (very weak). B sai v√¨ c·∫•p 1 ch∆∞a ph·∫£i "r·∫•t m·∫°nh" (so v·ªõi c·∫•p 4 sau n√†y). D sai v√¨ n√≥ m·∫°nh l√™n.'
            )
        },
        {
            id: 'ex4-q4',
            text: 'Question 4: What is NOT true about the National Hurricane Director?',
            options: ['He called the governors of Mississippi.', 'He called President Bush at his ranch in Texas.', 'He spoke directly with the New Orleans mayor.', 'He was very unconcerned.'],
            correct: 3,
            explanation: genExp(
                'ƒêi·ªÅu g√¨ KH√îNG ƒë√∫ng v·ªÅ Gi√°m ƒë·ªëc Trung t√¢m B√£o qu·ªëc gia?',
                [{word:'A', mean:'G·ªçi th·ªëng ƒë·ªëc Mississippi.'}, {word:'B', mean:'G·ªçi TT Bush.'}, {word:'C', mean:'N√≥i chuy·ªán v·ªõi th·ªã tr∆∞·ªüng.'}, {word:'D', mean:'√îng ·∫•y r·∫•t th·ªù ∆° (unconcerned).'}],
                3,
                'D·∫´n ch·ª©ng: "The National Hurricane Director was <b>very concerned</b>." (√îng ·∫•y r·∫•t lo l·∫Øng/quan t√¢m).',
                'ƒê√°p √°n D d√πng t·ª´ tr√°i nghƒ©a "unconcerned" => ƒê√¢y l√† c√¢u sai n·ªôi dung.'
            )
        },
        {
            id: 'ex4-q5',
            text: 'Question 5: According to the passage, how many people were evacuated?',
            options: ['About 80,000 people.', 'About 80% of the population.', 'Around 100,000 people.', 'Around 20% of the population'],
            correct: 1,
            explanation: genExp(
                'Theo b√†i ƒë·ªçc, bao nhi√™u ng∆∞·ªùi ƒë√£ s∆° t√°n?',
                [{word:'A', mean:'Kho·∫£ng 80,000 ng∆∞·ªùi'}, {word:'B', mean:'Kho·∫£ng 80% d√¢n s·ªë'}, {word:'C', mean:'Kho·∫£ng 100,000 ng∆∞·ªùi'}, {word:'D', mean:'Kho·∫£ng 20% d√¢n s·ªë'}],
                1,
                'D·∫´n ch·ª©ng: "About eighty percent of the population evacuated."',
                'C sai v√¨ 100,000 l√† s·ªë ng∆∞·ªùi "remained" (·ªü l·∫°i).'
            )
        }
    ];

    // --- RENDER FUNCTIONS ---

    function renderQuestions() {
        quizData.forEach((q, index) => {
            // Determine which container to put the question in
            let containerId = '';
            if (q.id.startsWith('ex1')) containerId = 'ex1-questions';
            else if (q.id.startsWith('ex2')) containerId = 'ex2-questions';
            else if (q.id.startsWith('ex3')) containerId = 'ex3-questions';
            else containerId = 'ex4-questions';

            const container = document.getElementById(containerId);
            
            // Create question HTML
            const qDiv = document.createElement('div');
            qDiv.className = 'question-block';
            qDiv.id = q.id;
            
            let optionsHtml = q.options.map((opt, i) => `
                <label class="option-label">
                    <input type="radio" name="${q.id}" value="${i}" onclick="resetState('${q.id}')">
                    <div class="option-content" id="${q.id}-opt-${i}">
                        <span style="margin-right:10px; color:var(--primary); font-size:1.2em;">${String.fromCharCode(65+i)}.</span> ${opt}
                    </div>
                </label>
            `).join('');

            qDiv.innerHTML = `
                <div class="question-text">${q.text}</div>
                <div class="options-grid">${optionsHtml}</div>
                <button class="check-btn" onclick="checkOne('${q.id}')">Ki·ªÉm tra ƒë√°p √°n üïµÔ∏è</button>
                <div class="explanation" id="${q.id}-exp">${q.explanation}</div>
            `;
            
            container.appendChild(qDiv);
        });
    }

    // --- LOGIC FUNCTIONS ---

    function resetState(qId) {
        // Remove error/shake states when user re-selects
        const qData = quizData.find(q => q.id === qId);
        qData.options.forEach((_, i) => {
            const el = document.getElementById(`${qId}-opt-${i}`);
            el.classList.remove('incorrect');
            // Don't remove 'correct' if already submitted, but here we allow re-trying until check?
            // Design choice: Once checked, stick? Let's allow simple visual reset.
        });
    }

    function checkOne(qId) {
        const qData = quizData.find(q => q.id === qId);
        const selected = document.querySelector(`input[name="${qId}"]:checked`);
        const expDiv = document.getElementById(`${qId}-exp`);
        
        if (!selected) {
            alert("Oops! Em ch∆∞a ch·ªçn ƒë√°p √°n n√†o c·∫£! ü§î");
            return;
        }

        const userAns = parseInt(selected.value);
        const correctAns = qData.correct;
        const correctEl = document.getElementById(`${qId}-opt-${correctAns}`);
        const userEl = document.getElementById(`${qId}-opt-${userAns}`);

        // Reveal Explanation
        expDiv.classList.add('visible');

        if (userAns === correctAns) {
            // Correct
            userEl.classList.add('correct');
            playSound('correct');
            triggerConfetti(userEl);
        } else {
            // Incorrect
            userEl.classList.add('incorrect');
            correctEl.classList.add('correct'); // Show correct answer
            playSound('wrong');
        }

        // Disable button to prevent spamming
        // document.querySelector(`#${qId} .check-btn`).disabled = true;
    }

    function submitAll() {
        let score = 0;
        let unanswered = 0;

        quizData.forEach(q => {
            const selected = document.querySelector(`input[name="${q.id}"]:checked`);
            const expDiv = document.getElementById(`${q.id}-exp`);
            
            if (selected) {
                const userAns = parseInt(selected.value);
                if (userAns === q.correct) {
                    score++;
                    document.getElementById(`${q.id}-opt-${userAns}`).classList.add('correct');
                } else {
                    document.getElementById(`${q.id}-opt-${userAns}`).classList.add('incorrect');
                    document.getElementById(`${q.id}-opt-${q.correct}`).classList.add('correct');
                }
                expDiv.classList.add('visible');
            } else {
                unanswered++;
                // Highlight missed question
                document.getElementById(q.id).classList.add('warning');
                document.getElementById(`${q.id}-opt-${q.correct}`).classList.add('missed');
                expDiv.classList.add('visible');
            }
        });

        // Calculate Score
        const total = quizData.length;
        const resultPopup = document.getElementById('resultPopup');
        const scoreValue = document.getElementById('scoreValue');
        const comment = document.getElementById('teacher-comment');

        scoreValue.innerText = `${score}/${total}`;
        
        if (score === total) {
            comment.innerText = "üåü XU·∫§T S·∫ÆC! Em l√† thi√™n t√†i ti·∫øng Anh! Ms Mai An r·∫•t t·ª± h√†o! üåü";
            triggerMassiveConfetti();
        } else if (score >= total * 0.8) {
            comment.innerText = "üëè R·∫•t t·ªët! Ch·ªâ m·ªôt ch√∫t n·ªØa l√† ho√†n h·∫£o r·ªìi!";
        } else if (score >= total * 0.5) {
            comment.innerText = "üí™ C·ªë g·∫Øng l√™n! H√£y xem k·ªπ l·∫°i ph·∫ßn gi·∫£i th√≠ch nh√©!";
        } else {
            comment.innerText = "üìö C·∫ßn √¥n t·∫≠p th√™m nha! ƒê·ª´ng n·∫£n ch√≠, xem l·∫°i l·ªùi gi·∫£i b√™n d∆∞·ªõi n√†o!";
        }

        resultPopup.style.display = 'flex';
        playSound(score > total/2 ? 'correct' : 'wrong');
    }

    function closePopup() {
        document.getElementById('resultPopup').style.display = 'none';
    }

    // --- EFFECTS ---

    function playSound(type) {
        const audio = document.getElementById(type === 'correct' ? 'sound-correct' : 'sound-wrong');
        if(audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio play failed interaction required"));
        }
    }

    function triggerConfetti(element) {
        const rect = element.getBoundingClientRect();
        // Normalized coordinates
        const x = (rect.left + rect.width / 2) / window.innerWidth;
        const y = (rect.top + rect.height / 2) / window.innerHeight;

        confetti({
            particleCount: 60,
            spread: 70,
            origin: { x: x, y: y },
            colors: ['#00C9A7', '#8854C0', '#FFD700']
        });
    }

    function triggerMassiveConfetti() {
        var duration = 3000;
        var end = Date.now() + duration;

        (function frame() {
            confetti({
                particleCount: 5,
                angle: 60,
                spread: 55,
                origin: { x: 0 },
                colors: ['#00C9A7', '#8854C0']
            });
            confetti({
                particleCount: 5,
                angle: 120,
                spread: 55,
                origin: { x: 1 },
                colors: ['#00C9A7', '#8854C0']
            });

            if (Date.now() < end) {
                requestAnimationFrame(frame);
            }
        }());
    }

    // Initialize
    window.onload = renderQuestions;

</script>

</body>
</html>