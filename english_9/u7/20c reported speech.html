<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reported Speech Challenge - Ms. Mai An ULIS</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Confetti JS -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Tailwind CSS (for layout utility) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --primary-color: #8854C0; /* T√≠m h·ªìng */
            --secondary-color: #00C9A7; /* Xanh ng·ªçc */
            --correct-color: #00D26A; /* Xanh l√° */
            --wrong-color: #FF4757; /* ƒê·ªè cam */
            --bg-pattern: #f0f4f8;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-pattern);
            background-image: radial-gradient(var(--primary-color) 0.5px, transparent 0.5px), radial-gradient(var(--secondary-color) 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: #2d3436;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* 3D Button Style */
        .btn-3d {
            transition: all 0.1s;
            border-bottom: 5px solid rgba(0,0,0,0.2);
            transform: translateY(0);
        }
        .btn-3d:active {
            transform: translateY(3px);
            border-bottom: 2px solid rgba(0,0,0,0.2);
        }

        .card-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: 0 12px 24px rgba(136, 84, 192, 0.15);
            border: 4px solid white;
            transition: all 0.3s ease;
        }

        /* Option Buttons */
        .option-btn {
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: 16px;
            padding: 15px 20px;
            margin-bottom: 12px;
            cursor: pointer;
            text-align: left;
            font-weight: 600;
            font-size: 1.05rem;
            color: #555;
            box-shadow: 0 4px 0 #e0e0e0;
            transition: all 0.2s;
            width: 100%;
            position: relative;
        }
        
        .option-btn:hover:not(.disabled) {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: scale(1.02);
        }

        .option-btn:active:not(.disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 #e0e0e0;
        }

        .option-btn.correct {
            background-color: var(--correct-color);
            color: white;
            border-color: #00b85c;
            box-shadow: 0 4px 0 #00b85c;
        }

        .option-btn.wrong {
            background-color: var(--wrong-color);
            color: white;
            border-color: #e0404f;
            box-shadow: 0 4px 0 #e0404f;
            animation: shake 0.5s;
        }

        .disabled {
            pointer-events: none;
        }

        /* Animations */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            50% { transform: translateX(5px) rotate(2deg); }
            75% { transform: translateX(-5px) rotate(-2deg); }
            100% { transform: translateX(0); }
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Explanation Box */
        .explanation-box {
            background-color: #f8f9fa;
            border-left: 5px solid var(--primary-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .highlight-text {
            color: var(--primary-color);
            font-weight: 800;
        }

        .teacher-badge {
            background: linear-gradient(45deg, #8854C0, #00C9A7);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            display: inline-block;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            height: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        /* Custom Scrollbar for lengthy explanations */
        .explanation-content::-webkit-scrollbar {
            width: 8px;
        }
        .explanation-content::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .explanation-content::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        .explanation-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        strong {
            color: #2d3436;
            font-weight: 700;
        }
        
        .rationale-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #e0e0e0;
        }
        .rationale-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <!-- Header -->
    <div class="text-center mb-6 pop-in">
        <div class="teacher-badge mb-2"><i class="fas fa-chalkboard-teacher mr-2"></i>Ms. Mai An ULIS</div>
        <h1 class="text-3xl md:text-4xl font-extrabold text-[#8854C0] drop-shadow-sm">
            REPORTED SPEECH
            <span class="block text-xl text-[#00C9A7] mt-1 font-bold">Vi·∫øt l·∫°i c√¢u & Tr·∫Øc nghi·ªám</span>
        </h1>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="card-container w-full max-w-2xl p-8 text-center pop-in">
        <img src="https://cdn-icons-png.flaticon.com/512/2641/2641457.png" alt="Quiz Icon" class="w-32 h-32 mx-auto mb-6 animate-bounce">
        <h2 class="text-2xl font-bold mb-4 text-gray-700">S·∫µn s√†ng chinh ph·ª•c B√†i t·∫≠p C√¢u t∆∞·ªùng thu·∫≠t ch∆∞a?</h2>
        <p class="text-gray-500 mb-8 text-lg">20 c√¢u h·ªèi th·ª≠ th√°ch ki·∫øn th·ª©c c·ªßa b·∫°n. C·ªë g·∫Øng ƒë·∫°t ƒëi·ªÉm t·ªëi ƒëa nh√©!</p>
        <button onclick="startQuiz()" class="btn-3d bg-[#00C9A7] hover:bg-[#00a88d] text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg transform transition">
            <i class="fas fa-play mr-2"></i> B·∫ÆT ƒê·∫¶U NGAY
        </button>
    </div>

    <!-- Quiz Container -->
    <div id="quiz-container" class="w-full max-w-3xl hidden">
        <!-- Progress -->
        <div class="flex justify-between text-sm font-bold text-gray-500 mb-1">
            <span id="question-count">Question 1/20</span>
            <span id="score-display" class="text-[#8854C0]">Score: 0</span>
        </div>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>

        <!-- Question Card -->
        <div class="card-container p-6 md:p-8 relative">
            <div id="question-text" class="text-xl md:text-2xl font-bold text-gray-800 mb-6 leading-relaxed">
                <!-- Question content goes here -->
            </div>

            <!-- Options -->
            <div id="options-container" class="grid grid-cols-1 gap-3">
                <!-- Buttons go here -->
            </div>

            <!-- Explanation Panel -->
            <div id="explanation-panel" class="explanation-box">
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 rounded-full bg-[#8854C0] flex items-center justify-center text-white mr-3">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <h3 class="text-lg font-bold text-[#8854C0]">Gi·∫£i th√≠ch chi ti·∫øt c·ªßa C√¥ Mai An:</h3>
                </div>
                <div id="explanation-content" class="explanation-content text-gray-700 leading-relaxed text-base">
                    <!-- Dynamic Explanation -->
                </div>
                <div class="mt-6 text-right">
                    <button onclick="nextQuestion()" class="btn-3d bg-[#8854C0] hover:bg-[#7043a0] text-white font-bold py-2 px-6 rounded-xl shadow-md transition">
                        C√¢u ti·∫øp theo <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="card-container w-full max-w-2xl p-8 text-center hidden pop-in">
        <div id="result-icon" class="text-6xl mb-4">üèÜ</div>
        <h2 class="text-3xl font-bold mb-2 text-[#8854C0]">K·∫æT QU·∫¢</h2>
        <div class="text-gray-500 mb-6 text-lg">B·∫°n ƒë√£ ho√†n th√†nh b√†i ki·ªÉm tra!</div>
        
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                <div class="text-3xl font-bold text-green-600" id="final-score">0</div>
                <div class="text-sm font-semibold text-green-800 uppercase">ƒêi·ªÉm s·ªë</div>
            </div>
            <div class="bg-purple-50 rounded-xl p-4 border-2 border-purple-200">
                <div class="text-3xl font-bold text-purple-600" id="final-percent">0%</div>
                <div class="text-sm font-semibold text-purple-800 uppercase">Ch√≠nh x√°c</div>
            </div>
        </div>

        <p id="teacher-feedback" class="text-xl font-bold text-gray-700 mb-8 italic">
            "Tuy·ªát v·ªùi! Em ƒë√£ l√†m r·∫•t t·ªët!"
        </p>

        <button onclick="restartQuiz()" class="btn-3d bg-[#00C9A7] hover:bg-[#00a88d] text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg mr-4">
            <i class="fas fa-redo mr-2"></i> L√†m l·∫°i
        </button>
    </div>

    <script>
        // --- DATA SOURCE ---
        const rawData = {
            "questions": [
                {
                    "questionNumber": 1,
                    "question": "Exercise 18 - Q1: \"Have you ever visited the Grand Canyon?\" the tour guide asked me. (if)\n‚Üí The tour guide asked me ________________________________________",
                    "answerOptions": [
                        { "text": "A. if I had ever visited the Grand Canyon.", "rationale": "**D·ªãch:** H∆∞·ªõng d·∫´n vi√™n h·ªèi t√¥i li·ªáu t√¥i ƒë√£ t·ª´ng ƒë·∫øn thƒÉm Grand Canyon ch∆∞a.\n**Gi·∫£i th√≠ch:**\n1. D√πng t·ª´ n·ªëi 'if'.\n2. ƒê·ªïi ng√¥i: You (b·∫°n) -> I (t√¥i).\n3. L√πi th√¨: Hi·ªán t·∫°i ho√†n th√†nh (Have visited) -> Qu√° kh·ª© ho√†n th√†nh (had visited).\n4. Tr·∫≠t t·ª± t·ª´: Ch·ªß ng·ªØ + ƒê·ªông t·ª´ (kh√¥ng ƒë·∫£o ng·ªØ).", "isCorrect": true },
                        { "text": "B. if had I ever visited the Grand Canyon.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (ƒë·∫£o ng·ªØ 'had I' gi·ªëng c√¢u h·ªèi tr·ª±c ti·∫øp).", "isCorrect": false },
                        { "text": "C. if I have ever visited the Grand Canyon.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ (v·∫´n d√πng 'have').", "isCorrect": false },
                        { "text": "D. that I had ever visited the Grand Canyon.", "rationale": "**Sai:** C√¢u h·ªèi Yes/No kh√¥ng d√πng t·ª´ n·ªëi 'that'.", "isCorrect": false }
                    ],
                    "hint": "C·∫•u tr√∫c: S + asked + O + if + S + V(l√πi th√¨)."
                },
                {
                    "questionNumber": 2,
                    "question": "Exercise 18 - Q2: \"Is Mount Everest getting taller every year?\" the student asked the teacher. (whether)\n‚Üí The student asked the teacher ____________________________________",
                    "answerOptions": [
                        { "text": "A. whether Mount Everest is getting taller every year.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ (v·∫´n d√πng 'is').", "isCorrect": false },
                        { "text": "B. whether Mount Everest was getting taller every year.", "rationale": "**D·ªãch:** H·ªçc sinh h·ªèi gi√°o vi√™n li·ªáu ƒë·ªânh Everest c√≥ ƒëang cao l√™n m·ªói nƒÉm kh√¥ng.\n**Gi·∫£i th√≠ch:**\n1. D√πng t·ª´ n·ªëi 'whether' (theo y√™u c·∫ßu ƒë·ªÅ b√†i).\n2. L√πi th√¨: Hi·ªán t·∫°i ti·∫øp di·ªÖn (Is getting) -> Qu√° kh·ª© ti·∫øp di·ªÖn (was getting).", "isCorrect": true },
                        { "text": "C. whether was Mount Everest getting taller every year.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (ƒë·∫£o ng·ªØ 'was Mount Everest').", "isCorrect": false },
                        { "text": "D. if Mount Everest was getting taller every year.", "rationale": "**Sai y√™u c·∫ßu:** ƒê·ªÅ b√†i b·∫Øt bu·ªôc d√πng t·ª´ 'whether' trong ngo·∫∑c, d√π 'if' ƒë√∫ng ng·ªØ ph√°p nh∆∞ng kh√¥ng ƒë√∫ng y√™u c·∫ßu b√†i t·∫≠p n√†y.", "isCorrect": false }
                    ],
                    "hint": "D√πng 'whether' v√† l√πi th√¨ 'is' th√†nh 'was'."
                },
                {
                    "questionNumber": 3,
                    "question": "Exercise 18 - Q3: \"Did the ancient people know about Victoria Falls?\" she wondered. (if)\n‚Üí She wondered _________________________________________________",
                    "answerOptions": [
                        { "text": "A. if the ancient people know about Victoria Falls.", "rationale": "**Sai:** Sai th√¨ (v·∫´n d√πng hi·ªán t·∫°i 'know').", "isCorrect": false },
                        { "text": "B. if did the ancient people know about Victoria Falls.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (gi·ªØ tr·ª£ ƒë·ªông t·ª´ 'did' v√† ƒë·∫£o ng·ªØ).", "isCorrect": false },
                        { "text": "C. if the ancient people had known about Victoria Falls.", "rationale": "**D·ªãch:** C√¥ ·∫•y t·ª± h·ªèi li·ªáu ng∆∞·ªùi x∆∞a c√≥ bi·∫øt v·ªÅ th√°c Victoria kh√¥ng.\n**Gi·∫£i th√≠ch:**\n1. D√πng t·ª´ n·ªëi 'if'.\n2. L√πi th√¨: Qu√° kh·ª© ƒë∆°n (Did know) -> Qu√° kh·ª© ho√†n th√†nh (had known).", "isCorrect": true },
                        { "text": "D. if the ancient people knew about Victoria Falls.", "rationale": "**L∆∞u √Ω:** Qu√° kh·ª© ƒë∆°n l√πi v·ªÅ Qu√° kh·ª© ƒë∆°n c≈©ng ch·∫•p nh·∫≠n ƒë∆∞·ª£c trong m·ªôt s·ªë tr∆∞·ªùng h·ª£p, nh∆∞ng chu·∫©n nh·∫•t l√† l√πi v·ªÅ Qu√° kh·ª© ho√†n th√†nh (had known) ƒë·ªÉ th·ªÉ hi·ªán r√µ h√†nh ƒë·ªông x·∫£y ra tr∆∞·ªõc.", "isCorrect": false }
                    ],
                    "hint": "Qu√° kh·ª© ƒë∆°n (Did know) l√πi th√†nh Qu√° kh·ª© ho√†n th√†nh (Had known)."
                },
                {
                    "questionNumber": 4,
                    "question": "Exercise 18 - Q4: \"Can tourists still swim in the Dead Sea?\" my friend asked. (whether)\n‚Üí My friend asked _______________________________________________",
                    "answerOptions": [
                        { "text": "A. whether tourists could still swim in the Dead Sea.", "rationale": "**D·ªãch:** B·∫°n t√¥i h·ªèi li·ªáu du kh√°ch c√≥ c√≤n b∆°i ƒë∆∞·ª£c ·ªü Bi·ªÉn Ch·∫øt kh√¥ng.\n**Gi·∫£i th√≠ch:**\n1. D√πng 'whether'.\n2. L√πi th√¨: Can -> Could.", "isCorrect": true },
                        { "text": "B. whether can tourists still swim in the Dead Sea.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (ƒë·∫£o ng·ªØ).", "isCorrect": false },
                        { "text": "C. whether tourists can still swim in the Dead Sea.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'can'.", "isCorrect": false },
                        { "text": "D. if tourists could still swim in the Dead Sea.", "rationale": "**Sai y√™u c·∫ßu:** ƒê·ªÅ b√†i y√™u c·∫ßu d√πng 'whether'.", "isCorrect": false }
                    ],
                    "hint": "Can -> Could."
                },
                {
                    "questionNumber": 5,
                    "question": "Exercise 18 - Q5: \"Will the Great Barrier Reef survive climate change?\" the scientist questioned. (if)\n‚Üí The scientist questioned _________________________________________",
                    "answerOptions": [
                        { "text": "A. if the Great Barrier Reef will survive climate change.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'will'.", "isCorrect": false },
                        { "text": "B. if the Great Barrier Reef would survive climate change.", "rationale": "**D·ªãch:** Nh√† khoa h·ªçc ƒë·∫∑t c√¢u h·ªèi li·ªáu r·∫°n san h√¥ Great Barrier c√≥ s·ªëng s√≥t qua bi·∫øn ƒë·ªïi kh√≠ h·∫≠u kh√¥ng.\n**Gi·∫£i th√≠ch:**\n1. D√πng 'if'.\n2. L√πi th√¨: Will -> Would.", "isCorrect": true },
                        { "text": "C. if would the Great Barrier Reef survive climate change.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (ƒë·∫£o ng·ªØ).", "isCorrect": false },
                        { "text": "D. whether the Great Barrier Reef would survive climate change.", "rationale": "**Sai y√™u c·∫ßu:** ƒê·ªÅ b√†i y√™u c·∫ßu d√πng 'if'.", "isCorrect": false }
                    ],
                    "hint": "Will -> Would."
                },
                {
                    "questionNumber": 6,
                    "question": "Exercise 18 - Q6: \"Do the Northern Lights appear every night?\" the tourist wanted to know. (whether)\n‚Üí The tourist wanted to know ______________________________________",
                    "answerOptions": [
                        { "text": "A. whether the Northern Lights appeared every night.", "rationale": "**D·ªãch:** Du kh√°ch mu·ªën bi·∫øt li·ªáu B·∫Øc C·ª±c Quang c√≥ xu·∫•t hi·ªán m·ªói ƒë√™m kh√¥ng.\n**Gi·∫£i th√≠ch:**\n1. D√πng 'whether'.\n2. L√πi th√¨: Hi·ªán t·∫°i ƒë∆°n (appear) -> Qu√° kh·ª© ƒë∆°n (appeared).", "isCorrect": true },
                        { "text": "B. whether do the Northern Lights appear every night.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (gi·ªØ tr·ª£ ƒë·ªông t·ª´ 'do').", "isCorrect": false },
                        { "text": "C. whether the Northern Lights appear every night.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ (appear).", "isCorrect": false },
                        { "text": "D. if the Northern Lights appeared every night.", "rationale": "**Sai y√™u c·∫ßu:** ƒê·ªÅ b√†i y√™u c·∫ßu d√πng 'whether'.", "isCorrect": false }
                    ],
                    "hint": "Hi·ªán t·∫°i ƒë∆°n (appear) -> Qu√° kh·ª© ƒë∆°n (appeared)."
                },
                {
                    "questionNumber": 7,
                    "question": "Exercise 18 - Q7: \"Has anyone explored the entire Amazon Rainforest?\" the journalist asked. (if)\n‚Üí The journalist asked ____________________________________________",
                    "answerOptions": [
                        { "text": "A. if anyone has explored the entire Amazon Rainforest.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'has'.", "isCorrect": false },
                        { "text": "B. if anyone had explored the entire Amazon Rainforest.", "rationale": "**D·ªãch:** Nh√† b√°o h·ªèi li·ªáu c√≥ ai ƒë√£ kh√°m ph√° to√†n b·ªô r·ª´ng nhi·ªát ƒë·ªõi Amazon ch∆∞a.\n**Gi·∫£i th√≠ch:**\n1. D√πng 'if'.\n2. L√πi th√¨: Hi·ªán t·∫°i ho√†n th√†nh (Has explored) -> Qu√° kh·ª© ho√†n th√†nh (had explored).", "isCorrect": true },
                        { "text": "C. if had anyone explored the entire Amazon Rainforest.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´.", "isCorrect": false },
                        { "text": "D. whether anyone had explored the entire Amazon Rainforest.", "rationale": "**Sai y√™u c·∫ßu:** ƒê·ªÅ b√†i y√™u c·∫ßu d√πng 'if'.", "isCorrect": false }
                    ],
                    "hint": "Has explored -> Had explored."
                },
                {
                    "questionNumber": 8,
                    "question": "Exercise 18 - Q8: \"Are there dangerous animals in Ha Long Bay?\" the children asked their parents. (whether)\n‚Üí The children asked their parents __________________________________",
                    "answerOptions": [
                        { "text": "A. whether there are dangerous animals in Ha Long Bay.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'are'.", "isCorrect": false },
                        { "text": "B. whether were there dangerous animals in Ha Long Bay.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´.", "isCorrect": false },
                        { "text": "C. whether there were dangerous animals in Ha Long Bay.", "rationale": "**D·ªãch:** L≈© tr·∫ª h·ªèi b·ªë m·∫π li·ªáu c√≥ ƒë·ªông v·∫≠t nguy hi·ªÉm ·ªü V·ªãnh H·∫° Long kh√¥ng.\n**Gi·∫£i th√≠ch:**\n1. D√πng 'whether'.\n2. L√πi th√¨: Are -> Were.", "isCorrect": true },
                        { "text": "D. if there were dangerous animals in Ha Long Bay.", "rationale": "**Sai y√™u c·∫ßu:** ƒê·ªÅ b√†i y√™u c·∫ßu d√πng 'whether'.", "isCorrect": false }
                    ],
                    "hint": "Are there -> There were."
                },
                {
                    "questionNumber": 9,
                    "question": "Exercise 18 - Q9: \"Did Niagara Falls freeze completely last winter?\" he inquired. (if)\n‚Üí He inquired ___________________________________________________",
                    "answerOptions": [
                        { "text": "A. if Niagara Falls froze completely the previous winter.", "rationale": "**Ch·∫•p nh·∫≠n ƒë∆∞·ª£c:** Nh∆∞ng chu·∫©n ng·ªØ ph√°p c√¢u t∆∞·ªùng thu·∫≠t ∆∞u ti√™n Qu√° kh·ª© ho√†n th√†nh (had frozen).", "isCorrect": false },
                        { "text": "B. if Niagara Falls had frozen completely the previous winter.", "rationale": "**D·ªãch:** Anh ·∫•y h·ªèi thƒÉm li·ªáu th√°c Niagara c√≥ ƒë√≥ng bƒÉng ho√†n to√†n v√†o m√πa ƒë√¥ng tr∆∞·ªõc ƒë√≥ kh√¥ng.\n**Gi·∫£i th√≠ch:**\n1. D√πng 'if'.\n2. L√πi th√¨: Qu√° kh·ª© ƒë∆°n (Did freeze) -> Qu√° kh·ª© ho√†n th√†nh (had frozen).\n3. ƒê·ªïi t·ª´ ch·ªâ th·ªùi gian: last winter -> the previous winter / the winter before.", "isCorrect": true },
                        { "text": "C. if Niagara Falls had frozen completely last winter.", "rationale": "**Sai:** Ch∆∞a ƒë·ªïi t·ª´ ch·ªâ th·ªùi gian 'last winter'.", "isCorrect": false },
                        { "text": "D. if did Niagara Falls freeze completely the previous winter.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´.", "isCorrect": false }
                    ],
                    "hint": "L√πi th√¨ v√† ƒë·ªïi 'last winter' th√†nh 'the previous winter'."
                },
                {
                    "questionNumber": 10,
                    "question": "Exercise 18 - Q10: \"Is the Sahara Desert expanding every year?\" the researcher wanted to find out. (whether)\n‚Üí The researcher wanted to find out _________________________________",
                    "answerOptions": [
                        { "text": "A. whether the Sahara Desert was expanding every year.", "rationale": "**D·ªãch:** Nh√† nghi√™n c·ª©u mu·ªën t√¨m hi·ªÉu xem li·ªáu sa m·∫°c Sahara c√≥ ƒëang m·ªü r·ªông m·ªói nƒÉm kh√¥ng.\n**Gi·∫£i th√≠ch:**\n1. D√πng 'whether'.\n2. L√πi th√¨: Is expanding -> Was expanding.", "isCorrect": true },
                        { "text": "B. whether is the Sahara Desert expanding every year.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´.", "isCorrect": false },
                        { "text": "C. whether the Sahara Desert is expanding every year.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨.", "isCorrect": false },
                        { "text": "D. if the Sahara Desert was expanding every year.", "rationale": "**Sai y√™u c·∫ßu:** ƒê·ªÅ b√†i y√™u c·∫ßu d√πng 'whether'.", "isCorrect": false }
                    ],
                    "hint": "Is expanding -> Was expanding."
                },
                {
                    "questionNumber": 11,
                    "question": "Exercise 19 - Q1: \"Is the Amazon Rainforest the largest rainforest in the world?\" the student asked.",
                    "answerOptions": [
                        { "text": "A. The student asked if the Amazon Rainforest is the largest rainforest in the world.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'is'.", "isCorrect": false },
                        { "text": "B. The student asked whether the Amazon Rainforest was the largest rainforest in the world.", "rationale": "**D·ªãch:** H·ªçc sinh h·ªèi li·ªáu r·ª´ng m∆∞a Amazon c√≥ ph·∫£i l√† r·ª´ng m∆∞a l·ªõn nh·∫•t th·∫ø gi·ªõi kh√¥ng.\n**Gi·∫£i th√≠ch:** L√πi th√¨ 'is' -> 'was' v√† d√πng 'whether' l√† ch√≠nh x√°c.", "isCorrect": true },
                        { "text": "C. The student asked that the Amazon Rainforest was the largest rainforest in the world.", "rationale": "**Sai:** D√πng sai t·ª´ n·ªëi 'that' (c√¢u h·ªèi kh√¥ng d√πng 'that').", "isCorrect": false },
                        { "text": "D. The student asked if was the Amazon Rainforest the largest rainforest in the world.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (ƒë·∫£o ng·ªØ).", "isCorrect": false }
                    ],
                    "hint": "L√πi th√¨ 'is' -> 'was', d√πng 'if' ho·∫∑c 'whether'."
                },
                {
                    "questionNumber": 12,
                    "question": "Exercise 19 - Q2: \"Have you taken any photos of Mount Fuji?\" she asked her friend.",
                    "answerOptions": [
                        { "text": "A. She asked her friend whether she had taken any photos of Mount Fuji.", "rationale": "**ƒê√∫ng:** D√πng 'whether' v√† l√πi th√¨ Hi·ªán t·∫°i ho√†n th√†nh -> Qu√° kh·ª© ho√†n th√†nh (had taken). Ng√¥i 'she' (c√¥ ·∫•y) ·ªü ƒë√¢y thay th·∫ø cho 'her friend' (gi·∫£ ƒë·ªãnh b·∫°n l√† n·ªØ), c·∫•u tr√∫c ng·ªØ ph√°p ho√†n to√†n ch√≠nh x√°c.", "isCorrect": true },
                        { "text": "B. She asked her friend if he had taken any photos of Mount Fuji.", "rationale": "**C≈©ng ƒë√∫ng:** Ng·ªØ ph√°p ƒë√∫ng ('if', l√πi th√¨ 'had taken'). Ng√¥i 'he' (anh ·∫•y) thay th·∫ø cho 'her friend' (gi·∫£ ƒë·ªãnh b·∫°n l√† nam). Tuy nhi√™n, trong c√°c b√†i ki·ªÉm tra tr·∫Øc nghi·ªám, ƒë√°p √°n d√πng 'whether' (Option A) th∆∞·ªùng ƒë∆∞·ª£c ∆∞u ti√™n h∆°n v√¨ t√≠nh trang tr·ªçng.", "isCorrect": false },
                        { "text": "C. She asked her friend have you taken any photos of Mount Fuji.", "rationale": "**Sai:** ƒê√¢y l√† c√¢u tr·ª±c ti·∫øp, kh√¥ng ph·∫£i gi√°n ti·∫øp.", "isCorrect": false },
                        { "text": "D. She asked her friend if did he take any photos of Mount Fuji.", "rationale": "**Sai:** D√πng tr·ª£ ƒë·ªông t·ª´ 'did' trong c√¢u t∆∞·ªùng thu·∫≠t l√† sai.", "isCorrect": false }
                    ],
                    "hint": "L√πi th√¨ 'Have taken' -> 'Had taken'."
                },
                {
                    "questionNumber": 13,
                    "question": "Exercise 19 - Q3: \"Will the glaciers in Antarctica melt completely?\" the scientist wondered.",
                    "answerOptions": [
                        { "text": "A. The scientist wondered whether the glaciers in Antarctica would melt completely.", "rationale": "**D·ªãch:** Nh√† khoa h·ªçc t·ª± h·ªèi li·ªáu c√°c d√≤ng s√¥ng bƒÉng ·ªü Nam C·ª±c c√≥ tan ch·∫£y ho√†n to√†n kh√¥ng.\n**Gi·∫£i th√≠ch:** L√πi th√¨ 'will' -> 'would' v√† d√πng 'whether'.", "isCorrect": true },
                        { "text": "B. The scientist wondered if will the glaciers in Antarctica melt completely.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ v√† ch∆∞a l√πi th√¨.", "isCorrect": false },
                        { "text": "C. The scientist wondered that the glaciers in Antarctica would melt completely.", "rationale": "**Sai:** Sai t·ª´ n·ªëi 'that'.", "isCorrect": false },
                        { "text": "D. The scientist wondered whether the glaciers in Antarctica will melt completely.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'will'.", "isCorrect": false }
                    ],
                    "hint": "Will -> Would."
                },
                {
                    "questionNumber": 14,
                    "question": "Exercise 19 - Q4: \"Did ancient civilizations visit Machu Picchu?\" the archaeologist questioned.",
                    "answerOptions": [
                        { "text": "A. The archaeologist questioned if ancient civilizations visited Machu Picchu.", "rationale": "**Sai:** 'Visited' (Qu√° kh·ª© ƒë∆°n) n√™n l√πi v·ªÅ Qu√° kh·ª© ho√†n th√†nh (had visited) ƒë·ªÉ ch√≠nh x√°c h∆°n trong c√¢u t∆∞·ªùng thu·∫≠t.", "isCorrect": false },
                        { "text": "B. The archaeologist questioned whether ancient civilizations have visited Machu Picchu.", "rationale": "**Sai:** D√πng th√¨ Hi·ªán t·∫°i ho√†n th√†nh (have visited) l√† sai.", "isCorrect": false },
                        { "text": "C. The archaeologist questioned if ancient civilizations had visited Machu Picchu.", "rationale": "**D·ªãch:** Nh√† kh·∫£o c·ªï h·ªçc ƒë·∫∑t c√¢u h·ªèi li·ªáu c√°c n·ªÅn vƒÉn minh c·ªï ƒë·∫°i ƒë√£ t·ª´ng ƒë·∫øn Machu Picchu ch∆∞a.\n**Gi·∫£i th√≠ch:** L√πi th√¨ Qu√° kh·ª© ƒë∆°n (did visit) -> Qu√° kh·ª© ho√†n th√†nh (had visited).", "isCorrect": true },
                        { "text": "D. The archaeologist questioned did ancient civilizations visit Machu Picchu.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (ƒë·∫£o ng·ªØ).", "isCorrect": false }
                    ],
                    "hint": "Did visit -> Had visited."
                },
                {
                    "questionNumber": 15,
                    "question": "Exercise 19 - Q5: \"Can we see the Aurora Borealis from here?\" the tourists asked the guide.",
                    "answerOptions": [
                        { "text": "A. The tourists asked the guide if they could see the Aurora Borealis from there.", "rationale": "**D·ªãch:** C√°c du kh√°ch h·ªèi h∆∞·ªõng d·∫´n vi√™n li·ªáu h·ªç c√≥ th·ªÉ nh√¨n th·∫•y B·∫Øc C·ª±c Quang t·ª´ ƒë√≥ kh√¥ng.\n**Gi·∫£i th√≠ch:**\n1. Can -> Could.\n2. We -> They (ƒë·ªïi ng√¥i).\n3. Here -> There (ƒë·ªïi t·ª´ ch·ªâ ƒë·ªãa ƒëi·ªÉm).", "isCorrect": true },
                        { "text": "B. The tourists asked the guide whether we could see the Aurora Borealis from here.", "rationale": "**Sai:** Ch∆∞a ƒë·ªïi ng√¥i 'we' v√† ƒë·ªãa ƒëi·ªÉm 'here'.", "isCorrect": false },
                        { "text": "C. The tourists asked the guide can they see the Aurora Borealis from there.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'can' v√† sai tr·∫≠t t·ª± t·ª´.", "isCorrect": false },
                        { "text": "D. The tourists asked the guide if they can see the Aurora Borealis from there.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'can'.", "isCorrect": false }
                    ],
                    "hint": "Can -> Could, Here -> There."
                },
                {
                    "questionNumber": 16,
                    "question": "Exercise 19 - Q6: \"Is Ha Long Bay more beautiful than Phang Nga Bay?\" my colleague asked me.",
                    "answerOptions": [
                        { "text": "A. My colleague asked me whether Ha Long Bay is more beautiful than Phang Nga Bay.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'is'.", "isCorrect": false },
                        { "text": "B. My colleague asked me if was Ha Long Bay more beautiful than Phang Nga Bay.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (ƒë·∫£o ng·ªØ).", "isCorrect": false },
                        { "text": "C. My colleague asked me whether Ha Long Bay was more beautiful than Phang Nga Bay.", "rationale": "**D·ªãch:** ƒê·ªìng nghi·ªáp h·ªèi t√¥i li·ªáu V·ªãnh H·∫° Long c√≥ ƒë·∫πp h∆°n V·ªãnh Phang Nga kh√¥ng.\n**Gi·∫£i th√≠ch:** L√πi th√¨ 'is' -> 'was' v√† d√πng 'whether' + tr·∫≠t t·ª± c√¢u tr·∫ßn thu·∫≠t.", "isCorrect": true },
                        { "text": "D. My colleague asked me that Ha Long Bay was more beautiful than Phang Nga Bay.", "rationale": "**Sai:** Sai t·ª´ n·ªëi 'that'.", "isCorrect": false }
                    ],
                    "hint": "Is -> Was."
                },
                {
                    "questionNumber": 17,
                    "question": "Exercise 19 - Q7: \"Have the coral reefs recovered from the bleaching?\" the marine biologist inquired.",
                    "answerOptions": [
                        { "text": "A. The marine biologist inquired if have the coral reefs recovered from the bleaching.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (ƒë·∫£o ng·ªØ).", "isCorrect": false },
                        { "text": "B. The marine biologist inquired whether the coral reefs had recovered from the bleaching.", "rationale": "**D·ªãch:** Nh√† sinh v·∫≠t bi·ªÉn h·ªèi thƒÉm li·ªáu c√°c r·∫°n san h√¥ ƒë√£ ph·ª•c h·ªìi sau ƒë·ª£t t·∫©y tr·∫Øng ch∆∞a.\n**Gi·∫£i th√≠ch:** L√πi th√¨ Hi·ªán t·∫°i ho√†n th√†nh (Have recovered) -> Qu√° kh·ª© ho√†n th√†nh (had recovered).", "isCorrect": true },
                        { "text": "C. The marine biologist inquired if the coral reefs have recovered from the bleaching.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'have'.", "isCorrect": false },
                        { "text": "D. The marine biologist inquired that the coral reefs had recovered from the bleaching.", "rationale": "**Sai:** Sai t·ª´ n·ªëi 'that'.", "isCorrect": false }
                    ],
                    "hint": "Have recovered -> Had recovered."
                },
                {
                    "questionNumber": 18,
                    "question": "Exercise 19 - Q8: \"Do penguins live only in Antarctica?\" the child asked his teacher.",
                    "answerOptions": [
                        { "text": "A. The child asked his teacher whether penguins lived only in Antarctica.", "rationale": "**D·ªãch:** ƒê·ª©a tr·∫ª h·ªèi gi√°o vi√™n li·ªáu chim c√°nh c·ª•t c√≥ ch·ªâ s·ªëng ·ªü Nam C·ª±c kh√¥ng.\n**Gi·∫£i th√≠ch:** L√πi th√¨ Hi·ªán t·∫°i ƒë∆°n (live) -> Qu√° kh·ª© ƒë∆°n (lived). (L∆∞u √Ω: M·∫∑c d√π ƒë√¢y l√† s·ª± th·∫≠t hi·ªÉn nhi√™n, nh∆∞ng trong b√†i t·∫≠p ng·ªØ ph√°p chuy·ªÉn ƒë·ªïi c√¢u, vi·ªác l√πi th√¨ l√† quy t·∫Øc chu·∫©n).", "isCorrect": true },
                        { "text": "B. The child asked his teacher if do penguins live only in Antarctica.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (gi·ªØ tr·ª£ ƒë·ªông t·ª´ 'do').", "isCorrect": false },
                        { "text": "C. The child asked his teacher whether penguins live only in Antarctica.", "rationale": "**Ch∆∞a ch√≠nh x√°c:** Ch∆∞a l√πi th√¨. Trong tr·∫Øc nghi·ªám, ƒë√°p √°n ƒë√£ l√πi th√¨ (A) ƒë∆∞·ª£c ∆∞u ti√™n h∆°n.", "isCorrect": false },
                        { "text": "D. The child asked his teacher that penguins lived only in Antarctica.", "rationale": "**Sai:** Sai t·ª´ n·ªëi 'that'.", "isCorrect": false }
                    ],
                    "hint": "Live -> Lived."
                },
                {
                    "questionNumber": 19,
                    "question": "Exercise 19 - Q9: \"Was the Great Wall of China visible from space?\" she wanted to know.",
                    "answerOptions": [
                        { "text": "A. She wanted to know if the Great Wall of China is visible from space.", "rationale": "**Sai:** Sai th√¨ (d√πng hi·ªán t·∫°i 'is').", "isCorrect": false },
                        { "text": "B. She wanted to know whether was the Great Wall of China visible from space.", "rationale": "**Sai:** Sai tr·∫≠t t·ª± t·ª´ (ƒë·∫£o ng·ªØ).", "isCorrect": false },
                        { "text": "C. She wanted to know if the Great Wall of China was visible from space.", "rationale": "**D·ªãch:** C√¥ ·∫•y mu·ªën bi·∫øt li·ªáu V·∫°n L√Ω Tr∆∞·ªùng Th√†nh c√≥ nh√¨n th·∫•y ƒë∆∞·ª£c t·ª´ v≈© tr·ª• kh√¥ng.\n**Gi·∫£i th√≠ch:** Gi·ªØ nguy√™n th√¨ Qu√° kh·ª© (was) ho·∫∑c l√πi v·ªÅ Qu√° kh·ª© ho√†n th√†nh (had been) ƒë·ªÅu ƒë∆∞·ª£c. Trong c√°c ƒë√°p √°n n√†y, C l√† ƒë√°p √°n ƒë√∫ng ng·ªØ ph√°p nh·∫•t v·ªÅ tr·∫≠t t·ª± t·ª´.", "isCorrect": true },
                        { "text": "D. She wanted to know that the Great Wall of China was visible from space.", "rationale": "**Sai:** Sai t·ª´ n·ªëi 'that'.", "isCorrect": false }
                    ],
                    "hint": "Is -> Was (ho·∫∑c gi·ªØ nguy√™n Was)."
                },
                {
                    "questionNumber": 20,
                    "question": "Exercise 19 - Q10: \"Will you visit Niagara Falls next summer?\" John asked Mary.",
                    "answerOptions": [
                        { "text": "A. John asked Mary if she would visit Niagara Falls next summer.", "rationale": "**Sai:** Ch∆∞a ƒë·ªïi t·ª´ ch·ªâ th·ªùi gian 'next summer'.", "isCorrect": false },
                        { "text": "B. John asked Mary whether she would visit Niagara Falls the following summer.", "rationale": "**D·ªãch:** John h·ªèi Mary li·ªáu c√¥ ·∫•y c√≥ ƒëi thƒÉm th√°c Niagara v√†o m√πa h√® t·ªõi kh√¥ng.\n**Gi·∫£i th√≠ch:**\n1. Will -> Would.\n2. Next summer -> The following summer (ho·∫∑c The next summer).", "isCorrect": true },
                        { "text": "C. John asked Mary will you visit Niagara Falls next summer.", "rationale": "**Sai:** C√¢u tr·ª±c ti·∫øp.", "isCorrect": false },
                        { "text": "D. John asked Mary if she will visit Niagara Falls the following summer.", "rationale": "**Sai:** Ch∆∞a l√πi th√¨ 'will'.", "isCorrect": false }
                    ],
                    "hint": "Next summer -> The following summer."
                }
            ]
        };

        // --- GAME LOGIC ---
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = [];
        let canAnswer = true;

        // Shuffle Array (Fisher-Yates)
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // Markdown-like parser for bold text
        function parseMarkdown(text) {
            if (!text) return "";
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

        // Audio System (Synthesized to avoid broken links)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'correct') {
                // High pitch "Ding"
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                oscillator.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1); // C6
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            } else if (type === 'wrong') {
                // Low pitch "Buzz"
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'finish') {
                // Victory sound
                 oscillator.type = 'triangle';
                 oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
                 oscillator.frequency.setValueAtTime(600, audioCtx.currentTime + 0.1);
                 oscillator.frequency.setValueAtTime(800, audioCtx.currentTime + 0.2);
                 gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                 gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
                 oscillator.start();
                 oscillator.stop(audioCtx.currentTime + 0.5);
            }
        }

        function startQuiz() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            
            // Clone and Shuffle Questions
            currentQuestions = JSON.parse(JSON.stringify(rawData.questions));
            currentQuestions = shuffle(currentQuestions);
            
            // Also shuffle options within each question but keep track of the original index/letter logic if needed
            // (Here we just shuffle the array of options)
            currentQuestions.forEach(q => {
               // We won't shuffle options because the rationale refers to "A, B, C, D". 
               // If we shuffle options, the text "A." might appear in the 3rd position which is confusing.
               // So we keep option order fixed as per dataset for consistency with the rationale text.
            });

            currentQuestionIndex = 0;
            score = 0;
            updateScore();
            renderQuestion();
        }

        function updateScore() {
            document.getElementById('score-display').innerText = `Score: ${score}`;
            const progress = ((currentQuestionIndex) / currentQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('question-count').innerText = `C√¢u h·ªèi ${currentQuestionIndex + 1}/${currentQuestions.length}`;
        }

        function renderQuestion() {
            canAnswer = true;
            const q = currentQuestions[currentQuestionIndex];
            
            // Reset UI
            document.getElementById('explanation-panel').style.display = 'none';
            document.getElementById('question-text').innerHTML = parseMarkdown(q.question);
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            q.answerOptions.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn btn-3d pop-in';
                btn.style.animationDelay = `${index * 0.1}s`;
                btn.innerHTML = parseMarkdown(opt.text);
                btn.onclick = () => checkAnswer(index, q);
                optionsContainer.appendChild(btn);
            });

            updateScore();
        }

        function checkAnswer(selectedIndex, questionData) {
            if (!canAnswer) return;
            canAnswer = false;

            const options = document.querySelectorAll('.option-btn');
            const selectedOptionData = questionData.answerOptions[selectedIndex];
            
            // Visual Feedback
            if (selectedOptionData.isCorrect) {
                options[selectedIndex].classList.add('correct');
                score += 10;
                playSound('correct');
                // Confetti
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            } else {
                options[selectedIndex].classList.add('wrong');
                playSound('wrong');
                // Highlight correct answer
                const correctIndex = questionData.answerOptions.findIndex(o => o.isCorrect);
                if (correctIndex !== -1) {
                    options[correctIndex].classList.add('correct');
                }
            }

            // Disable all buttons
            options.forEach(btn => btn.classList.add('disabled'));
            updateScore();

            // Show Super Detailed Explanation
            showExplanation(questionData);
        }

        function showExplanation(q) {
            const panel = document.getElementById('explanation-panel');
            const content = document.getElementById('explanation-content');
            
            // Build the HTML for explanation
            let html = `<div class="mb-4 text-sm text-gray-500"><i class="fas fa-question-circle"></i> Hint: ${q.hint || "H√£y xem k·ªπ c·∫•u tr√∫c c√¢u."}</div>`;
            
            // Loop through all options to show detailed analysis
            html += `<div class="space-y-3">`;
            
            q.answerOptions.forEach(opt => {
                const icon = opt.isCorrect ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-times-circle text-red-400"></i>';
                const bgClass = opt.isCorrect ? 'bg-green-50 border-green-200' : 'bg-white border-gray-100';
                
                // Tr√≠ch xu·∫•t ch·ªØ c√°i ƒë·∫ßu (A, B, C, D) t·ª´ text
                const letter = opt.text.match(/^([A-D]\.)/);
                const letterDisplay = letter ? `<strong class="text-gray-900">${letter[0]}</strong>` : '';
                const textDisplay = letter ? opt.text.substring(letter[0].length) : opt.text;

                html += `
                <div class="rationale-item p-3 rounded-lg border ${bgClass}">
                    <div class="font-bold text-gray-800 mb-1 flex items-start gap-2">
                        <span class="mt-1">${icon}</span>
                        <span>${letterDisplay} ${textDisplay}</span>
                    </div>
                    <div class="text-sm text-gray-600 pl-6 mt-1">
                        ${parseMarkdown(opt.rationale)}
                    </div>
                </div>`;
            });
            
            html += `</div>`;

            content.innerHTML = html;
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestions.length) {
                renderQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('quiz-container').classList.add('hidden');
            const resultScreen = document.getElementById('result-screen');
            resultScreen.classList.remove('hidden');
            
            const maxScore = currentQuestions.length * 10;
            const percentage = Math.round((score / maxScore) * 100);
            
            document.getElementById('final-score').innerText = `${score}/${maxScore}`;
            document.getElementById('final-percent').innerText = `${percentage}%`;
            
            // Feedback Text
            const feedback = document.getElementById('teacher-feedback');
            if (percentage === 100) {
                feedback.innerText = "Xu·∫•t s·∫Øc! C√¥ Mai An r·∫•t t·ª± h√†o v·ªÅ em! üåü";
                playSound('finish');
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            } else if (percentage >= 80) {
                feedback.innerText = "L√†m t·ªët l·∫Øm! Em n·∫Øm r·∫•t ch·∫Øc b√†i! üéâ";
                playSound('finish');
            } else if (percentage >= 50) {
                feedback.innerText = "C·ªë g·∫Øng l√™n! √în l·∫°i c√°c c·∫•u tr√∫c sai nh√©! üí™";
            } else {
                feedback.innerText = "ƒê·ª´ng bu·ªìn nh√©! H√£y xem l·∫°i ph·∫ßn gi·∫£i th√≠ch v√† l√†m l·∫°i n√†o! üìö";
            }
        }

        function restartQuiz() {
            document.getElementById('result-screen').classList.add('hidden');
            startQuiz();
        }

    </script>
</body>
</html>
