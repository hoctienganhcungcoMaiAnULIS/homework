<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test 1 - Ms Mai An ULIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8854C0; /* H·ªìng t√≠m pastel */
            --secondary: #00C9A7; /* Xanh ng·ªçc */
            --correct: #00D26A; /* Xanh l√° */
            --wrong: #FF4757; /* ƒê·ªè cam */
            --bg-pattern: radial-gradient(#ffffff 15%, transparent 16%) 0 0, radial-gradient(#ffffff 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;
            --bg-color: #f0f3f8;
            --card-shadow: 0 10px 0px rgba(0,0,0,0.1);
            --btn-shadow: 0 6px 0px rgba(0,0,0,0.2);
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #e0f7fa;
            background-image: var(--bg-pattern);
            background-size: 16px 16px;
            margin: 0;
            padding: 20px;
            color: #2c3e50;
        }

        /* Header nh·ªè g·ªçn */
        header {
            text-align: center;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        h1 {
            font-size: 1.2rem;
            color: var(--primary);
            margin: 0;
            font-weight: 800;
        }

        h2 {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin: 5px 0 0 0;
        }

        /* Container ch√≠nh */
        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Th·∫ª b√†i (Card) */
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
            border: 2px solid #f1f2f6;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .section-title {
            color: var(--secondary);
            font-weight: 800;
            font-size: 1.4rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            border-bottom: 3px dashed #e1e1e1;
            padding-bottom: 10px;
            display: inline-block;
        }

        /* C√¢u h·ªèi */
        .question-block {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .question-text {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* D·∫°ng b√†i Circle Answer (Inline Buttons) */
        .inline-options {
            display: inline-flex;
            gap: 5px;
            flex-wrap: wrap;
            align-items: center;
        }

        .inline-btn {
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            transition: all 0.2s;
            box-shadow: 0 3px 0 #6c429c;
            position: relative;
            top: 0;
        }

        .inline-btn:active {
            top: 3px;
            box-shadow: 0 0 0 #6c429c;
        }

        .inline-btn:hover {
            transform: scale(1.05);
            background: #f3e5f5;
        }

        /* D·∫°ng ƒëi·ªÅn t·ª´ (Input) */
        .gap-input {
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            padding: 8px 12px;
            font-family: 'Quicksand', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            width: 140px;
            color: var(--primary);
            outline: none;
            transition: all 0.3s;
            text-align: center;
        }

        .gap-input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 201, 167, 0.2);
        }

        .check-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 4px 0 #009e82;
            margin-left: 10px;
        }

        .check-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #009e82;
        }

        /* Tr·∫Øc nghi·ªám ABCD */
        .mcq-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .mcq-btn {
            background: white;
            border: 2px solid #dcdde1;
            padding: 15px;
            border-radius: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 0 #bdc3c7;
            transition: all 0.2s;
            position: relative;
        }

        .mcq-btn:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .mcq-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        /* Text Area cho b√†i vi·∫øt */
        textarea {
            width: 95%;
            height: 80px;
            border: 2px solid #bdc3c7;
            border-radius: 15px;
            padding: 10px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            resize: none;
        }

        /* Gi·∫£i th√≠ch (Explanation Box) - C·ª∞C QUAN TR·ªåNG */
        .explanation {
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            margin-top: 15px;
            background: #fff3e0;
            border-left: 5px solid #ff9800;
            padding: 15px;
            border-radius: 10px;
            animation: slideDown 0.4s ease-out;
            font-size: 0.95rem;
        }

        .explanation.visible {
            display: block;
        }

        .exp-header {
            font-weight: 800;
            color: #e65100;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .exp-content p {
            margin: 5px 0;
            line-height: 1.5;
        }

        .exp-label {
            font-weight: 700;
            color: #555;
            background: #ffe0b2;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-right: 5px;
        }

        /* Tr·∫°ng th√°i ƒê√∫ng/Sai */
        .correct {
            background-color: var(--correct) !important;
            color: white !important;
            border-color: #00b85c !important;
            box-shadow: 0 4px 0 #008f47 !important;
        }

        .wrong {
            background-color: var(--wrong) !important;
            color: white !important;
            border-color: #ff2e40 !important;
            box-shadow: 0 4px 0 #cc1e2e !important;
            animation: shake 0.5s;
        }

        /* Glossary Table */
        .glossary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .glossary-table th {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: left;
        }
        .glossary-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .tag-type {
            font-style: italic;
            color: #888;
            font-size: 0.8rem;
        }

        /* Animations */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-5deg); }
            50% { transform: translateX(5px) rotate(5deg); }
            75% { transform: translateX(-5px) rotate(-5deg); }
            100% { transform: translateX(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(720deg); }
        }

        /* Canvas Confetti */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* Footer Submit */
        .footer-submit {
            text-align: center;
            margin-top: 40px;
            margin-bottom: 60px;
        }

        .submit-btn {
            background: linear-gradient(to bottom, #00C9A7, #009E82);
            color: white;
            font-size: 1.5rem;
            padding: 15px 50px;
            border: none;
            border-radius: 50px;
            font-weight: 800;
            box-shadow: 0 8px 0 #007963;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .submit-btn:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #007963;
        }

    </style>
</head>
<body>

    <header>
        <h1>B√ÄI KI·ªÇM TRA T∆Ø∆†NG T√ÅC S·ªê 1</h1>
        <h2>Bi√™n so·∫°n b·ªüi: Ms Mai An ULIS</h2>
    </header>

    <canvas id="confetti-canvas"></canvas>

    <div class="container">

        <div class="card">
            <div class="section-title">PART 1: PAST SIMPLE & PAST CONTINUOUS</div>
            <p style="font-style: italic; margin-bottom: 20px;">H∆∞·ªõng d·∫´n: B·∫•m v√†o ƒë√°p √°n ƒë√∫ng trong ngo·∫∑c.</p>
            
            <div class="question-block" id="p1q1">
                <div class="question-text">
                    1. My mom 
                    <div class="inline-options">
                        <button class="inline-btn" onclick="checkBinary('p1q1', 0, 'was cooking', 'cooked')">was cooking</button>
                        <button class="inline-btn" onclick="checkBinary('p1q1', 1, 'was cooking', 'cooked')">cooked</button>
                    </div>
                    dinner when I 
                    <div class="inline-options">
                        <button class="inline-btn" onclick="checkBinary('p1q1b', 1, 'arrived', 'was arriving')">arrived</button>
                        <button class="inline-btn" onclick="checkBinary('p1q1b', 0, 'arrived', 'was arriving')">was arriving</button>
                    </div>
                    home.
                </div>
                <div class="explanation" id="exp-p1q1"></div>
            </div>

            <div class="question-block" id="p1q2">
                <div class="question-text">
                    2. The students 
                    <div class="inline-options">
                        <button class="inline-btn" onclick="checkBinary('p1q2', 0, 'were writing', 'wrote')">were writing</button>
                        <button class="inline-btn" onclick="checkBinary('p1q2', 1, 'were writing', 'wrote')">wrote</button>
                    </div>
                    a test when the bell 
                    <div class="inline-options">
                        <button class="inline-btn" onclick="checkBinary('p1q2b', 0, 'rang', 'was ringing')">rang</button>
                        <button class="inline-btn" onclick="checkBinary('p1q2b', 1, 'rang', 'was ringing')">was ringing</button>
                    </div>.
                </div>
                <div class="explanation" id="exp-p1q2"></div>
            </div>

            <div class="question-block" id="p1q3">
                <div class="question-text">
                    3. He 
                    <div class="inline-options">
                        <button class="inline-btn" onclick="checkBinary('p1q3', 0, 'was sleeping', 'slept')">was sleeping</button>
                        <button class="inline-btn" onclick="checkBinary('p1q3', 1, 'was sleeping', 'slept')">slept</button>
                    </div>
                    while his sister 
                    <div class="inline-options">
                        <button class="inline-btn" onclick="checkBinary('p1q3b', 0, 'was playing', 'played')">was playing</button>
                        <button class="inline-btn" onclick="checkBinary('p1q3b', 1, 'was playing', 'played')">played</button>
                    </div>
                    the piano.
                </div>
                <div class="explanation" id="exp-p1q3"></div>
            </div>

             <div class="question-block" id="p1q4">
                <div class="question-text">
                    4. We 
                    <div class="inline-options">
                        <button class="inline-btn" onclick="checkBinary('p1q4', 1, 'were walking', 'walked')">walked</button>
                        <button class="inline-btn" onclick="checkBinary('p1q4', 0, 'were walking', 'walked')">were walking</button>
                    </div>
                    in the park when we 
                    <div class="inline-options">
                        <button class="inline-btn" onclick="checkBinary('p1q4b', 0, 'saw', 'were seeing')">saw</button>
                        <button class="inline-btn" onclick="checkBinary('p1q4b', 1, 'saw', 'were seeing')">were seeing</button>
                    </div>
                    a cute dog.
                </div>
                <div class="explanation" id="exp-p1q4"></div>
            </div>

             <div class="question-block" id="p1q5">
                <div class="question-text">
                    5. They 
                    <div class="inline-options">
                        <button class="inline-btn" onclick="checkBinary('p1q5', 0, 'were swimming', 'swam')">were swimming</button>
                        <button class="inline-btn" onclick="checkBinary('p1q5', 1, 'were swimming', 'swam')">swam</button>
                    </div>
                    in the pool when it 
                    <div class="inline-options">
                        <button class="inline-btn" onclick="checkBinary('p1q5b', 0, 'started', 'was starting')">started</button>
                        <button class="inline-btn" onclick="checkBinary('p1q5b', 1, 'started', 'was starting')">was starting</button>
                    </div>
                    to rain.
                </div>
                <div class="explanation" id="exp-p1q5"></div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">PART 2: FILL IN THE BLANKS</div>
            <p style="font-style: italic; margin-bottom: 20px;">ƒêi·ªÅn ƒë·ªông t·ª´ ƒë√∫ng trong ngo·∫∑c. Nh·∫•n n√∫t "Check" ƒë·ªÉ ki·ªÉm tra.</p>

            <div class="question-block">
                <div class="question-text">
                    1. While I <input type="text" class="gap-input" id="p2q1a" placeholder="clean"> <button class="check-btn" onclick="checkFill('p2q1a', 'was cleaning', 'p2q1')">Check</button> my room, my brother <input type="text" class="gap-input" id="p2q1b" placeholder="play"> <button class="check-btn" onclick="checkFill('p2q1b', 'was playing', 'p2q1')">Check</button> video games.
                </div>
                <div class="explanation" id="exp-p2q1"></div>
            </div>

            <div class="question-block">
                <div class="question-text">
                    2. She <input type="text" class="gap-input" id="p2q2a" placeholder="wait"> <button class="check-btn" onclick="checkFill('p2q2a', 'was waiting', 'p2q2')">Check</button> for the bus when she <input type="text" class="gap-input" id="p2q2b" placeholder="see"> <button class="check-btn" onclick="checkFill('p2q2b', 'saw', 'p2q2')">Check</button> her friend.
                </div>
                <div class="explanation" id="exp-p2q2"></div>
            </div>

            <div class="question-block">
                <div class="question-text">
                    3. The baby <input type="text" class="gap-input" id="p2q3a" placeholder="sleep"> <button class="check-btn" onclick="checkFill('p2q3a', 'was sleeping', 'p2q3')">Check</button> when the phone <input type="text" class="gap-input" id="p2q3b" placeholder="ring"> <button class="check-btn" onclick="checkFill('p2q3b', 'rang', 'p2q3')">Check</button>.
                </div>
                <div class="explanation" id="exp-p2q3"></div>
            </div>

            <div class="question-block">
                <div class="question-text">
                    4. We <input type="text" class="gap-input" id="p2q4a" placeholder="study"> <button class="check-btn" onclick="checkFill('p2q4a', 'were studying', 'p2q4')">Check</button> English while our dad <input type="text" class="gap-input" id="p2q4b" placeholder="work"> <button class="check-btn" onclick="checkFill('p2q4b', 'was working', 'p2q4')">Check</button> in the garden.
                </div>
                <div class="explanation" id="exp-p2q4"></div>
            </div>
            
            <table class="glossary-table">
                <thead>
                    <tr><th>Vocabulary</th><th>Type</th><th>Meaning</th></tr>
                </thead>
                <tbody>
                    <tr><td>Video games</td><td><span class="tag-type">n. phrase</span></td><td>Tr√≤ ch∆°i ƒëi·ªán t·ª≠</td></tr>
                    <tr><td>Wait for</td><td><span class="tag-type">phrasal verb</span></td><td>Ch·ªù ƒë·ª£i ai/c√°i g√¨</td></tr>
                    <tr><td>Garden</td><td><span class="tag-type">noun</span></td><td>Khu v∆∞·ªùn</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="section-title">PART 3: PRESENT PERFECT</div>
            <p style="font-style: italic; margin-bottom: 20px;">Ho√†n th√†nh c√¢u d√πng Have/Has + V3.</p>

            <div class="question-block">
                <div class="question-text">
                    1. I <input type="text" class="gap-input" id="p3q1" placeholder="buy"> <button class="check-btn" onclick="checkFill('p3q1', 'have bought', 'p3q1')">Check</button> a new bicycle.
                </div>
                <div class="explanation" id="exp-p3q1"></div>
            </div>

            <div class="question-block">
                <div class="question-text">
                    2. She <input type="text" class="gap-input" id="p3q2" placeholder="not / do"> <button class="check-btn" onclick="checkFill('p3q2', 'has not done', 'p3q2', ['hasn\'t done'])">Check</button> her homework yet.
                </div>
                <div class="explanation" id="exp-p3q2"></div>
            </div>

            <div class="question-block">
                <div class="question-text">
                    3. We <input type="text" class="gap-input" id="p3q3" placeholder="be"> <button class="check-btn" onclick="checkFill('p3q3', 'have been', 'p3q3')">Check</button> to Singapore twice.
                </div>
                <div class="explanation" id="exp-p3q3"></div>
            </div>

            <div class="question-block">
                <div class="question-text">
                    4. He <input type="text" class="gap-input" id="p3q4" placeholder="break"> <button class="check-btn" onclick="checkFill('p3q4', 'has broken', 'p3q4')">Check</button> his leg playing football.
                </div>
                <div class="explanation" id="exp-p3q4"></div>
            </div>

            <div class="question-block">
                <div class="question-text">
                    5. <input type="text" class="gap-input" id="p3q5a" placeholder="you"> you ever <input type="text" class="gap-input" id="p3q5b" placeholder="lose"> <button class="check-btn" onclick="checkFillPairs('p3q5a', 'Have', 'p3q5b', 'lost', 'p3q5')">Check</button> your keys?
                </div>
                <div class="explanation" id="exp-p3q5"></div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">PART 4: MULTIPLE CHOICE</div>
            
            <div class="question-block">
                <div class="question-text">1. I have played the piano ________ two years.</div>
                <div class="mcq-options">
                    <button class="mcq-btn" onclick="checkMCQ(this, 'for', 'p4q1')">A. Since (k·ªÉ t·ª´ khi)</button>
                    <button class="mcq-btn" onclick="checkMCQ(this, 'for', 'p4q1', true)">B. For (kho·∫£ng)</button>
                </div>
                <div class="explanation" id="exp-p4q1"></div>
            </div>

            <div class="question-block">
                <div class="question-text">2. She hasn‚Äôt cleaned her room ________.</div>
                <div class="mcq-options">
                    <button class="mcq-btn" onclick="checkMCQ(this, 'yet', 'p4q2')">A. Already (r·ªìi)</button>
                    <button class="mcq-btn" onclick="checkMCQ(this, 'yet', 'p4q2', true)">B. Yet (ch∆∞a)</button>
                </div>
                <div class="explanation" id="exp-p4q2"></div>
            </div>

            <div class="question-block">
                <div class="question-text">3. We have lived in Hanoi ________ 2015.</div>
                <div class="mcq-options">
                    <button class="mcq-btn" onclick="checkMCQ(this, 'since', 'p4q3', true)">A. Since (k·ªÉ t·ª´ khi)</button>
                    <button class="mcq-btn" onclick="checkMCQ(this, 'since', 'p4q3')">B. For (kho·∫£ng)</button>
                </div>
                <div class="explanation" id="exp-p4q3"></div>
            </div>

            <div class="question-block">
                <div class="question-text">4. Have you ________ seen a ghost?</div>
                <div class="mcq-options">
                    <button class="mcq-btn" onclick="checkMCQ(this, 'ever', 'p4q4', true)">A. Ever (ƒë√£ t·ª´ng)</button>
                    <button class="mcq-btn" onclick="checkMCQ(this, 'ever', 'p4q4')">B. Never (ch∆∞a bao gi·ªù)</button>
                </div>
                <div class="explanation" id="exp-p4q4"></div>
            </div>

            <table class="glossary-table">
                <thead>
                    <tr><th>Vocabulary</th><th>Type</th><th>Meaning</th></tr>
                </thead>
                <tbody>
                    <tr><td>Ghost</td><td><span class="tag-type">noun</span></td><td>Con ma</td></tr>
                    <tr><td>Clean</td><td><span class="tag-type">verb</span></td><td>D·ªçn d·∫πp, lau ch√πi</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="section-title">PART 5: WRITE YOUR OWN SENTENCES</div>
            
            <div class="question-block">
                <div class="question-text">1. Write one sentence using PAST CONTINUOUS + PAST SIMPLE:</div>
                <textarea placeholder="Example: I was reading when my mom called me..."></textarea>
                <button class="check-btn" style="margin-top:10px;" onclick="toggleExp('exp-p5q1')">Show Suggestion</button>
                <div class="explanation" id="exp-p5q1">
                    <div class="exp-header">üë©‚Äçüè´ C√¥ Mai An g·ª£i √Ω:</div>
                    <div class="exp-content">
                        <p>C√°c em c√≥ th·ªÉ vi·∫øt theo c·∫•u tr√∫c: <b>While + S + was/were + V-ing, S + V2/ed.</b> ho·∫∑c <b>S + was/were + V-ing + when + S + V2/ed.</b></p>
                        <p><i>V√≠ d·ª•: I was doing my homework when the lights went out. (T·ªõ ƒëang l√†m b√†i t·∫≠p th√¨ m·∫•t ƒëi·ªán.)</i></p>
                    </div>
                </div>
            </div>

            <div class="question-block">
                <div class="question-text">2. Write one sentence using PRESENT PERFECT:</div>
                <textarea placeholder="Example: I have never eaten sushi..."></textarea>
                <button class="check-btn" style="margin-top:10px;" onclick="toggleExp('exp-p5q2')">Show Suggestion</button>
                <div class="explanation" id="exp-p5q2">
                    <div class="exp-header">üë©‚Äçüè´ C√¥ Mai An g·ª£i √Ω:</div>
                    <div class="exp-content">
                        <p>C·∫•u tr√∫c: <b>S + have/has + V3/ed.</b></p>
                        <p><i>V√≠ d·ª•: I have finished my project. (T·ªõ ƒë√£ ho√†n th√†nh d·ª± √°n.)</i></p>
                        <p><i>V√≠ d·ª•: She has lived here for 10 years. (C√¥ ·∫•y s·ªëng ·ªü ƒë√¢y ƒë∆∞·ª£c 10 nƒÉm r·ªìi.)</i></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-submit">
            <button class="submit-btn" onclick="submitTest()">N·ªòP B√ÄI & XEM ƒêI·ªÇM</button>
        </div>

    </div>

    <script>
        // --- √Çm thanh (Base64 ƒë·ªÉ ch·∫°y offline) ---
        const soundDing = new Audio("data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="); // Placeholder shorten
        // Th·ª±c t·∫ø c·∫ßn Base64 d√†i h∆°n. D√πng h√†m synth ƒë∆°n gi·∫£n h∆°n:
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- D·ªØ li·ªáu Gi·∫£i th√≠ch Chi ti·∫øt (Ms Mai An Data) ---
        const explanations = {
            'p1q1': {
                vi: "M·∫π t·ªõ ƒëang n·∫•u b·ªØa t·ªëi th√¨ t·ªõ v·ªÅ nh√†.",
                opts: "A. was cooking (ƒëang n·∫•u - qu√° kh·ª© ti·∫øp di·ªÖn)<br>B. cooked (ƒë√£ n·∫•u - qu√° kh·ª© ƒë∆°n)",
                right: "H√†nh ƒë·ªông 'n·∫•u ƒÉn' ƒëang x·∫£y ra (k√©o d√†i) th√¨ h√†nh ƒë·ªông 'v·ªÅ nh√†' (ng·∫Øn) xen v√†o. Ta d√πng Past Continuous cho h√†nh ƒë·ªông d√†i.",
                wrong: "'Cooked' l√† h√†nh ƒë·ªông ng·∫Øn, ƒë√£ ch·∫•m d·ª©t, kh√¥ng di·ªÖn t·∫£ ƒë∆∞·ª£c s·ª± vi·ªác ƒëang x·∫£y ra l√∫c ƒë√≥."
            },
            'p1q1b': { // Ph·∫ßn 2 c·ªßa c√¢u 1
                 vi: "...khi t·ªõ v·ªÅ nh√†.",
                 opts: "A. arrived (ƒë√£ ƒë·∫øn)<br>B. was arriving (ƒëang ƒë·∫øn)",
                 right: "H√†nh ƒë·ªông 'v·ªÅ nh√†' c·∫Øt ngang h√†nh ƒë·ªông n·∫•u ƒÉn. D√πng Past Simple sau 'when'.",
                 wrong: "'Was arriving' √°m ch·ªâ qu√° tr√¨nh ƒëi v·ªÅ ƒëang di·ªÖn ra, nh∆∞ng ·ªü ƒë√¢y ng·ªØ c·∫£nh l√† th·ªùi ƒëi·ªÉm c·∫Øt ngang."
            },
            'p1q2': {
                vi: "H·ªçc sinh ƒëang l√†m b√†i ki·ªÉm tra th√¨ chu√¥ng reo.",
                opts: "A. were writing (ƒëang vi·∫øt)<br>B. wrote (ƒë√£ vi·∫øt)",
                right: "H√†nh ƒë·ªông vi·∫øt b√†i ƒëang di·ªÖn ra li√™n t·ª•c.",
                wrong: "'Wrote' ch·ªâ ƒë∆°n thu·∫ßn l√† ƒë√£ vi·∫øt xong, kh√¥ng nh·∫•n m·∫°nh t√≠nh ƒëang ti·∫øp di·ªÖn khi chu√¥ng reo."
            },
            'p1q2b': {
                vi: "...th√¨ chu√¥ng reo.",
                opts: "A. rang (ƒë√£ reo)<br>B. was ringing (ƒëang reo)",
                right: "Chu√¥ng reo l√† h√†nh ƒë·ªông ng·∫Øn xen v√†o. D√πng Past Simple.",
                wrong: "'Was ringing' l√† ƒëang reo k√©o d√†i, th∆∞·ªùng chu√¥ng reo b√°o h·∫øt gi·ªù t√≠nh l√† th·ªùi ƒëi·ªÉm c·∫Øt ngang."
            },
            'p1q3': {
                vi: "C·∫≠u ·∫•y ƒëang ng·ªß trong khi em g√°i ƒëang ch∆°i piano.",
                opts: "A. was sleeping (ƒëang ng·ªß)<br>B. slept (ƒë√£ ng·ªß)",
                right: "Hai h√†nh ƒë·ªông x·∫£y ra song song c√πng l√∫c trong qu√° kh·ª© (d·∫•u hi·ªáu: 'while').",
                wrong: "D√πng Past Simple kh√¥ng th·ªÉ hi·ªán ƒë∆∞·ª£c t√≠nh song song c·ªßa hai s·ª± vi·ªác."
            },
            'p1q3b': {
                vi: "...trong khi em g√°i ƒëang ch∆°i piano.",
                opts: "A. was playing (ƒëang ch∆°i)<br>B. played (ƒë√£ ch∆°i)",
                right: "Sau 'while' th∆∞·ªùng l√† Past Continuous ƒë·ªÉ ch·ªâ h√†nh ƒë·ªông k√©o d√†i song song.",
                wrong: "'Played' l√†m m·∫•t √Ω nghƒ©a hai ng∆∞·ªùi ƒëang l√†m vi·ªác ri√™ng c√πng l√∫c."
            },
            'p1q4': {
                vi: "Ch√∫ng t·ªõ ƒëang ƒëi d·∫°o trong c√¥ng vi√™n...",
                opts: "A. were walking (ƒëang ƒëi)<br>B. walked (ƒë√£ ƒëi)",
                right: "H√†nh ƒë·ªông ƒëi d·∫°o l√† n·ªÅn t·∫£ng (background action) ƒëang di·ªÖn ra.",
                wrong: "'Walked' ch·ªâ l√† k·ªÉ l·∫°i, kh√¥ng t·∫°o ra b·ªëi c·∫£nh ƒëang x·∫£y ra th√¨ th·∫•y con ch√≥."
            },
            'p1q4b': {
                vi: "...th√¨ ch√∫ng t·ªõ nh√¨n th·∫•y m·ªôt ch√∫ ch√≥ d·ªÖ th∆∞∆°ng.",
                opts: "A. saw (nh√¨n th·∫•y)<br>B. were seeing (ƒëang nh√¨n)",
                right: "ƒê·ªông t·ª´ tri gi√°c 'see' r·∫•t hi·∫øm khi d√πng ·ªü ti·∫øp di·ªÖn. H√†nh ƒë·ªông 'th·∫•y' x·∫£y ra b·∫•t ch·ª£t.",
                wrong: "'Were seeing' sai ng·ªØ ph√°p v·ªõi ƒë·ªông t·ª´ ch·ªâ tri gi√°c (stative verbs)."
            },
            'p1q5': {
                vi: "H·ªç ƒëang b∆°i trong h·ªì...",
                opts: "A. were swimming (ƒëang b∆°i)<br>B. swam (ƒë√£ b∆°i)",
                right: "H√†nh ƒë·ªông b∆°i ƒëang x·∫£y ra.",
                wrong: "'Swam' l√† k·ªÉ l·∫°i s·ª± ki·ªán ƒë√£ xong."
            },
            'p1q5b': {
                vi: "...th√¨ tr·ªùi b·∫Øt ƒë·∫ßu m∆∞a.",
                opts: "A. started (b·∫Øt ƒë·∫ßu)<br>B. was starting (ƒëang b·∫Øt ƒë·∫ßu)",
                right: "Tr·ªùi b·∫Øt ƒë·∫ßu m∆∞a l√† h√†nh ƒë·ªông xen v√†o/c·∫Øt ngang.",
                wrong: "'Was starting' √≠t d√πng trong ng·ªØ c·∫£nh c·∫Øt ngang d·ª©t kho√°t n√†y."
            },
            // Part 2
            'p2q1': {
                vi: "Trong khi t·ªõ ƒëang d·ªçn ph√≤ng, anh t·ªõ ƒëang ch∆°i game.",
                opts: "Clean -> was cleaning; Play -> was playing",
                right: "C·∫•u tr√∫c song song v·ªõi 'While': S + was/were + V-ing. Hai h√†nh ƒë·ªông x·∫£y ra c√πng l√∫c.",
                wrong: "D√πng qu√° kh·ª© ƒë∆°n (cleaned/played) s·∫Ω kh√¥ng di·ªÖn t·∫£ ƒë∆∞·ª£c s·ª± ti·∫øp di·ªÖn song song."
            },
            'p2q2': {
                vi: "C√¥ ·∫•y ƒëang ch·ªù xe bu√Ωt th√¨ c√¥ ·∫•y nh√¨n th·∫•y b·∫°n.",
                opts: "Wait -> was waiting; See -> saw",
                right: "H√†nh ƒë·ªông ch·ªù (d√†i) -> Was waiting. H√†nh ƒë·ªông th·∫•y (ng·∫Øn, xen v√†o) -> Saw.",
                wrong: "Kh√¥ng d√πng 'was seeing' v√¨ see l√† ƒë·ªông t·ª´ tri gi√°c."
            },
            'p2q3': {
                vi: "Em b√© ƒëang ng·ªß th√¨ ƒëi·ªán tho·∫°i reo.",
                opts: "Sleep -> was sleeping; Ring -> rang",
                right: "Ng·ªß l√† h√†nh ƒë·ªông d√†i (was sleeping), chu√¥ng reo l√† h√†nh ƒë·ªông ng·∫Øn b·∫•t ng·ªù (rang).",
                wrong: "Rang (V2 c·ªßa Ring) ch·ª© kh√¥ng ph·∫£i Ringed."
            },
            'p2q4': {
                vi: "Ch√∫ng t·ªõ ƒëang h·ªçc ti·∫øng Anh trong khi b·ªë ƒëang l√†m v∆∞·ªùn.",
                opts: "Study -> were studying; Work -> was working",
                right: "Hai h√†nh ƒë·ªông song song n·ªëi b·ªüi 'while'. C·∫£ hai ƒë·ªÅu chia Past Continuous.",
                wrong: "L∆∞u √Ω ch·ªß ng·ªØ 'We' ƒëi v·ªõi 'were', 'Dad' ƒëi v·ªõi 'was'."
            },
            // Part 3
            'p3q1': {
                vi: "T·ªõ v·ª´a mua m·ªôt chi·∫øc xe ƒë·∫°p m·ªõi.",
                opts: "Buy -> have bought",
                right: "D√πng Present Perfect ƒë·ªÉ th√¥ng b√°o m·ªôt tin m·ªõi ho·∫∑c s·ª± vi·ªác v·ª´a x·∫£y ra kh√¥ng r√µ th·ªùi gian.",
                wrong: "Buy l√† ƒë·ªông t·ª´ b·∫•t quy t·∫Øc -> Bought (V2) -> Bought (V3)."
            },
            'p3q2': {
                vi: "C√¥ ·∫•y v·∫´n ch∆∞a l√†m b√†i t·∫≠p v·ªÅ nh√†.",
                opts: "Not/Do -> has not done (ho·∫∑c hasn't done)",
                right: "C√¢u ph·ªß ƒë·ªãnh v·ªõi 'yet' ·ªü cu·ªëi -> D√πng Present Perfect. Ch·ªß ng·ªØ 'She' d√πng 'Has'.",
                wrong: "V3 c·ªßa 'Do' l√† 'Done', kh√¥ng ph·∫£i 'Doed'."
            },
            'p3q3': {
                vi: "Ch√∫ng t·ªõ ƒë√£ ƒëi Singapore hai l·∫ßn.",
                opts: "Be -> have been",
                right: "Tr·∫£i nghi·ªám trong qu√° kh·ª© (twice) d√πng Present Perfect. 'Have been to' l√† ƒë√£ ƒëi v√† ƒë√£ v·ªÅ.",
                wrong: "V3 c·ªßa Be l√† Been."
            },
            'p3q4': {
                vi: "C·∫≠u ·∫•y b·ªã g√£y ch√¢n khi ch∆°i b√≥ng ƒë√°.",
                opts: "Break -> has broken",
                right: "H√†nh ƒë·ªông g√£y ch√¢n g√¢y h·∫≠u qu·∫£ ·ªü hi·ªán t·∫°i (ch√¢n ƒëang ƒëau).",
                wrong: "V3 c·ªßa Break l√† Broken."
            },
            'p3q5': {
                vi: "B·∫°n ƒë√£ bao gi·ªù l√†m m·∫•t ch√¨a kh√≥a ch∆∞a?",
                opts: "You/Lose -> Have you... lost",
                right: "C√¢u h·ªèi kinh nghi·ªám v·ªõi 'Ever'. ƒê·∫£o tr·ª£ ƒë·ªông t·ª´ 'Have' l√™n ƒë·∫ßu.",
                wrong: "V3 c·ªßa Lose l√† Lost."
            },
            // Part 4
            'p4q1': {
                vi: "T·ªõ ƒë√£ ch∆°i piano ƒê∆Ø·ª¢C 2 nƒÉm r·ªìi.",
                opts: "A. Since (m·ªëc th·ªùi gian)<br>B. For (kho·∫£ng th·ªùi gian)",
                right: "'Two years' l√† m·ªôt kho·∫£ng th·ªùi gian (duration) -> D√πng 'For'.",
                wrong: "'Since' ch·ªâ ƒëi v·ªõi m·ªëc th·ªùi gian c·ª• th·ªÉ (v√≠ d·ª•: Since 2022)."
            },
            'p4q2': {
                vi: "C√¥ ·∫•y v·∫´n CH∆ØA d·ªçn ph√≤ng.",
                opts: "A. Already (r·ªìi)<br>B. Yet (ch∆∞a)",
                right: "'Yet' d√πng trong c√¢u ph·ªß ƒë·ªãnh v√† c√¢u h·ªèi, ƒë·ª©ng cu·ªëi c√¢u.",
                wrong: "'Already' th∆∞·ªùng d√πng trong c√¢u kh·∫≥ng ƒë·ªãnh."
            },
            'p4q3': {
                vi: "Ch√∫ng t·ªõ s·ªëng ·ªü H√† N·ªôi T·ª™ nƒÉm 2015.",
                opts: "A. Since (k·ªÉ t·ª´)<br>B. For (kho·∫£ng)",
                right: "'2015' l√† m·ªëc th·ªùi gian b·∫Øt ƒë·∫ßu -> D√πng 'Since'.",
                wrong: "'For' d√πng cho t·ªïng th·ªùi gian (v√≠ d·ª•: For 10 years)."
            },
            'p4q4': {
                vi: "C·∫≠u ƒê√É T·ª™NG th·∫•y ma ch∆∞a?",
                opts: "A. Ever (ƒë√£ t·ª´ng)<br>B. Never (ch∆∞a bao gi·ªù)",
                right: "Trong c√¢u h·ªèi v·ªÅ tr·∫£i nghi·ªám, ta d√πng 'Ever'.",
                wrong: "'Never' mang nghƒ©a ph·ªß ƒë·ªãnh, th∆∞·ªùng d√πng trong c√¢u tr·∫£ l·ªùi (I have never...)."
            }
        };

        // --- H√†m Render Gi·∫£i th√≠ch ---
        function showExplanation(id, isCorrect) {
            const expBox = document.getElementById(`exp-${id}`);
            const data = explanations[id];
            
            if (!data) return; // N·∫øu kh√¥ng c√≥ data (Part 5)

            // N·∫øu c√¢u h·ªèi gh√©p (Part 2), l·∫•y data g·ªëc
            const parentKey = id.replace(/[ab]$/, ''); // p2q1a -> p2q1
            const finalData = explanations[parentKey] || data;

            let html = `
                <div class="exp-header">
                    ${isCorrect ? 'üéâ Ch√≠nh x√°c!' : 'üòÖ Ti·∫øc qu√°, sai r·ªìi!'} 
                    - üë©‚Äçüè´ C√¥ Mai An gi·∫£i th√≠ch:
                </div>
                <div class="exp-content">
                    <p><span class="exp-label">D·ªãch:</span> ${finalData.vi}</p>
                    <p><span class="exp-label">ƒê√°p √°n:</span> ${finalData.opts}</p>
                    <p><span class="exp-label" style="background:#c8e6c9; color:#2e7d32">T·∫°i sao ƒë√∫ng:</span> ${finalData.right}</p>
                    <p><span class="exp-label" style="background:#ffcdd2; color:#c62828">T·∫°i sao sai:</span> ${finalData.wrong}</p>
                </div>
            `;
            expBox.innerHTML = html;
            expBox.classList.add('visible');
        }

        // --- Logic Ch·∫•m ƒëi·ªÉm Binary (Part 1) ---
        function checkBinary(qId, selectedIndex, rightAns, wrongAns) {
            // qId: p1q1
            // selectedIndex: 0 or 1 button index
            // rightAns: text of right answer
            
            const btnContainer = document.getElementById(qId).querySelector('.inline-options');
            // N·∫øu c√≥ 2 b·ªô n√∫t trong 1 c√¢u (p1q1 v√† p1q1b), c·∫ßn t√¨m ƒë√∫ng container
            // Nh∆∞ng id ·ªü ƒë√¢y l√† id c·ªßa div cha, n√™n ta c·∫ßn query specific buttons
            // Fix: id truy·ªÅn v√†o checkBinary l√† id c·ªßa div cha ch·ª©a c√¢u h·ªèi? 
            // Kh√¥ng, p1q1 v√† p1q1b l√† id ri√™ng cho logic.
            
            // Logic t√¨m n√∫t:
            // V·ªõi HTML structure tr√™n, p1q1 l√† ID c·ªßa div.question-block? 
            // Wait, p1q1 is div block. Inside are 2 sets of buttons.
            // C·∫ßn s·ª≠a HTML ID m·ªôt ch√∫t ƒë·ªÉ target ƒë√∫ng.
            // ƒê√£ s·ª≠a HTML: checkBinary('p1q1'...) -> n√∫t b·∫•m n·∫±m ngay trong ƒë√≥.
            
            // T√¨m n√∫t ƒë∆∞·ª£c b·∫•m:
            // Event target l√† button.
            const btns = event.target.parentElement.children;
            const selectedBtn = btns[selectedIndex];
            const isRight = selectedBtn.innerText === rightAns;

            // Reset style
            for (let btn of btns) {
                btn.classList.remove('correct', 'wrong');
            }

            if (isRight) {
                selectedBtn.classList.add('correct');
                playSound('correct');
                fireConfetti();
                // Show explanation
                showExplanation(qId, true);
            } else {
                selectedBtn.classList.add('wrong');
                playSound('wrong');
                showExplanation(qId, false);
            }
        }

        // --- Logic Ch·∫•m ƒëi·ªÉm ƒêi·ªÅn t·ª´ (Part 2, 3) ---
        function checkFill(inputId, correctAnswer, expId, altAnswers = []) {
            const input = document.getElementById(inputId);
            const val = input.value.trim().toLowerCase();
            const correctLo = correctAnswer.toLowerCase();
            
            let isCorrect = (val === correctLo);
            
            // Check alternatives (e.g., hasn't vs has not)
            if (!isCorrect && altAnswers.length > 0) {
                altAnswers.forEach(alt => {
                    if (val === alt.toLowerCase()) isCorrect = true;
                });
            }

            if (isCorrect) {
                input.classList.add('correct');
                input.classList.remove('wrong'); // X√≥a class wrong n·∫øu s·ª≠a l·∫°i ƒë√∫ng
                playSound('correct');
                fireConfetti();
            } else {
                input.classList.add('wrong');
                input.classList.remove('correct');
                playSound('wrong');
            }
            
            showExplanation(expId, isCorrect);
        }

        // Check c·∫∑p ƒë√¥i (Part 3 Q5)
        function checkFillPairs(id1, ans1, id2, ans2, expId) {
            const i1 = document.getElementById(id1);
            const i2 = document.getElementById(id2);
            
            const v1 = i1.value.trim().toLowerCase();
            const v2 = i2.value.trim().toLowerCase();
            
            const ok1 = v1 === ans1.toLowerCase();
            const ok2 = v2 === ans2.toLowerCase();

            if(ok1) i1.classList.add('correct'); else i1.classList.add('wrong');
            if(ok2) i2.classList.add('correct'); else i2.classList.add('wrong');

            if (ok1 && ok2) {
                playSound('correct');
                fireConfetti();
                showExplanation(expId, true);
            } else {
                playSound('wrong');
                showExplanation(expId, false);
            }
        }

        // --- Logic MCQ (Part 4) ---
        function checkMCQ(btn, correctVal, qId, isCorrectLogic) {
            // isCorrectLogic: true n·∫øu n√∫t n√†y l√† ƒë√°p √°n ƒë√∫ng
            const parent = btn.parentElement;
            const allBtns = parent.querySelectorAll('.mcq-btn');
            
            // Disable other clicks temporarily or just highlight
            allBtns.forEach(b => b.classList.remove('correct', 'wrong'));

            if (isCorrectLogic) {
                btn.classList.add('correct');
                playSound('correct');
                fireConfetti();
                showExplanation(qId, true);
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
                showExplanation(qId, false);
            }
        }

        // --- Toggle Hint (Part 5) ---
        function toggleExp(id) {
            const el = document.getElementById(id);
            if (el.style.display === 'block') {
                el.style.display = 'none';
            } else {
                el.style.display = 'block';
                el.classList.add('visible');
            }
        }

        // --- Hi·ªáu ·ª©ng Confetti (Ph√°o gi·∫•y) ---
        // Simple Canvas Confetti implementation
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let particles = [];
        const colors = ['#8854C0', '#00C9A7', '#FF4757', '#FF9800', '#2196F3'];

        function fireConfetti() {
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: -10,
                    w: Math.random() * 10 + 5,
                    h: Math.random() * 5 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speedY: Math.random() * 3 + 2,
                    speedX: Math.random() * 4 - 2,
                    rotation: Math.random() * 360,
                    spin: Math.random() * 10 - 5
                });
            }
        }

        function updateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, index) => {
                p.y += p.speedY;
                p.x += p.speedX;
                p.rotation += p.spin;

                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                ctx.restore();

                if (p.y > canvas.height) {
                    particles.splice(index, 1);
                }
            });
            requestAnimationFrame(updateConfetti);
        }
        updateConfetti();

        // --- Submit ---
        function submitTest() {
            // Count corrects
            const corrects = document.querySelectorAll('.correct').length;
            // Total items to check (approximate)
            // Part 1: 5 q * 2 gaps = 10 points
            // Part 2: 4 q * 2 gaps = 8 points
            // Part 3: 5 q (last one has 2 gaps) = 6 points
            // Part 4: 4 q = 4 points
            // Total ~ 28 points interactable
            
            // Simple alert for now
            alert(`üéâ Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i thi!\nS·ªë c√¢u tr·∫£ l·ªùi ƒë√∫ng hi·ªán t·∫°i: ${corrects}\n\nH√£y xem l·∫°i ph·∫ßn gi·∫£i th√≠ch chi ti·∫øt b√™n d∆∞·ªõi m·ªói c√¢u nh√©!`);
            fireConfetti();
            fireConfetti();
            fireConfetti();
        }

        // Resize canvas
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

    </script>
</body>
</html>