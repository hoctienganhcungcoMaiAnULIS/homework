<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ms Mai An ULIS - Unit 9 Test (Scored)</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8854C0; /* H·ªìng t√≠m */
            --secondary: #00C9A7; /* Xanh ng·ªçc */
            --success: #00D26A; /* Xanh l√° */
            --error: #FF4757; /* ƒê·ªè cam */
            --bg-pattern: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #2f3542;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #fce4ec;
            background-image: radial-gradient(#8854C0 1.5px, transparent 1.5px), radial-gradient(#00C9A7 1.5px, #fce4ec 1.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* HEADER */
        header {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border: 4px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        h1 {
            font-family: 'Quicksand', sans-serif;
            color: var(--primary);
            margin: 0;
            font-size: 1.8rem;
            text-transform: uppercase;
            font-weight: 800;
        }

        .sub-header {
            color: var(--secondary);
            font-weight: 700;
            margin-top: 5px;
        }

        /* CARD STYLE */
        .question-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 6px 0 #e1e1e1;
            border: 2px solid #f1f1f1;
            transition: transform 0.3s;
            position: relative;
        }

        .question-card:hover {
            transform: translateY(-3px);
        }

        .q-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .q-text {
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* OPTIONS BUTTONS */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }

        .option-btn {
            background: white;
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 15px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #ccc;
            position: relative;
        }

        .option-btn:hover {
            transform: scale(1.02);
            border-color: var(--secondary);
            background: #f0fffc;
        }

        .option-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .option-btn.correct {
            background-color: var(--success) !important;
            color: white;
            border-color: #00b85c;
            box-shadow: 0 4px 0 #008f47;
        }

        .option-btn.wrong {
            background-color: var(--error) !important;
            color: white;
            border-color: #e03b4b;
            box-shadow: 0 4px 0 #b32f3b;
            animation: shake 0.5s;
        }

        /* INPUT FIELD STYLE */
        .input-group {
            margin-bottom: 15px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
        }

        input[type="text"]:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(0, 201, 167, 0.2);
        }

        .check-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #6c4299;
            margin-top: 10px;
            display: inline-block;
        }
        
        .check-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* EXPLANATION BOX */
        .explanation-box {
            display: none; /* Hidden by default */
            margin-top: 20px;
            background: #fff9fa;
            border: 2px dashed var(--secondary);
            border-radius: 15px;
            padding: 15px;
            animation: popIn 0.4s ease-out;
        }

        .exp-header {
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
            display: block;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .exp-content {
            font-size: 0.95rem;
            color: #444;
        }

        .exp-step {
            margin-bottom: 8px;
        }
        
        .exp-label {
            font-weight: bold;
            color: var(--secondary);
        }

        /* ANIMATIONS */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            50% { transform: translateX(5px) rotate(2deg); }
            75% { transform: translateX(-5px) rotate(-2deg); }
            100% { transform: translateX(0); }
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* FOOTER & MODAL */
        .footer-bar {
            text-align: center;
            margin-top: 40px;
            padding-bottom: 80px;
        }

        .submit-all-btn {
            background: linear-gradient(45deg, #FF4757, #FF6B81);
            color: white;
            font-size: 1.5rem;
            padding: 15px 50px;
            border-radius: 50px;
            border: 4px solid white;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255, 71, 87, 0.4);
            transition: 0.3s;
        }

        .submit-all-btn:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 15px 25px rgba(255, 71, 87, 0.5);
        }

        /* SCORE MODAL STYLES */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 40px;
            border: 5px solid var(--secondary);
            width: 90%;
            max-width: 500px;
            border-radius: 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 800;
            margin: 0 auto 20px auto;
            border: 8px solid #e0cffc;
            box-shadow: 0 10px 0 rgba(0,0,0,0.2);
        }

        .score-text {
            font-size: 1.5rem;
            color: var(--text-main);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .teacher-comment {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.1rem;
            color: #555;
            background: #f0f2f5;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid var(--secondary);
        }

        .close-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 0 #00917c;
        }

        .close-btn:hover {
            transform: translateY(-2px);
        }

        /* CANVAS */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1500;
        }

        u {
            text-decoration: underline;
            text-decoration-thickness: 3px;
            text-decoration-color: var(--error);
            font-weight: 900;
        }
        
        .section-header {
            background: var(--primary);
            color: white;
            padding: 12px 25px;
            border-radius: 15px;
            margin: 40px 0 20px 0;
            font-weight: 800;
            font-size: 1.1rem;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            display: inline-block;
        }

    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div id="scoreModal" class="modal">
    <div class="modal-content">
        <div class="score-circle" id="scoreValue">0/0</div>
        <div class="score-text" id="scorePercent">0% Correct</div>
        <div class="teacher-comment" id="teacherComment">
            "H√£y ho√†n th√†nh b√†i thi nh√©!"
        </div>
        <button class="close-btn" onclick="closeModal()">Xem l·∫°i b√†i l√†m</button>
    </div>
</div>

<div class="container">
    <header>
        <h1>Gi√°o vi√™n t·∫°o: Ms Mai An ULIS</h1>
        <div class="sub-header">TEST FOR UNIT 9 - CITIES OF THE WORLD</div>
    </header>

    <div class="section-header">I. Choose the word whose underlined part is pronounced differently.</div>
    <div id="part1-container"></div>

    <div class="section-header">II. Read & Write the name of landmarks.</div>
    <div class="question-card">
        <div class="q-text" style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 2px dashed #ffa000;">
            <strong>Word Bank:</strong> Eiffel Tower, Taj Mahal, Great Wall of China, Empire State Building, Petronas Towers, Sydney Opera House, Angkor Wat, Big Ben.
        </div>
        <div id="part2-container"></div>
    </div>

    <div class="section-header">IV. Choose the best answer a, b, c or d.</div>
    <div id="part4-container"></div>

    <div class="section-header">V. Complete the sentences with correct form/tense.</div>
    <div id="part5-container"></div>

    <div class="footer-bar">
        <button class="submit-all-btn" onclick="finishTest()">N·ªòP B√ÄI & XEM ƒêI·ªÇM üèÜ</button>
    </div>
</div>

<script>
    // --- GLOBAL STATE ---
    // We will track user answers in the data objects themselves
    
    // PART 1: PHONETICS
    const part1Data = [
        {
            id: "p1_1",
            text: "Choose the word with different underlined sound:",
            options: [
                { text: "p<u>ri</u>ze", val: "a" },
                { text: "exc<u>i</u>te", val: "b" },
                { text: "des<u>i</u>gn", val: "c" },
                { text: "cap<u>i</u>tal", val: "d" }
            ],
            correct: 3, // d
            userChoice: null, // to track user selection
            explanation: `
                <div class="exp-step"><span class="exp-label">1. Ph√¢n t√≠ch phi√™n √¢m:</span></div>
                <ul style="list-style: none; padding-left: 10px;">
                    <li>A. prize /pra…™z/ -> /a…™/</li>
                    <li>B. excite /…™kÀàsa…™t/ -> /a…™/</li>
                    <li>C. design /d…™Ààza…™n/ -> /a…™/</li>
                    <li>D. capital /Ààk√¶p…™tl/ -> /…™/</li>
                </ul>
                <div class="exp-step"><span class="exp-label">K·∫øt lu·∫≠n:</span> ƒê√°p √°n D ph√°t √¢m l√† /…™/, c√°c t·ª´ c√≤n l·∫°i l√† /a…™/.</div>
            `
        },
        {
            id: "p1_2",
            text: "Choose the word with different underlined sound:",
            options: [
                { text: "<u>c</u>ity", val: "a" },
                { text: "<u>c</u>apital", val: "b" },
                { text: "ni<u>c</u>e", val: "c" },
                { text: "ex<u>c</u>ite", val: "d" }
            ],
            correct: 1, // b
            userChoice: null,
            explanation: `
                <div class="exp-step"><span class="exp-label">1. Ph√¢n t√≠ch phi√™n √¢m:</span></div>
                <ul style="list-style: none; padding-left: 10px;">
                    <li>A. city /Ààs…™ti/ -> /s/</li>
                    <li>B. capital /Ààk√¶p…™tl/ -> /k/</li>
                    <li>C. nice /na…™s/ -> /s/</li>
                    <li>D. excite /…™kÀàsa…™t/ -> /s/</li>
                </ul>
                <div class="exp-step"><span class="exp-label">K·∫øt lu·∫≠n:</span> ƒê√°p √°n B l√† /k/.</div>
            `
        },
        {
            id: "p1_3",
            text: "Choose the word with different underlined sound:",
            options: [
                { text: "c<u>o</u>ld", val: "a" },
                { text: "ph<u>o</u>to", val: "b" },
                { text: "c<u>o</u>ntinent", val: "c" },
                { text: "p<u>o</u>ster", val: "d" }
            ],
            correct: 2, // c
            userChoice: null,
            explanation: `
                <div class="exp-step"><span class="exp-label">1. Ph√¢n t√≠ch:</span></div>
                <ul style="list-style: none; padding-left: 10px;">
                    <li>A. cold /…ô ä/</li>
                    <li>B. photo /…ô ä/</li>
                    <li>C. continent /…í/ (o ng·∫Øn)</li>
                    <li>D. poster /…ô ä/</li>
                </ul>
                <div class="exp-step"><span class="exp-label">K·∫øt lu·∫≠n:</span> ƒê√°p √°n C.</div>
            `
        },
        {
            id: "p1_4",
            text: "Choose the word with different underlined sound:",
            options: [
                { text: "design<u>ed</u>", val: "a" },
                { text: "receiv<u>ed</u>", val: "b" },
                { text: "cycl<u>ed</u>", val: "c" },
                { text: "reward<u>ed</u>", val: "d" }
            ],
            correct: 3, // d
            userChoice: null,
            explanation: `
                <div class="exp-step"><span class="exp-label">Quy t·∫Øc ƒëu√¥i -ed:</span></div>
                <ul style="list-style: none; padding-left: 10px;">
                    <li>A, B, C ph√°t √¢m l√† /d/ (√¢m h·ªØu thanh).</li>
                    <li>D. rewarded /…™d/ (t·∫≠n c√πng l√† d/t).</li>
                </ul>
            `
        },
        {
            id: "p1_5",
            text: "Choose the word with different underlined sound:",
            options: [
                { text: "tomorr<u>ow</u>", val: "a" },
                { text: "t<u>ow</u>er", val: "b" },
                { text: "cr<u>ow</u>d", val: "c" },
                { text: "ar<u>ou</u>nd", val: "d" }
            ],
            correct: 0, // a
            userChoice: null,
            explanation: `
                <div class="exp-step"><span class="exp-label">1. Ph√¢n t√≠ch:</span></div>
                <ul style="list-style: none; padding-left: 10px;">
                    <li>A. tomorrow /…ô ä/</li>
                    <li>B. tower /a ä/</li>
                    <li>C. crowd /a ä/</li>
                    <li>D. around /a ä/</li>
                </ul>
            `
        }
    ];

    // PART 2: LANDMARKS
    const part2Data = [
        {
            desc: "200BC; protects borders; longest man made structure. Capital: Beijing -> ___________________",
            correct: ["Great Wall of China", "Great Wall"],
            explain: "B·∫Øc Kinh (Beijing) n·ªïi ti·∫øng v·ªõi V·∫°n L√Ω Tr∆∞·ªùng Th√†nh (Great Wall of China)."
        },
        {
            desc: "World's tallest twin buildings 452 meters tall. There is a skybridge between the towers. Capital: Kuala Lumpur. -> ___________________",
            correct: ["Petronas Towers", "Petronas Twin Towers"],
            explain: "Th√°p ƒë√¥i ·ªü Kuala Lumpur (Malaysia) l√† Petronas Towers."
        },
        {
            desc: "Largest 4 sided clock. Symbol of the UK. Capital: London -> ___________________",
            correct: ["Big Ben"],
            explain: "ƒê·ªìng h·ªì 4 m·∫∑t l·ªõn nh·∫•t, bi·ªÉu t∆∞·ª£ng c·ªßa London l√† Big Ben."
        },
        {
            desc: "300 meters tall 3 floors; tallest structure until 1930; most visited landmark in the world. Capital: Paris -> ___________________",
            correct: ["Eiffel Tower", "Eiffel"],
            explain: "Bi·ªÉu t∆∞·ª£ng c·ªßa Paris (Ph√°p) l√† Th√°p Eiffel."
        },
        {
            desc: "NYC Skyscraper 103 floors; from 1931-1970 world's tallest building. Capital: Washington, D.C. -> ___________________",
            correct: ["Empire State Building"],
            explain: "T√≤a nh√† ch·ªçc tr·ªùi n·ªïi ti·∫øng ·ªü NYC (New York) l√† Empire State Building."
        },
        {
            desc: "Built of white marble; tomb built by emperor in memory of 3rd wife. Capital: New Delhi -> ___________________",
            correct: ["Taj Mahal"],
            explain: "LƒÉng m·ªô b·∫±ng ƒë√° c·∫©m th·∫°ch tr·∫Øng ·ªü ·∫§n ƒê·ªô l√† Taj Mahal."
        },
        {
            desc: "1150 AD completed; pictured on flag; largest religious monument in the world. Capital: Phnom Penh -> ___________________",
            correct: ["Angkor Wat"],
            explain: "Di t√≠ch t√¥n gi√°o l·ªõn nh·∫•t th·∫ø gi·ªõi ·ªü Campuchia l√† Angkor Wat."
        },
        {
            desc: "One of the most loved buildings in the world; performing arts center; supposed to represent a sail boat. Capital: Canberra -> ___________________",
            correct: ["Sydney Opera House", "Opera House"],
            explain: "Nh√† h√°t c√≥ h√¨nh d√°ng c√°nh bu·ªìm ·ªü √öc l√† Sydney Opera House."
        }
    ];

    // PART 4: MULTIPLE CHOICE
    const part4Data = [
        {
            q: "Manchester is famous _______ its football teams.",
            options: ["in", "with", "for", "as"],
            correct: 2, 
            userChoice: null,
            trans: "Manchester n·ªïi ti·∫øng v·ªÅ c√°c ƒë·ªôi b√≥ng ƒë√° c·ªßa h·ªç.",
            explain: "C·∫•u tr√∫c 'to be famous for sth': N·ªïi ti·∫øng v·ªÅ c√°i g√¨."
        },
        {
            q: "Oxford University was built _______ the 12th century.",
            options: ["in", "of", "at", "on"],
            correct: 0,
            userChoice: null,
            trans: "ƒê·∫°i h·ªçc Oxford ƒë∆∞·ª£c x√¢y d·ª±ng v√†o th·∫ø k·ª∑ 12.",
            explain: "D√πng 'in' cho Th·∫ø k·ª∑, NƒÉm, Th√°ng, M√πa."
        },
        {
            q: "The Golden Gate Bridge is San Francisco's most famous _______.",
            options: ["building", "monument", "palace", "landmark"],
            correct: 3,
            userChoice: null,
            trans: "C·∫ßu C·ªïng V√†ng l√† ƒë·ªãa danh n·ªïi ti·∫øng nh·∫•t c·ªßa San Francisco.",
            explain: "Landmark (ƒë·ªãa danh/th·∫Øng c·∫£nh) ph√π h·ª£p nh·∫•t v·ªõi m·ªôt c√¢y c·∫ßu bi·ªÉu t∆∞·ª£ng."
        },
        {
            q: "_______ is a nice day! Shall we go swimming?",
            options: ["How", "When", "What", "Which"],
            correct: 2,
            userChoice: null,
            trans: "H√¥m nay ƒë·∫πp tr·ªùi qu√°! Ch√∫ng ta ƒëi b∆°i nh√©?",
            explain: "C·∫•u tr√∫c c·∫£m th√°n: What + (a/an) + adj + noun!"
        },
        {
            q: "France is the most _______ country to visit. It has about 76 million visitors a year.",
            options: ["visiting", "expensive", "popular", "relaxing"],
            correct: 2,
            userChoice: null,
            trans: "Ph√°p l√† ƒë·∫•t n∆∞·ªõc ph·ªï bi·∫øn nh·∫•t ƒë·ªÉ ƒë·∫øn thƒÉm.",
            explain: "C√≥ 76 tri·ªáu du kh√°ch -> Popular (ph·ªï bi·∫øn/ƒë∆∞·ª£c y√™u th√≠ch)."
        },
        {
            q: "_______ do you live in? - Asia.",
            options: ["Where", "What country", "What continent", "What city"],
            correct: 2,
            userChoice: null,
            trans: "B·∫°n s·ªëng ·ªü ch√¢u l·ª•c n√†o? - Ch√¢u √Å.",
            explain: "Asia (Ch√¢u √Å) l√† m·ªôt Ch√¢u l·ª•c (Continent)."
        },
        {
            q: "The _______ is a mythical creature with the head of a lion and the body of a fish.",
            options: ["Komodo Dragon", "Red Kangaroo", "Phoenix", "Merlion"],
            correct: 3,
            userChoice: null,
            trans: "Merlion l√† sinh v·∫≠t huy·ªÅn tho·∫°i v·ªõi ƒë·∫ßu s∆∞ t·ª≠ v√† m√¨nh c√°.",
            explain: "Merlion (Bi·ªÉu t∆∞·ª£ng Singapore) = Mermaid + Lion."
        },
        {
            q: "I really love living in Montreal _______ there are so many places to visit that are nearby.",
            options: ["but", "so", "because", "although"],
            correct: 2,
            userChoice: null,
            trans: "T√¥i r·∫•t th√≠ch s·ªëng ·ªü Montreal V√å c√≥ r·∫•t nhi·ªÅu n∆°i ƒë·ªÉ tham quan.",
            explain: "D√πng 'because' ƒë·ªÉ ch·ªâ nguy√™n nh√¢n."
        },
        {
            q: "What is the capital of Greece? - _______.",
            options: ["Amsterdam", "Athens", "Stockholm", "Sydney"],
            correct: 1,
            userChoice: null,
            trans: "Th·ªß ƒë√¥ c·ªßa Hy L·∫°p l√† g√¨? - Athens.",
            explain: "Greece (Hy L·∫°p) -> Athens."
        }
    ];

    // PART 5: VERBS
    const part5Data = [
        {
            q: "My cousin _______________ (be) in Canada two years ago.",
            correct: ["was"],
            explain: "D·∫•u hi·ªáu 'two years ago' -> Qu√° kh·ª© ƒë∆°n."
        },
        {
            q: "Tomorrow we _______________ (cycle) around to discover the city.",
            correct: ["will cycle", "are going to cycle"],
            explain: "D·∫•u hi·ªáu 'Tomorrow' -> T∆∞∆°ng lai ƒë∆°n."
        },
        {
            q: "At the moment I _______________ (stay) at a very nice hotel in the south of France.",
            correct: ["am staying"],
            explain: "D·∫•u hi·ªáu 'At the moment' -> Hi·ªán t·∫°i ti·∫øp di·ªÖn."
        },
        {
            q: "When I was younger, we _______________ (not do) much sport at school.",
            correct: ["didn't do", "did not do"],
            explain: "D·∫•u hi·ªáu 'When I was younger' -> Qu√° kh·ª© ƒë∆°n (Ph·ªß ƒë·ªãnh)."
        },
        {
            q: "Last year I _______________ (go) on a school trip to Scotland.",
            correct: ["went"],
            explain: "D·∫•u hi·ªáu 'Last year' -> Qu√° kh·ª© ƒë∆°n. Go -> went."
        },
        {
            q: "We _______________ (have) a very interesting time.",
            correct: ["had"],
            explain: "K·ªÉ l·∫°i s·ª± vi·ªác trong qu√° kh·ª© -> Qu√° kh·ª© ƒë∆°n."
        },
        {
            q: "Could you meet me at the bus station? My bus _______________ (arrive) at six.",
            correct: ["arrives", "is arriving"],
            explain: "L·ªãch tr√¨nh t√†u xe (Timetable) -> Hi·ªán t·∫°i ƒë∆°n (arrives)."
        }
    ];

    // --- AUDIO & EFFECTS ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'correct') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
            fireConfetti(0.5); // mini confetti
        } else {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    // --- RENDER FUNCTIONS ---

    // Render Part 1
    const p1Container = document.getElementById('part1-container');
    part1Data.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.innerHTML = `
            <div class="q-title">Question ${index + 1}</div>
            <div class="q-text">${item.text}</div>
            <div class="options-grid" id="p1-opts-${index}">
                ${item.options.map((opt, i) => `
                    <button class="option-btn" onclick="checkP1(${index}, ${i}, this)">
                        ${String.fromCharCode(65+i)}. ${opt.text}
                    </button>
                `).join('')}
            </div>
            <div class="explanation-box" id="p1-exp-${index}">
                <span class="exp-header">üí° C√¥ Mai An gi·∫£i th√≠ch:</span>
                <div class="exp-content">${item.explanation}</div>
            </div>
        `;
        p1Container.appendChild(card);
    });

    // Render Part 2 (Fill)
    const p2Container = document.getElementById('part2-container');
    part2Data.forEach((item, index) => {
        const div = document.createElement('div');
        div.style.marginBottom = "20px";
        div.innerHTML = `
            <div style="font-weight:600; margin-bottom:5px;">${index+1}. ${item.desc}</div>
            <div class="input-group">
                <input type="text" id="p2-in-${index}" placeholder="Nh·∫≠p t√™n ƒë·ªãa danh...">
                <button class="check-btn" onclick="checkP2(${index})">Ki·ªÉm tra</button>
            </div>
            <div class="explanation-box" id="p2-exp-${index}">
                <span class="exp-header">üí° ƒê√°p √°n:</span>
                <div class="exp-content">
                    <div><strong>ƒê√°p √°n ƒë√∫ng:</strong> <span style="color:var(--success); font-weight:bold;">${item.correct[0]}</span></div>
                    <div style="margin-top:5px;">${item.explain}</div>
                </div>
            </div>
        `;
        p2Container.appendChild(div);
    });

    // Render Part 4 (MCQ)
    const p4Container = document.getElementById('part4-container');
    part4Data.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.innerHTML = `
            <div class="q-title">Question ${index + 1}</div>
            <div class="q-text">${item.q}</div>
            <div class="options-grid" id="p4-opts-${index}">
                ${item.options.map((opt, i) => `
                    <button class="option-btn" onclick="checkP4(${index}, ${i}, this)">
                        ${String.fromCharCode(65+i)}. ${opt}
                    </button>
                `).join('')}
            </div>
            <div class="explanation-box" id="p4-exp-${index}">
                <span class="exp-header">üí° C√¥ Mai An gi·∫£i th√≠ch:</span>
                <div class="exp-content">
                    <div class="exp-step"><span class="exp-label">D·ªãch:</span> "${item.trans}"</div>
                    <div class="exp-step"><span class="exp-label">T·∫°i sao ƒë√∫ng?</span> <br> ${item.explain}</div>
                </div>
            </div>
        `;
        p4Container.appendChild(card);
    });

    // Render Part 5 (Verbs)
    const p5Container = document.getElementById('part5-container');
    part5Data.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'question-card';
        div.innerHTML = `
            <div class="q-title">Question ${index + 1}</div>
            <div class="q-text">${item.q}</div>
            <div class="input-group">
                <input type="text" id="p5-in-${index}" placeholder="Chia ƒë·ªông t·ª´...">
                <button class="check-btn" onclick="checkP5(${index})">Ki·ªÉm tra</button>
            </div>
            <div class="explanation-box" id="p5-exp-${index}">
                <span class="exp-header">üí° Gi·∫£i th√≠ch:</span>
                <div class="exp-content">
                    <div><strong>ƒê√°p √°n:</strong> <span style="color:var(--success); font-weight:bold;">${item.correct[0]}</span></div>
                    <div style="margin-top:5px;">${item.explain}</div>
                </div>
            </div>
        `;
        p5Container.appendChild(div);
    });

    // --- INTERACTION LOGIC ---

    function showExplanation(id) {
        document.getElementById(id).style.display = 'block';
    }

    // Check Part 1
    function checkP1(qIndex, optIndex, btn) {
        const q = part1Data[qIndex];
        q.userChoice = optIndex; // Save user choice for scoring

        const container = document.getElementById(`p1-opts-${qIndex}`);
        const buttons = container.getElementsByClassName('option-btn');
        for(let b of buttons) b.disabled = true;

        if (optIndex === q.correct) {
            btn.classList.add('correct');
            playSound('correct');
        } else {
            btn.classList.add('wrong');
            buttons[q.correct].classList.add('correct');
            playSound('wrong');
        }
        showExplanation(`p1-exp-${qIndex}`);
    }

    // Check Part 2
    function checkP2(index) {
        const input = document.getElementById(`p2-in-${index}`);
        const userVal = input.value.trim().toLowerCase();
        const correctVals = part2Data[index].correct.map(s => s.toLowerCase());
        
        if (correctVals.includes(userVal)) {
            input.style.borderColor = 'var(--success)';
            input.style.backgroundColor = '#e8f5e9';
            playSound('correct');
        } else {
            input.style.borderColor = 'var(--error)';
            input.style.backgroundColor = '#ffebee';
            input.classList.add('shake');
            playSound('wrong');
        }
        showExplanation(`p2-exp-${index}`);
    }

    // Check Part 4
    function checkP4(qIndex, optIndex, btn) {
        const q = part4Data[qIndex];
        q.userChoice = optIndex;

        const container = document.getElementById(`p4-opts-${qIndex}`);
        const buttons = container.getElementsByClassName('option-btn');
        for(let b of buttons) b.disabled = true;

        if (optIndex === q.correct) {
            btn.classList.add('correct');
            playSound('correct');
        } else {
            btn.classList.add('wrong');
            buttons[q.correct].classList.add('correct');
            playSound('wrong');
        }
        showExplanation(`p4-exp-${qIndex}`);
    }

    // Check Part 5
    function checkP5(index) {
        const input = document.getElementById(`p5-in-${index}`);
        const userVal = input.value.trim().toLowerCase();
        const correctVals = part5Data[index].correct.map(s => s.toLowerCase());
        
        if (correctVals.includes(userVal)) {
            input.style.borderColor = 'var(--success)';
            input.style.backgroundColor = '#e8f5e9';
            playSound('correct');
        } else {
            input.style.borderColor = 'var(--error)';
            input.style.backgroundColor = '#ffebee';
            playSound('wrong');
        }
        showExplanation(`p5-exp-${index}`);
    }

    // --- SCORING SYSTEM ---
    
    function finishTest() {
        let score = 0;
        let totalQuestions = 0;

        // Count Part 1
        part1Data.forEach(q => {
            totalQuestions++;
            if (q.userChoice === q.correct) score++;
        });

        // Count Part 2 (Check input value at the time of Submit)
        part2Data.forEach((q, index) => {
            totalQuestions++;
            const input = document.getElementById(`p2-in-${index}`);
            const userVal = input.value.trim().toLowerCase();
            const correctVals = q.correct.map(s => s.toLowerCase());
            if (correctVals.includes(userVal)) score++;
        });

        // Count Part 4
        part4Data.forEach(q => {
            totalQuestions++;
            if (q.userChoice === q.correct) score++;
        });

        // Count Part 5
        part5Data.forEach((q, index) => {
            totalQuestions++;
            const input = document.getElementById(`p5-in-${index}`);
            const userVal = input.value.trim().toLowerCase();
            const correctVals = q.correct.map(s => s.toLowerCase());
            if (correctVals.includes(userVal)) score++;
        });

        // Show Modal
        const modal = document.getElementById('scoreModal');
        const scoreVal = document.getElementById('scoreValue');
        const scorePct = document.getElementById('scorePercent');
        const teacherComment = document.getElementById('teacherComment');

        const percentage = Math.round((score / totalQuestions) * 100);

        scoreVal.innerText = `${score}/${totalQuestions}`;
        scorePct.innerText = `${percentage}% Correct`;

        if (percentage === 100) {
            teacherComment.innerText = "üåü Xu·∫•t s·∫Øc! Con l√†m ƒë√∫ng h·∫øt r·ªìi! C√¥ Mai An r·∫•t t·ª± h√†o!";
        } else if (percentage >= 80) {
            teacherComment.innerText = "üéâ R·∫•t t·ªët! Con n·∫Øm b√†i r·∫•t ch·∫Øc. C·ªë g·∫Øng th√™m ch√∫t n·ªØa ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm tuy·ªát ƒë·ªëi nh√©!";
        } else if (percentage >= 50) {
            teacherComment.innerText = "üôÇ Kh√°! Con ƒë√£ l√†m ƒë∆∞·ª£c m·ªôt n·ª≠a ch·∫∑ng ƒë∆∞·ªùng. H√£y xem l·∫°i ph·∫ßn gi·∫£i th√≠ch c√°c c√¢u sai nh√©.";
        } else {
            teacherComment.innerText = "üí™ ƒê·ª´ng bu·ªìn! H√£y ƒë·ªçc k·ªπ ph·∫ßn gi·∫£i th√≠ch chi ti·∫øt c·ªßa c√¥ v√† l√†m l·∫°i b√†i nh√©!";
        }

        modal.style.display = "flex";
        fireConfetti(2.5); // Big explosion
        
        // Play win sound
        playSound('correct');
    }

    function closeModal() {
        document.getElementById('scoreModal').style.display = "none";
    }

    // --- CONFETTI ---
    const canvas = document.getElementById("confetti-canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let particles = [];
    const colors = ['#8854C0', '#00C9A7', '#FF4757', '#FFD700', '#00D26A'];

    function fireConfetti(intensity = 1) {
        const amount = 100 * intensity;
        for (let i = 0; i < amount; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                w: Math.random() * 10 + 5,
                h: Math.random() * 10 + 5,
                color: colors[Math.floor(Math.random() * colors.length)],
                vy: Math.random() * 5 + 2,
                vx: Math.random() * 4 - 2,
                r: Math.random() * 360
            });
        }
        animateConfetti();
    }

    function animateConfetti() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let activeParticles = false;
        
        particles.forEach((p, i) => {
            p.y += p.vy;
            p.x += p.vx;
            p.r += 2;
            
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.r * Math.PI / 180);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
            ctx.restore();

            if (p.y < canvas.height) activeParticles = true;
            else particles.splice(i, 1);
        });
        
        if (particles.length > 0) requestAnimationFrame(animateConfetti);
    }
    
    // Resume audio context
    document.addEventListener('click', function() {
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    });

</script>

</body>
</html>