<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i Ki·ªÉm Tra Ti·∫øng Anh - Ms Mai An ULIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8854C0;
            --secondary: #FFD166;
            --tertiary: #00C9A7;
            --correct: #00D26A;
            --correct-shadow: #00a854;
            --wrong: #FF4757;
            --wrong-shadow: #d63031;
            --text-main: #2d3436;
            --btn-bg: #ffffff;
            --btn-shadow: #e0e0e0;
        }

        * { box-sizing: border-box; font-family: 'Quicksand', sans-serif; }

        body {
            margin: 0; padding: 20px;
            /* Background h·ªça ti·∫øt vui nh·ªôn Pastel + Neon */
            background: 
                url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M20 20 L25 10 L30 20 L40 25 L30 30 L25 40 L20 30 L10 25 Z" fill="%23ffffff" opacity="0.4"/><circle cx="80" cy="80" r="8" fill="%23ffffff" opacity="0.4"/><path d="M70 20 Q80 10 90 20 Q80 30 70 20" fill="%23ffffff" opacity="0.4"/><circle cx="30" cy="80" r="5" fill="%23ffffff" opacity="0.4"/></svg>'),
                linear-gradient(135deg, var(--primary), var(--secondary), var(--tertiary));
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
        }

        .header {
            text-align: center; background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px; border-radius: 20px; margin: 0 auto 30px;
            max-width: 800px; box-shadow: 0 8px 0 rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 1.2rem; color: var(--primary); margin: 0; font-weight: 900; }

        .container { max-width: 800px; margin: 0 auto; }

        .section-title {
            background: var(--btn-bg); padding: 15px 25px; border-radius: 20px;
            font-size: 1.5rem; font-weight: 900; color: var(--primary);
            margin-bottom: 20px; box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            text-transform: uppercase; text-align: center;
        }

        .card {
            background: #ffffff; border-radius: 20px; padding: 25px;
            margin-bottom: 30px; box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            transition: transform 0.2s; position: relative;
        }

        .question-text { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; line-height: 1.5; }
        .logic-text { background: #f1f2f6; padding: 15px; border-radius: 10px; margin-bottom: 15px; font-weight: 500;}

        /* CSS V·∫Ω Bi·ªÉn b√°o */
        .sign-water {
            border: 3px solid #000; border-radius: 8px; width: 260px; text-align: center; margin: 15px auto; font-family: 'Arial', sans-serif; background: #fff; overflow: hidden;
        }
        .sign-water-header { background: #000; color: #fff; font-weight: 900; padding: 10px; font-size: 1.2em; text-transform: uppercase;}
        .sign-water-body { padding: 15px; display: flex; align-items: center; justify-content: space-between; }
        .sign-water-body span:first-child { font-weight: bold; text-align: left; font-size: 1em; line-height: 1.2;}
        .sign-water-body span:last-child { font-size: 3em; }

        .sign-shop {
            border: 4px solid #000; width: 300px; text-align: center; margin: 15px auto; padding: 15px; font-family: 'Arial', sans-serif; background: #fff;
        }
        .sign-shop-title { font-weight: 900; font-size: 1.3em; letter-spacing: 1px; margin-bottom: 8px; text-transform: uppercase;}
        .sign-shop-text { font-weight: bold; font-size: 1.1em; line-height: 1.4;}

        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media (max-width: 600px) { .options-grid { grid-template-columns: 1fr; } }
        
        /* Grid cho c√¢u d√†i (1 c·ªôt) */
        .options-grid.long-text { grid-template-columns: 1fr; }

        .option-btn {
            background: var(--btn-bg); border: 2px solid #f1f2f6; border-radius: 15px;
            padding: 15px; font-size: 1.1rem; font-weight: 700; color: var(--text-main);
            cursor: pointer; box-shadow: 0 6px 0 var(--btn-shadow);
            transition: all 0.1s ease-in-out; text-align: left; display: flex; align-items: center;
        }
        .option-btn:hover:not(:disabled) { transform: translateY(-3px) scale(1.02); box-shadow: 0 9px 0 var(--btn-shadow); }
        .option-btn:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 2px 0 var(--btn-shadow); }
        .option-btn.correct { background: var(--correct); border-color: var(--correct-shadow); box-shadow: 0 6px 0 var(--correct-shadow); color: white; animation: pop 0.3s; }
        .option-btn.wrong { background: var(--wrong); border-color: var(--wrong-shadow); box-shadow: 0 6px 0 var(--wrong-shadow); color: white; animation: shake 0.4s; }

        .explanation {
            display: none; margin-top: 20px; padding: 20px; background: #f8f9fa;
            border-left: 6px solid var(--tertiary); border-radius: 15px;
            font-size: 1rem; line-height: 1.6; animation: slideDown 0.3s ease-out;
        }
        .explanation.show { display: block; }
        .explanation h4 { margin: 0 0 10px 0; color: var(--primary); font-size: 1.1rem; }
        .step-title { font-weight: 900; color: #d63031; }

        .gap-fill {
            display: inline-block; min-width: 80px; padding: 5px 15px; background: #f1f2f6;
            border: 2px dashed var(--primary); border-radius: 10px; cursor: pointer;
            font-weight: bold; color: var(--primary); text-align: center; transition: 0.2s;
        }
        .gap-fill:hover { background: #eccc68; color: #fff; }
        .gap-fill.answered-correct { background: var(--correct); border-color: var(--correct-shadow); color: white; border-style: solid; }
        .gap-fill.answered-wrong { background: var(--wrong); border-color: var(--wrong-shadow); color: white; border-style: solid; }

        .submit-btn {
            display: block; width: 100%; background: var(--tertiary); color: white;
            border: none; border-radius: 20px; padding: 20px; font-size: 1.5rem;
            font-weight: 900; cursor: pointer; box-shadow: 0 8px 0 #009980;
            transition: all 0.2s; margin-top: 40px; margin-bottom: 50px; text-transform: uppercase;
        }
        .submit-btn:hover { transform: translateY(-3px); box-shadow: 0 11px 0 #009980; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25%, 75% { transform: translateX(-8px); } 50% { transform: translateX(8px); } }
        @keyframes pop { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: white; padding: 30px; border-radius: 25px; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 15px 0 rgba(0,0,0,0.2); animation: pop 0.4s; }
        .modal h2 { color: var(--primary); font-size: 2rem; margin-top: 0;}
        .modal p { font-size: 1.2rem; font-weight: 700;}
        
        .gap-popup { display: none; position: absolute; background: white; border-radius: 15px; padding: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 100; border: 2px solid var(--primary); flex-direction: column; gap: 10px; width: max-content; max-width: 90vw; }
        .gap-popup button { background: white; border: 2px solid #e0e0e0; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; text-align: left;}
        .gap-popup button:hover { background: var(--secondary); border-color: #f1c40f; }

        canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 9999; }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>

    <div class="header">
        <h1>Gi√°o vi√™n t·∫°o: Ms Mai An ULIS</h1>
    </div>

    <div class="container" id="quiz-container">
        </div>

    <div class="container">
        <button class="submit-btn" onclick="submitQuiz()">N·ªôp B√†i L·∫•y ƒêi·ªÉm!</button>
    </div>

    <div class="modal-overlay" id="result-modal">
        <div class="modal">
            <h2>Tuy·ªát V·ªùi! üéâ</h2>
            <p id="score-text"></p>
            <p id="praise-text" style="color: var(--tertiary); font-size: 1.5rem;"></p>
            <button class="submit-btn" style="margin-top:20px; padding: 10px; font-size: 1.2rem;" onclick="location.reload()">Ch∆°i L·∫°i N√†o!</button>
        </div>
    </div>

<script>
// WEB AUDIO API
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(freq, type, duration, vol=0.1) {
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration);
}
function playCorrect() { if(audioCtx.state === 'suspended') audioCtx.resume(); playTone(600, 'sine', 0.1); setTimeout(() => playTone(800, 'sine', 0.2), 100); fireConfetti(); }
function playWrong() { if(audioCtx.state === 'suspended') audioCtx.resume(); playTone(300, 'sawtooth', 0.2, 0.2); setTimeout(() => playTone(250, 'sawtooth', 0.3, 0.2), 150); }

// CONFETTI
const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth; canvas.height = window.innerHeight; let particles = [];
function fireConfetti() {
    for (let i=0; i<100; i++) particles.push({ x: canvas.width/2, y: canvas.height/2, r: Math.random()*6+2, dx: Math.random()*10-5, dy: Math.random()*-10-5, color: `hsl(${Math.random()*360}, 100%, 50%)`, tilt: Math.floor(Math.random()*10)-10, tiltAngle: 0, tiltAngleInc: (Math.random()*0.07)+0.05 });
}
function renderConfetti() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach((p, index) => {
        p.tiltAngle += p.tiltAngleInc; p.y += (Math.cos(p.tiltAngle) + 1 + p.r/2)/2; p.x += Math.sin(p.tiltAngle)*2;
        if (p.y > canvas.height) particles.splice(index, 1);
        ctx.beginPath(); ctx.lineWidth = p.r; ctx.strokeStyle = p.color; ctx.moveTo(p.x+p.tilt+p.r, p.y); ctx.lineTo(p.x+p.tilt, p.y+p.tilt+p.r); ctx.stroke();
    });
    requestAnimationFrame(renderConfetti);
}
renderConfetti();

// DATA PREPARATION
function buildExp(qTrans, ops, correctOp, correctReason, wrongReason) {
    return `
        <span class="step-title">B∆∞·ªõc 1: D·ªãch nghƒ©a/Ph√¢n t√≠ch:</span> ${qTrans}<br><br>
        <span class="step-title">B∆∞·ªõc 2: C√°c l·ª±a ch·ªçn:</span><br>${ops.join('<br>')}<br><br>
        <span class="step-title">B∆∞·ªõc 3: T·∫°i sao ƒë√°p √°n ƒë√∫ng?</span><br><b>ƒê√°p √°n ${correctOp}:</b> ${correctReason}<br><br>
        <span class="step-title">B∆∞·ªõc 4: T·∫°i sao c√°c ƒë√°p √°n c√≤n l·∫°i sai?</span><br>${wrongReason}
    `;
}

const quizData = [
    // --- EXERCISE 2: LOGICAL TEXT ---
    {
        section: "READING - Exercise 2. Choose the correct answer.",
        q: `1. Put the sentences (a-c) in the correct order to make a logical text.<br>
            <div class="logic-text">
            <b>Our town has an environmental problem.</b> _____<br>
            a. In the past, there were a lot of fish in the lake, and people could go fishing or enjoy the beautiful scenery.<br>
            b. The lake has a lot of trash, such as plastic bags and bottles, making the water dirty and harmful to aquatic life.<br>
            c. We have lots of water pollution in Mallard Lake because factories and residents throw waste into the water, affecting both the environment and people's health.
            </div>`, 
        type: "mcq", layout: "grid-2",
        options: [ { text: "A. b-c-a", isCorrect: false }, { text: "B. a-c-b", isCorrect: false }, { text: "C. c-b-a", isCorrect: true }, { text: "D. b-a-c", isCorrect: false } ],
        exp: buildExp("S·∫Øp x·∫øp c√°c c√¢u th√†nh ƒëo·∫°n vƒÉn logic: 'Th·ªã tr·∫•n c√≥ m·ªôt v·∫•n ƒë·ªÅ m√¥i tr∆∞·ªùng...'", ["A. b-c-a", "B. a-c-b", "C. c-b-a", "D. b-a-c"], "C (c-b-a)", "ƒêo·∫°n vƒÉn ƒëi t·ª´ √Ω chung (v·∫•n ƒë·ªÅ) -> chi ti·∫øt (·ªü h·ªì Mallard - c) -> mi√™u t·∫£ r√°c th·∫£i (b) -> h·ªìi t∆∞·ªüng qu√° kh·ª© (a).", "C√°c ƒë√°p √°n kh√°c l√†m ƒë·ª©t g√£y m·∫°ch logic c·ªßa ƒëo·∫°n vƒÉn.")
    },
    {
        q: "2. Choose the sentence that can end the text most appropriately.", 
        type: "mcq", layout: "long-text",
        options: [ 
            { text: "A. And people should not pollute the lake because it is important for the community.", isCorrect: false }, 
            { text: "B. Now, there aren't many fish in the lake, and local fishermen can no longer catch fish for their living.", isCorrect: true }, 
            { text: "C. However, we can still see some of them in the lake, but their numbers are decreasing.", isCorrect: false }, 
            { text: "D. But the lake is so polluted that we cannot swim in it, and this makes people very upset.", isCorrect: false } 
        ],
        exp: buildExp("Ch·ªçn c√¢u k·∫øt th√∫c ƒëo·∫°n vƒÉn tr√™n m·ªôt c√°ch ph√π h·ª£p nh·∫•t.", ["A. M·ªçi ng∆∞·ªùi kh√¥ng n√™n l√†m √¥ nhi·ªÖm...", "B. B√¢y gi·ªù, kh√¥ng c√≤n nhi·ªÅu c√° n·ªØa...", "C. Tuy nhi√™n, ch√∫ng ta v·∫´n th·∫•y m·ªôt v√†i con...", "D. Nh∆∞ng h·ªì qu√° √¥ nhi·ªÖm ƒë·∫øn m·ª©c kh√¥ng th·ªÉ b∆°i..."], "B", "V√¨ c√¢u tr∆∞·ªõc (a) n√≥i v·ªÅ 'In the past' (qu√° kh·ª© c√≥ nhi·ªÅu c√°), n√™n c√¢u ch·ªët d√πng 'Now' (B√¢y gi·ªù) t·∫°o s·ª± t∆∞∆°ng ph·∫£n h·∫≠u qu·∫£ hi·ªán t·∫°i l√† chu·∫©n x√°c nh·∫•t.", "C√°c ƒë√°p √°n kh√°c kh√¥ng li√™n k·∫øt ch·∫∑t ch·∫Ω v·ªõi chi ti·∫øt 'con c√°' ·ªü c√¢u k·ªÅ tr∆∞·ªõc.")
    },

    // --- EXERCISE 3: SIGNS ---
    {
        section: "READING - Exercise 3. Read the sign and indicate the correct answer.",
        q: `1. What does the sign say?
            <div class="sign-water">
                <div class="sign-water-header">Please Don't<br>Waste Water</div>
                <div class="sign-water-body">
                    <span>Protect the<br>environment<br>for our children</span>
                    <span>üö∞</span>
                </div>
            </div>`, 
        type: "mcq", layout: "long-text",
        options: [ 
            { text: "A. You should use more water.", isCorrect: false }, 
            { text: "B. You shouldn't use water.", isCorrect: false }, 
            { text: "C. You should turn off the tap.", isCorrect: false }, 
            { text: "D. You should save water for our children.", isCorrect: true } 
        ],
        exp: buildExp("Bi·ªÉn b√°o n√†y c√≥ nghƒ©a l√† g√¨?", ["A. B·∫°n n√™n d√πng nhi·ªÅu n∆∞·ªõc h∆°n.", "B. B·∫°n kh√¥ng n√™n d√πng n∆∞·ªõc.", "C. B·∫°n n√™n t·∫Øt v√≤i n∆∞·ªõc.", "D. B·∫°n n√™n ti·∫øt ki·ªám n∆∞·ªõc cho con ch√°u ch√∫ng ta."], "D", "'Don't Waste Water' ƒë·ªìng nghƒ©a v·ªõi 'save water' (ti·∫øt ki·ªám n∆∞·ªõc), v√† nh·∫Øc ƒë·∫øn 'for our children' kh·ªõp ho√†n to√†n v·ªõi ƒë√°p √°n D.", "A sai nghƒ©a ho√†n to√†n. B sai v√¨ kh√¥ng ai c·∫•m d√πng n∆∞·ªõc. C l√† m·ªôt h√†nh ƒë·ªông c·ª• th·ªÉ ch·ª© ch∆∞a bao qu√°t to√†n b·ªô th√¥ng ƒëi·ªáp.")
    },
    {
        q: `2. What does the sign say?
            <div class="sign-shop">
                <div class="sign-shop-title">LATE NIGHT SHOPPING</div>
                <div class="sign-shop-text">Until 8 p.m in the week and<br>until 10 p.m at the weekend</div>
            </div>`, 
        type: "mcq", layout: "long-text",
        options: [ 
            { text: "A. On Saturdays and Sundays you can shop at 9 p. m.", isCorrect: true }, 
            { text: "B. On Fridays you can only shop after 8 p. m.", isCorrect: false }, 
            { text: "C. On Mondays you can shop at 9 p. m.", isCorrect: false }, 
            { text: "D. You can shop after 10 p. m at the weekend.", isCorrect: false } 
        ],
        exp: buildExp("Bi·ªÉn b√°o n√†y c√≥ nghƒ©a l√† g√¨?", ["A. T7, CN b·∫°n c√≥ th·ªÉ mua l√∫c 9h t·ªëi.", "B. Th·ª© 6 b·∫°n ch·ªâ c√≥ th·ªÉ mua sau 8h t·ªëi.", "C. Th·ª© 2 b·∫°n c√≥ th·ªÉ mua l√∫c 9h t·ªëi.", "D. B·∫°n c√≥ th·ªÉ mua sau 10h t·ªëi cu·ªëi tu·∫ßn."], "A", "Th·ª© 7 v√† Ch·ªß nh·∫≠t l√† 'weekend' (cu·ªëi tu·∫ßn), c·ª≠a h√†ng m·ªü t·ªõi 10h t·ªëi. Do ƒë√≥ mua l√∫c 9h t·ªëi cu·ªëi tu·∫ßn l√† h·ª£p l·ªá.", "B sai v√¨ th·ª© 6 ƒë√≥ng c·ª≠a l√∫c 8h ch·ª© kh√¥ng ph·∫£i m·ªü sau 8h. C sai v√¨ th·ª© 2 ƒë√≥ng c·ª≠a l√∫c 8h. D sai v√¨ cu·ªëi tu·∫ßn ƒë√≥ng c·ª≠a L√öC 10h.")
    },

    // --- WRITING EXERCISE 1 & 2 (Gi·ªØ nguy√™n d·∫°ng GAP FILL) ---
    {
        section: "WRITING - Exercise 1. Put the conjunction into its correct position.",
        q: "1. A serious road accident happened <span class='gap-fill' data-answer='while' data-wrong='when,before'>[ _____ ]</span> we were waiting for the bus yesterday. <i>(T·ª´ g·ªëc: while)</i>", 
        type: "gap",
        exp: buildExp("M·ªôt v·ª• tai n·∫°n x·∫£y ra <b>trong khi</b> ch√∫ng t√¥i ƒëang ƒë·ª£i xe.", ["while: trong khi", "when: khi"], "while", "T·ª´ n·ªëi 'while' ƒë·∫∑t tr∆∞·ªõc m·ªánh ƒë·ªÅ chia th√¨ QKTD (we were waiting...) ƒë·ªÉ nh·∫•n m·∫°nh h√†nh ƒë·ªông ƒëang k√©o d√†i.", "Sai v·ªã tr√≠ n·∫øu ch·ªçn c√°c ph∆∞∆°ng √°n r√°c.")
    },
    {
        q: "2. Jack can't play games <span class='gap-fill' data-answer='before' data-wrong='after,while'>[ _____ ]</span> he finishes his homework. <i>(T·ª´ g·ªëc: before)</i>", 
        type: "gap",
        exp: buildExp("Jack kh√¥ng th·ªÉ ch∆°i game <b>tr∆∞·ªõc khi</b> c·∫≠u ·∫•y ho√†n th√†nh b√†i t·∫≠p.", ["before: tr∆∞·ªõc khi"], "before", "Logic ng·ªØ nghƒ©a: Ph·∫£i l√†m xong b√†i t·∫≠p r·ªìi m·ªõi ƒë∆∞·ª£c ch∆°i.", "D√πng 'after' (sau khi l√†m xong) th√¨ s·∫Ω b·ªã ng∆∞·ª£c nghƒ©a ƒëen c·ªßa c√¢u.")
    },
    {
        q: "3. It started raining <span class='gap-fill' data-answer='when' data-wrong='while,soon'>[ _____ ]</span> they were putting up the tent. <i>(T·ª´ g·ªëc: when)</i>", 
        type: "gap",
        exp: buildExp("Tr·ªùi b·∫Øt ƒë·∫ßu m∆∞a <b>khi</b> h·ªç ƒëang d·ª±ng l·ªÅu.", ["when: khi"], "when", "Y√™u c·∫ßu c·ªßa ƒë·ªÅ b√†i l√† ch√®n t·ª´ 'when' v√†o ƒë√∫ng v·ªã tr√≠ n·ªëi 2 v·∫ø c√¢u.", "ƒê·ªÅ b·∫Øt bu·ªôc d√πng 'when', n·∫øu d√πng t·ª´ kh√°c l√† sai y√™u c·∫ßu.")
    },
    {
        q: "4. <span class='gap-fill' data-answer='After' data-wrong='Before,When'>[ _____ ]</span> I get my parents' permission, I will go out with my friends. <i>(T·ª´ g·ªëc: after)</i>", 
        type: "gap",
        exp: buildExp("<b>Sau khi</b> t√¥i nh·∫≠n ƒë∆∞·ª£c s·ª± cho ph√©p, t√¥i s·∫Ω ƒëi ch∆°i.", ["After: sau khi"], "After", "Logic nh√¢n qu·∫£: Ph·∫£i xin ph√©p xong (After) th√¨ m·ªõi ƒëi ch∆°i.", "Ch√®n sai v·ªã tr√≠ s·∫Ω l√†m ƒë·∫£o l·ªôn tr·∫≠t t·ª± th·ªùi gian.")
    },
    {
        q: "5. I will call my mom <span class='gap-fill' data-answer='as soon as' data-wrong='so soon,soon that'>[ _____ ]</span> I get the result. <i>(T·ª´ g·ªëc: as soon as)</i>", 
        type: "gap",
        exp: buildExp("T√¥i s·∫Ω g·ªçi cho m·∫π <b>ngay khi</b> nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£.", ["as soon as: ngay khi"], "as soon as", "N·ªëi m·ªánh ƒë·ªÅ T∆∞∆°ng lai ƒë∆°n + as soon as + Hi·ªán t·∫°i ƒë∆°n.", "C√°c t·ª´ r√°c vi·∫øt sai ch√≠nh t·∫£ c·∫•u tr√∫c 'as soon as'.")
    },

    {
        section: "WRITING - Exercise 2. Rewrite the sentences.",
        q: "1. I will pick you up right after you get off the bus. <br>=> I will pick you up <span class='gap-fill' data-answer='as soon as' data-wrong='soon after,so soon'>[ _____ ]</span> you get off the bus.", 
        type: "gap",
        exp: buildExp("ƒê√≥n b·∫°n ngay sau khi xu·ªëng xe. => Vi·∫øt l·∫°i v·ªõi 'soon'.", ["as soon as: ngay khi"], "as soon as", "C·ª•m 'right after' (ngay sau khi) ƒë·ªìng nghƒ©a tuy·ªát ƒë·ªëi v·ªõi 'as soon as'.", "Kh√¥ng c√≥ c·∫•u tr√∫c 'so soon' n·ªëi 2 m·ªánh ƒë·ªÅ.")
    },
    {
        q: "2. The rich girl doesn't often check price tags... <br>=> The rich girl <span class='gap-fill' data-answer='rarely checks' data-wrong='rarely check,is rarely checking'>[ _____ ]</span> price tags when buying brand-name clothes.", 
        type: "gap",
        exp: buildExp("C√¥ g√°i kh√¥ng th∆∞·ªùng xuy√™n ki·ªÉm tra m√°c gi√°. => Vi·∫øt l·∫°i v·ªõi 'rarely'.", ["rarely checks: hi·∫øm khi ki·ªÉm tra"], "rarely checks", "'doesn't often' = 'rarely'. Ch·ªß ng·ªØ 'The rich girl' s·ªë √≠t n√™n 'check' th√™m 's'.", "Sai ng·ªØ ph√°p chia th√¨ hi·ªán t·∫°i ƒë∆°n n·∫øu thi·∫øu 's'.")
    },
    {
        q: "3. During their dinner time, a flash flood swept through their house. <br>=> A flash flood swept through their house <span class='gap-fill' data-answer='while they were having' data-wrong='during they have,when they are having'>[ _____ ]</span> dinner.", 
        type: "gap",
        exp: buildExp("Trong b·ªØa t·ªëi, l≈© qu√©t cu·ªën qua. => Vi·∫øt l·∫°i v·ªõi 'while'.", ["while they were having: trong khi h·ªç ƒëang ƒÉn"], "while they were having", "'During + Noun' chuy·ªÉn th√†nh 'While + S + QKTD (were having)'.", "Sau during kh√¥ng c·ªông m·ªánh ƒë·ªÅ. Sai th√¨ hi·ªán t·∫°i.")
    },
    {
        q: "4. There was heavy snow between 8 p.m. and 11 p.m. yesterday. <br>=> It <span class='gap-fill' data-answer='was snowing heavily' data-wrong='snowed heavy,is snowing heavily'>[ _____ ]</span> at 10 p.m. yesterday.", 
        type: "gap",
        exp: buildExp("C√≥ tuy·∫øt r∆°i d√†y gi·ªØa 8h-11h t·ªëi qua. => Vi·∫øt l·∫°i v·ªõi 'snowing'.", ["was snowing heavily"], "was snowing heavily", "10 gi·ªù t·ªëi qua n·∫±m trong kho·∫£ng 8h-11h, t·ª©c l√† ƒêANG r∆°i -> QKTD (was snowing). T√≠nh t·ª´ 'heavy' chuy·ªÉn th√†nh tr·∫°ng t·ª´ 'heavily'.", "Sai t·ª´ lo·∫°i t√≠nh t·ª´/tr·∫°ng t·ª´ ho·∫∑c chia sai th√¨.")
    },
    {
        q: "5. Josh hates eating carrots and peas. <br>=> Josh <span class='gap-fill' data-answer='never eats' data-wrong='doesn't never eat,never eating'>[ _____ ]</span> carrots and peas.", 
        type: "gap",
        exp: buildExp("Josh gh√©t ƒÉn c√† r·ªët. => Vi·∫øt l·∫°i v·ªõi 'never'.", ["never eats"], "never eats", "Hates (gh√©t) = never eats (kh√¥ng bao gi·ªù ƒÉn). Josh s·ªë √≠t n√™n 'eats' th√™m 's'.", "Ti·∫øng Anh kh√¥ng d√πng ph·ªß ƒë·ªãnh k√©p 'doesn't never'.")
    },
    {
        q: "8. If James doesn't bring a compass, he will get lost... <br>=> <span class='gap-fill' data-answer='Unless' data-wrong='If not,Because'>[ _____ ]</span> James brings a compass, he will get lost...", 
        type: "gap",
        exp: buildExp("N·∫øu James kh√¥ng mang la b√†n... => Vi·∫øt l·∫°i c√¢u ƒëi·ªÅu ki·ªán.", ["Unless: Tr·ª´ khi / N·∫øu kh√¥ng"], "Unless", "C·∫•u tr√∫c c·ªë ƒë·ªãnh: Unless = If ... not.", "Sai c·∫•u tr√∫c c√¢u ƒëi·ªÅu ki·ªán.")
    },

    // --- WRITING EXERCISE 3 (Chuy·ªÉn th√†nh MCQ 4 ƒë√°p √°n theo y√™u c·∫ßu) ---
    {
        section: "WRITING - Exercise 3. Write complete sentences using the given words.",
        q: "1. be / your sister / addict / shop / ?", 
        type: "mcq", layout: "long-text",
        options: [ 
            { text: "A. Does your sister addict to shopping?", isCorrect: false }, 
            { text: "B. Is your sister addict to shopping?", isCorrect: false }, 
            { text: "C. Is your sister addicted to shopping?", isCorrect: true }, 
            { text: "D. Is your sister addicted to shop?", isCorrect: false } 
        ],
        exp: buildExp(
            "D·ªãch: Ch·ªã g√°i b·∫°n c√≥ b·ªã nghi·ªán mua s·∫Øm kh√¥ng?", 
            ["A. D√πng tr·ª£ ƒë·ªông t·ª´ Does l√† sai c·∫•u tr√∫c t√≠nh t·ª´.", "B. Thi·∫øu -ed ·ªü t√≠nh t·ª´ addicted.", "C. Is your sister addicted to shopping?", "D. Sau to ph·∫£i l√† V-ing (shopping) trong c·∫•u tr√∫c n√†y."], 
            "C", 
            "C·∫•u tr√∫c c·ªë ƒë·ªãnh: <b>be addicted to + V-ing/Noun</b> (nghi·ªán c√°i g√¨ ƒë√≥). C√¢u h·ªèi nghi v·∫•n ƒë∆∞a tobe (Is) l√™n ƒë·∫ßu.", 
            "A d√πng sai tr·ª£ ƒë·ªông t·ª´. B sai t·ª´ lo·∫°i (addict). D sai d·∫°ng ƒë·ªông t·ª´ sau gi·ªõi t·ª´ (shop -> shopping)."
        )
    },
    {
        q: "2. We / can't / bargain / prices of goods / supermarkets /.", 
        type: "mcq", layout: "long-text",
        options: [ 
            { text: "A. We can't to bargain the prices of goods at supermarkets.", isCorrect: false }, 
            { text: "B. We can't bargain the prices of goods at supermarkets.", isCorrect: true }, 
            { text: "C. We can't bargaining the prices of goods in supermarkets.", isCorrect: false }, 
            { text: "D. We can't bargain prices of goods on supermarkets.", isCorrect: false } 
        ],
        exp: buildExp(
            "D·ªãch: Ch√∫ng ta kh√¥ng th·ªÉ m·∫∑c c·∫£ gi√° h√†ng h√≥a ·ªü si√™u th·ªã.", 
            ["A. Th·ª´a 'to' sau can't.", "B. We can't bargain the prices of goods at supermarkets.", "C. D√πng V-ing (bargaining) sau can't l√† sai.", "D. D√πng gi·ªõi t·ª´ 'on' cho si√™u th·ªã l√† sai."], 
            "B", 
            "Sau ƒë·ªông t·ª´ khuy·∫øt thi·∫øu 'can't' ƒë·ªông t·ª´ ph·∫£i gi·ªØ nguy√™n th·ªÉ (bargain). Gi·ªõi t·ª´ ch·ªâ ƒë·ªãa ƒëi·ªÉm si√™u th·ªã l√† 'at'.", 
            "A sai v√¨ can't kh√¥ng ƒëi v·ªõi to V. C sai v√¨ can't kh√¥ng ƒëi v·ªõi V-ing. D d√πng sai gi·ªõi t·ª´ ƒë·ªãa ƒëi·ªÉm (on)."
        )
    },
    {
        q: "3. What / you / do / 9 o'clock yesterday morning / ?", 
        type: "mcq", layout: "long-text",
        options: [ 
            { text: "A. What did you do at 9 o'clock yesterday morning?", isCorrect: false }, 
            { text: "B. What was you doing at 9 o'clock yesterday morning?", isCorrect: false }, 
            { text: "C. What are you doing at 9 o'clock yesterday morning?", isCorrect: false }, 
            { text: "D. What were you doing at 9 o'clock yesterday morning?", isCorrect: true } 
        ],
        exp: buildExp(
            "D·ªãch: B·∫°n ƒëang l√†m g√¨ l√∫c 9 gi·ªù s√°ng h√¥m qua?", 
            ["A. Qu√° kh·ª© ƒë∆°n.", "B. Qu√° kh·ª© ti·∫øp di·ªÖn nh∆∞ng sai tobe (was).", "C. Hi·ªán t·∫°i ti·∫øp di·ªÖn.", "D. What were you doing..."], 
            "D", 
            "C√≥ gi·ªù gi·∫•c c·ª• th·ªÉ trong qu√° kh·ª© (9 o'clock yesterday morning) b·∫Øt bu·ªôc d√πng th√¨ Qu√° kh·ª© ti·∫øp di·ªÖn. Ch·ªß ng·ªØ 'you' ƒëi v·ªõi tobe 'were'.", 
            "A sai th√¨ (d√πng qu√° kh·ª© ƒë∆°n). B chia sai tobe cho you. C sai th√¨ (d√πng hi·ªán t·∫°i)."
        )
    },
    {
        q: "4. I / call / make a complaint / the skirt I order / you last week.", 
        type: "mcq", layout: "long-text",
        options: [ 
            { text: "A. I called to make a complaint for the skirt I order you last week.", isCorrect: false }, 
            { text: "B. I called to make a complaint about the skirt I ordered from you last week.", isCorrect: true }, 
            { text: "C. I call making a complaint about the skirt I ordered from you last week.", isCorrect: false }, 
            { text: "D. I was calling to make a complaint about the skirt I order from you last week.", isCorrect: false } 
        ],
        exp: buildExp(
            "D·ªãch: T√¥i g·ªçi ƒëi·ªán ƒë·ªÉ ph√†n n√†n v·ªÅ chi·∫øc v√°y t√¥i ƒë√£ ƒë·∫∑t t·ª´ b·∫°n tu·∫ßn tr∆∞·ªõc.", 
            ["A. Sai gi·ªõi t·ª´ 'for' v√† ch∆∞a chia qu√° kh·ª© t·ª´ 'order'.", "B. I called to make a complaint about the skirt I ordered...", "C. C·∫•u tr√∫c ch·ªâ m·ª•c ƒë√≠ch ph·∫£i d√πng 'to V' (to make), kh√¥ng d√πng V-ing.", "D. Sai th√¨ ·ªü t·ª´ 'order'."], 
            "B", 
            "C·∫•u tr√∫c: <b>make a complaint about sth</b> (ph√†n n√†n V·ªÄ c√°i g√¨). G·ªçi ƒëi·ªán ƒê·ªÇ l√†m g√¨ d√πng to-V (to make). S·ª± vi·ªác ƒë·∫∑t h√†ng di·ªÖn ra tu·∫ßn tr∆∞·ªõc (last week) n√™n ƒë·ªông t·ª´ order ph·∫£i th√™m ƒëu√¥i -ed.", 
            "A d√πng sai gi·ªõi t·ª´ 'for'. C sai ng·ªØ ph√°p ch·ªâ m·ª•c ƒë√≠ch. D chia sai th√¨ ·ªü v·∫ø sau."
        )
    },
    {
        q: "5. When / a natural disaster / happen, / we / must / listen / instruction from local authorities /.", 
        type: "mcq", layout: "long-text",
        options: [ 
            { text: "A. When a natural disaster happens, we must listen the instruction from local authorities.", isCorrect: false }, 
            { text: "B. When a natural disaster happen, we must listen to the instructions from local authorities.", isCorrect: false }, 
            { text: "C. When a natural disaster happens, we must to listen to the instructions from local authorities.", isCorrect: false }, 
            { text: "D. When a natural disaster happens, we must listen to the instructions from local authorities.", isCorrect: true } 
        ],
        exp: buildExp(
            "D·ªãch: Khi thi√™n tai x·∫£y ra, ch√∫ng ta ph·∫£i l·∫Øng nghe ch·ªâ d·∫´n t·ª´ ch√≠nh quy·ªÅn.", 
            ["A. Thi·∫øu gi·ªõi t·ª´ 'to' sau 'listen'.", "B. Thi·∫øu 's' ·ªü ƒë·ªông t·ª´ 'happen'.", "C. Th·ª´a 'to' sau 'must'.", "D. When a natural disaster happens..."], 
            "D", 
            "'a natural disaster' l√† s·ªë √≠t n√™n ƒë·ªông t·ª´ 'happens' ph·∫£i th√™m 's'. C·ª•m ƒë·ªông t·ª´ 'listen to' (l·∫Øng nghe). Sau 'must' ƒë·ªông t·ª´ gi·ªØ nguy√™n th·ªÉ.", 
            "A sai v√¨ listen kh√¥ng ƒëi th·∫≥ng v·ªõi t√¢n ng·ªØ. B chia sai ng√¥i ·ªü v·∫ø 1. C sai c·∫•u tr√∫c ƒë·ªông t·ª´ khuy·∫øt thi·∫øu must."
        )
    },
    {
        q: "6. By / plant trees / and / pick up rubbish, / we / can / improve our environment.", 
        type: "mcq", layout: "long-text",
        options: [ 
            { text: "A. By planting trees and picking up rubbish, we can improve our environment.", isCorrect: true }, 
            { text: "B. By plant trees and pick up rubbish, we can improve our environment.", isCorrect: false }, 
            { text: "C. By planting trees and pick up rubbish, we can improve our environment.", isCorrect: false }, 
            { text: "D. By plant trees and picking up rubbish, we can improve our environment.", isCorrect: false } 
        ],
        exp: buildExp(
            "D·ªãch: B·∫±ng c√°ch tr·ªìng c√¢y v√† nh·∫∑t r√°c, ch√∫ng ta c√≥ th·ªÉ c·∫£i thi·ªán m√¥i tr∆∞·ªùng.", 
            ["A. By planting trees and picking up rubbish...", "B. Gi·ªØ nguy√™n V sau By l√† sai.", "C. Kh√¥ng c√¢n b·∫±ng c·∫•u tr√∫c song song (and).", "D. Kh√¥ng c√¢n b·∫±ng c·∫•u tr√∫c song song (and)."], 
            "A", 
            "Sau gi·ªõi t·ª´ 'By' (b·∫±ng c√°ch), ƒë·ªông t·ª´ b·∫Øt bu·ªôc ph·∫£i ·ªü d·∫°ng <b>V-ing</b> (planting). T·ª´ 'and' n·ªëi 2 ƒë·ªông t·ª´ ƒë·ªìng ƒë·∫≥ng n√™n 'pick' c≈©ng ph·∫£i bi·∫øn th√†nh <b>picking</b>.", 
            "B sai ng·ªØ ph√°p c∆° b·∫£n sau gi·ªõi t·ª´. C v√† D chia ƒë·ªông t·ª´ c·ªçc c·∫°ch, kh√¥ng c√¢n x·ª©ng 2 b√™n ch·ªØ 'and'."
        )
    }
];

// RENDER FUNCTION
let correctCount = 0; let answeredCards = new Set();
function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

function renderQuiz() {
    const container = document.getElementById('quiz-container');
    let html = ''; let currentSection = '';

    quizData.forEach((item, qIndex) => {
        if (item.section && item.section !== currentSection) { html += `<div class="section-title">${item.section}</div>`; currentSection = item.section; }
        html += `<div class="card" id="card-${qIndex}">`;
        
        if (item.type === 'mcq') {
            html += `<div class="question-text">${item.q}</div>`;
            // C√†i ƒë·∫∑t class grid tu·ª≥ theo ƒë·ªô d√†i ƒë√°p √°n
            let gridClass = item.layout === "long-text" ? "options-grid long-text" : "options-grid";
            html += `<div class="${gridClass}">`;
            let opts = [...item.options]; 
            // Kh√¥ng mix ƒë√°p √°n ph·∫ßn logic text ƒë·ªÉ gi·ªØ ƒë√∫ng format A,B,C,D c·ªë ƒë·ªãnh
            if(item.section !== "READING - Exercise 2. Choose the correct answer.") {
                shuffleArray(opts);
            }
            opts.forEach(opt => { 
                // Escape quotes
                let safeText = opt.text.replace(/'/g, "\\'");
                html += `<button class="option-btn" onclick="checkMCQ(${qIndex}, this, ${opt.isCorrect})">${opt.text}</button>`; 
            });
            html += `</div>`;
        } else if (item.type === 'gap') { 
            html += `<div class="question-text">${item.q}</div>`; 
        }

        html += `<div class="explanation" id="exp-${qIndex}"><h4>üí° Gi·∫£i th√≠ch chi ti·∫øt:</h4>${item.exp}</div></div>`;
    });
    container.innerHTML = html; setupGapFills();
}

function checkMCQ(qIndex, btnElement, isCorrect) {
    const card = document.getElementById(`card-${qIndex}`); const buttons = card.querySelectorAll('.option-btn'); const expBox = document.getElementById(`exp-${qIndex}`);
    if (btnElement.classList.contains('correct') || btnElement.classList.contains('wrong') || Array.from(buttons).some(b => b.disabled)) return;
    buttons.forEach(btn => btn.disabled = true);
    answeredCards.add(qIndex);

    if (isCorrect) { btnElement.classList.add('correct'); playCorrect(); correctCount++; } 
    else {
        btnElement.classList.add('wrong'); playWrong();
        buttons.forEach(btn => { if(btn.getAttribute('onclick').includes('true')) btn.style.border = "3px solid var(--correct)"; });
    }
    expBox.classList.add('show');
}

// GAP FILL LOGIC
let activeGap = null;
function setupGapFills() {
    const gaps = document.querySelectorAll('.gap-fill');
    const popup = document.createElement('div'); popup.className = 'gap-popup'; document.body.appendChild(popup);

    gaps.forEach(gap => {
        gap.addEventListener('click', (e) => {
            if (gap.classList.contains('answered-correct') || gap.classList.contains('answered-wrong')) return;
            activeGap = gap; const ans = gap.getAttribute('data-answer'); const wrongs = gap.getAttribute('data-wrong').split(',');
            let opts = [{text: ans, correct: true}, ...wrongs.map(w => ({text: w, correct: false}))]; shuffleArray(opts);
            popup.innerHTML = '';
            opts.forEach(opt => { const btn = document.createElement('button'); btn.innerText = opt.text; btn.onclick = () => selectGap(opt); popup.appendChild(btn); });
            
            const rect = gap.getBoundingClientRect(); 
            popup.style.display = 'flex';
            let topPos = window.scrollY + rect.bottom + 10;
            let leftPos = rect.left;
            if (leftPos + popup.offsetWidth > window.innerWidth) { leftPos = window.innerWidth - popup.offsetWidth - 20; }
            popup.style.top = topPos + 'px'; popup.style.left = leftPos + 'px'; 
        });
    });
    document.addEventListener('click', (e) => { if (!e.target.classList.contains('gap-fill') && !e.target.closest('.gap-popup')) popup.style.display = 'none'; });
}

function selectGap(opt) {
    if (!activeGap) return; const popup = document.querySelector('.gap-popup'); popup.style.display = 'none';
    activeGap.innerText = opt.text; const card = activeGap.closest('.card'); const qIndex = card.id.split('-')[1];

    if (opt.correct) { activeGap.classList.add('answered-correct'); playCorrect(); correctCount++; } 
    else { activeGap.classList.add('answered-wrong'); activeGap.style.animation = 'shake 0.4s'; playWrong(); }
    
    const gapsInCard = card.querySelectorAll('.gap-fill');
    const allAnswered = Array.from(gapsInCard).every(g => g.classList.contains('answered-correct') || g.classList.contains('answered-wrong'));
    if (allAnswered) { document.getElementById(`exp-${qIndex}`).classList.add('show'); answeredCards.add(qIndex); }
}

function submitQuiz() {
    const modal = document.getElementById('result-modal'); const scoreText = document.getElementById('score-text'); const praiseText = document.getElementById('praise-text');
    let totalScore = quizData.reduce((acc, curr) => curr.type === 'gap' ? acc + (curr.q.match(/gap-fill/g) || []).length : acc + 1, 0);
    scoreText.innerText = `B·∫°n ƒë√£ l√†m ƒë√∫ng ${correctCount}/${totalScore} c√¢u h·ªèi & thao t√°c.`;
    
    let ratio = correctCount / totalScore; let praise = "";
    if (ratio === 1) praise = "Th·∫≠t xu·∫•t s·∫Øc! ƒêi·ªÉm 10 kh√¥ng c√≥ nh∆∞ng! üèÜ";
    else if (ratio >= 0.7) praise = "Gi·ªèi l·∫Øm! C·ªë g·∫Øng ch√∫t n·ªØa l√† ho√†n h·∫£o! üåü";
    else if (ratio >= 0.5) praise = "L√†m t·ªët l·∫Øm! H√£y xem l·∫°i ph·∫ßn gi·∫£i th√≠ch nh√©! üëç";
    else praise = "ƒê·ª´ng n·∫£n ch√≠! H·ªçc k·ªπ l·ªói sai s·∫Ω gi√∫p em ti·∫øn b·ªô! üí™";

    praiseText.innerText = praise; modal.style.display = 'flex';
    playCorrect(); fireConfetti(); fireConfetti(); 
}
window.onload = renderQuiz;
</script>
</body>
</html>