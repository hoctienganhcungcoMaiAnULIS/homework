<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Kiểm Tra Ms Mai An ULIS - Past Simple: To Be vs Verb</title>
    <!-- Google Fonts: Quicksand for a friendly look -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Custom Theme Colors */
        :root {
            --primary-purple: #8854C0;
            --primary-teal: #00C9A7;
            --correct-green: #00D26A;
            --wrong-red: #FF4757;
            --bg-pattern: #f0f4f8;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #E0EAFC; 
            background-image: 
                radial-gradient(#8854C0 0.5px, transparent 0.5px), 
                radial-gradient(#00C9A7 0.5px, #E0EAFC 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: #2d3748;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* 3D Button Styles */
        .btn-3d {
            transition: all 0.1s;
            box-shadow: 0px 5px 0px 0px rgba(0,0,0,0.2);
            transform: translateY(0);
        }

        .btn-3d:active {
            transform: translateY(5px);
            box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.2);
        }

        .option-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .option-card:hover:not(.disabled) {
            transform: scale(1.02);
            border-color: var(--primary-purple);
            background-color: #F3E8FF;
        }

        .option-card.correct {
            background-color: #d1fae5;
            border-color: var(--correct-green);
            color: #065f46;
            box-shadow: 0 0 15px rgba(0, 210, 106, 0.4);
        }

        .option-card.wrong {
            background-color: #fee2e2;
            border-color: var(--wrong-red);
            color: #991b1b;
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        .option-card.disabled {
            cursor: default;
            opacity: 0.7;
        }

        /* Animations */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .animate-pop {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Explanation Box */
        .explanation-box {
            border-left: 5px solid var(--primary-purple);
            background: #fff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Progress Bar */
        .progress-container {
            background: rgba(255,255,255,0.5);
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-fill {
            background: linear-gradient(90deg, #00C9A7, #8854C0);
            transition: width 0.5s ease-in-out;
        }

        /* Confetti Canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <canvas id="confetti-canvas"></canvas>

    <!-- Main Container -->
    <div class="w-full max-w-3xl bg-white/90 backdrop-blur-sm rounded-3xl shadow-2xl overflow-hidden animate-pop border-4 border-white">
        
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-4 text-white text-center shadow-lg relative">
            <h1 class="text-2xl md:text-3xl font-bold drop-shadow-md">
                <i class="fas fa-graduation-cap mr-2 text-yellow-300"></i>
                Bài Kiểm Tra Ms Mai An ULIS
            </h1>
            <p class="text-sm md:text-base opacity-90 mt-1">Phân biệt: To Be vs Động từ thường (Quá khứ đơn)</p>
            <div class="absolute top-4 right-4 bg-white/20 px-3 py-1 rounded-full text-sm font-bold backdrop-blur-md">
                Score: <span id="score-display">0</span>
            </div>
        </div>

        <!-- Progress -->
        <div class="px-6 py-4">
            <div class="flex justify-between text-sm text-gray-600 font-bold mb-2">
                <span>Câu hỏi <span id="current-q">1</span>/<span id="total-q">30</span></span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="progress-container h-4 w-full">
                <div id="progress-bar" class="progress-fill h-full w-0"></div>
            </div>
        </div>

        <!-- Quiz Area -->
        <div id="quiz-container" class="p-6 relative">
            <!-- Question Text -->
            <div class="mb-8">
                <div class="bg-indigo-50 rounded-2xl p-6 border-l-8 border-indigo-400 shadow-sm">
                    <h2 id="question-text" class="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed">
                        Loading...
                    </h2>
                </div>
            </div>

            <!-- Options Grid -->
            <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Options will be injected here -->
            </div>
        </div>

        <!-- Explanation Area (Hidden initially) -->
        <div id="explanation-area" class="hidden bg-gray-50 border-t-2 border-gray-100 p-6 animate-pop">
            <div class="explanation-box p-5 rounded-lg">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600">
                        <i class="fas fa-chalkboard-teacher text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-purple-700">Cô Mai An giải thích chi tiết:</h3>
                </div>
                
                <div class="space-y-4 text-gray-700 text-base">
                    <!-- Dynamic Explanation Content -->
                    <div id="detailed-explanation"></div>
                </div>
            </div>
            
            <button id="next-btn" onclick="nextQuestion()" class="mt-6 w-full bg-[#00C9A7] hover:bg-[#00b596] text-white font-bold py-3 px-6 rounded-xl btn-3d text-lg uppercase tracking-wider">
                Câu tiếp theo <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>

        <!-- Result Modal (Hidden) -->
        <div id="result-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl p-8 max-w-md w-full text-center shadow-2xl border-4 border-indigo-200 animate-pop relative">
                <div class="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-yellow-300">
                    <i class="fas fa-trophy text-4xl text-yellow-500"></i>
                </div>
                <h2 class="text-3xl font-bold text-purple-700 mb-2">Tổng Kết</h2>
                <p class="text-gray-500 mb-6">Bạn đã hoàn thành bài kiểm tra!</p>
                
                <div class="bg-gray-100 rounded-xl p-4 mb-6 grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-500" id="final-score">0</div>
                        <div class="text-xs text-gray-500 font-bold uppercase">Điểm số</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-500" id="final-percent">0%</div>
                        <div class="text-xs text-gray-500 font-bold uppercase">Chính xác</div>
                    </div>
                </div>

                <p id="final-message" class="text-lg font-medium text-indigo-600 mb-8 italic">
                    "Tuyệt vời!"
                </p>

                <button onclick="location.reload()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl btn-3d">
                    <i class="fas fa-redo mr-2"></i> Làm lại bài
                </button>
            </div>
        </div>

    </div>

    <!-- Audio Elements (Using Web Audio API in script, but keeping tags for fallback if needed) -->

    <script>
        // --- DATA SOURCE ---
        const quizData = {
          "questions": [
            {
              "questionNumber": 1,
              "question": "He ______ tired yesterday, so he went home early.",
              "answerOptions": [
                { "text": "was", "rationale": "Chính xác! 'Tired' là TÍNH TỪ (mệt mỏi). Ta dùng To Be để miêu tả trạng thái.\n• Cấu trúc: S + was/were + Adj.\n• Dịch: Anh ấy đã mệt vào hôm qua.", "isCorrect": true },
                { "text": "did", "rationale": "Sai. 'Did' là trợ động từ, thường đi kèm với một động từ nguyên thể khác (ví dụ: did not go). Ở đây không có động từ nào.", "isCorrect": false },
                { "text": "were", "rationale": "Sai. Chủ ngữ 'He' (số ít) dùng 'was'.", "isCorrect": false },
                { "text": "had", "rationale": "Sai. 'Had' nghĩa là 'có', không hợp nghĩa với 'mệt'.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 2,
              "question": "______ you go to the cinema last night?",
              "answerOptions": [
                { "text": "Were", "rationale": "Sai. Câu đã có động từ chính là 'go' (đi). Không dùng To Be đi kèm động từ thường nguyên thể.", "isCorrect": false },
                { "text": "Did", "rationale": "Chính xác! Câu hỏi có động từ thường 'go' -> Dùng trợ động từ 'Did'.\n• Cấu trúc: Did + S + V(nguyên thể)?\n• Dịch: Bạn có đi xem phim tối qua không?", "isCorrect": true },
                { "text": "Was", "rationale": "Sai. 'Was' không đi với 'you' và không đi với động từ 'go'.", "isCorrect": false },
                { "text": "Do", "rationale": "Sai thì (Do là hiện tại).", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 3,
              "question": "Where ______ your grandfather born?",
              "answerOptions": [
                { "text": "did", "rationale": "Sai. 'Born' (được sinh ra) được dùng như một tính từ/bị động, luôn đi với To Be, không dùng 'did'.", "isCorrect": false },
                { "text": "was", "rationale": "Chính xác! Cụm từ cố định: 'be born' (được sinh ra). Chủ ngữ 'grandfather' số ít -> dùng 'was'.\n• Dịch: Ông của bạn sinh ra ở đâu?", "isCorrect": true },
                { "text": "were", "rationale": "Sai. Chủ ngữ số ít.", "isCorrect": false },
                { "text": "is", "rationale": "Sai. Việc sinh ra đã xảy ra trong quá khứ.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 4,
              "question": "I ______ hungry, but I didn't have any food.",
              "answerOptions": [
                { "text": "was", "rationale": "Chính xác! 'Hungry' là TÍNH TỪ. Ta dùng To Be.\n• Dịch: Tôi đã đói, nhưng tôi không có chút thức ăn nào.", "isCorrect": true },
                { "text": "did", "rationale": "Sai. Không dùng 'I did hungry'.", "isCorrect": false },
                { "text": "am", "rationale": "Sai thì (vế sau là didn't - quá khứ).", "isCorrect": false },
                { "text": "felt", "rationale": "Đúng ngữ pháp nhưng trong bài trắc nghiệm phân biệt Was/Did thì 'was' là đáp án ưu tiên cho cấu trúc cơ bản S + be + adj.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 5,
              "question": "They ______ happy with the service at the restaurant.",
              "answerOptions": [
                { "text": "weren't", "rationale": "Chính xác! 'Happy' là TÍNH TỪ. Ta dùng To Be (phủ định).\n• Dịch: Họ đã không hài lòng với dịch vụ tại nhà hàng.", "isCorrect": true },
                { "text": "didn't", "rationale": "Sai. Nếu dùng 'didn't', phải có động từ theo sau (ví dụ: didn't feel happy). Ở đây chỉ có tính từ 'happy'.", "isCorrect": false },
                { "text": "don't", "rationale": "Sai thì hiện tại.", "isCorrect": false },
                { "text": "wasn't", "rationale": "Sai. Chủ ngữ 'They' số nhiều.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 6,
              "question": "______ she buy a new car yesterday?",
              "answerOptions": [
                { "text": "Did", "rationale": "Chính xác! Có động từ chính 'buy' (mua) -> Dùng trợ động từ 'Did'.\n• Dịch: Cô ấy đã mua một chiếc xe mới hôm qua phải không?", "isCorrect": true },
                { "text": "Was", "rationale": "Sai. To Be không đi với động từ nguyên thể 'buy'.", "isCorrect": false },
                { "text": "Were", "rationale": "Sai tương tự.", "isCorrect": false },
                { "text": "Does", "rationale": "Sai thì hiện tại.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 7,
              "question": "We ______ at home last Sunday. We went to the park.",
              "answerOptions": [
                { "text": "weren't", "rationale": "Chính xác! 'At home' là cụm giới từ chỉ VỊ TRÍ. Dùng To Be.\n• Ngữ cảnh: Chúng tôi ĐÃ KHÔNG ở nhà (vì chúng tôi đi công viên). -> Weren't.\n• Dịch: Chúng tôi đã không ở nhà chủ nhật trước.", "isCorrect": true },
                { "text": "didn't", "rationale": "Sai. Không dùng 'didn't' với cụm chỉ nơi chốn (at home) nếu thiếu động từ (như stay).", "isCorrect": false },
                { "text": "wasn't", "rationale": "Sai. Chủ ngữ 'We' số nhiều.", "isCorrect": false },
                { "text": "aren't", "rationale": "Sai thì hiện tại.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 8,
              "question": "Why ______ you sad yesterday?",
              "answerOptions": [
                { "text": "did", "rationale": "Sai. 'Sad' là TÍNH TỪ. Không dùng 'did' trực tiếp với tính từ.", "isCorrect": false },
                { "text": "were", "rationale": "Chính xác! Sad (buồn) là tính từ -> dùng To Be. Chủ ngữ You -> dùng 'were'.\n• Dịch: Tại sao hôm qua bạn buồn?", "isCorrect": true },
                { "text": "was", "rationale": "Sai. 'You' đi với 'were'.", "isCorrect": false },
                { "text": "are", "rationale": "Sai thì hiện tại.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 9,
              "question": "Why ______ you cry yesterday?",
              "answerOptions": [
                { "text": "were", "rationale": "Sai. Câu có động từ 'cry' (khóc). To Be không đi với động từ nguyên thể.", "isCorrect": false },
                { "text": "did", "rationale": "Chính xác! Có động từ chỉ hành động 'cry' -> Dùng trợ động từ 'Did'.\n• Dịch: Tại sao hôm qua bạn lại khóc?", "isCorrect": true },
                { "text": "was", "rationale": "Sai ngữ pháp.", "isCorrect": false },
                { "text": "do", "rationale": "Sai thì hiện tại.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 10,
              "question": "It ______ very cold last night.",
              "answerOptions": [
                { "text": "was", "rationale": "Chính xác! 'Cold' là TÍNH TỪ chỉ thời tiết. Dùng To Be.\n• Dịch: Tối qua trời rất lạnh.", "isCorrect": true },
                { "text": "did", "rationale": "Sai. Không dùng 'did cold'.", "isCorrect": false },
                { "text": "were", "rationale": "Sai. Chủ ngữ 'It' số ít.", "isCorrect": false },
                { "text": "is", "rationale": "Sai thì hiện tại.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 11,
              "question": "______ you see the match on TV?",
              "answerOptions": [
                { "text": "Did", "rationale": "Chính xác! Có động từ 'see' (xem/nhìn) -> Dùng 'Did'.\n• Dịch: Bạn có xem trận đấu trên TV không?", "isCorrect": true },
                { "text": "Were", "rationale": "Sai. To Be không đi với 'see'.", "isCorrect": false },
                { "text": "Was", "rationale": "Sai.", "isCorrect": false },
                { "text": "Had", "rationale": "Sai.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 12,
              "question": "Who ______ the first person in the room?",
              "answerOptions": [
                { "text": "did", "rationale": "Sai. Câu hỏi 'Ai LÀ người đầu tiên'. 'Person' là danh từ, cần động từ nối To Be.", "isCorrect": false },
                { "text": "was", "rationale": "Chính xác! Hỏi về danh tính/đối tượng (LÀ ai) -> Dùng To Be. 'Who' thường chia số ít -> 'was'.\n• Dịch: Ai là người đầu tiên ở trong phòng?", "isCorrect": true },
                { "text": "were", "rationale": "Thường dùng 'was' trừ khi biết chắc chắn câu trả lời là số nhiều.", "isCorrect": false },
                { "text": "is", "rationale": "Sai thì (ngữ cảnh quá khứ 'first person' thường kể lại).", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 13,
              "question": "I ______ agree with his opinion.",
              "answerOptions": [
                { "text": "wasn't", "rationale": "Sai. 'Agree' là ĐỘNG TỪ (đồng ý). Không dùng 'wasn't agree'.", "isCorrect": false },
                { "text": "didn't", "rationale": "Chính xác! 'Agree' là động từ thường -> Phủ định dùng 'didn't'.\n• Dịch: Tôi đã không đồng ý với ý kiến của anh ấy.", "isCorrect": true },
                { "text": "not", "rationale": "Sai ngữ pháp (thiếu trợ động từ).", "isCorrect": false },
                { "text": "don't", "rationale": "Sai thì (nếu ngữ cảnh là quá khứ).", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 14,
              "question": "My parents ______ teachers.",
              "answerOptions": [
                { "text": "did", "rationale": "Sai.", "isCorrect": false },
                { "text": "were", "rationale": "Chính xác! 'Teachers' là DANH TỪ chỉ nghề nghiệp. Dùng To Be để giới thiệu nghề nghiệp.\n• Dịch: Bố mẹ tôi (đã từng) là giáo viên.", "isCorrect": true },
                { "text": "was", "rationale": "Sai. 'Parents' số nhiều.", "isCorrect": false },
                { "text": "had", "rationale": "Sai nghĩa.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 15,
              "question": "______ they play football yesterday?",
              "answerOptions": [
                { "text": "Were", "rationale": "Sai. Có động từ 'play' -> không dùng Were.", "isCorrect": false },
                { "text": "Did", "rationale": "Chính xác! Động từ hành động 'play' -> Dùng 'Did'.\n• Dịch: Họ có chơi bóng đá hôm qua không?", "isCorrect": true },
                { "text": "Do", "rationale": "Sai thì hiện tại.", "isCorrect": false },
                { "text": "Are", "rationale": "Sai thì hiện tại.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 16,
              "question": "The movie ______ boring. I fell asleep.",
              "answerOptions": [
                { "text": "was", "rationale": "Chính xác! 'Boring' là TÍNH TỪ. Dùng To Be.\n• Dịch: Bộ phim thật nhàm chán. Tôi đã ngủ gật.", "isCorrect": true },
                { "text": "did", "rationale": "Sai.", "isCorrect": false },
                { "text": "were", "rationale": "Sai. 'Movie' số ít.", "isCorrect": false },
                { "text": "felt", "rationale": "Sai. Phim 'thì' chán (bản chất), không phải phim 'cảm thấy' chán.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 17,
              "question": "When ______ you start learning English?",
              "answerOptions": [
                { "text": "were", "rationale": "Sai. Có động từ 'start' (bắt đầu).", "isCorrect": false },
                { "text": "did", "rationale": "Chính xác! Có động từ 'start' -> Dùng 'Did'.\n• Dịch: Bạn bắt đầu học tiếng Anh khi nào?", "isCorrect": true },
                { "text": "was", "rationale": "Sai.", "isCorrect": false },
                { "text": "are", "rationale": "Sai thì.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 18,
              "question": "______ he angry with you?",
              "answerOptions": [
                { "text": "Did", "rationale": "Sai. 'Angry' là TÍNH TỪ. Không dùng 'Did he angry'.", "isCorrect": false },
                { "text": "Was", "rationale": "Chính xác! Angry (tức giận) là tính từ -> Dùng To Be.\n• Dịch: Anh ấy có giận bạn không?", "isCorrect": true },
                { "text": "Were", "rationale": "Sai. 'He' là số ít.", "isCorrect": false },
                { "text": "Does", "rationale": "Sai thì.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 19,
              "question": "They ______ come to the party because they were busy.",
              "answerOptions": [
                { "text": "weren't", "rationale": "Sai. Có động từ 'come' (đến). Không dùng 'weren't come'.", "isCorrect": false },
                { "text": "didn't", "rationale": "Chính xác! Động từ 'come' -> Phủ định dùng 'didn't'.\n• Dịch: Họ đã không đến bữa tiệc vì họ bận.", "isCorrect": true },
                { "text": "wasn't", "rationale": "Sai.", "isCorrect": false },
                { "text": "don't", "rationale": "Sai thì.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 20,
              "question": "Where ______ your shoes? I couldn't find them.",
              "answerOptions": [
                { "text": "did", "rationale": "Sai. Hỏi về vị trí của vật (ở đâu), không có động từ hành động -> Dùng To Be.", "isCorrect": false },
                { "text": "were", "rationale": "Chính xác! Shoes (số nhiều) + Vị trí -> Dùng 'were'.\n• Dịch: Giày của bạn ở đâu? Tôi không tìm thấy chúng.", "isCorrect": true },
                { "text": "was", "rationale": "Sai. 'Shoes' số nhiều.", "isCorrect": false },
                { "text": "are", "rationale": "Sai thì (ngữ cảnh 'couldn't' là quá khứ).", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 21,
              "question": "I ______ a student at this school 5 years ago.",
              "answerOptions": [
                { "text": "was", "rationale": "Chính xác! 'A student' là DANH TỪ. Dùng To Be.\n• Dịch: Tôi là một học sinh tại trường này 5 năm trước.", "isCorrect": true },
                { "text": "did", "rationale": "Sai.", "isCorrect": false },
                { "text": "were", "rationale": "Sai. 'I' đi với 'was'.", "isCorrect": false },
                { "text": "am", "rationale": "Sai thì.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 22,
              "question": "What ______ you do last weekend?",
              "answerOptions": [
                { "text": "were", "rationale": "Sai. Có động từ 'do' (làm). Không dùng 'What were you do'.", "isCorrect": false },
                { "text": "did", "rationale": "Chính xác! Động từ chính là 'do' -> Trợ động từ là 'did'.\n• Dịch: Bạn đã làm gì cuối tuần trước?", "isCorrect": true },
                { "text": "was", "rationale": "Sai.", "isCorrect": false },
                { "text": "are", "rationale": "Sai thì.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 23,
              "question": "______ it rain heavily yesterday?",
              "answerOptions": [
                { "text": "Was", "rationale": "Sai. 'Rain' ở đây là động từ. Nếu dùng Was phải là 'Was it rainy?'.", "isCorrect": false },
                { "text": "Did", "rationale": "Chính xác! 'Rain' là động từ (mưa) -> Dùng 'Did'.\n• Dịch: Hôm qua trời có mưa to không?", "isCorrect": true },
                { "text": "Is", "rationale": "Sai thì.", "isCorrect": false },
                { "text": "Were", "rationale": "Sai.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 24,
              "question": "The children ______ in the garden.",
              "answerOptions": [
                { "text": "did", "rationale": "Sai.", "isCorrect": false },
                { "text": "were", "rationale": "Chính xác! 'In the garden' là cụm giới từ chỉ VỊ TRÍ. Dùng To Be. 'Children' số nhiều -> 'were'.\n• Dịch: Bọn trẻ đã ở trong vườn.", "isCorrect": true },
                { "text": "was", "rationale": "Sai. 'Children' là số nhiều.", "isCorrect": false },
                { "text": "stayed", "rationale": "Cũng đúng ngữ pháp nhưng đề bài yêu cầu phân biệt To Be và Did, và 'were' là đáp án trực tiếp nhất cho cấu trúc vị trí.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 25,
              "question": "______ you visit the museum?",
              "answerOptions": [
                { "text": "Did", "rationale": "Chính xác! Động từ 'visit' (thăm) -> Dùng 'Did'.\n• Dịch: Bạn có đi thăm bảo tàng không?", "isCorrect": true },
                { "text": "Were", "rationale": "Sai. To Be không đi với 'visit'.", "isCorrect": false },
                { "text": "Was", "rationale": "Sai.", "isCorrect": false },
                { "text": "Are", "rationale": "Sai thì.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 26,
              "question": "The food ______ delicious, but it ______ expensive.",
              "answerOptions": [
                { "text": "was / was", "rationale": "Chính xác! 'Delicious' (ngon) và 'Expensive' (đắt) đều là TÍNH TỪ. Cả 2 vế đều dùng To Be.\n• Dịch: Đồ ăn thì ngon, nhưng nó đắt.", "isCorrect": true },
                { "text": "did / did", "rationale": "Sai.", "isCorrect": false },
                { "text": "was / did", "rationale": "Sai.", "isCorrect": false },
                { "text": "were / were", "rationale": "Sai. 'Food' và 'It' là số ít.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 27,
              "question": "I ______ know the answer.",
              "answerOptions": [
                { "text": "wasn't", "rationale": "Sai. 'Know' là động từ. Không dùng 'wasn't know'.", "isCorrect": false },
                { "text": "didn't", "rationale": "Chính xác! Động từ 'know' -> Phủ định dùng 'didn't'.\n• Dịch: Tôi đã không biết câu trả lời.", "isCorrect": true },
                { "text": "not", "rationale": "Sai ngữ pháp.", "isCorrect": false },
                { "text": "don't", "rationale": "Sai thì (nếu ngữ cảnh quá khứ).", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 28,
              "question": "______ your holiday fun?",
              "answerOptions": [
                { "text": "Did", "rationale": "Sai. 'Fun' ở đây đóng vai trò tính từ/danh từ chỉ tính chất, không phải động từ hành động.", "isCorrect": false },
                { "text": "Was", "rationale": "Chính xác! 'Holiday' (kỳ nghỉ) là chủ ngữ số ít, 'fun' là tính từ -> Dùng 'Was'.\n• Dịch: Kỳ nghỉ của bạn có vui không?", "isCorrect": true },
                { "text": "Were", "rationale": "Sai. Chủ ngữ số ít.", "isCorrect": false },
                { "text": "Is", "rationale": "Sai thì.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 29,
              "question": "We ______ watch TV, we read books.",
              "answerOptions": [
                { "text": "weren't", "rationale": "Sai. Có động từ 'watch'.", "isCorrect": false },
                { "text": "didn't", "rationale": "Chính xác! Phủ định hành động 'watch' -> Dùng 'didn't'.\n• Dịch: Chúng tôi đã không xem TV, chúng tôi đọc sách.", "isCorrect": true },
                { "text": "wasn't", "rationale": "Sai.", "isCorrect": false },
                { "text": "don't", "rationale": "Sai thì.", "isCorrect": false }
              ]
            },
            {
              "questionNumber": 30,
              "question": "______ they late for school?",
              "answerOptions": [
                { "text": "Did", "rationale": "Sai. 'Late' là TÍNH TỪ (muộn). Không dùng 'Did they late'.", "isCorrect": false },
                { "text": "Were", "rationale": "Chính xác! Late (muộn) là tính từ -> Dùng To Be. They -> Dùng Were.\n• Dịch: Họ có bị muộn học không?", "isCorrect": true },
                { "text": "Was", "rationale": "Sai. Chủ ngữ số nhiều.", "isCorrect": false },
                { "text": "Do", "rationale": "Sai thì.", "isCorrect": false }
              ]
            }
          ]
        };

        // --- GAME STATE ---
        let currentQuestionIndex = 0;
        let score = 0;
        const totalQuestions = quizData.questions.length;
        let isQuestionAnswered = false;

        // --- AUDIO ENGINE (Web Audio API for No-Dependency Sounds) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'correct') {
                // Ding sound (High pitch sine wave)
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.5);
            } else if (type === 'wrong') {
                // Buzz sound (Sawtooth wave, descending)
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
                
                // Add a second "Téo" part
                setTimeout(() => {
                    const osc2 = audioCtx.createOscillator();
                    const gain2 = audioCtx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioCtx.destination);
                    osc2.type = 'sawtooth';
                    osc2.frequency.setValueAtTime(100, audioCtx.currentTime);
                    osc2.frequency.linearRampToValueAtTime(80, audioCtx.currentTime + 0.4);
                    gain2.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                    osc2.start();
                    osc2.stop(audioCtx.currentTime + 0.4);
                }, 150);
            }
        }

        // --- CONFETTI ENGINE ---
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        let confettiParticles = [];
        
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;

        function createConfetti() {
            confettiParticles = [];
            const colors = ['#8854C0', '#00C9A7', '#FFD700', '#FF4757', '#00D26A'];
            for (let i = 0; i < 150; i++) {
                confettiParticles.push({
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2,
                    w: Math.random() * 10 + 5,
                    h: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20 - 5,
                    gravity: 0.5,
                    rotation: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 10
                });
            }
            animateConfetti();
        }

        function animateConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            let active = false;
            
            confettiParticles.forEach((p, index) => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += p.gravity;
                p.rotation += p.rotationSpeed;
                
                if (p.y < confettiCanvas.height) active = true;

                confettiCtx.save();
                confettiCtx.translate(p.x, p.y);
                confettiCtx.rotate(p.rotation * Math.PI / 180);
                confettiCtx.fillStyle = p.color;
                confettiCtx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
                confettiCtx.restore();
            });

            if (active) requestAnimationFrame(animateConfetti);
        }

        // --- MAIN LOGIC ---

        function initQuiz() {
            renderQuestion();
            updateProgress();
            document.getElementById('total-q').textContent = totalQuestions;
        }

        function updateProgress() {
            const percent = ((currentQuestionIndex) / totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-percent').textContent = `${Math.round(percent)}%`;
            document.getElementById('current-q').textContent = currentQuestionIndex + 1;
            document.getElementById('score-display').textContent = score;
        }

        function renderQuestion() {
            const q = quizData.questions[currentQuestionIndex];
            const qText = document.getElementById('question-text');
            const optionsGrid = document.getElementById('options-grid');
            const explanationArea = document.getElementById('explanation-area');

            // Reset UI
            isQuestionAnswered = false;
            explanationArea.classList.add('hidden');
            optionsGrid.innerHTML = '';
            
            // Set Question Text
            qText.innerHTML = q.question.replace(/______/g, '<span class="text-indigo-500 border-b-2 border-indigo-500 px-2 inline-block">______</span>');

            // Render Options
            q.answerOptions.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = `option-card p-6 flex items-center btn-3d`;
                btn.onclick = () => checkAnswer(idx, btn);
                
                const label = String.fromCharCode(65 + idx); // A, B, C, D
                
                btn.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold flex items-center justify-center mr-4 group-hover:bg-white group-hover:text-purple-600 border-2 border-gray-200">
                        ${label}
                    </div>
                    <span class="text-lg font-semibold">${opt.text}</span>
                `;
                optionsGrid.appendChild(btn);
            });
        }

        function checkAnswer(selectedIndex, btnElement) {
            if (isQuestionAnswered) return;
            isQuestionAnswered = true;

            const q = quizData.questions[currentQuestionIndex];
            const selectedOpt = q.answerOptions[selectedIndex];
            const allBtns = document.querySelectorAll('.option-card');

            // Find correct index
            const correctIndex = q.answerOptions.findIndex(o => o.isCorrect);

            // Highlight Logic
            if (selectedOpt.isCorrect) {
                // Correct
                btnElement.classList.add('correct');
                playSound('correct');
                createConfetti();
                score += 10;
            } else {
                // Wrong
                btnElement.classList.add('wrong');
                allBtns[correctIndex].classList.add('correct'); // Show correct answer
                playSound('wrong');
            }

            // Disable all buttons
            allBtns.forEach(btn => btn.classList.add('disabled'));

            // Show Explanation
            showDetailedExplanation(q, selectedIndex);
            updateProgress();
        }

        function showDetailedExplanation(questionData, selectedIndex) {
            const expArea = document.getElementById('explanation-area');
            const detailContainer = document.getElementById('detailed-explanation');
            
            expArea.classList.remove('hidden');

            let htmlContent = `
                <div class="mb-3 font-semibold text-lg border-b pb-2">
                    <span class="text-indigo-600"><i class="fas fa-language"></i> Dịch câu hỏi:</span>
                    <span class="italic text-gray-600 block mt-1">"${extractTranslation(questionData)}"</span>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-bold text-gray-700 mb-2">Phân tích các đáp án:</h4>
                    <ul class="space-y-2">
            `;

            questionData.answerOptions.forEach((opt, idx) => {
                const label = String.fromCharCode(65 + idx);
                const isCorrect = opt.isCorrect;
                const colorClass = isCorrect ? "text-green-600 font-bold" : "text-gray-500";
                const icon = isCorrect ? '<i class="fas fa-check-circle ml-1"></i>' : '';
                
                // Format rationale nicely
                let rationaleText = opt.rationale.replace(/\n/g, '<br>');

                htmlContent += `
                    <li class="p-3 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-white border border-gray-100'}">
                        <span class="text-purple-600 font-bold mr-2">${label}. ${opt.text}</span>
                        <span class="${colorClass}">${icon}</span>
                        <div class="mt-1 text-sm text-gray-700 ml-6 border-l-2 border-gray-300 pl-2">
                            ${rationaleText}
                        </div>
                    </li>
                `;
            });

            htmlContent += `</ul></div>`;
            
            detailContainer.innerHTML = htmlContent;
            
            // Auto scroll to explanation
            setTimeout(() => {
                expArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        // Helper to extract translation from the rationale text if possible
        // Since the JSON puts translation inside rationale like "• Dịch: ...", we try to find it in the Correct Answer's rationale.
        function extractTranslation(qData) {
            const correctOpt = qData.answerOptions.find(o => o.isCorrect);
            if (!correctOpt) return "Không có bản dịch.";
            
            const match = correctOpt.rationale.match(/Dịch:\s*(.*?)(\n|$)/);
            if (match && match[1]) {
                return match[1];
            }
            return "Hãy xem bản dịch trong phần giải thích bên dưới.";
        }

        function nextQuestion() {
            if (currentQuestionIndex < totalQuestions - 1) {
                currentQuestionIndex++;
                renderQuestion();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                finishQuiz();
            }
        }

        function finishQuiz() {
            const modal = document.getElementById('result-modal');
            const scoreText = document.getElementById('final-score');
            const percentText = document.getElementById('final-percent');
            const msg = document.getElementById('final-message');

            const percent = Math.round((score / (totalQuestions * 10)) * 100);
            
            scoreText.textContent = score;
            percentText.textContent = `${percent}%`;
            
            if (percent >= 90) msg.textContent = "Xuất sắc! Bạn là bậc thầy ngữ pháp!";
            else if (percent >= 70) msg.textContent = "Làm tốt lắm! Chỉ còn vài lỗi nhỏ thôi.";
            else msg.textContent = "Cố gắng lên nhé! Hãy ôn lại các kiến thức chưa vững.";

            modal.classList.remove('hidden');
            playSound('correct');
            createConfetti();
        }

        // --- INIT ---
        window.onload = initQuiz;

    </script>
</body>
</html>
