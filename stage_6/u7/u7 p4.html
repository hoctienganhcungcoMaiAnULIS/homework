<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i T·∫≠p Qu√° Kh·ª© Ti·∫øp Di·ªÖn - Ms Mai An ULIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8854C0; /* H·ªìng t√≠m pastel */
            --secondary: #00C9A7; /* Xanh ng·ªçc */
            --correct: #00D26A; /* Xanh l√° */
            --wrong: #FF4757; /* ƒê·ªè cam */
            --bg-pattern: radial-gradient(#e9e9e9 1px, transparent 1px);
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f3f5;
            background-image: var(--bg-pattern);
            background-size: 20px 20px;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(136, 84, 192, 0.2);
            padding: 30px;
            position: relative;
            overflow: hidden;
            border: 4px solid var(--primary);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px dashed #ddd;
            padding-bottom: 10px;
        }

        .header h4 {
            color: var(--primary);
            margin: 0;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.2rem;
        }

        .progress-bar {
            background: #eee;
            height: 10px;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--secondary);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Question */
        .question-box {
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            margin: 20px 0 30px;
            color: #2c3e50;
        }

        /* Options */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }

        .option-btn {
            background: white;
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 15px;
            font-size: 1.1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #ddd; /* 3D effect */
            position: relative;
            text-align: left;
        }

        .option-btn:hover:not(:disabled) {
            transform: scale(1.02);
            border-color: var(--secondary);
        }

        .option-btn:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: none;
        }

        .option-btn.correct {
            background-color: var(--correct);
            color: white;
            border-color: var(--correct);
            box-shadow: 0 4px 0 #009e4d;
        }

        .option-btn.wrong {
            background-color: var(--wrong);
            color: white;
            border-color: var(--wrong);
            box-shadow: 0 4px 0 #c22a38;
            animation: shake 0.5s;
        }

        /* Explanation */
        .explanation-box {
            margin-top: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid var(--primary);
            padding: 20px;
            display: none; /* Hidden by default */
            animation: slideDown 0.4s ease;
        }

        .exp-header {
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .exp-header::before {
            content: 'üí°';
            margin-right: 8px;
            font-size: 1.5rem;
        }

        .exp-content p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .vocab-list {
            margin-top: 10px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #eee;
        }

        .vocab-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #eee;
            padding: 5px 0;
        }
        
        .vocab-item:last-child { border-bottom: none; }
        .vocab-word { font-weight: 700; color: #333; }
        .vocab-type { font-style: italic; color: #888; font-size: 0.9rem; }
        .vocab-mean { color: var(--secondary); font-weight: 600; }

        .why-correct { color: var(--correct); font-weight: bold; }
        .why-wrong { color: var(--wrong); }

        /* Next Button */
        .next-btn {
            display: none;
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            border: none;
            border-radius: 15px;
            background: var(--primary);
            color: white;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 5px 0 #6c429c;
            transition: transform 0.2s;
        }

        .next-btn:hover {
            transform: translateY(-2px);
        }

        .next-btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        /* Animations */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Result Popup */
        .popup-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .score-circle {
            width: 120px;
            height: 120px;
            background: var(--secondary);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 2.5rem;
            font-weight: 800;
            border: 5px solid white;
            box-shadow: 0 0 0 5px var(--secondary);
        }

        @keyframes zoomIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Canvas for Confetti */
        #confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }
    </style>
</head>
<body>

    <canvas id="confetti"></canvas>

    <div class="container">
        <div class="header">
            <h4>Gi√°o vi√™n t·∫°o: Ms Mai An ULIS</h4>
            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-weight: bold; color: #666;">
                <span id="q-number">C√¢u 1/30</span>
                <span id="score-display">ƒêi·ªÉm: 0</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
        </div>

        <div id="quiz-area">
            <div class="question-box" id="question-text">
                </div>

            <div class="options-grid" id="options-area">
                </div>

            <div class="explanation-box" id="explanation">
                <div class="exp-header">C√¥ Mai An gi·∫£i th√≠ch chi ti·∫øt:</div>
                <div class="exp-content" id="exp-content">
                    </div>
            </div>

            <button class="next-btn" id="next-btn" onclick="nextQuestion()">C√¢u ti·∫øp theo ‚ûú</button>
            <button class="next-btn" id="finish-btn" onclick="showResult()" style="display:none; background-color: #FF4757;">N·ªôp b√†i & Xem ƒëi·ªÉm</button>
        </div>
    </div>

    <div class="popup-overlay" id="result-popup">
        <div class="popup-content">
            <div class="score-circle" id="final-score">10/10</div>
            <h2 style="color: var(--primary);">Ch√∫c m·ª´ng!</h2>
            <p id="feedback-msg" style="font-size: 1.1rem; color: #555;">B·∫°n ƒë√£ l√†m r·∫•t t·ªët!</p>
            <button onclick="location.reload()" class="next-btn" style="display: block; margin-top: 20px;">L√†m l·∫°i b√†i</button>
        </div>
    </div>

    <script>
        // --- DATA B√ÄI T·∫¨P (30 C√¢u - Generated based on provided theory) ---
        const rawQuestions = [
            {
                q: "At 7 p.m yesterday, I ______ dinner with my family.",
                opts: ["cooked", "was cooking", "cook", "am cooking"],
                correct: 1, // B
                trans: "V√†o l√∫c 7 gi·ªù t·ªëi h√¥m qua, t√¥i ƒëang n·∫•u b·ªØa t·ªëi c√πng gia ƒë√¨nh.",
                vocab: [
                    {w: "cook", t: "v", m: "n·∫•u ƒÉn"},
                    {w: "dinner", t: "n", m: "b·ªØa t·ªëi"}
                ],
                why: "C√≥ m·ªëc th·ªùi gian c·ª• th·ªÉ trong qu√° kh·ª© 'At 7 p.m yesterday' n√™n d√πng th√¨ Qu√° kh·ª© ti·∫øp di·ªÖn (S + was/were + V-ing).",
                wrong: "A l√† qu√° kh·ª© ƒë∆°n (d√πng cho hƒë ƒë√£ xong). C l√† hi·ªán t·∫°i ƒë∆°n. D l√† hi·ªán t·∫°i ti·∫øp di·ªÖn."
            },
            {
                q: "They ______ badminton when I came yesterday.",
                opts: ["played", "are playing", "were playing", "play"],
                correct: 2, // C
                trans: "H·ªç ƒëang ch∆°i c·∫ßu l√¥ng khi t√¥i ƒë·∫øn ng√†y h√¥m qua.",
                vocab: [
                    {w: "badminton", t: "n", m: "c·∫ßu l√¥ng"},
                    {w: "come/came", t: "v", m: "ƒë·∫øn"}
                ],
                why: "H√†nh ƒë·ªông 'ch∆°i c·∫ßu l√¥ng' ƒëang x·∫£y ra (QKTD) th√¨ h√†nh ƒë·ªông 't√¥i ƒë·∫øn' xen v√†o (QKƒê). C·∫•u tr√∫c: S + were + V-ing.",
                wrong: "A d√πng cho h√†nh ƒë·ªông ng·∫Øn. B l√† hi·ªán t·∫°i. D l√† hi·ªán t·∫°i ƒë∆°n."
            },
            {
                q: "He ______ working when his boss came yesterday.",
                opts: ["weren't", "isn't", "wasn't", "didn't"],
                correct: 2, // C
                trans: "Anh ·∫•y ƒëang kh√¥ng l√†m vi·ªác khi √¥ng ch·ªß c·ªßa anh ·∫•y ƒë·∫øn h√¥m qua.",
                vocab: [
                    {w: "boss", t: "n", m: "√¥ng ch·ªß"},
                    {w: "work", t: "v", m: "l√†m vi·ªác"}
                ],
                why: "Ch·ªß ng·ªØ 'He' s·ªë √≠t -> ƒëi v·ªõi 'was'. C√¢u ph·ªß ƒë·ªãnh -> 'wasn't'. ƒê√¢y l√† h√†nh ƒë·ªông ƒëang di·ªÖn ra b·ªã xen v√†o.",
                wrong: "A d√πng cho s·ªë nhi·ªÅu. B l√† hi·ªán t·∫°i. D l√† tr·ª£ ƒë·ªông t·ª´ qu√° kh·ª© ƒë∆°n (kh√¥ng ƒëi v·ªõi V-ing)."
            },
            {
                q: "______ your mother going to the market at 7 a.m yesterday?",
                opts: ["Did", "Was", "Is", "Were"],
                correct: 1, // B
                trans: "M·∫π b·∫°n ƒëang ƒëi ch·ª£ l√∫c 7 gi·ªù s√°ng h√¥m qua ph·∫£i kh√¥ng?",
                vocab: [
                    {w: "market", t: "n", m: "ch·ª£"},
                    {w: "go", t: "v", m: "ƒëi"}
                ],
                why: "C√¢u h·ªèi QKTD v·ªõi ch·ªß ng·ªØ 'your mother' (s·ªë √≠t) -> ƒê·∫£o 'Was' l√™n ƒë·∫ßu.",
                wrong: "A d√πng cho QKƒê. C d√πng cho HTTD. D d√πng cho ch·ªß ng·ªØ s·ªë nhi·ªÅu."
            },
            {
                q: "At 12 o‚Äôclock yesterday, we ______ lunch.",
                opts: ["had", "are having", "were having", "have"],
                correct: 2, // C
                trans: "V√†o l√∫c 12 gi·ªù tr∆∞a h√¥m qua, ch√∫ng t√¥i ƒëang ƒÉn tr∆∞a.",
                vocab: [
                    {w: "have lunch", t: "collocation", m: "ƒÉn tr∆∞a"}
                ],
                why: "M·ªëc th·ªùi gian c·ª• th·ªÉ 'At 12 o‚Äôclock yesterday' -> Qu√° kh·ª© ti·∫øp di·ªÖn. Ch·ªß ng·ªØ 'We' -> were having.",
                wrong: "A l√† qu√° kh·ª© ƒë∆°n. B l√† hi·ªán t·∫°i. D l√† nguy√™n th·ªÉ."
            },
            {
                q: "I ______ TV when he phoned me.",
                opts: ["watched", "was watching", "am watching", "watch"],
                correct: 1, // B
                trans: "T√¥i ƒëang xem TV th√¨ anh ·∫•y g·ªçi ƒëi·ªán cho t√¥i.",
                vocab: [
                    {w: "phone", t: "v", m: "g·ªçi ƒëi·ªán"},
                    {w: "watch", t: "v", m: "xem"}
                ],
                why: "H√†nh ƒë·ªông ƒëang xem TV l√† h√†nh ƒë·ªông d√†i (ƒëang x·∫£y ra) -> Was watching.",
                wrong: "A l√† h√†nh ƒë·ªông ng·∫Øn. C sai th√¨. D sai th√¨."
            },
            {
                q: "While Ellen ______ reading, Tim ______ watching television.",
                opts: ["was / was", "were / was", "was / were", "is / is"],
                correct: 0, // A
                trans: "Trong khi Ellen ƒëang ƒë·ªçc s√°ch th√¨ Tim ƒëang xem TV.",
                vocab: [
                    {w: "while", t: "conj", m: "trong khi"},
                    {w: "read", t: "v", m: "ƒë·ªçc"}
                ],
                why: "Hai h√†nh ƒë·ªông x·∫£y ra song song trong qu√° kh·ª© -> C·∫£ 2 ƒë·ªÅu chia QKTD. Ellen (s·ªë √≠t) -> was, Tim (s·ªë √≠t) -> was.",
                wrong: "B, C sai ng√¥i. D sai th√¨ (hi·ªán t·∫°i)."
            },
            {
                q: "While we ______ to the park, it started to rain.",
                opts: ["go", "went", "were going", "are going"],
                correct: 2, // C
                trans: "Trong khi ch√∫ng t√¥i ƒëang ƒëi ƒë·∫øn c√¥ng vi√™n, tr·ªùi b·∫Øt ƒë·∫ßu m∆∞a.",
                vocab: [
                    {w: "park", t: "n", m: "c√¥ng vi√™n"},
                    {w: "start", t: "v", m: "b·∫Øt ƒë·∫ßu"}
                ],
                why: "Sau 'While' th∆∞·ªùng l√† QKTD di·ªÖn t·∫£ h√†nh ƒë·ªông ƒëang x·∫£y ra (ƒëang ƒëi). 'We' -> were going.",
                wrong: "A, D sai th√¨. B l√† QKƒê (h√†nh ƒë·ªông ng·∫Øn/ƒë√£ xong)."
            },
            {
                q: "What ______ you doing at this time yesterday?",
                opts: ["are", "did", "were", "do"],
                correct: 2, // C
                trans: "B·∫°n ƒëang l√†m g√¨ v√†o th·ªùi ƒëi·ªÉm n√†y ng√†y h√¥m qua?",
                vocab: [
                    {w: "at this time", t: "adv", m: "v√†o th·ªùi ƒëi·ªÉm n√†y"}
                ],
                why: "D·∫•u hi·ªáu 'at this time yesterday' -> QKTD. Ch·ªß ng·ªØ 'you' -> Were.",
                wrong: "A l√† hi·ªán t·∫°i. B l√† tr·ª£ ƒë·ªông t·ª´ QKƒê. D l√† tr·ª£ ƒë·ªông t·ª´ HTƒê."
            },
            {
                q: "She ______ her homework at 8 o‚Äôclock last night.",
                opts: ["did", "was doing", "does", "is doing"],
                correct: 1, // B
                trans: "C√¥ ·∫•y ƒëang l√†m b√†i t·∫≠p v·ªÅ nh√† l√∫c 8 gi·ªù t·ªëi qua.",
                vocab: [
                    {w: "homework", t: "n", m: "b√†i t·∫≠p v·ªÅ nh√†"}
                ],
                why: "Gi·ªù + qu√° kh·ª© (8 o'clock last night) -> QKTD. She -> was doing.",
                wrong: "A l√† QKƒê. C, D l√† th√¨ hi·ªán t·∫°i."
            },
            {
                q: "It ______ heavily while I was sleeping.",
                opts: ["rained", "was raining", "rains", "is raining"],
                correct: 1, // B
                trans: "Tr·ªùi ƒëang m∆∞a to trong khi t√¥i ƒëang ng·ªß.",
                vocab: [
                    {w: "heavily", t: "adv", m: "n·∫∑ng h·∫°t/to"},
                    {w: "sleep", t: "v", m: "ng·ªß"}
                ],
                why: "Hai h√†nh ƒë·ªông song song: M∆∞a v√† Ng·ªß ƒë·ªÅu ƒëang di·ªÖn ra. Ho·∫∑c nh·∫•n m·∫°nh qu√° tr√¨nh m∆∞a trong l√∫c ng·ªß.",
                wrong: "A l√† QKƒê (nh·∫•n m·∫°nh k·∫øt qu·∫£ h∆°n qu√° tr√¨nh). C, D sai th√¨."
            },
            {
                q: "When the teacher came in, the students ______ noise.",
                opts: ["make", "made", "are making", "were making"],
                correct: 3, // D
                trans: "Khi gi√°o vi√™n b∆∞·ªõc v√†o, c√°c h·ªçc sinh ƒëang l√†m ·ªìn.",
                vocab: [
                    {w: "noise", t: "n", m: "ti·∫øng ·ªìn"},
                    {w: "come in", t: "v", m: "b∆∞·ªõc v√†o"}
                ],
                why: "H√†nh ƒë·ªông 'l√†m ·ªìn' ƒëang di·ªÖn ra th√¨ gi√°o vi√™n 'b∆∞·ªõc v√†o' (xen ngang). Students (s·ªë nhi·ªÅu) -> were making.",
                wrong: "A, C sai th√¨. B l√† QKƒê (nghƒ©a l√† gi√°o vi√™n v√†o r·ªìi m·ªõi l√†m ·ªìn - sai ng·ªØ c·∫£nh)."
            },
            {
                q: "Some people fell off the road while they ______ motorbikes.",
                opts: ["ride", "rode", "were riding", "are riding"],
                correct: 2, // C
                trans: "M·ªôt v√†i ng∆∞·ªùi ng√£ xu·ªëng ƒë∆∞·ªùng khi h·ªç ƒëang l√°i xe m√°y.",
                vocab: [
                    {w: "fall off", t: "v", m: "ng√£ kh·ªèi"},
                    {w: "ride", t: "v", m: "l√°i (xe m√°y/ng·ª±a)"}
                ],
                why: "H√†nh ƒë·ªông 'ng√£' (fell - QKƒê) xen v√†o h√†nh ƒë·ªông 'ƒëang l√°i xe' (QKTD). They -> were riding.",
                wrong: "A, D sai th√¨. B l√† QKƒê."
            },
            {
                q: "While my father was reading news, my mother ______ dinner.",
                opts: ["cooked", "was cooking", "cooks", "is cooking"],
                correct: 1, // B
                trans: "Trong khi b·ªë t√¥i ƒëang ƒë·ªçc tin t·ª©c, m·∫π t√¥i ƒëang n·∫•u b·ªØa t·ªëi.",
                vocab: [
                    {w: "news", t: "n", m: "tin t·ª©c"}
                ],
                why: "Hai h√†nh ƒë·ªông song song (Parallel actions) d√πng While. C·∫£ hai ƒë·ªÅu chia QKTD.",
                wrong: "A ng·∫Øt qu√£ng s·ª± song song. C, D sai th√¨."
            },
            {
                q: "______ they staying with you when I called you yesterday?",
                opts: ["Did", "Do", "Were", "Are"],
                correct: 2, // C
                trans: "H·ªç c√≥ ƒëang ·ªü c√πng b·∫°n khi t√¥i g·ªçi h√¥m qua kh√¥ng?",
                vocab: [
                    {w: "stay with", t: "v", m: "·ªü c√πng"}
                ],
                why: "C√¢u h·ªèi QKTD: Were + S + V-ing? Ch·ªß ng·ªØ 'they' -> Were.",
                wrong: "A d√πng cho QKƒê (Did + V-inf). B, D sai th√¨."
            },
            {
                q: "Just as I ______ the street, the traffic light turned red.",
                opts: ["crossed", "was crossing", "am crossing", "cross"],
                correct: 1, // B
                trans: "Ngay khi t√¥i ƒëang bƒÉng qua ƒë∆∞·ªùng, ƒë√®n giao th√¥ng chuy·ªÉn sang m√†u ƒë·ªè.",
                vocab: [
                    {w: "cross", t: "v", m: "bƒÉng qua"},
                    {w: "traffic light", t: "n", m: "ƒë√®n giao th√¥ng"}
                ],
                why: "H√†nh ƒë·ªông 'bƒÉng qua ƒë∆∞·ªùng' ƒëang x·∫£y ra (WAS CROSSING) th√¨ ƒë√®n chuy·ªÉn ƒë·ªè.",
                wrong: "A l√† h√†nh ƒë·ªông ng·∫Øn. C, D sai th√¨."
            },
            {
                q: "Who ______ you talking to on the phone at 9 pm last night?",
                opts: ["did", "are", "were", "was"],
                correct: 2, // C
                trans: "B·∫°n ƒëang n√≥i chuy·ªán v·ªõi ai tr√™n ƒëi·ªán tho·∫°i l√∫c 9 gi·ªù t·ªëi qua?",
                vocab: [
                    {w: "talk to", t: "v", m: "n√≥i chuy·ªán v·ªõi"}
                ],
                why: "C√¢u h·ªèi Wh-question th√¨ QKTD. Ch·ªß ng·ªØ 'you' -> Were.",
                wrong: "A ƒëi v·ªõi V-nguy√™n th·ªÉ. B sai th√¨. D d√πng cho s·ªë √≠t."
            },
            {
                q: "My computer ______ down while I was working.",
                opts: ["broke", "was breaking", "breaks", "is breaking"],
                correct: 0, // A
                trans: "M√°y t√≠nh c·ªßa t√¥i b·ªã h·ªèng trong khi t√¥i ƒëang l√†m vi·ªác.",
                vocab: [
                    {w: "break down", t: "v", m: "h·ªèng h√≥c"},
                    {w: "working", t: "v", m: "l√†m vi·ªác"}
                ],
                why: "H√†nh ƒë·ªông 'h·ªèng' (broke) x·∫£y ra ƒë·ªôt ng·ªôt, c·∫Øt ngang h√†nh ƒë·ªông 'ƒëang l√†m vi·ªác'. D√πng QKƒê.",
                wrong: "B sai v√¨ h·ªèng l√† hƒë t·ª©c th√¨, kh√¥ng k√©o d√†i. C, D sai th√¨."
            },
            {
                q: "She ______ constantly ______ in class in those days.",
                opts: ["was / talking", "is / talking", "did / talk", "talked / null"],
                correct: 0, // A
                trans: "H·ªìi ƒë√≥ c√¥ ·∫•y c·ª© n√≥i chuy·ªán li√™n t·ª•c trong l·ªõp.",
                vocab: [
                    {w: "constantly", t: "adv", m: "li√™n t·ª•c/th∆∞·ªùng xuy√™n"},
                    {w: "in those days", t: "adv", m: "trong nh·ªØng ng√†y ƒë√≥ (qu√° kh·ª©)"}
                ],
                why: "QKTD + always/constantly di·ªÖn t·∫£ s·ª± ph√†n n√†n trong qu√° kh·ª©.",
                wrong: "B l√† hi·ªán t·∫°i. C, D kh√¥ng mang s·∫Øc th√°i ph√†n n√†n r√µ r·ªát nh∆∞ QKTD."
            },
            {
                q: "The children ______ hide and seek in the garden at 4 pm.",
                opts: ["played", "were playing", "play", "are playing"],
                correct: 1, // B
                trans: "B·ªçn tr·∫ª ƒëang ch∆°i tr·ªën t√¨m trong v∆∞·ªùn l√∫c 4 gi·ªù chi·ªÅu.",
                vocab: [
                    {w: "hide and seek", t: "n", m: "tr√≤ tr·ªën t√¨m"}
                ],
                why: "Th·ªùi ƒëi·ªÉm c·ª• th·ªÉ trong qu√° kh·ª© -> QKTD. Children (s·ªë nhi·ªÅu) -> were playing.",
                wrong: "A l√† QKƒê. C, D sai th√¨."
            },
            {
                q: "What was she doing when you ______ her?",
                opts: ["see", "saw", "was seeing", "seen"],
                correct: 1, // B
                trans: "C√¥ ·∫•y ƒëang l√†m g√¨ khi b·∫°n nh√¨n th·∫•y c√¥ ·∫•y?",
                vocab: [
                    {w: "see", t: "v", m: "nh√¨n th·∫•y"}
                ],
                why: "M·ªánh ƒë·ªÅ sau 'When' (h√†nh ƒë·ªông xen v√†o) chia Qu√° kh·ª© ƒë∆°n -> Saw.",
                wrong: "A l√† HTƒê. C sai v√¨ 'see' l√† ƒë·ªông t·ª´ tri gi√°c, √≠t d√πng ti·∫øp di·ªÖn, v√† ƒë√¢y l√† h√†nh ƒë·ªông ng·∫Øn. D l√† V3."
            },
            {
                q: "While I ______ for the bus, I saw a car accident.",
                opts: ["waited", "was waiting", "am waiting", "wait"],
                correct: 1, // B
                trans: "Trong khi t√¥i ƒëang ƒë·ª£i xe bu√Ωt, t√¥i nh√¨n th·∫•y m·ªôt v·ª• tai n·∫°n xe h∆°i.",
                vocab: [
                    {w: "wait for", t: "v", m: "ch·ªù ƒë·ª£i"},
                    {w: "accident", t: "n", m: "tai n·∫°n"}
                ],
                why: "Sau While l√† h√†nh ƒë·ªông ƒëang di·ªÖn ra (ƒëang ƒë·ª£i) -> QKTD: was waiting.",
                wrong: "A l√† h√†nh ƒë·ªông ng·∫Øn. C, D sai th√¨."
            },
            {
                q: "He ______ a shower when the phone rang.",
                opts: ["had", "has", "was having", "is having"],
                correct: 2, // C
                trans: "Anh ·∫•y ƒëang t·∫Øm th√¨ ƒëi·ªán tho·∫°i reo.",
                vocab: [
                    {w: "have a shower", t: "v", m: "ƒëi t·∫Øm"},
                    {w: "ring/rang", t: "v", m: "reo (chu√¥ng)"}
                ],
                why: "H√†nh ƒë·ªông 't·∫Øm' l√† h√†nh ƒë·ªông d√†i -> Was having. H√†nh ƒë·ªông 'reo' xen v√†o.",
                wrong: "A l√† QKƒê. B, D sai th√¨."
            },
            {
                q: "We ______ English at this time last week.",
                opts: ["learnt", "were learning", "learn", "are learning"],
                correct: 1, // B
                trans: "Ch√∫ng t√¥i ƒëang h·ªçc ti·∫øng Anh v√†o gi·ªù n√†y tu·∫ßn tr∆∞·ªõc.",
                vocab: [
                    {w: "learn", t: "v", m: "h·ªçc"}
                ],
                why: "At this time + time qu√° kh·ª© -> QKTD. We -> were learning.",
                wrong: "A l√† QKƒê. C, D sai th√¨."
            },
            {
                q: "The sun ______ when I woke up this morning.",
                opts: ["shone", "is shining", "was shining", "shines"],
                correct: 2, // C
                trans: "M·∫∑t tr·ªùi ƒëang chi·∫øu s√°ng khi t√¥i th·ª©c d·∫≠y s√°ng nay.",
                vocab: [
                    {w: "shine", t: "v", m: "chi·∫øu s√°ng"},
                    {w: "wake up", t: "v", m: "th·ª©c d·∫≠y"}
                ],
                why: "M·∫∑t tr·ªùi chi·∫øu s√°ng l√† b·ªëi c·∫£nh (ƒëang x·∫£y ra) cho h√†nh ƒë·ªông th·ª©c d·∫≠y. -> Was shining.",
                wrong: "A l√† QKƒê. B, D sai th√¨."
            },
            {
                q: "While the teacher ______, the students were listening carefully.",
                opts: ["spoke", "speaks", "was speaking", "has spoken"],
                correct: 2, // C
                trans: "Trong khi gi√°o vi√™n ƒëang n√≥i, h·ªçc sinh ƒëang l·∫Øng nghe chƒÉm ch√∫.",
                vocab: [
                    {w: "carefully", t: "adv", m: "c·∫©n th·∫≠n/chƒÉm ch√∫"}
                ],
                why: "Hai h√†nh ƒë·ªông song song: N√≥i v√† Nghe. Teacher -> was speaking.",
                wrong: "A m·∫•t t√≠nh song song. B, D sai th√¨."
            },
            {
                q: "I ______ my keys while I was walking in the park.",
                opts: ["lost", "was losing", "lose", "am losing"],
                correct: 0, // A
                trans: "T√¥i ƒë√£ l√†m m·∫•t ch√¨a kh√≥a khi ƒëang ƒëi d·∫°o trong c√¥ng vi√™n.",
                vocab: [
                    {w: "lose/lost", t: "v", m: "l√†m m·∫•t"},
                    {w: "key", t: "n", m: "ch√¨a kh√≥a"}
                ],
                why: "Vi·ªác 'm·∫•t' x·∫£y ra t·ª©c th√¨ (xen v√†o) -> QKƒê (Lost).",
                wrong: "B sai v√¨ 'm·∫•t' kh√¥ng ph·∫£i l√† qu√° tr√¨nh k√©o d√†i. C, D sai th√¨."
            },
            {
                q: "They ______ about the movie all yesterday evening.",
                opts: ["talked", "were talking", "talk", "are talking"],
                correct: 1, // B
                trans: "H·ªç ƒë√£ n√≥i chuy·ªán v·ªÅ b·ªô phim su·ªët c·∫£ bu·ªïi t·ªëi h√¥m qua.",
                vocab: [
                    {w: "all yesterday evening", t: "adv", m: "c·∫£ bu·ªïi t·ªëi h√¥m qua"}
                ],
                why: "D·∫•u hi·ªáu 'All + time qu√° kh·ª©' nh·∫•n m·∫°nh t√≠nh li√™n t·ª•c -> QKTD.",
                wrong: "A ƒë√∫ng ng·ªØ ph√°p nh∆∞ng k√©m ch√≠nh x√°c h∆°n B v·ªÅ √Ω nghƒ©a li√™n t·ª•c. C, D sai th√¨."
            },
            {
                q: "______ you reading a comic book at 10 pm last night?",
                opts: ["Did", "Do", "Were", "Are"],
                correct: 2, // C
                trans: "B·∫°n ƒëang ƒë·ªçc truy·ªán tranh l√∫c 10 gi·ªù t·ªëi qua ph·∫£i kh√¥ng?",
                vocab: [
                    {w: "comic book", t: "n", m: "truy·ªán tranh"}
                ],
                why: "C√¢u h·ªèi Yes/No th√¨ QKTD: Were you + V-ing?",
                wrong: "A ƒëi v·ªõi V-inf. B, D sai th√¨."
            },
            {
                q: "The bird ______ when the cat jumped up.",
                opts: ["flew", "was flying", "flies", "is flying"],
                correct: 1, // B
                trans: "Con chim ƒëang bay th√¨ con m√®o nh·∫£y l√™n.",
                vocab: [
                    {w: "jump up", t: "v", m: "nh·∫£y l√™n"},
                    {w: "fly", t: "v", m: "bay"}
                ],
                why: "H√†nh ƒë·ªông 'bay' ƒëang di·ªÖn ra -> Was flying. M√®o nh·∫£y l√™n l√† h√†nh ƒë·ªông xen ngang.",
                wrong: "A l√† QKƒê. C, D sai th√¨."
            }
        ];

        // --- √Çm thanh (Base64 ƒë·ªÉ ch·∫°y Single File) ---
        const soundCorrect = new Audio("data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq"); 
        // (L∆∞u √Ω: ƒê·ªÉ t·ªëi ∆∞u, t√¥i d√πng placeholder base64 ng·∫Øn. Th·ª±c t·∫ø n√™n d√πng link mp3 ngo√†i ho·∫∑c base64 full n·∫øu mu·ªën file ho·∫°t ƒë·ªông ƒë·ªôc l·∫≠p ho√†n to√†n. ·ªû ƒë√¢y t√¥i s·∫Ω d√πng logic JS t·∫°o √¢m thanh ƒë∆°n gi·∫£n b·∫±ng Web Audio API ƒë·ªÉ kh√¥ng c·∫ßn file ngo√†i)

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playTone(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            osc.stop(audioCtx.currentTime + duration);
        }

        function playCorrectSound() {
            playTone(600, 'sine', 0.1);
            setTimeout(() => playTone(800, 'sine', 0.2), 100);
        }

        function playWrongSound() {
            playTone(150, 'sawtooth', 0.3);
            setTimeout(() => playTone(100, 'sawtooth', 0.3), 150);
        }

        // --- Logic Game ---
        let currentQ = 0;
        let score = 0;
        let shuffledQuestions = [];

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initGame() {
            shuffledQuestions = shuffleArray([...rawQuestions]);
            currentQ = 0;
            score = 0;
            document.getElementById('progress').style.width = '0%';
            document.getElementById('finish-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'block';
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQ >= shuffledQuestions.length) {
                // End game logic handled in nextQuestion
                return;
            }

            const qData = shuffledQuestions[currentQ];
            document.getElementById('q-number').innerText = `C√¢u ${currentQ + 1}/${shuffledQuestions.length}`;
            document.getElementById('question-text').innerText = qData.q;
            document.getElementById('explanation').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';

            // Reset options
            const optsDiv = document.getElementById('options-area');
            optsDiv.innerHTML = '';

            qData.opts.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = `<span style="font-weight:800; color:var(--primary)">${String.fromCharCode(65 + index)}.</span> ${opt}`;
                btn.onclick = () => checkAnswer(index, btn, qData);
                optsDiv.appendChild(btn);
            });

            // Update Progress
            const progressPercent = ((currentQ) / shuffledQuestions.length) * 100;
            document.getElementById('progress').style.width = `${progressPercent}%`;
        }

        function checkAnswer(selectedIndex, btn, qData) {
            // Disable all buttons
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => b.disabled = true);

            if (selectedIndex === qData.correct) {
                // Correct
                btn.classList.add('correct');
                playCorrectSound();
                score++;
                document.getElementById('score-display').innerText = `ƒêi·ªÉm: ${score}`;
                fireConfetti();
            } else {
                // Wrong
                btn.classList.add('wrong');
                playWrongSound();
                // Highlight correct one
                buttons[qData.correct].classList.add('correct');
            }

            showExplanation(qData);
            
            // Show Next or Finish button
            if (currentQ < shuffledQuestions.length - 1) {
                document.getElementById('next-btn').style.display = 'block';
            } else {
                const finishBtn = document.getElementById('finish-btn');
                finishBtn.style.display = 'block';
                document.getElementById('next-btn').style.display = 'none';
            }
        }

        function showExplanation(qData) {
            const expDiv = document.getElementById('explanation');
            const contentDiv = document.getElementById('exp-content');
            
            // Build vocab list
            let vocabHTML = '';
            if (qData.vocab && qData.vocab.length > 0) {
                vocabHTML = `<div class="vocab-list">`;
                qData.vocab.forEach(v => {
                    vocabHTML += `
                        <div class="vocab-item">
                            <span class="vocab-word">${v.w}</span>
                            <span class="vocab-type">(${v.t})</span>
                            <span class="vocab-mean">${v.m}</span>
                        </div>`;
                });
                vocabHTML += `</div>`;
            }

            contentDiv.innerHTML = `
                <p><strong>üåê D·ªãch c√¢u:</strong> "${qData.trans}"</p>
                <p><strong>üìö Ph√¢n t√≠ch t·ª´ v·ª±ng:</strong></p>
                ${vocabHTML}
                <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
                <p class="why-correct"><strong>‚úÖ T·∫°i sao ƒê√öNG:</strong> ${qData.why}</p>
                <p class="why-wrong"><strong>‚ùå T·∫°i sao SAI:</strong> ${qData.wrong}</p>
            `;
            
            expDiv.style.display = 'block';
            // Scroll to explanation
            expDiv.scrollIntoView({behavior: 'smooth', block: 'center'});
        }

        function nextQuestion() {
            currentQ++;
            loadQuestion();
            window.scrollTo(0, 0);
        }

        function showResult() {
            const popup = document.getElementById('result-popup');
            const scoreCircle = document.getElementById('final-score');
            const feedback = document.getElementById('feedback-msg');

            scoreCircle.innerText = `${score}/${shuffledQuestions.length}`;
            
            if (score === shuffledQuestions.length) {
                feedback.innerText = "Xu·∫•t s·∫Øc! B·∫°n l√† b·∫≠c th·∫ßy Qu√° kh·ª© ti·∫øp di·ªÖn! üèÜ";
                fireConfetti();
            } else if (score >= shuffledQuestions.length * 0.8) {
                feedback.innerText = "Gi·ªèi l·∫Øm! B·∫°n n·∫Øm r·∫•t ch·∫Øc ki·∫øn th·ª©c! üåü";
            } else if (score >= shuffledQuestions.length * 0.5) {
                feedback.innerText = "Kh√° t·ªët! H√£y √¥n l·∫°i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm t·ªëi ƒëa nh√©! üí™";
            } else {
                feedback.innerText = "C·ªë l√™n! H√£y xem l·∫°i ph·∫ßn gi·∫£i th√≠ch ƒë·ªÉ hi·ªÉu r√µ h∆°n nha! üìö";
            }

            popup.style.display = 'flex';
        }

        // --- Simple Confetti Effect ---
        function fireConfetti() {
            const canvas = document.getElementById('confetti');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const pieces = [];
            const colors = ['#8854C0', '#00C9A7', '#FF4757', '#FFD700', '#00D26A'];

            for (let i = 0; i < 100; i++) {
                pieces.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    w: Math.random() * 10 + 5,
                    h: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    vy: Math.random() * 5 + 2,
                    vx: Math.random() * 4 - 2
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                pieces.forEach(p => {
                    p.y += p.vy;
                    p.x += p.vx;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.w, p.h);
                    if (p.y < canvas.height) active = true;
                });
                if (active) requestAnimationFrame(animate);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            animate();
        }

        // Start Game
        window.onload = initGame;

    </script>
</body>
</html>