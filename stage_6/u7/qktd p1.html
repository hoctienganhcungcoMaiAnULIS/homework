<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i T·∫≠p Ti·∫øng Anh - Ms Mai An ULIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-pink: #8854C0;
            --primary-teal: #00C9A7;
            --success: #00D26A;
            --error: #FF4757;
            --bg-pattern: #f0f4f8;
            --card-bg: #ffffff;
            --text-color: #2d3436;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #E0EAFC;
            background-image: radial-gradient(#8854C0 0.8px, transparent 0.8px), radial-gradient(#00C9A7 0.8px, #E0EAFC 0.8px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }

        /* --- Header --- */
        header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        h1 {
            font-family: 'Quicksand', sans-serif;
            color: var(--primary-pink);
            font-size: 1.5rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .teacher-tag {
            font-size: 0.9rem;
            color: #636e72;
            font-weight: 600;
        }

        /* --- Containers --- */
        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .section-title {
            background: var(--primary-pink);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 15px;
            margin-top: 30px;
            box-shadow: 0 4px 0 #5e3a8a;
            font-weight: 800;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border: 2px solid #f1f2f6;
            position: relative;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .question-text {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* --- Buttons & Inputs --- */
        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn-option {
            background: white;
            border: 2px solid #dfe6e9;
            border-radius: 15px;
            padding: 10px 15px;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #dfe6e9;
            flex-grow: 1;
            text-align: center;
        }

        .btn-option:hover {
            transform: scale(1.05);
            border-color: var(--primary-teal);
        }

        .btn-option:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-option.correct {
            background-color: var(--success);
            color: white;
            border-color: #00b85c;
            box-shadow: 0 4px 0 #00b85c;
        }

        .btn-option.wrong {
            background-color: var(--error);
            color: white;
            border-color: #d63031;
            box-shadow: 0 4px 0 #d63031;
            animation: shake 0.5s;
        }

        /* --- Gap Fill Styling --- */
        .gap-fill-text {
            line-height: 2.2;
            font-size: 1.1rem;
        }

        .gap-input {
            display: inline-block;
            min-width: 80px;
            padding: 5px 10px;
            border: 2px dashed var(--primary-pink);
            border-radius: 10px;
            background: #fff0f6;
            color: var(--primary-pink);
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            margin: 0 5px;
            position: relative;
            top: 2px;
        }
        
        .gap-input.filled-correct {
            background: var(--success);
            color: white;
            border-style: solid;
        }
        
        .gap-input.filled-wrong {
            background: var(--error);
            color: white;
            border-style: solid;
            animation: shake 0.5s;
        }

        /* --- Explanation Box --- */
        .explanation-box {
            margin-top: 15px;
            background: #f1f2f6;
            border-left: 5px solid var(--primary-teal);
            padding: 15px;
            border-radius: 0 10px 10px 0;
            display: none; /* Hidden by default */
            animation: slideDown 0.3s ease-out;
        }

        .explanation-box.show {
            display: block;
        }

        .exp-header {
            font-weight: 800;
            color: var(--primary-teal);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .exp-content p {
            margin: 5px 0;
            font-size: 0.95rem;
        }

        .exp-label {
            font-weight: 700;
            color: #636e72;
        }

        /* --- Modal for Gap Fill --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-title {
            font-size: 1.2rem;
            color: var(--primary-pink);
            margin-bottom: 15px;
            font-weight: 800;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* --- Animations --- */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* --- Footer & Score --- */
        .submit-btn {
            display: block;
            width: 100%;
            padding: 20px;
            background: var(--primary-pink);
            color: white;
            font-size: 1.5rem;
            font-weight: 800;
            border: none;
            border-radius: 20px;
            margin-top: 40px;
            margin-bottom: 60px;
            cursor: pointer;
            box-shadow: 0 8px 0 #5e3a8a;
            transition: transform 0.1s;
        }

        .submit-btn:active {
            transform: translateY(8px);
            box-shadow: none;
        }
        
        /* Phonetic specific */
        .phonetic u {
            text-decoration: none;
            border-bottom: 3px solid var(--primary-pink);
            padding-bottom: 2px;
        }

        /* Confetti Canvas */
        #confetti-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 999;
        }

    </style>
</head>
<body>

    <header>
        <h1>B√†i T·∫≠p Ng·ªØ Ph√°p T∆∞∆°ng T√°c</h1>
        <div class="teacher-tag">Bi√™n so·∫°n b·ªüi: Ms Mai An ULIS</div>
    </header>

    <div class="container" id="quiz-container">
        </div>

    <div class="container">
        <button class="submit-btn" onclick="finishQuiz()">N·ªòP B√ÄI & XEM ƒêI·ªÇM</button>
    </div>

    <div class="modal-overlay" id="selectionModal">
        <div class="modal-content">
            <div class="modal-title">Ch·ªçn t·ª´ ƒë√∫ng</div>
            <div class="modal-options" id="modalOptionsContainer">
                </div>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>

<script>
    // --- D·ªÆ LI·ªÜU ƒê·ªÄ B√ÄI V√Ä GI·∫¢I TH√çCH CHI TI·∫æT ---
    const quizData = [
        {
            type: "part-title",
            title: "PH·∫¶N 1: PAST CONTINUOUS VS PAST SIMPLE (TR·∫ÆC NGHI·ªÜM)"
        },
        {
            id: 1,
            type: "choice",
            question: "I ________ my homework when you ________ me.",
            options: [
                "was doing / phoned",
                "did / were phoning",
                "were doing / was phoning",
                "did / phoned"
            ],
            correctIndex: 0,
            explanation: {
                trans: "T√¥i ƒëang l√†m b√†i t·∫≠p v·ªÅ nh√† th√¨ b·∫°n g·ªçi ƒëi·ªán.",
                whyCorrect: "H√†nh ƒë·ªông 'l√†m b√†i t·∫≠p' ƒëang di·ªÖn ra (Past Continuous: was/were + V-ing) th√¨ h√†nh ƒë·ªông 'g·ªçi ƒëi·ªán' xen v√†o (Past Simple: V2/ed). Ch·ªß ng·ªØ 'I' ƒëi v·ªõi 'was'.",
                whyWrong: "'did / were phoning' ng∆∞·ª£c tr·∫≠t t·ª±. 'were doing' sai ch·ªß ng·ªØ 'I'. 'did / phoned' ch·ªâ 2 h√†nh ƒë·ªông li√™n ti·∫øp, kh√¥ng di·ªÖn t·∫£ s·ª± xen ngang."
            }
        },
        {
            id: 2,
            type: "choice",
            question: "We ________ tennis when it ________ to rain.",
            options: [
                "played / was starting",
                "were playing / started",
                "was playing / were starting",
                "played / started"
            ],
            correctIndex: 1,
            explanation: {
                trans: "Ch√∫ng t√¥i ƒëang ch∆°i qu·∫ßn v·ª£t th√¨ tr·ªùi b·∫Øt ƒë·∫ßu m∆∞a.",
                whyCorrect: "H√†nh ƒë·ªông ƒëang ch∆°i (k√©o d√†i) -> Past Cont (We were playing). H√†nh ƒë·ªông m∆∞a ·∫≠p ƒë·∫øn (ng·∫Øn, xen ngang) -> Past Simple (started).",
                whyWrong: "C·∫•u tr√∫c chu·∫©n: Past Cont (ƒëang x·∫£y ra) + when + Past Simple (xen v√†o)."
            }
        },
        {
            id: 3,
            type: "choice",
            question: "When Bob ________ his car accident, he ________ at his mobile phone.",
            options: [
                "was having / looked",
                "had / was looking",
                "were having / were looking",
                "had / looked"
            ],
            correctIndex: 1,
            explanation: {
                trans: "Khi Bob g·∫∑p tai n·∫°n √¥ t√¥, anh ·∫•y ƒëang nh√¨n v√†o ƒëi·ªán tho·∫°i.",
                whyCorrect: "H√†nh ƒë·ªông 'nh√¨n ƒëi·ªán tho·∫°i' ƒëang di·ªÖn ra (was looking) th√¨ tai n·∫°n x·∫£y ra (had - h√†nh ƒë·ªông t·ª©c th·ªùi).",
                whyWrong: "'have an accident' th∆∞·ªùng l√† h√†nh ƒë·ªông d·ª©t ƒëi·ªÉm (Past Simple), kh√¥ng d√πng ti·∫øp di·ªÖn cho nghƒ©a n√†y trong ng·ªØ c·∫£nh n√†y."
            }
        },
        {
            id: 4,
            type: "choice",
            question: "Emma ________ when she ________ her leg.",
            options: [
                "skied / was breaking",
                "were skiing / broke",
                "was skiing / broke",
                "was skiing / were breaking"
            ],
            correctIndex: 2,
            explanation: {
                trans: "Emma ƒëang tr∆∞·ª£t tuy·∫øt th√¨ c√¥ ·∫•y b·ªã g√£y ch√¢n.",
                whyCorrect: "H√†nh ƒë·ªông tr∆∞·ª£t tuy·∫øt l√†m n·ªÅn (was skiing) b·ªã h√†nh ƒë·ªông g√£y ch√¢n ng·∫Øt qu√£ng (broke). Ch·ªß ng·ªØ Emma (s·ªë √≠t) d√πng 'was'.",
                whyWrong: "'Break a leg' l√† h√†nh ƒë·ªông t·ª©c th√¨, kh√¥ng d√πng ti·∫øp di·ªÖn (was breaking). 'were skiing' sai v√¨ Emma l√† s·ªë √≠t."
            }
        },
        {
            id: 5,
            type: "choice",
            question: "When I last ________ Bob‚Äôs children, they ________ in their garden.",
            options: [
                "saw / were playing",
                "was seeing / was playing",
                "were seeing / played",
                "saw / played"
            ],
            correctIndex: 0,
            explanation: {
                trans: "L·∫ßn cu·ªëi t√¥i nh√¨n th·∫•y c√°c con c·ªßa Bob, ch√∫ng ƒëang ch∆°i trong v∆∞·ªùn.",
                whyCorrect: "ƒê·ªông t·ª´ 'see' (nh√¨n th·∫•y) l√† ƒë·ªông t·ª´ ch·ªâ tri gi√°c, th∆∞·ªùng d√πng Past Simple (saw). L√∫c nh√¨n th·∫•y th√¨ b·ªçn tr·∫ª 'ƒëang ch∆°i' (were playing).",
                whyWrong: "Kh√¥ng d√πng 'was seeing' v·ªõi nghƒ©a 'nh√¨n th·∫•y' (ch·ªâ d√πng khi nghƒ©a l√† g·∫∑p g·ª°/h·∫πn h√≤). 'They' s·ªë nhi·ªÅu ƒëi v·ªõi 'were'."
            }
        },
        {
            id: 6,
            type: "choice",
            question: "Mr Johnson ________ in the ocean when a shark ________ him.",
            options: [
                "swam / was attacking",
                "was swimming / attacked",
                "were swimming / were attacking",
                "swam / attacked"
            ],
            correctIndex: 1,
            explanation: {
                trans: "√îng Johnson ƒëang b∆°i tr√™n bi·ªÉn th√¨ m·ªôt con c√° m·∫≠p t·∫•n c√¥ng √¥ng ·∫•y.",
                whyCorrect: "H√†nh ƒë·ªông b∆°i ƒëang di·ªÖn ra (was swimming). H√†nh ƒë·ªông t·∫•n c√¥ng xen v√†o b·∫•t ng·ªù (attacked).",
                whyWrong: "'attack' l√† h√†nh ƒë·ªông t·ª©c th·ªùi xen ngang."
            }
        },
        {
            id: 7,
            type: "choice",
            question: "My mobile phone ________ while I ________ a bath.",
            options: [
                "was ringing / had",
                "rang / was having",
                "were ringing / were having",
                "rang / had"
            ],
            correctIndex: 1,
            explanation: {
                trans: "ƒêi·ªán tho·∫°i c·ªßa t√¥i reo trong khi t√¥i ƒëang t·∫Øm.",
                whyCorrect: "D√πng 'While' cho h√†nh ƒë·ªông ƒëang di·ªÖn ra (was having a bath). H√†nh ƒë·ªông reo (rang) xen v√†o.",
                whyWrong: "'Ring' (reo) l√† h√†nh ƒë·ªông ng·∫Øn. 'Have a bath' l√† qu√° tr√¨nh d√†i."
            }
        },
        {
            id: 8,
            type: "choice",
            question: "They ________ the street when the lights ________ red.",
            options: [
                "were crossing / turned",
                "was crossing / was turning",
                "crossed / were turning",
                "were crossing / was turning"
            ],
            correctIndex: 0,
            explanation: {
                trans: "H·ªç ƒëang bƒÉng qua ƒë∆∞·ªùng th√¨ ƒë√®n chuy·ªÉn sang m√†u ƒë·ªè.",
                whyCorrect: "H·ªç ƒëang ƒëi (were crossing - They s·ªë nhi·ªÅu). ƒê√®n chuy·ªÉn m√†u (turned - d·ª©t ƒëi·ªÉm).",
                whyWrong: "'Lights' s·ªë nhi·ªÅu kh√¥ng d√πng 'was'. H√†nh ƒë·ªông chuy·ªÉn m√†u ƒë√®n th∆∞·ªùng di·ªÖn ra nhanh (Simple)."
            }
        },
        {
            id: 9,
            type: "choice",
            question: "When my mother ________ in the room, my father ________ on his bed.",
            options: [
                "was coming / jumped",
                "came / was jumping",
                "were coming / were jumping",
                "came / jumped"
            ],
            correctIndex: 1,
            explanation: {
                trans: "Khi m·∫π t√¥i b∆∞·ªõc v√†o ph√≤ng, b·ªë t√¥i ƒëang nh·∫£y tr√™n gi∆∞·ªùng.",
                whyCorrect: "M·∫π b∆∞·ªõc v√†o (came - h√†nh ƒë·ªông ng·∫Øn). B·ªë ƒëang nh·∫£y (was jumping - h√†nh ƒë·ªông ƒëang di·ªÖn ra).",
                whyWrong: "'Come' v√†o ph√≤ng l√† h√†nh ƒë·ªông c·∫Øt ngang kho·∫£nh kh·∫Øc ƒë√≥."
            }
        },
        {
            id: 10,
            type: "choice",
            question: "I ________ my teacher in the street while I ________ shopping.",
            options: [
                "was meeting / did",
                "met / was doing",
                "were meeting / were doing",
                "met / did"
            ],
            correctIndex: 1,
            explanation: {
                trans: "T√¥i g·∫∑p gi√°o vi√™n tr√™n ph·ªë trong khi t√¥i ƒëang ƒëi mua s·∫Øm.",
                whyCorrect: "'G·∫∑p' l√† t√¨nh c·ªù, ng·∫Øn (met). 'Mua s·∫Øm' l√† qu√° tr√¨nh ƒëang di·ªÖn ra (was doing).",
                whyWrong: "'Meet' (g·∫∑p) hi·∫øm khi d√πng ti·∫øp di·ªÖn trong ng·ªØ c·∫£nh n√†y."
            }
        },

        // --- PART 2 ---
        {
            type: "part-title",
            title: "PH·∫¶N 2: CHIA ƒê·ªòNG T·ª™ (GAP FILL)"
        },
        {
            id: 11,
            type: "gap-fill",
            sentenceParts: ["Yoshi ", " (sit) in a caf√© when Palm ", " (call)."],
            answers: ["was sitting", "called"],
            options: [
                ["sat", "was sitting", "were sitting"],
                ["was calling", "called", "call"]
            ],
            explanation: {
                trans: "Yoshi ƒëang ng·ªìi trong qu√°n c√† ph√™ th√¨ Palm g·ªçi.",
                whyCorrect: "V·∫ø 1: ƒêang ng·ªìi (h√†nh ƒë·ªông d√†i) -> was sitting. V·∫ø 2: G·ªçi (xen v√†o) -> called.",
                whyWrong: "'sat' l√† qu√° kh·ª© ƒë∆°n, kh√¥ng di·ªÖn t·∫£ tr·∫°ng th√°i ƒëang ti·∫øp di·ªÖn l√∫c ƒë√≥."
            }
        },
        {
            id: 12,
            type: "gap-fill",
            sentenceParts: ["When you ", " (arrive) at the party, who ", " (be) there?"],
            answers: ["arrived", "was"],
            options: [
                ["arrived", "was arriving"],
                ["was", "were", "was being"]
            ],
            explanation: {
                trans: "Khi b·∫°n ƒë·∫øn b·ªØa ti·ªác, ai ƒë√£ ·ªü ƒë√≥?",
                whyCorrect: "'Arrive' l√† h√†nh ƒë·ªông ng·∫Øn (ƒë·∫øn n∆°i) -> arrived. ƒê·ªông t·ª´ 'to be' KH√îNG d√πng ·ªü ti·∫øp di·ªÖn -> who was there.",
                whyWrong: "Kh√¥ng d√πng 'was being' tr·ª´ khi n√≥i v·ªÅ h√†nh vi c∆∞ x·ª≠."
            }
        },
        {
            id: 13,
            type: "gap-fill",
            sentenceParts: ["Cash ", " (watch) a film when she ", " (hear) the noise."],
            answers: ["was watching", "heard"],
            options: [
                ["watched", "was watching"],
                ["heard", "was hearing"]
            ],
            explanation: {
                trans: "Cash ƒëang xem phim th√¨ c√¥ ·∫•y nghe th·∫•y ti·∫øng ·ªìn.",
                whyCorrect: "ƒêang xem phim (was watching). Nghe th·∫•y (heard - ƒë·ªông t·ª´ tri gi√°c kh√¥ng d√πng ti·∫øp di·ªÖn).",
                whyWrong: "'was hearing' l√† sai ng·ªØ ph√°p v·ªõi nghƒ©a 'nghe th·∫•y'."
            }
        },
        {
            id: 14,
            type: "gap-fill",
            sentenceParts: ["We ", " (play) tennis when Aon ", " (hurt) his ankle."],
            answers: ["were playing", "hurt"],
            options: [
                ["played", "were playing"],
                ["hurt", "was hurting"]
            ],
            explanation: {
                trans: "Ch√∫ng t√¥i ƒëang ch∆°i tennis th√¨ Aon b·ªã ƒëau m·∫Øt c√° ch√¢n.",
                whyCorrect: "ƒêang ch∆°i (were playing). B·ªã th∆∞∆°ng (hurt - x·∫£y ra b·∫•t ng·ªù).",
                whyWrong: "'hurt' V2 v·∫´n l√† 'hurt'."
            }
        },
        {
            id: 15,
            type: "gap-fill",
            sentenceParts: ["When I ", " (walk) into the room, everyone ", " (work)."],
            answers: ["walked", "was working"],
            options: [
                ["walked", "was walking"],
                ["worked", "was working"]
            ],
            explanation: {
                trans: "Khi t√¥i b∆∞·ªõc v√†o ph√≤ng, m·ªçi ng∆∞·ªùi ƒëang l√†m vi·ªác.",
                whyCorrect: "B∆∞·ªõc v√†o (walked - ng·∫Øn). M·ªçi ng∆∞·ªùi ƒëang l√†m vi·ªác l√∫c ƒë√≥ (was working - Everyone l√† ƒë·∫°i t·ª´ b·∫•t ƒë·ªãnh s·ªë √≠t, nh∆∞ng n·∫øu hi·ªÉu theo s·ªë ƒë√¥ng c√≥ th·ªÉ d√πng 'were working' trong vƒÉn n√≥i, tuy nhi√™n ng·ªØ ph√°p chu·∫©n 'Everyone' ƒëi v·ªõi ƒë·ªông t·ª´ s·ªë √≠t 'was'). *L∆∞u √Ω: N·∫øu ƒë√°p √°n ch·ªçn 'were working' c≈©ng ch·∫•p nh·∫≠n ƒë∆∞·ª£c trong vƒÉn c·∫£nh kh√¥ng trang tr·ªçng, nh∆∞ng chu·∫©n nh·∫•t l√† 'was'. ·ªû ƒë√¢y h·ªá th·ªëng ∆∞u ti√™n 'was working' ho·∫∑c 'were working' t√πy theo ƒë√°p √°n b·∫°n ch·ªçn, t√¥i s·∫Ω c√†i 'was working'.*",
                // ƒêi·ªÅu ch·ªânh: Everyone ƒëi v·ªõi s·ªë √≠t (was).
                whyWrong: "H√†nh ƒë·ªông l√†m vi·ªác ƒëang di·ªÖn ra khi t√¥i b∆∞·ªõc v√†o."
            }
        },
        {
            id: 16,
            type: "gap-fill",
            sentenceParts: ["Aimee ", " (take) a shower when the phone ", " (ring)."],
            answers: ["was taking", "rang"],
            options: [
                ["took", "was taking"],
                ["rang", "was ringing"]
            ],
            explanation: {
                trans: "Aimee ƒëang t·∫Øm th√¨ ƒëi·ªán tho·∫°i reo.",
                whyCorrect: "ƒêang t·∫Øm (was taking). Reo (rang).",
                whyWrong: "C·∫•u tr√∫c kinh ƒëi·ªÉn: Past Cont + When + Past Simple."
            }
        },
        {
            id: 17,
            type: "gap-fill",
            sentenceParts: ["He ", " (live) in Bangkok when he ", " (meet) his wife."],
            answers: ["was living", "met"],
            options: [
                ["lived", "was living"],
                ["met", "was meeting"]
            ],
            explanation: {
                trans: "Anh ·∫•y ƒëang s·ªëng ·ªü Bangkok th√¨ g·∫∑p v·ª£ m√¨nh.",
                whyCorrect: "S·ªëng ·ªü ƒë√¢u (trong kho·∫£ng th·ªùi gian ƒë√≥) d√πng ti·∫øp di·ªÖn ƒë·ªÉ nh·∫•n m·∫°nh b·ªëi c·∫£nh (was living). G·∫∑p (met).",
                whyWrong: "'lived' c≈©ng ƒë√∫ng nh∆∞ng 'was living' nh·∫•n m·∫°nh t√≠nh th·ªùi ƒëi·ªÉm h∆°n."
            }
        },
        {
            id: 18,
            type: "gap-fill",
            sentenceParts: ["When I ", " (leave) the house, it ", " (snow)."],
            answers: ["left", "was snowing"],
            options: [
                ["left", "was leaving"],
                ["snowed", "was snowing"]
            ],
            explanation: {
                trans: "Khi t√¥i r·ªùi kh·ªèi nh√†, tr·ªùi ƒëang c√≥ tuy·∫øt r∆°i.",
                whyCorrect: "R·ªùi nh√† (left - xong r·ªìi). Tr·ªùi ƒëang m∆∞a tuy·∫øt (was snowing - b·ªëi c·∫£nh).",
                whyWrong: "Tuy·∫øt r∆°i l√† n·ªÅn c·∫£nh cho h√†nh ƒë·ªông r·ªùi nh√†."
            }
        },
        {
            id: 19,
            type: "gap-fill",
            sentenceParts: ["What ", " (you/do) when I ", " (call) you last night?"],
            answers: ["were you doing", "called"],
            options: [
                ["did you do", "were you doing"],
                ["called", "was calling"]
            ],
            explanation: {
                trans: "B·∫°n ƒëang l√†m g√¨ khi t√¥i g·ªçi b·∫°n t·ªëi qua?",
                whyCorrect: "H·ªèi v·ªÅ h√†nh ƒë·ªông ƒëang di·ªÖn ra t·∫°i 1 th·ªùi ƒëi·ªÉm c·ª• th·ªÉ -> Were you doing. G·ªçi -> called.",
                whyWrong: "Did you do h·ªèi v·ªÅ h√†nh ƒë·ªông ƒë√£ ho√†n t·∫•t."
            }
        },
        {
            id: 20,
            type: "gap-fill",
            sentenceParts: ["When the train ", " (get) to the station, we ", " (wait) on the platform."],
            answers: ["got", "were waiting"],
            options: [
                ["got", "was getting"],
                ["waited", "were waiting"]
            ],
            explanation: {
                trans: "Khi t√†u ƒë·∫øn ga, ch√∫ng t√¥i ƒëang ƒë·ª£i tr√™n s√¢n ga.",
                whyCorrect: "T√†u ƒë·∫øn (got - ng·∫Øn). ƒêang ƒë·ª£i (were waiting - d√†i).",
                whyWrong: "Wait l√† h√†nh ƒë·ªông k√©o d√†i."
            }
        },

        // --- PART 3 ---
        {
            type: "part-title",
            title: "PH·∫¶N 3: T·ªîNG H·ª¢P & N√ÇNG CAO"
        },
        {
            id: 21,
            type: "choice",
            question: "The plane ________ to Paris when it crashed.",
            options: ["WAS FLYING", "FLEW"],
            correctIndex: 0,
            explanation: {
                trans: "M√°y bay ƒëang bay t·ªõi Paris th√¨ b·ªã r∆°i.",
                whyCorrect: "ƒêang bay (Was flying) th√¨ tai n·∫°n x·∫£y ra.",
                whyWrong: "Flew l√† ƒë√£ bay xong r·ªìi."
            }
        },
        {
            id: 22,
            type: "choice",
            question: "The students ________ for the bus when it started to rain.",
            options: ["WAITED", "WERE WAITING"],
            correctIndex: 1,
            explanation: {
                trans: "H·ªçc sinh ƒëang ƒë·ª£i xe bu√Ωt th√¨ tr·ªùi m∆∞a.",
                whyCorrect: "H√†nh ƒë·ªông ƒë·ª£i (Were waiting) b·ªã m∆∞a c·∫Øt ngang.",
                whyWrong: "Waited l√† h√†nh ƒë·ªông ƒë√£ k·∫øt th√∫c."
            }
        },
        {
            id: 23,
            type: "choice",
            question: "We were crossing when the traffic lights ________ red.",
            options: ["TURNED", "WAS TURNING"],
            correctIndex: 0,
            explanation: {
                trans: "Ch√∫ng t√¥i ƒëang bƒÉng qua th√¨ ƒë√®n chuy·ªÉn ƒë·ªè.",
                whyCorrect: "ƒê√®n chuy·ªÉn m√†u l√† kho·∫£nh kh·∫Øc (Turned).",
                whyWrong: "Was turning nghe nh∆∞ ƒë√®n ƒëang quay v√≤ng tr√≤n."
            }
        },
        {
            id: 24,
            type: "choice",
            question: "When their mother called, the children ________ games.",
            options: ["PLAYED", "WERE PLAYING"],
            correctIndex: 1,
            explanation: {
                trans: "Khi m·∫π g·ªçi, b·ªçn tr·∫ª ƒëang ch∆°i game.",
                whyCorrect: "ƒêang ch∆°i (Were playing) t·∫°i th·ªùi ƒëi·ªÉm g·ªçi.",
                whyWrong: "Played nghƒ©a l√† m·∫π g·ªçi xong m·ªõi ch∆°i."
            }
        },
        {
            id: 25,
            type: "gap-fill",
            sentenceParts: ["While we ", " (run) in the park, Mary ", " (fall over)."],
            answers: ["were running", "fell over"],
            options: [
                ["ran", "were running"],
                ["fell over", "was falling over"]
            ],
            explanation: {
                trans: "Trong khi ch√∫ng t√¥i ƒëang ch·∫°y trong c√¥ng vi√™n, Mary b·ªã ng√£.",
                whyCorrect: "ƒêang ch·∫°y (were running). Ng√£ (fell over - b·∫•t ng·ªù).",
                whyWrong: "Fell l√† V2 c·ªßa Fall."
            }
        },
        {
            id: 26,
            type: "gap-fill",
            sentenceParts: ["While Kate ", " (drink) some milk, she ", " (drop) the glass."],
            answers: ["was drinking", "dropped"],
            options: [
                ["drank", "was drinking"],
                ["dropped", "was dropping"]
            ],
            explanation: {
                trans: "Trong khi Kate ƒëang u·ªëng s·ªØa, c√¥ ·∫•y l√†m r∆°i c√°i ly.",
                whyCorrect: "ƒêang u·ªëng (was drinking). L√†m r∆°i (dropped).",
                whyWrong: "Dropped g·∫•p ƒë√¥i ch·ªØ 'p'."
            }
        },
        {
            id: 27,
            type: "gap-fill",
            sentenceParts: ["While I ", " (listen) to music, I ", " (hear) the doorbell."],
            answers: ["was listening", "heard"],
            options: [
                ["listened", "was listening"],
                ["heard", "was hearing"]
            ],
            explanation: {
                trans: "Trong khi t√¥i ƒëang nghe nh·∫°c, t√¥i nghe th·∫•y chu√¥ng c·ª≠a.",
                whyCorrect: "ƒêang nghe (was listening). Nghe th·∫•y (heard - tri gi√°c).",
                whyWrong: "Hear kh√¥ng d√πng V-ing."
            }
        }
    ];

    // --- LOGIC TR√í CH∆†I ---
    let score = 0;
    const totalQuestions = quizData.filter(q => q.type !== 'part-title').length; // Estimate logic needs refinement for gap fill
    
    // Helper: T√≠nh t·ªïng ƒëi·ªÉm max (m·ªói gap t√≠nh l√† 1 ƒëi·ªÉm, m·ªói c√¢u choice t√≠nh 1 ƒëi·ªÉm)
    let maxScore = 0;
    quizData.forEach(q => {
        if(q.type === 'choice') maxScore++;
        if(q.type === 'gap-fill') maxScore += q.answers.length;
    });

    const quizContainer = document.getElementById('quiz-container');

    // --- SOUNDS (Base64 ƒë·ªÉ ch·∫°y Single File) ---
    // Short beep for Correct
    const sndCorrect = new Audio("data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="); // Placeholder, using SpeechSynthesis better for interactions or simple logic.
    // Actually, let's use a real trick: AudioContext Oscillator for pure code sounds.
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'correct') {
            // Ding: High pitch, fading
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        } else {
            // Buzz: Sawtooth, low pitch
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }
    }

    function playConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const pieces = [];
        const colors = ['#8854C0', '#00C9A7', '#FF4757', '#FFD700'];

        for(let i=0; i<100; i++) {
            pieces.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                w: 10 + Math.random() * 10,
                h: 5 + Math.random() * 5,
                color: colors[Math.floor(Math.random() * colors.length)],
                speed: 2 + Math.random() * 3,
                angle: Math.random() * 6.2
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let active = false;
            pieces.forEach(p => {
                p.y += p.speed;
                p.angle += 0.1;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.angle);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
                ctx.restore();
                if(p.y < canvas.height) active = true;
            });
            if(active) requestAnimationFrame(draw);
            else ctx.clearRect(0,0, canvas.width, canvas.height);
        }
        draw();
    }

    // --- RENDER QUIZ ---
    function renderQuiz() {
        quizData.forEach((item, index) => {
            if (item.type === 'part-title') {
                const title = document.createElement('div');
                title.style.textAlign = 'center';
                title.innerHTML = `<div class="section-title">${item.title}</div>`;
                quizContainer.appendChild(title);
                return;
            }

            const card = document.createElement('div');
            card.className = 'card';
            card.id = `q-card-${item.id}`;

            // Explanation Block (Prepared)
            const explanationHTML = `
                <div class="explanation-box" id="exp-${item.id}">
                    <div class="exp-header">
                        <span>üë©‚Äçüè´ Ms Mai An gi·∫£i th√≠ch:</span>
                    </div>
                    <div class="exp-content">
                        <p><span class="exp-label">D·ªãch:</span> ${item.explanation.trans}</p>
                        <p><span class="exp-label" style="color:var(--success)">T·∫°i sao ƒê√öNG:</span> ${item.explanation.whyCorrect}</p>
                        <p><span class="exp-label" style="color:var(--error)">T·∫°i sao SAI:</span> ${item.explanation.whyWrong}</p>
                    </div>
                </div>
            `;

            if (item.type === 'choice') {
                let optionsHTML = '';
                item.options.forEach((opt, idx) => {
                    optionsHTML += `<div class="btn-option" onclick="checkChoice(${item.id}, ${idx}, ${item.correctIndex}, this)">${opt}</div>`;
                });

                card.innerHTML = `
                    <div class="question-text"><strong>Q${item.id}:</strong> ${item.question.replace('________', '<u>.....</u>').replace('________', '<u>.....</u>')}</div>
                    <div class="options-grid">${optionsHTML}</div>
                    ${explanationHTML}
                `;
            } else if (item.type === 'gap-fill') {
                let sentenceHTML = `<div class="question-text gap-fill-text"><strong>Q${item.id}:</strong> `;
                
                item.sentenceParts.forEach((part, idx) => {
                    sentenceHTML += part;
                    if (idx < item.answers.length) {
                        sentenceHTML += `<span class="gap-input" id="gap-${item.id}-${idx}" onclick="openGapModal(${item.id}, ${idx})">?</span>`;
                    }
                });
                sentenceHTML += `</div>`;

                card.innerHTML = `
                    ${sentenceHTML}
                    ${explanationHTML}
                `;
            }

            quizContainer.appendChild(card);
        });
    }

    // --- LOGIC CHECKING ---

    // 1. Multiple Choice Logic
    window.checkChoice = function(qId, selectedIdx, correctIdx, btnElement) {
        const card = document.getElementById(`q-card-${qId}`);
        // Disable all buttons in this card
        const buttons = card.querySelectorAll('.btn-option');
        if(card.getAttribute('data-answered') === 'true') return; // Prevent re-answering
        card.setAttribute('data-answered', 'true');

        if (selectedIdx === correctIdx) {
            btnElement.classList.add('correct');
            playSound('correct');
            playConfetti();
            score++;
        } else {
            btnElement.classList.add('wrong');
            playSound('wrong');
            // Highlight correct one
            buttons[correctIdx].classList.add('correct');
        }

        // Show Explanation
        document.getElementById(`exp-${qId}`).classList.add('show');
    };

    // 2. Gap Fill Modal Logic
    let currentGap = { qId: null, gapIdx: null };

    window.openGapModal = function(qId, gapIdx) {
        const gapEl = document.getElementById(`gap-${qId}-${gapIdx}`);
        if(gapEl.classList.contains('filled-correct') || gapEl.classList.contains('filled-wrong')) return;

        currentGap = { qId, gapIdx };
        const qData = quizData.find(q => q.id === qId);
        const options = qData.options[gapIdx]; // Array of words for this specific gap

        const modalOpts = document.getElementById('modalOptionsContainer');
        modalOpts.innerHTML = '';
        
        options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'btn-option';
            btn.innerText = opt;
            btn.onclick = () => selectGapAnswer(opt);
            modalOpts.appendChild(btn);
        });

        document.getElementById('selectionModal').style.display = 'flex';
    };

    window.selectGapAnswer = function(selectedWord) {
        document.getElementById('selectionModal').style.display = 'none';
        const { qId, gapIdx } = currentGap;
        const qData = quizData.find(q => q.id === qId);
        const correctWord = qData.answers[gapIdx];
        const gapEl = document.getElementById(`gap-${qId}-${gapIdx}`);

        gapEl.innerText = selectedWord;

        if (selectedWord.toLowerCase() === correctWord.toLowerCase()) {
            gapEl.classList.add('filled-correct');
            playSound('correct');
            score++;
            playConfetti();
        } else {
            gapEl.classList.add('filled-wrong');
            playSound('wrong');
            // Append correct answer text small
            gapEl.innerHTML = `<strike>${selectedWord}</strike> <br><span style="font-size:0.8em">${correctWord}</span>`;
        }

        // Check if all gaps in this sentence are filled to show explanation
        let allFilled = true;
        for(let i=0; i<qData.answers.length; i++) {
            const g = document.getElementById(`gap-${qId}-${i}`);
            if(!g.classList.contains('filled-correct') && !g.classList.contains('filled-wrong')) {
                allFilled = false;
            }
        }

        if(allFilled) {
            document.getElementById(`exp-${qId}`).classList.add('show');
        }
    };

    // Close modal if clicking outside
    document.getElementById('selectionModal').onclick = function(e) {
        if(e.target === this) this.style.display = 'none';
    }

    // --- FINISH ---
    window.finishQuiz = function() {
        let percent = Math.round((score / maxScore) * 100);
        let msg = "";
        if(percent === 100) msg = "Xu·∫•t s·∫Øc! B·∫°n l√† thi√™n t√†i ng·ªØ ph√°p! üåü";
        else if(percent >= 80) msg = "R·∫•t t·ªët! Ms Mai An t·ª± h√†o v·ªÅ b·∫°n! üéâ";
        else if(percent >= 50) msg = "C·ªë g·∫Øng l√™n! √în l·∫°i b√†i m·ªôt ch√∫t l√† ·ªïn. üí™";
        else msg = "ƒê·ª´ng bu·ªìn nh√©, l√†m l·∫°i ƒë·ªÉ gi·ªèi h∆°n n√†o! üìö";

        alert(`T·ªîNG K·∫æT:\n\nƒêi·ªÉm c·ªßa b·∫°n: ${score} / ${maxScore}\n(${percent}%)\n\n${msg}`);
    };

    // Initialize
    renderQuiz();

</script>
</body>
</html>
