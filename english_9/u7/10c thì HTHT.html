<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentence Building Challenge - Ms Mai An ULIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-purple: #8854C0;
            --primary-teal: #00C9A7;
            --correct-green: #00D26A;
            --wrong-red: #FF4757;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-dark: #2d3436;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#8854c0 1.5px, transparent 1.5px), radial-gradient(#8854c0 1.5px, var(--bg-color) 1.5px);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 900px;
            margin-top: 20px;
            padding-bottom: 80px;
        }

        /* HEADER */
        .header {
            text-align: center;
            background: linear-gradient(135deg, var(--primary-purple), #a29bfe);
            color: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 0 #5f27cd;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-family: 'Quicksand', sans-serif;
            font-size: 2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header p {
            margin: 5px 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .score-board {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: white;
            color: var(--primary-purple);
            padding: 10px 20px;
            border-radius: 15px;
            font-weight: 800;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }

        /* QUESTION CARD */
        .question-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border: 2px solid #dfe6e9;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .q-tag {
            background: var(--primary-teal);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-purple);
            margin-bottom: 25px;
            line-height: 1.5;
            background: #fdf2f8;
            padding: 15px;
            border-radius: 15px;
            border-left: 5px solid var(--primary-purple);
        }

        /* OPTIONS GRID */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .option-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px 20px;
            font-family: 'Nunito', sans-serif;
            font-size: 1.05rem;
            color: var(--text-dark);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 4px 0 #b2bec3;
            display: flex;
            align-items: center;
        }

        .option-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #b2bec3;
            background-color: #f8f9fa;
        }

        .option-btn:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #b2bec3;
        }

        .option-letter {
            background: var(--primary-purple);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        /* STATES */
        .option-btn.correct {
            background-color: #d1fae5;
            border-color: var(--correct-green);
            box-shadow: 0 4px 0 #059669;
            color: #065f46;
        }
        .option-btn.correct .option-letter {
            background-color: var(--correct-green);
        }

        .option-btn.wrong {
            background-color: #ffe5e5;
            border-color: var(--wrong-red);
            box-shadow: 0 4px 0 #c0392b;
            color: #c0392b;
            animation: shake 0.5s;
        }
        .option-btn.wrong .option-letter {
            background-color: var(--wrong-red);
        }

        .option-btn:disabled {
            cursor: default;
            opacity: 0.8;
            pointer-events: none;
        }

        /* EXPLANATION BOX */
        .explanation-box {
            margin-top: 25px;
            background: #fff;
            border: 2px dashed var(--primary-purple);
            border-radius: 15px;
            padding: 20px;
            display: none; /* Hidden by default */
            animation: slideDown 0.4s ease-out;
        }

        .exp-header {
            font-weight: 800;
            color: var(--primary-purple);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .exp-content {
            font-size: 1rem;
            line-height: 1.6;
        }

        .exp-section {
            margin-bottom: 12px;
        }

        .exp-label {
            font-weight: 700;
            color: var(--primary-teal);
            display: block;
            margin-bottom: 4px;
        }

        /* ANIMATIONS */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            50% { transform: translateX(5px) rotate(2deg); }
            75% { transform: translateX(-5px) rotate(-2deg); }
            100% { transform: translateX(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* SUBMIT BUTTON */
        .submit-container {
            text-align: center;
            margin-top: 40px;
        }

        .submit-btn {
            background: var(--primary-teal);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            font-weight: 800;
            box-shadow: 0 6px 0 #009688;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Quicksand', sans-serif;
            text-transform: uppercase;
        }

        .submit-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 0 #009688;
        }

        .submit-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #009688;
        }

        /* CANVAS FOR CONFETTI */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 25px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            border: 4px solid var(--primary-purple);
            animation: zoomIn 0.3s;
        }

        .modal h2 {
            color: var(--primary-purple);
            font-family: 'Quicksand', sans-serif;
            font-size: 2rem;
        }

        .final-score {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary-teal);
            margin: 20px 0;
        }

        @keyframes zoomIn {
            from {transform: scale(0.5); opacity: 0;}
            to {transform: scale(1); opacity: 1;}
        }

        /* Responsive */
        @media (max-width: 600px) {
            .header h1 { font-size: 1.5rem; }
            .question-text { font-size: 1.1rem; }
            .score-board { position: static; transform: none; display: inline-block; margin-top: 10px; }
        }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div class="container">
        <div class="header">
            <h1>Ms Mai An ULIS</h1>
            <p>Sentence Building: Present Perfect Tense</p>
            <div class="score-board">ƒêi·ªÉm: <span id="current-score">0</span>/<span id="total-qs">0</span></div>
        </div>

        <div id="quiz-container">
            <!-- Questions will be rendered here -->
        </div>

        <div class="submit-container">
            <button class="submit-btn" onclick="finishQuiz()">N·ªòP B√ÄI & XEM ƒêI·ªÇM</button>
        </div>
    </div>

    <!-- Modal Result -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2>K·∫æT QU·∫¢ C·ª¶A CON</h2>
            <div class="final-score" id="final-score-display">0/10</div>
            <p id="teacher-comment" style="font-size: 1.2rem; margin-bottom: 20px;">...</p>
            <button class="submit-btn" onclick="closeModal()">Xem l·∫°i b√†i l√†m</button>
        </div>
    </div>

    <script>
        // --- DATASET FROM CONTEXT ---
        const quizDataRaw = {
          "questions": [
            {
              "questionNumber": 1,
              "question": "The Great Barrier Reef/ lose/ half/ its coral/ since 1995.",
              "answerOptions": [
                {
                  "text": "The Great Barrier Reef has lost half of its coral since 1995.",
                  "rationale": "**D·ªãch c√¢u:** R·∫°n san h√¥ Great Barrier ƒë√£ m·∫•t ƒëi m·ªôt n·ª≠a l∆∞·ª£ng san h√¥ k·ªÉ t·ª´ nƒÉm 1995.\n\n**Gi·∫£i th√≠ch chi ti·∫øt:**\n- **Th√¨:** C√≥ t·ª´ \"since 1995\" -> D√πng th√¨ Hi·ªán t·∫°i ho√†n th√†nh (Present Perfect).\n- **Ch·ªß ng·ªØ:** \"The Great Barrier Reef\" (s·ªë √≠t) -> D√πng tr·ª£ ƒë·ªông t·ª´ **has**.\n- **ƒê·ªông t·ª´:** \"lose\" (b·∫•t quy t·∫Øc) -> V3 l√† **lost**.\n- **C√¥ng th·ª©c:** S + has + V3.",
                  "isCorrect": true
                },
                {
                  "text": "The Great Barrier Reef lost half of its coral since 1995.",
                  "rationale": "**Gi·∫£i th√≠ch:** ƒê√¢y l√† th√¨ Qu√° kh·ª© ƒë∆°n (Past Simple), kh√¥ng d√πng v·ªõi \"since\" trong ng·ªØ c·∫£nh k·∫øt qu·∫£ c√≤n k√©o d√†i ƒë·∫øn hi·ªán t·∫°i.",
                  "isCorrect": false
                },
                {
                  "text": "The Great Barrier Reef has lose half of its coral since 1995.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai d·∫°ng ƒë·ªông t·ª´. Sau \"has\" ph·∫£i l√† V3 (lost), kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ nguy√™n th·ªÉ (lose).",
                  "isCorrect": false
                },
                {
                  "text": "The Great Barrier Reef have lost half of its coral since 1995.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai tr·ª£ ƒë·ªông t·ª´. Ch·ªß ng·ªØ s·ªë √≠t kh√¥ng d√πng \"have\".",
                  "isCorrect": false
                }
              ]
            },
            {
              "questionNumber": 2,
              "question": "Mount Everest/ grow/ taller/ every year/ due to/ tectonic movement.",
              "answerOptions": [
                {
                  "text": "Mount Everest has grown taller over the years due to tectonic movement.",
                  "rationale": "**D·ªãch c√¢u:** ƒê·ªânh Everest ƒë√£ cao th√™m qua c√°c nƒÉm do s·ª± v·∫≠n ƒë·ªông ki·∫øn t·∫°o.\n\n**Gi·∫£i th√≠ch chi ti·∫øt:**\n- **Th√¨:** Di·ªÖn t·∫£ s·ª± thay ƒë·ªïi k√©o d√†i t·ª´ qu√° kh·ª© ƒë·∫øn nay -> Hi·ªán t·∫°i ho√†n th√†nh.\n- **Ch·ªß ng·ªØ:** \"Mount Everest\" (s·ªë √≠t) -> D√πng **has**.\n- **ƒê·ªông t·ª´:** \"grow\" (b·∫•t quy t·∫Øc) -> V3 l√† **grown**.",
                  "isCorrect": true
                },
                {
                  "text": "Mount Everest grew taller every year due to tectonic movement.",
                  "rationale": "**Gi·∫£i th√≠ch:** Th√¨ Qu√° kh·ª© ƒë∆°n, di·ªÖn t·∫£ vi·ªác ƒë√£ ch·∫•m d·ª©t, kh√¥ng ph√π h·ª£p v·ªõi th·ª±c t·∫ø l√† n√∫i v·∫´n ƒëang cao l√™n.",
                  "isCorrect": false
                },
                {
                  "text": "Mount Everest has grow taller every year due to tectonic movement.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai d·∫°ng ƒë·ªông t·ª´ (thi·∫øu \"n\" ·ªü grown).",
                  "isCorrect": false
                },
                {
                  "text": "Mount Everest have grown taller every year due to tectonic movement.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai tr·ª£ ƒë·ªông t·ª´ (Mount Everest l√† s·ªë √≠t).",
                  "isCorrect": false
                }
              ]
            },
            {
              "questionNumber": 3,
              "question": "Tourists/ damage/ many parts/ Grand Canyon/ over the years.",
              "answerOptions": [
                {
                  "text": "Tourists have damaged many parts of the Grand Canyon over the years.",
                  "rationale": "**D·ªãch c√¢u:** Kh√°ch du l·ªãch ƒë√£ l√†m h∆∞ h·∫°i nhi·ªÅu ph·∫ßn c·ªßa h·∫ªm n√∫i Grand Canyon qua nhi·ªÅu nƒÉm.\n\n**Gi·∫£i th√≠ch chi ti·∫øt:**\n- **Th√¨:** \"Over the years\" (qua nhi·ªÅu nƒÉm) -> Hi·ªán t·∫°i ho√†n th√†nh.\n- **Ch·ªß ng·ªØ:** \"Tourists\" (s·ªë nhi·ªÅu) -> D√πng tr·ª£ ƒë·ªông t·ª´ **have**.\n- **ƒê·ªông t·ª´:** \"damage\" (c√≥ quy t·∫Øc) -> V3 l√† **damaged**.",
                  "isCorrect": true
                },
                {
                  "text": "Tourists damaged many parts of the Grand Canyon over the years.",
                  "rationale": "**Gi·∫£i th√≠ch:** Qu√° kh·ª© ƒë∆°n, ch∆∞a ch√≠nh x√°c b·∫±ng hi·ªán t·∫°i ho√†n th√†nh khi ƒëi v·ªõi \"over the years\".",
                  "isCorrect": false
                },
                {
                  "text": "Tourists have damage many parts of the Grand Canyon over the years.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai d·∫°ng ƒë·ªông t·ª´ (thi·∫øu ƒëu√¥i -ed).",
                  "isCorrect": false
                },
                {
                  "text": "Tourists has damaged many parts of the Grand Canyon over the years.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai tr·ª£ ƒë·ªông t·ª´. Ch·ªß ng·ªØ s·ªë nhi·ªÅu kh√¥ng d√πng \"has\".",
                  "isCorrect": false
                }
              ]
            },
            {
              "questionNumber": 4,
              "question": "Scientists/ never/ explore/ deepest parts/ Amazon Rainforest.",
              "answerOptions": [
                {
                  "text": "Scientists have never explored the deepest parts of the Amazon Rainforest.",
                  "rationale": "**D·ªãch c√¢u:** C√°c nh√† khoa h·ªçc ch∆∞a bao gi·ªù kh√°m ph√° nh·ªØng ph·∫ßn s√¢u nh·∫•t c·ªßa r·ª´ng m∆∞a Amazon.\n\n**Gi·∫£i th√≠ch chi ti·∫øt:**\n- **Th√¨:** C√≥ t·ª´ \"never\" (ch∆∞a t·ª´ng) n√≥i v·ªÅ tr·∫£i nghi·ªám -> Hi·ªán t·∫°i ho√†n th√†nh.\n- **Ch·ªß ng·ªØ:** \"Scientists\" (s·ªë nhi·ªÅu) -> D√πng **have**.\n- **V·ªã tr√≠ tr·∫°ng t·ª´:** \"never\" ƒë·ª©ng gi·ªØa have v√† V3 -> have **never** explored.",
                  "isCorrect": true
                },
                {
                  "text": "Scientists never explored the deepest parts of the Amazon Rainforest.",
                  "rationale": "**Gi·∫£i th√≠ch:** Qu√° kh·ª© ƒë∆°n, ng·ª• √Ω l√† vi·ªác n√†y ƒë√£ ch·∫•m d·ª©t (v√≠ d·ª• c√°c nh√† khoa h·ªçc ƒë√£ qua ƒë·ªùi ho·∫∑c kh√¥ng c√≤n l√†m vi·ªác n·ªØa).",
                  "isCorrect": false
                },
                {
                  "text": "Scientists have never explore the deepest parts of the Amazon Rainforest.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai d·∫°ng ƒë·ªông t·ª´ (thi·∫øu -ed).",
                  "isCorrect": false
                },
                {
                  "text": "Scientists has never explored the deepest parts of the Amazon Rainforest.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai tr·ª£ ƒë·ªông t·ª´ (Scientists s·ªë nhi·ªÅu kh√¥ng d√πng has).",
                  "isCorrect": false
                }
              ]
            },
            {
              "questionNumber": 5,
              "question": "Victoria Falls/ attract/ millions/ visitors/ since/ it/ become/ famous.",
              "answerOptions": [
                {
                  "text": "Victoria Falls has attracted millions of visitors since it became famous.",
                  "rationale": "**D·ªãch c√¢u:** Th√°c Victoria ƒë√£ thu h√∫t h√†ng tri·ªáu du kh√°ch k·ªÉ t·ª´ khi n√≥ tr·ªü n√™n n·ªïi ti·∫øng.\n\n**Gi·∫£i th√≠ch chi ti·∫øt:**\n- **C·∫•u tr√∫c v·ªõi SINCE:** M·ªánh ƒë·ªÅ ch√≠nh d√πng Hi·ªán t·∫°i ho√†n th√†nh (S + has attracted), m·ªánh ƒë·ªÅ sau \"since\" d√πng Qu√° kh·ª© ƒë∆°n (it became).\n- **Ch·ªß ng·ªØ ch√≠nh:** \"Victoria Falls\" (t√™n ri√™ng, s·ªë √≠t) -> D√πng **has**.",
                  "isCorrect": true
                },
                {
                  "text": "Victoria Falls attracted millions of visitors since it became famous.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai th√¨ ·ªü m·ªánh ƒë·ªÅ ch√≠nh (ph·∫£i d√πng HTHT, kh√¥ng d√πng QKƒê).",
                  "isCorrect": false
                },
                {
                  "text": "Victoria Falls have attracted millions of visitors since it became famous.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai tr·ª£ ƒë·ªông t·ª´. T√™n ƒë·ªãa danh s·ªë √≠t d√πng \"has\".",
                  "isCorrect": false
                },
                {
                  "text": "Victoria Falls has attract millions of visitors since it became famous.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai d·∫°ng ƒë·ªông t·ª´ (thi·∫øu -ed).",
                  "isCorrect": false
                }
              ]
            },
            {
              "questionNumber": 6,
              "question": "Climate change/ already/ affect/ Northern Lights/ visibility.",
              "answerOptions": [
                {
                  "text": "Climate change has already affected the Northern Lights' visibility.",
                  "rationale": "**D·ªãch c√¢u:** Bi·∫øn ƒë·ªïi kh√≠ h·∫≠u ƒë√£ ·∫£nh h∆∞·ªüng ƒë·∫øn t·∫ßm nh√¨n c·ªßa B·∫Øc C·ª±c Quang r·ªìi.\n\n**Gi·∫£i th√≠ch chi ti·∫øt:**\n- **Th√¨:** C√≥ t·ª´ \"already\" -> Hi·ªán t·∫°i ho√†n th√†nh.\n- **Ch·ªß ng·ªØ:** \"Climate change\" (kh√¥ng ƒë·∫øm ƒë∆∞·ª£c, s·ªë √≠t) -> D√πng **has**.\n- **V·ªã tr√≠ tr·∫°ng t·ª´:** \"already\" ƒë·ª©ng gi·ªØa has v√† V3 -> has **already** affected.",
                  "isCorrect": true
                },
                {
                  "text": "Climate change already affected the Northern Lights' visibility.",
                  "rationale": "**Gi·∫£i th√≠ch:** Qu√° kh·ª© ƒë∆°n, thi·∫øu tr·ª£ ƒë·ªông t·ª´.",
                  "isCorrect": false
                },
                {
                  "text": "Climate change has already affect the Northern Lights' visibility.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai d·∫°ng ƒë·ªông t·ª´ (thi·∫øu -ed).",
                  "isCorrect": false
                },
                {
                  "text": "Climate change have already affected the Northern Lights' visibility.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai tr·ª£ ƒë·ªông t·ª´ (s·ªë √≠t kh√¥ng d√πng have).",
                  "isCorrect": false
                }
              ]
            },
            {
              "questionNumber": 7,
              "question": "Ha Long Bay/ receive/ UNESCO recognition/ since 1994.",
              "answerOptions": [
                {
                  "text": "Ha Long Bay has received UNESCO recognition since 1994.",
                  "rationale": "**D·ªãch c√¢u:** V·ªãnh H·∫° Long ƒë√£ nh·∫≠n ƒë∆∞·ª£c s·ª± c√¥ng nh·∫≠n c·ªßa UNESCO t·ª´ nƒÉm 1994.\n\n**Gi·∫£i th√≠ch chi ti·∫øt:**\n- **Th√¨:** C√≥ \"since 1994\" -> Hi·ªán t·∫°i ho√†n th√†nh.\n- **Ch·ªß ng·ªØ:** \"Ha Long Bay\" (s·ªë √≠t) -> D√πng **has**.\n- **ƒê·ªông t·ª´:** \"receive\" (c√≥ quy t·∫Øc) -> V3 l√† **received**.",
                  "isCorrect": true
                },
                {
                  "text": "Ha Long Bay received UNESCO recognition since 1994.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai th√¨ (QKƒê kh√¥ng ƒëi v·ªõi since).",
                  "isCorrect": false
                },
                {
                  "text": "Ha Long Bay has receive UNESCO recognition since 1994.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai d·∫°ng ƒë·ªông t·ª´ (thi·∫øu -ed).",
                  "isCorrect": false
                },
                {
                  "text": "Ha Long Bay have received UNESCO recognition since 1994.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai tr·ª£ ƒë·ªông t·ª´ (s·ªë √≠t kh√¥ng d√πng have).",
                  "isCorrect": false
                }
              ]
            },
            {
              "questionNumber": 8,
              "question": "Many species/ disappear/ from/ Sahara Desert/ recent decades.",
              "answerOptions": [
                {
                  "text": "Many species have disappeared from the Sahara Desert in recent decades.",
                  "rationale": "**D·ªãch c√¢u:** Nhi·ªÅu lo√†i ƒë√£ bi·∫øn m·∫•t kh·ªèi sa m·∫°c Sahara trong nh·ªØng th·∫≠p k·ª∑ g·∫ßn ƒë√¢y.\n\n**Gi·∫£i th√≠ch chi ti·∫øt:**\n- **Th√¨:** \"In recent decades\" (trong c√°c th·∫≠p k·ª∑ g·∫ßn ƒë√¢y) -> Hi·ªán t·∫°i ho√†n th√†nh.\n- **Ch·ªß ng·ªØ:** \"Many species\" (s·ªë nhi·ªÅu) -> D√πng **have**.\n- **ƒê·ªông t·ª´:** \"disappear\" -> V3 l√† **disappeared**.",
                  "isCorrect": true
                },
                {
                  "text": "Many species disappeared from the Sahara Desert in recent decades.",
                  "rationale": "**Gi·∫£i th√≠ch:** Qu√° kh·ª© ƒë∆°n, th∆∞·ªùng d√πng khi c√≥ m·ªëc th·ªùi gian c·ª• th·ªÉ trong qu√° kh·ª© (v√≠ d·ª•: in 1990) h∆°n l√† kho·∫£ng th·ªùi gian k√©o d√†i ƒë·∫øn nay.",
                  "isCorrect": false
                },
                {
                  "text": "Many species has disappeared from the Sahara Desert in recent decades.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai tr·ª£ ƒë·ªông t·ª´ (species s·ªë nhi·ªÅu kh√¥ng d√πng has).",
                  "isCorrect": false
                },
                {
                  "text": "Many species have disappear from the Sahara Desert in recent decades.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai d·∫°ng ƒë·ªông t·ª´ (thi·∫øu -ed).",
                  "isCorrect": false
                }
              ]
            },
            {
              "questionNumber": 9,
              "question": "Niagara Falls/ not freeze/ completely/ for/ 100 years.",
              "answerOptions": [
                {
                  "text": "Niagara Falls has not frozen completely for 100 years.",
                  "rationale": "**D·ªãch c√¢u:** Th√°c Niagara ƒë√£ kh√¥ng ƒë√≥ng bƒÉng ho√†n to√†n trong su·ªët 100 nƒÉm qua.\n\n**Gi·∫£i th√≠ch chi ti·∫øt:**\n- **Th√¨:** \"For 100 years\" -> Hi·ªán t·∫°i ho√†n th√†nh.\n- **Th·ªÉ:** Ph·ªß ƒë·ªãnh (not freeze) -> has not + V3.\n- **Ch·ªß ng·ªØ:** \"Niagara Falls\" (t√™n ri√™ng, s·ªë √≠t) -> D√πng **has**.\n- **ƒê·ªông t·ª´:** \"freeze\" (b·∫•t quy t·∫Øc) -> V3 l√† **frozen**.",
                  "isCorrect": true
                },
                {
                  "text": "Niagara Falls did not freeze completely for 100 years.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai th√¨ (QKƒê).",
                  "isCorrect": false
                },
                {
                  "text": "Niagara Falls have not frozen completely for 100 years.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai tr·ª£ ƒë·ªông t·ª´ (s·ªë √≠t kh√¥ng d√πng have).",
                  "isCorrect": false
                },
                {
                  "text": "Niagara Falls has not freeze completely for 100 years.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai d·∫°ng ƒë·ªông t·ª´ (ph·∫£i l√† frozen, kh√¥ng ph·∫£i freeze).",
                  "isCorrect": false
                }
              ]
            },
            {
              "questionNumber": 10,
              "question": "The Dead Sea/ shrink/ significantly/ past 50 years.",
              "answerOptions": [
                {
                  "text": "The Dead Sea has shrunk significantly in the past 50 years.",
                  "rationale": "**D·ªãch c√¢u:** Bi·ªÉn Ch·∫øt ƒë√£ thu h·∫πp ƒë√°ng k·ªÉ trong 50 nƒÉm qua.\n\n**Gi·∫£i th√≠ch chi ti·∫øt:**\n- **Th√¨:** \"In the past 50 years\" -> Hi·ªán t·∫°i ho√†n th√†nh.\n- **Ch·ªß ng·ªØ:** \"The Dead Sea\" (s·ªë √≠t) -> D√πng **has**.\n- **ƒê·ªông t·ª´:** \"shrink\" (b·∫•t quy t·∫Øc) -> V3 l√† **shrunk** (ho·∫∑c shrunken).",
                  "isCorrect": true
                },
                {
                  "text": "The Dead Sea shrank significantly in the past 50 years.",
                  "rationale": "**Gi·∫£i th√≠ch:** Qu√° kh·ª© ƒë∆°n (shrank l√† V2).",
                  "isCorrect": false
                },
                {
                  "text": "The Dead Sea has shrank significantly in the past 50 years.",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai d·∫°ng ƒë·ªông t·ª´ (sau has ph·∫£i l√† V3 shrunk, kh√¥ng ph·∫£i V2 shrank).",
                  "isCorrect": false
                },
                {
                  "text": "The Dead Sea have shrunk significantly in the past 50 years",
                  "rationale": "**Gi·∫£i th√≠ch:** Sai tr·ª£ ƒë·ªông t·ª´ (s·ªë √≠t kh√¥ng d√πng have).",
                  "isCorrect": false
                }
              ]
            }
          ]
        };

        // --- GLOBAL VARIABLES ---
        let currentScore = 0;
        let answeredCount = 0;
        const totalQuestions = quizDataRaw.questions.length;
        
        // --- SOUND SYSTEM (Using AudioContext for no-dependency sounds) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'correct') {
                // Ding effect
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            } else {
                // Buzz/Error effect
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- SHUFFLE FUNCTION ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- RENDER GAME ---
        function initGame() {
            // Shuffle questions
            shuffleArray(quizDataRaw.questions);
            
            const container = document.getElementById('quiz-container');
            document.getElementById('total-qs').textContent = totalQuestions;

            quizDataRaw.questions.forEach((q, index) => {
                const qEl = document.createElement('div');
                qEl.className = 'question-card';
                qEl.id = `q-card-${index}`;

                // Process options: assign original index to track correctness later
                let optionsWithIndex = q.answerOptions.map((opt, i) => ({...opt, originalIndex: i}));
                
                // Note: We might NOT want to shuffle options for Sentence Building if they follow a pattern, 
                // but usually MCQs are shuffled. Let's shuffle options too.
                shuffleArray(optionsWithIndex);

                let optionsHtml = '';
                const letters = ['A', 'B', 'C', 'D'];
                
                optionsWithIndex.forEach((opt, i) => {
                    optionsHtml += `
                        <button class="option-btn" onclick="handleAnswer(${index}, ${opt.isCorrect}, this)">
                            <span class="option-letter">${letters[i]}</span>
                            <span class="option-text">${opt.text}</span>
                        </button>
                    `;
                });

                qEl.innerHTML = `
                    <div class="question-header">
                        <span class="q-tag">Question ${index + 1}</span>
                    </div>
                    <div class="question-text">
                         ${q.question}
                    </div>
                    <div class="options-grid">
                        ${optionsHtml}
                    </div>
                    <div class="explanation-box" id="exp-${index}">
                        <!-- Content injected via JS -->
                    </div>
                `;
                container.appendChild(qEl);
            });
        }

        function escapeHtml(text) {
          return text
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
        }

        // --- HANDLE ANSWER ---
        function handleAnswer(qIndex, isCorrect, btnEl) {
            // Check if already answered
            const card = document.getElementById(`q-card-${qIndex}`);
            if (card.classList.contains('answered')) return;
            card.classList.add('answered');

            // Retrieve options directly from data source instead of passing via HTML arguments
            // This prevents syntax errors when text contains quotes (e.g., "Northern Lights'")
            const allOptions = quizDataRaw.questions[qIndex].answerOptions;
            
            const expBox = document.getElementById(`exp-${qIndex}`);
            const buttons = card.querySelectorAll('.option-btn');

            answeredCount++;

            if (isCorrect) {
                // Correct Logic
                btnEl.classList.add('correct');
                playSound('correct');
                fireConfetti();
                currentScore++;
                document.getElementById('current-score').textContent = currentScore;
            } else {
                // Wrong Logic
                btnEl.classList.add('wrong');
                playSound('wrong');
                // Highlight correct one
                buttons.forEach(b => {
                    // Logic to find the button that has the text of the correct answer
                    // Since we shuffled, we find the one that corresponds to the correct data
                    // Actually, simpler: loop through original data to find correct text
                    const correctOptData = allOptions.find(o => o.isCorrect);
                    if(b.querySelector('.option-text').textContent === correctOptData.text) {
                        b.classList.add('correct');
                    }
                });
            }

            // Disable all buttons
            buttons.forEach(b => b.disabled = true);

            // GENERATE MS MAI AN'S EXPLANATION
            const correctOption = allOptions.find(o => o.isCorrect);
            
            // Extract Translation and Main Grammar from Correct Option's Rationale
            // The JSON has formatting like "**D·ªãch c√¢u:** ..."
            let rawCorrectRationale = correctOption.rationale;
            
            // Basic parsing to separate sections (assuming the consistent format in JSON)
            // If format varies, we display the raw markdown rendered nicely.
            
            let explanationHtml = `
                <div class="exp-header">
                    <i style="font-size: 1.5rem">üë©‚Äçüè´</i> L·ªùi gi·∫£i th√≠ch c·ªßa c√¥ Mai An:
                </div>
                <div class="exp-content">
            `;

            // 1. D·ªãch & Gi·∫£i th√≠ch ƒë√∫ng
            explanationHtml += `
                <div class="exp-section">
                    <span class="exp-label">‚úÖ T·∫°i sao ƒë√°p √°n n√†y ƒë√∫ng?</span>
                    ${renderMarkdown(rawCorrectRationale)}
                </div>
            `;

            // 2. Ph√¢n t√≠ch l·ªói sai (n·∫øu ch·ªçn sai) ho·∫∑c hi·ªÉn th·ªã c√°c l·ªói sai th∆∞·ªùng g·∫∑p
            let wrongAnalysisHtml = '';
            allOptions.forEach((opt, idx) => {
                if (!opt.isCorrect) {
                    // Extract just the explanation part from wrong answers usually starting with "**Gi·∫£i th√≠ch:**"
                    let cleanReason = opt.rationale.replace(/\*\*Gi·∫£i th√≠ch:\*\*/g, "").trim();
                    wrongAnalysisHtml += `<li style="margin-bottom: 5px;"><b>${opt.text}</b>: ${cleanReason}</li>`;
                }
            });

            if (wrongAnalysisHtml) {
                explanationHtml += `
                    <div class="exp-section">
                        <span class="exp-label">‚ö†Ô∏è T·∫°i sao c√°c ƒë√°p √°n kh√°c sai?</span>
                        <ul style="padding-left: 20px; margin: 5px 0;">${wrongAnalysisHtml}</ul>
                    </div>
                `;
            }

            explanationHtml += `</div>`;
            expBox.innerHTML = explanationHtml;
            expBox.style.display = 'block';
        }

        // Helper to basic render markdown-like bold syntax
        function renderMarkdown(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        // --- CONFETTI EFFECT ---
        function fireConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const pieces = [];
            const numberOfPieces = 100;
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff'];

            function Piece(x, y) {
                this.x = x;
                this.y = y;
                this.size = (Math.random() * 0.5 + 0.75) * 15;
                this.gravity = (Math.random() * 0.5 + 0.75) * 0.5;
                this.rotation = (Math.PI * 2) * Math.random();
                this.rotationSpeed = (Math.PI * 2) * (Math.random() - 0.5) * 0.05;
                this.color = colors[Math.floor(Math.random() * colors.length)];
            }
            
            Piece.prototype.update = function() {
                this.y += this.gravity;
                this.rotation += this.rotationSpeed;
            }
            
            Piece.prototype.draw = function() {
                ctx.save();
                ctx.fillStyle = this.color;
                ctx.translate(this.x + this.size / 2, this.y + this.size / 2);
                ctx.rotate(this.rotation);
                ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
                ctx.restore();
            }

            // Spawn center
            for (let i = 0; i < numberOfPieces; i++) {
                pieces.push(new Piece(window.innerWidth / 2, window.innerHeight / 2));
            }

            let animationId;
            function loop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let activePieces = 0;
                pieces.forEach(p => {
                    p.update();
                    p.draw();
                    if (p.y < canvas.height) activePieces++;
                });

                if (activePieces > 0) {
                    animationId = requestAnimationFrame(loop);
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }
            loop();
        }

        // --- FINISH & MODAL ---
        function finishQuiz() {
            const modal = document.getElementById('resultModal');
            const scoreDisplay = document.getElementById('final-score-display');
            const comment = document.getElementById('teacher-comment');

            scoreDisplay.textContent = `${currentScore}/${totalQuestions}`;
            
            const percentage = (currentScore / totalQuestions) * 100;
            if (percentage === 100) {
                comment.textContent = "üåü Xu·∫•t s·∫Øc! Con l√† thi√™n t√†i Ti·∫øng Anh!";
                fireConfetti();
                playSound('correct');
            } else if (percentage >= 80) {
                comment.textContent = "üéâ R·∫•t t·ªët! Con l√†m b√†i r·∫•t ch·∫Øc ch·∫Øn!";
                playSound('correct');
            } else if (percentage >= 50) {
                comment.textContent = "üí™ C·ªë g·∫Øng l√™n! Con c·∫ßn √¥n l·∫°i m·ªôt ch√∫t nh√©!";
            } else {
                comment.textContent = "üìö Con c·∫ßn luy·ªán t·∫≠p th√™m nhi·ªÅu nha!";
            }

            modal.style.display = "block";
        }

        function closeModal() {
            document.getElementById('resultModal').style.display = "none";
        }

        // Initialize
        window.onload = initGame;

    </script>
</body>
</html>
