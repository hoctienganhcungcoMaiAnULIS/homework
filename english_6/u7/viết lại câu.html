<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trắc nghiệm Tổng hợp Exercise 16 - 19 (Full) - Ms Mai An ULIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #8854C0; /* Tím hồng */
            --secondary-color: #00C9A7; /* Xanh ngọc */
            --accent-color: #FF9F43; /* Cam */
            --correct-color: #00D26A; /* Xanh lá */
            --wrong-color: #FF4757; /* Đỏ */
            --bg-pattern: radial-gradient(#ffffff 15%, transparent 16%), radial-gradient(#ffffff 15%, transparent 16%);
            --bg-color: #f0f3f8;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #e5e5f7;
            background-image:  repeating-radial-gradient( circle at 0 0, transparent 0, #e5e5f7 10px ), repeating-linear-gradient( #a29bfe55, #a29bfe55 );
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .header-container {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header-title {
            font-family: 'Quicksand', sans-serif;
            color: var(--primary-color);
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 2px 2px 0px #fff, 4px 4px 0px rgba(0,0,0,0.1);
            background: #fff;
            display: inline-block;
            padding: 15px 30px;
            border-radius: 50px;
            border: 4px solid var(--primary-color);
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
        }

        .teacher-name {
            font-size: 1.2rem;
            color: #555;
            margin-top: 10px;
            font-weight: 700;
            background-color: #FF9F43;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            box-shadow: 0 4px 0 #e67e22;
        }

        .quiz-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .question-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border-bottom: 6px solid #dfe4ea;
            position: relative;
            transition: transform 0.3s;
        }

        .question-card:hover {
            transform: translateY(-5px);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .q-number {
            background: var(--secondary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-weight: 800;
            font-size: 1.1rem;
            box-shadow: 0 4px 0 #009e82;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2f3542;
            line-height: 1.5;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .option-btn {
            background: #fff;
            border: 2px solid #dfe4ea;
            border-radius: 15px;
            padding: 15px 20px;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: #57606f;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            text-align: left;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 0 #dfe4ea;
        }

        .option-btn:hover:not(.disabled) {
            transform: translateY(-2px);
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: 0 6px 0 #dfe4ea;
        }

        .option-btn:active:not(.disabled) {
            transform: translateY(2px);
            box-shadow: 0 0 0 #dfe4ea;
        }

        /* States */
        .option-btn.correct {
            background-color: var(--correct-color);
            color: white;
            border-color: var(--correct-color);
            box-shadow: 0 4px 0 #00b85c;
        }

        .option-btn.wrong {
            background-color: var(--wrong-color);
            color: white;
            border-color: var(--wrong-color);
            box-shadow: 0 4px 0 #d63031;
            animation: shake 0.5s;
        }

        .option-btn.disabled {
            cursor: default;
            opacity: 0.7;
            pointer-events: none;
        }

        .explanation-box {
            margin-top: 20px;
            background: #f1f2f6;
            border-left: 5px solid var(--primary-color);
            border-radius: 10px;
            padding: 20px;
            display: none; /* Hidden by default */
            animation: slideDown 0.4s ease-out;
        }

        .explanation-title {
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .explanation-content p {
            margin: 8px 0;
            font-size: 1rem;
            color: #2f3542;
        }
        
        .explanation-detail-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        
        .explanation-detail-item {
            background: #fff;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid #dfe4ea;
            font-size: 0.95rem;
        }

        .explanation-detail-item strong {
            color: var(--primary-color);
        }

        /* Animations */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            50% { transform: translateX(5px) rotate(2deg); }
            75% { transform: translateX(-5px) rotate(-2deg); }
            100% { transform: translateX(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .hint-text {
            color: #747d8c;
            font-style: italic;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .submit-section {
            text-align: center;
            margin: 40px 0;
        }

        .submit-btn {
            background: var(--primary-color);
            color: white;
            font-size: 1.5rem;
            padding: 15px 50px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 800;
            box-shadow: 0 8px 0 #6c429c;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 0 #6c429c;
        }

        .submit-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #6c429c;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .modal-score {
            font-size: 4rem;
            font-weight: 800;
            color: var(--secondary-color);
            margin: 20px 0;
        }

        .modal-message {
            font-size: 1.2rem;
            color: #57606f;
            margin-bottom: 30px;
        }

        /* Canvas for confetti */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

    </style>
</head>
<body>

    <div class="header-container">
        <div class="header-title">Trắc nghiệm Tổng hợp Exercise 16 - 19</div>
        <br>
        <div class="teacher-name">Giáo viên: Ms Mai An ULIS</div>
    </div>

    <div class="quiz-container" id="quiz-content">
        <!-- Questions will be injected here by JS -->
    </div>

    <div class="submit-section">
        <button class="submit-btn" onclick="finishQuiz()">NỘP BÀI</button>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--primary-color);">KẾT QUẢ BÀI LÀM</h2>
            <div class="modal-score" id="finalScore">0/0</div>
            <p class="modal-message" id="finalMessage">Bạn đã làm rất tốt!</p>
            <button class="submit-btn" style="font-size: 1rem; padding: 10px 30px;" onclick="closeModal()">Xem lại bài</button>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>

<script>
    // --- DATA ---
    const quizData = {
        "questions": [
            {
                "questionNumber": 1,
                "question": "Ex 16-1: Reorder: watch/ My parents/ every evening/ the news",
                "answerOptions": [
                    { "text": "A. My parents watch the news every evening.", "rationale": "**Dịch:** Bố mẹ tôi xem tin tức mỗi buổi tối.<br>**Giải thích:** S (My parents) + V (watch) + O (the news) + Time (every evening).", "isCorrect": true },
                    { "text": "B. My parents watch every evening the news.", "rationale": "**Sai:** Trạng từ chỉ thời gian không đứng giữa động từ và tân ngữ.", "isCorrect": false },
                    { "text": "C. Every evening watch the news my parents.", "rationale": "**Sai:** Sai trật tự câu.", "isCorrect": false },
                    { "text": "D. The news watch my parents every evening.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false }
                ],
                "hint": "Chủ ngữ + Động từ + Tân ngữ + Thời gian."
            },
            {
                "questionNumber": 2,
                "question": "Ex 16-2: Reorder: too much/ shouldn't/ Children/ television/ watch",
                "answerOptions": [
                    { "text": "A. Children shouldn't watch television too much.", "rationale": "**Chấp nhận được nhưng chưa tối ưu:** 'too much television' là cụm danh từ chuẩn hơn.", "isCorrect": false },
                    { "text": "B. Children shouldn't watch too much television.", "rationale": "**Dịch:** Trẻ em không nên xem quá nhiều tivi.<br>**Giải thích:** S (Children) + Modal (shouldn't) + V (watch) + O (too much television).", "isCorrect": true },
                    { "text": "C. Children watch shouldn't too much television.", "rationale": "**Sai:** Động từ khuyết thiếu đứng trước động từ thường.", "isCorrect": false },
                    { "text": "D. Television shouldn't watch children too much.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false }
                ],
                "hint": "Shouldn't + động từ nguyên thể."
            },
            {
                "questionNumber": 3,
                "question": "Ex 16-3: Reorder: is/ favorite/ What/ TV program/ your/?",
                "answerOptions": [
                    { "text": "A. What is favorite your TV program?", "rationale": "**Sai:** Tính từ sở hữu 'your' phải đứng trước tính từ 'favorite'.", "isCorrect": false },
                    { "text": "B. What is your favorite TV program?", "rationale": "**Dịch:** Chương trình TV yêu thích của bạn là gì?<br>**Giải thích:** Wh-word (What) + to be (is) + S (your favorite TV program)?", "isCorrect": true },
                    { "text": "C. What your favorite TV program is?", "rationale": "**Sai:** Đây là trật tự câu trần thuật, không phải câu hỏi.", "isCorrect": false },
                    { "text": "D. What TV program is your favorite?", "rationale": "**Đúng ngữ pháp nhưng không sát từ cho sẵn:** Đề bài cho 'favorite' đứng riêng, cấu trúc B phổ biến hơn với các từ đã cho.", "isCorrect": false }
                ],
                "hint": "Your favorite TV program."
            },
            {
                "questionNumber": 4,
                "question": "Ex 16-4: Reorder: the living room/ The television/ in/ is/ big",
                "answerOptions": [
                    { "text": "A. The big television is in the living room.", "rationale": "**Dịch:** Chiếc tivi lớn nằm ở trong phòng khách.<br>**Giải thích:** Cụm danh từ: The + Adj (big) + N (television).", "isCorrect": true },
                    { "text": "B. The television is big in the living room.", "rationale": "**Khác nghĩa:** Câu này nghĩa là 'Cái tivi thì to khi ở trong phòng khách'. Câu A tự nhiên hơn.", "isCorrect": false },
                    { "text": "C. In the living room is the big television.", "rationale": "**Đảo ngữ:** Đúng nhưng ít dùng trong văn nói thông thường.", "isCorrect": false },
                    { "text": "D. The television big is in the living room.", "rationale": "**Sai:** Tính từ phải đứng trước danh từ.", "isCorrect": false }
                ],
                "hint": "Tính từ 'big' đứng trước danh từ 'television'."
            },
            {
                "questionNumber": 5,
                "question": "Ex 16-5: Reorder: cartoons/ My sister/ on Saturday/ watches/ morning",
                "answerOptions": [
                    { "text": "A. My sister watches cartoons on Saturday morning.", "rationale": "**Dịch:** Em gái tôi xem hoạt hình vào sáng thứ Bảy.<br>**Giải thích:** S + V (chia số ít) + O + Time.", "isCorrect": true },
                    { "text": "B. My sister watches on Saturday morning cartoons.", "rationale": "**Sai:** Sai vị trí trạng ngữ thời gian.", "isCorrect": false },
                    { "text": "C. On Saturday morning my sister watches cartoons.", "rationale": "**Đúng:** Nhưng cấu trúc xuôi (A) là đáp án chuẩn nhất cho bài tập sắp xếp từ.", "isCorrect": false },
                    { "text": "D. My sister cartoons watches on Saturday morning.", "rationale": "**Sai:** Sai trật tự từ.", "isCorrect": false }
                ],
                "hint": "Chủ ngữ + Động từ + Tân ngữ + Thời gian."
            },
            {
                "questionNumber": 6,
                "question": "Ex 16-6: Reorder: can/ the remote control/ I/ find/ not",
                "answerOptions": [
                    { "text": "A. I can find not the remote control.", "rationale": "**Sai:** Phủ định của can là 'cannot' hoặc 'can not', 'not' đứng sau can.", "isCorrect": false },
                    { "text": "B. I cannot find the remote control.", "rationale": "**Dịch:** Tôi không thể tìm thấy cái điều khiển từ xa.<br>**Giải thích:** S + can + not + V + O.", "isCorrect": true },
                    { "text": "C. I not can find the remote control.", "rationale": "**Sai:** Sai ngữ pháp.", "isCorrect": false },
                    { "text": "D. The remote control I cannot find.", "rationale": "**Sai:** Dạng câu nhấn mạnh tân ngữ, không phải cấu trúc cơ bản.", "isCorrect": false }
                ],
                "hint": "Can + not = Cannot."
            },
            {
                "questionNumber": 7,
                "question": "Ex 16-7: Reorder: at 8 PM/ starts/ The talent show/ tonight",
                "answerOptions": [
                    { "text": "A. The talent show at 8 PM starts tonight.", "rationale": "**Sai:** Sai trật tự.", "isCorrect": false },
                    { "text": "B. The talent show starts tonight at 8 PM.", "rationale": "**Đúng:** Nhưng thường giờ giấc đi trước buổi (at 8 PM tonight).", "isCorrect": false },
                    { "text": "C. The talent show starts at 8 PM tonight.", "rationale": "**Dịch:** Chương trình tìm kiếm tài năng bắt đầu lúc 8 giờ tối nay.<br>**Giải thích:** S + V + Time (giờ) + Time (buổi).", "isCorrect": true },
                    { "text": "D. Tonight starts the talent show at 8 PM.", "rationale": "**Sai:** Sai trật tự.", "isCorrect": false }
                ],
                "hint": "Giờ cụ thể (at 8 PM) thường đứng trước thời gian chung (tonight)."
            },
            {
                "questionNumber": 8,
                "question": "Ex 16-8: Reorder: TV/ during/ We/ watch/ dinner/ don't",
                "answerOptions": [
                    { "text": "A. We watch don't TV during dinner.", "rationale": "**Sai:** Trợ động từ phủ định đứng trước động từ chính.", "isCorrect": false },
                    { "text": "B. We don't watch TV during dinner.", "rationale": "**Dịch:** Chúng tôi không xem TV trong bữa tối.<br>**Giải thích:** S + don't + V + O + Time.", "isCorrect": true },
                    { "text": "C. We don't during dinner watch TV.", "rationale": "**Sai:** Sai vị trí trạng ngữ.", "isCorrect": false },
                    { "text": "D. During dinner we don't watch TV.", "rationale": "**Đúng:** Nhưng ưu tiên cấu trúc xuôi S-V-O.", "isCorrect": false }
                ],
                "hint": "Câu phủ định: Don't + V."
            },
            {
                "questionNumber": 9,
                "question": "Ex 16-9: Reorder: documentary/ watching/ about animals/ They/ are/ a",
                "answerOptions": [
                    { "text": "A. They are watching a documentary about animals.", "rationale": "**Dịch:** Họ đang xem một bộ phim tài liệu về động vật.<br>**Giải thích:** Thì hiện tại tiếp diễn: S + are + V-ing + O.", "isCorrect": true },
                    { "text": "B. They are watching about animals a documentary.", "rationale": "**Sai:** Cụm danh từ 'a documentary about animals' không được tách rời.", "isCorrect": false },
                    { "text": "C. They watching are a documentary about animals.", "rationale": "**Sai:** Sai vị trí to be 'are'.", "isCorrect": false },
                    { "text": "D. A documentary about animals are watching they.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false }
                ],
                "hint": "Cụm từ: a documentary about animals."
            },
            {
                "questionNumber": 10,
                "question": "Ex 16-10: Reorder: turn off/ before/ Please/ going to bed/ the TV",
                "answerOptions": [
                    { "text": "A. Please turn off the TV before going to bed.", "rationale": "**Dịch:** Làm ơn tắt TV trước khi đi ngủ.<br>**Giải thích:** Câu mệnh lệnh: Please + V + O + Time phrase.", "isCorrect": true },
                    { "text": "B. Before going to bed please turn off the TV.", "rationale": "**Đúng:** Nhưng cấu trúc Please đứng đầu câu phổ biến hơn trong bài tập này.", "isCorrect": false },
                    { "text": "C. Please turn off going to bed before the TV.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false },
                    { "text": "D. Turn off the TV please before going to bed.", "rationale": "**Đúng:** Nhưng 'Please' đầu câu lịch sự và chuẩn mực hơn.", "isCorrect": false }
                ],
                "hint": "Cấu trúc: Please + động từ..."
            },
            {
                "questionNumber": 11,
                "question": "Ex 17-1: Build sentence: My brother/ watch/ sports programs/ every weekend.",
                "answerOptions": [
                    { "text": "A. My brother watches sports programs every weekend.", "rationale": "**Dịch:** Anh trai tôi xem các chương trình thể thao mỗi cuối tuần.<br>**Giải thích:** Chia thì hiện tại đơn với chủ ngữ số ít 'My brother' (watch -> watches).", "isCorrect": true },
                    { "text": "B. My brother watch sports programs every weekend.", "rationale": "**Sai:** Thiếu 'es' ở động từ watch.", "isCorrect": false },
                    { "text": "C. My brother is watching sports programs every weekend.", "rationale": "**Sai:** 'Every weekend' là dấu hiệu hiện tại đơn.", "isCorrect": false },
                    { "text": "D. My brother watched sports programs every weekend.", "rationale": "**Sai:** Sai thì.", "isCorrect": false }
                ],
                "hint": "Chủ ngữ số ít 'My brother' -> động từ thêm 'es'."
            },
            {
                "questionNumber": 12,
                "question": "Ex 17-2: Build sentence: There/ be/ three televisions/ our house.",
                "answerOptions": [
                    { "text": "A. There is three televisions in our house.", "rationale": "**Sai:** Số nhiều (three televisions) phải dùng 'are'.", "isCorrect": false },
                    { "text": "B. There are three televisions in our house.", "rationale": "**Dịch:** Có 3 chiếc tivi trong nhà chúng tôi.<br>**Giải thích:** Cấu trúc There are + N số nhiều + giới từ chỉ nơi chốn (in).", "isCorrect": true },
                    { "text": "C. There have three televisions in our house.", "rationale": "**Sai:** Cấu trúc liệt kê là 'There be', không dùng 'There have'.", "isCorrect": false },
                    { "text": "D. There are three televisions on our house.", "rationale": "**Sai:** Giới từ 'on' (trên mái nhà) không hợp lý bằng 'in' (trong nhà).", "isCorrect": false }
                ],
                "hint": "Số nhiều dùng 'There are'. Trong nhà dùng 'in'."
            },
            {
                "questionNumber": 13,
                "question": "Ex 17-3: Build sentence: Children/ should/ not sit/ too close/ the screen.",
                "answerOptions": [
                    { "text": "A. Children should not sit too close the screen.", "rationale": "**Sai:** Thiếu giới từ 'to'.", "isCorrect": false },
                    { "text": "B. Children should not sitting too close to the screen.", "rationale": "**Sai:** Sau should là động từ nguyên thể.", "isCorrect": false },
                    { "text": "C. Children should not sit too close to the screen.", "rationale": "**Dịch:** Trẻ em không nên ngồi quá gần màn hình.<br>**Giải thích:** Close TO something.", "isCorrect": true },
                    { "text": "D. Children shouldn't to sit too close to the screen.", "rationale": "**Sai:** Thừa 'to' sau shouldn't.", "isCorrect": false }
                ],
                "hint": "Close TO the screen."
            },
            {
                "questionNumber": 14,
                "question": "Ex 17-4: Build sentence: My grandmother/ enjoy/ watch/ cooking shows/ afternoon.",
                "answerOptions": [
                    { "text": "A. My grandmother enjoys watch cooking shows in the afternoon.", "rationale": "**Sai:** Enjoy + V-ing.", "isCorrect": false },
                    { "text": "B. My grandmother enjoys watching cooking shows in the afternoon.", "rationale": "**Dịch:** Bà tôi thích xem chương trình nấu ăn vào buổi chiều.<br>**Giải thích:** Chia 'enjoys' (số ít), sau enjoy dùng 'watching', thêm giới từ 'in the'.", "isCorrect": true },
                    { "text": "C. My grandmother enjoy watching cooking shows in the afternoon.", "rationale": "**Sai:** Thiếu 's' ở động từ enjoy.", "isCorrect": false },
                    { "text": "D. My grandmother enjoys watching cooking shows on afternoon.", "rationale": "**Sai:** Phải là 'in the afternoon'.", "isCorrect": false }
                ],
                "hint": "Enjoy + V-ing."
            },
            {
                "questionNumber": 15,
                "question": "Ex 17-5: Build sentence: We/ need/ buy/ new remote control/ our TV.",
                "answerOptions": [
                    { "text": "A. We need buying a new remote control for our TV.", "rationale": "**Sai:** Need to V (cần phải làm gì). Need V-ing mang nghĩa bị động (cần được làm gì).", "isCorrect": false },
                    { "text": "B. We need to buy a new remote control for our TV.", "rationale": "**Dịch:** Chúng tôi cần mua một chiếc điều khiển mới cho tivi.<br>**Giải thích:** Need TO buy. Mua cái gì CHO cái gì -> for our TV.", "isCorrect": true },
                    { "text": "C. We need buy a new remote control to our TV.", "rationale": "**Sai:** Thiếu 'to' sau need và sai giới từ 'to our TV'.", "isCorrect": false },
                    { "text": "D. We need to buy new remote control for our TV.", "rationale": "**Thiếu:** Thiếu mạo từ 'a'.", "isCorrect": false }
                ],
                "hint": "Need TO do something."
            },
            {
                "questionNumber": 16,
                "question": "Ex 17-6: Build sentence: The weather forecast/ be/ on/ after/ the news.",
                "answerOptions": [
                    { "text": "A. The weather forecast is on after the news.", "rationale": "**Dịch:** Dự báo thời tiết được phát sóng sau bản tin thời sự.<br>**Giải thích:** Be on (được chiếu/phát sóng).", "isCorrect": true },
                    { "text": "B. The weather forecast be on after the news.", "rationale": "**Sai:** Chưa chia động từ 'be'.", "isCorrect": false },
                    { "text": "C. The weather forecast are on after the news.", "rationale": "**Sai:** Chủ ngữ số ít dùng 'is'.", "isCorrect": false },
                    { "text": "D. The weather forecast is in after the news.", "rationale": "**Sai:** Sai giới từ 'in'.", "isCorrect": false }
                ],
                "hint": "Chủ ngữ số ít -> is."
            },
            {
                "questionNumber": 17,
                "question": "Ex 17-7: Build sentence: My father/ always/ turn down/ volume/ when/ I/ study.",
                "answerOptions": [
                    { "text": "A. My father always turn down the volume when I study.", "rationale": "**Sai:** Thiếu 's' ở 'turn' (chủ ngữ số ít).", "isCorrect": false },
                    { "text": "B. My father always turns down volume when I study.", "rationale": "**Thiếu:** Thiếu mạo từ 'the' trước 'volume'.", "isCorrect": false },
                    { "text": "C. My father always turns down the volume when I study.", "rationale": "**Dịch:** Bố tôi luôn vặn nhỏ âm lượng khi tôi học bài.<br>**Giải thích:** Turns (chia số ít) + the volume (xác định).", "isCorrect": true },
                    { "text": "D. My father always turns down the volume when I studying.", "rationale": "**Sai:** Khi tôi học (thói quen) dùng hiện tại đơn 'I study'.", "isCorrect": false }
                ],
                "hint": "Chia động từ 'turns' và thêm 'the volume'."
            },
            {
                "questionNumber": 18,
                "question": "Ex 17-8: Build sentence: Game shows/ make/ people/ laugh/ learn/ same time.",
                "answerOptions": [
                    { "text": "A. Game shows make people laugh and learn at the same time.", "rationale": "**Dịch:** Các trò chơi truyền hình khiến mọi người cười và học hỏi cùng một lúc.<br>**Giải thích:** Make sbd V (laugh/learn). Cụm từ: At the same time.", "isCorrect": true },
                    { "text": "B. Game shows make people to laugh and learn at same time.", "rationale": "**Sai:** Make sbd V (không có to).", "isCorrect": false },
                    { "text": "C. Game shows makes people laugh and learn in the same time.", "rationale": "**Sai:** Game shows (số nhiều) không chia 'makes'. Sai giới từ 'in'.", "isCorrect": false },
                    { "text": "D. Game shows make people laughing and learning at the same time.", "rationale": "**Sai:** Make sbd V-ing là sai cấu trúc.", "isCorrect": false }
                ],
                "hint": "Make someone Do something (động từ nguyên thể). At the same time."
            },
            {
                "questionNumber": 19,
                "question": "Ex 17-9: Build sentence: Our family/ not have/ cable TV/ last year.",
                "answerOptions": [
                    { "text": "A. Our family do not have cable TV last year.", "rationale": "**Sai:** Last year là quá khứ, không dùng 'do not'.", "isCorrect": false },
                    { "text": "B. Our family did not have cable TV last year.", "rationale": "**Dịch:** Gia đình tôi không có truyền hình cáp vào năm ngoái.<br>**Giải thích:** Quá khứ đơn phủ định: Did not + V nguyên thể.", "isCorrect": true },
                    { "text": "C. Our family did not had cable TV last year.", "rationale": "**Sai:** Sau did not phải là động từ nguyên thể (have).", "isCorrect": false },
                    { "text": "D. Our family not have cable TV last year.", "rationale": "**Sai:** Thiếu trợ động từ.", "isCorrect": false }
                ],
                "hint": "Last year -> Quá khứ đơn (Did not)."
            },
            {
                "questionNumber": 20,
                "question": "Ex 17-10: Build sentence: How many hours/ you/ spend/ watch TV/ every day?",
                "answerOptions": [
                    { "text": "A. How many hours do you spend to watch TV every day?", "rationale": "**Sai:** Spend time + V-ing.", "isCorrect": false },
                    { "text": "B. How many hours do you spend watching TV every day?", "rationale": "**Dịch:** Bạn dành bao nhiêu giờ để xem TV mỗi ngày?<br>**Giải thích:** Cấu trúc: Spend + time + V-ing (watching).", "isCorrect": true },
                    { "text": "C. How many hours you spend watching TV every day?", "rationale": "**Sai:** Thiếu trợ động từ 'do' trong câu hỏi.", "isCorrect": false },
                    { "text": "D. How many hours do you spend watch TV every day?", "rationale": "**Sai:** Sau spend phải là V-ing.", "isCorrect": false }
                ],
                "hint": "Spend time + V-ing (dành thời gian làm gì)."
            },
            {
                "questionNumber": 21,
                "question": "Ex 18-1: Rewrite: My family always watches the news together after dinner. (We)",
                "answerOptions": [
                    { "text": "A. We always watch the news together after dinner.", "rationale": "**Dịch:** Chúng tôi luôn xem tin tức cùng nhau sau bữa tối.<br>**Giải thích:** Thay 'My family' bằng 'We', động từ 'watches' đổi thành 'watch' (chia theo We).", "isCorrect": true },
                    { "text": "B. We always watches the news together after dinner.", "rationale": "**Sai:** 'We' đi với động từ nguyên thể.", "isCorrect": false },
                    { "text": "C. We watch always the news together after dinner.", "rationale": "**Sai:** Trạng từ tần suất 'always' đứng trước động từ thường.", "isCorrect": false },
                    { "text": "D. We together always watch the news after dinner.", "rationale": "**Sai:** Vị trí từ không tự nhiên.", "isCorrect": false }
                ],
                "hint": "Đổi chủ ngữ We -> động từ watch (không chia)."
            },
            {
                "questionNumber": 22,
                "question": "Ex 18-2: Rewrite: Watching TV all day is bad for your eyes. (good)",
                "answerOptions": [
                    { "text": "A. Watching TV all day is good for your eyes.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false },
                    { "text": "B. Watching TV all day is not good for your eyes.", "rationale": "**Dịch:** Xem TV cả ngày không tốt cho mắt.<br>**Giải thích:** Bad = Not good.", "isCorrect": true },
                    { "text": "C. Watching TV all day isn't bad for your eyes.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false },
                    { "text": "D. Watching TV all day is no good for your eyes.", "rationale": "**Chấp nhận được:** Nhưng 'not good' phổ biến hơn cho trình độ lớp 6.", "isCorrect": false }
                ],
                "hint": "Bad = Not good."
            },
            {
                "questionNumber": 23,
                "question": "Ex 18-3: Rewrite: Tom's favorite TV show starts at 7 PM. (begins)",
                "answerOptions": [
                    { "text": "A. Tom's favorite TV show begin at 7 PM.", "rationale": "**Sai:** Thiếu 's' (chủ ngữ số ít).", "isCorrect": false },
                    { "text": "B. Tom's favorite TV show begins at 7 PM.", "rationale": "**Dịch:** Chương trình yêu thích của Tom bắt đầu lúc 7 giờ tối.<br>**Giải thích:** Starts = Begins.", "isCorrect": true },
                    { "text": "C. Tom's favorite TV show is begins at 7 PM.", "rationale": "**Sai:** Thừa 'is'.", "isCorrect": false },
                    { "text": "D. Tom's favorite TV show begins on 7 PM.", "rationale": "**Sai:** Giờ dùng giới từ 'at'.", "isCorrect": false }
                ],
                "hint": "Start = Begin."
            },
            {
                "questionNumber": 24,
                "question": "Ex 18-4: Rewrite: I prefer watching documentaries to game shows. (than)",
                "answerOptions": [
                    { "text": "A. I prefer documentaries than game shows.", "rationale": "**Sai:** Prefer đi với 'to'.", "isCorrect": false },
                    { "text": "B. I like documentaries more than game shows.", "rationale": "**Dịch:** Tôi thích phim tài liệu hơn là trò chơi truyền hình.<br>**Giải thích:** Prefer... to... = Like... more than...", "isCorrect": true },
                    { "text": "C. I like documentaries than game shows.", "rationale": "**Sai:** Thiếu 'more'.", "isCorrect": false },
                    { "text": "D. I watch documentaries more than game shows.", "rationale": "**Chấp nhận được:** Nhưng 'Like... more than' sát nghĩa với 'Prefer' (thích hơn) nhất.", "isCorrect": false }
                ],
                "hint": "Prefer = Like... more than."
            },
            {
                "questionNumber": 25,
                "question": "Ex 18-5: Rewrite: Remember to turn off the television before leaving. (forget)",
                "answerOptions": [
                    { "text": "A. Don't remember to turn off the television.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false },
                    { "text": "B. Don't forget turning off the television.", "rationale": "**Sai:** Forget + to V (để dặn dò làm việc gì đó). Forget + V-ing (quên đã làm gì trong quá khứ).", "isCorrect": false },
                    { "text": "C. Don't forget to turn off the television before leaving.", "rationale": "**Dịch:** Đừng quên tắt tivi trước khi đi.<br>**Giải thích:** Remember to V = Don't forget to V.", "isCorrect": true },
                    { "text": "D. Not forget to turn off the television.", "rationale": "**Sai:** Thiếu trợ động từ Do.", "isCorrect": false }
                ],
                "hint": "Remember to = Don't forget to."
            },
            {
                "questionNumber": 26,
                "question": "Ex 19A-1: Wh-Question: The documentary starts **at 8 PM** on Channel 5.",
                "answerOptions": [
                    { "text": "A. When the documentary starts on Channel 5?", "rationale": "**Sai:** Thiếu trợ động từ.", "isCorrect": false },
                    { "text": "B. What time does the documentary start on Channel 5?", "rationale": "**Dịch:** Phim tài liệu bắt đầu lúc mấy giờ...?<br>**Giải thích:** Hỏi giờ cụ thể -> What time + does + S + V?", "isCorrect": true },
                    { "text": "C. What time starts the documentary on Channel 5?", "rationale": "**Sai:** Sai cấu trúc câu hỏi.", "isCorrect": false },
                    { "text": "D. How long does the documentary start?", "rationale": "**Sai:** How long hỏi độ dài.", "isCorrect": false }
                ],
                "hint": "Hỏi giờ: What time."
            },
            {
                "questionNumber": 27,
                "question": "Ex 19A-2: Wh-Question: I don't know **the name of that game show host**.",
                "answerOptions": [
                    { "text": "A. I don't know who is the game show host.", "rationale": "**Sai:** Câu gốc nói về 'the name' (cái tên), không hỏi trực tiếp người đó là ai (dù nghĩa gần giống).", "isCorrect": false },
                    { "text": "B. I don't know what the game show host's name is.", "rationale": "**Dịch:** Tôi không biết tên người dẫn chương trình là gì.<br>**Giải thích:** Đây là câu hỏi gián tiếp (Embedded question). What + S + V.", "isCorrect": true },
                    { "text": "C. I don't know what is the game show host's name.", "rationale": "**Sai:** Câu hỏi gián tiếp không đảo ngữ (is không đứng trước name).", "isCorrect": false },
                    { "text": "D. I don't know which the game show host's name.", "rationale": "**Sai:** Dùng từ để hỏi sai.", "isCorrect": false }
                ],
                "hint": "Câu trần thuật chứa câu hỏi: What + S + V (không đảo ngữ)."
            },
            {
                "questionNumber": 28,
                "question": "Ex 19A-3: Wh-Question: My parents watch TV **for two hours** every evening.",
                "answerOptions": [
                    { "text": "A. How long do my parents watch TV every evening?", "rationale": "**Dịch:** Bố mẹ tôi xem TV bao lâu...?<br>**Giải thích:** 'For two hours' là khoảng thời gian -> How long.", "isCorrect": true },
                    { "text": "B. How much do my parents watch TV every evening?", "rationale": "**Sai:** How much thường hỏi giá hoặc lượng không đếm được.", "isCorrect": false },
                    { "text": "C. How often do my parents watch TV?", "rationale": "**Sai:** How often hỏi tần suất (ví dụ: always, twice a week).", "isCorrect": false },
                    { "text": "D. When do my parents watch TV?", "rationale": "**Sai:** When hỏi thời điểm (every evening), nhưng phần gạch chân là 'for two hours'.", "isCorrect": false }
                ],
                "hint": "Hỏi khoảng thời gian: How long."
            },
            {
                "questionNumber": 29,
                "question": "Ex 19A-4: Wh-Question: She asked me about **my favorite TV program**.",
                "answerOptions": [
                    { "text": "A. She asked me what my favorite TV program was.", "rationale": "**Dịch:** Cô ấy hỏi tôi chương trình yêu thích của tôi là gì.<br>**Giải thích:** Câu tường thuật gián tiếp: What + S + V (lùi thì).", "isCorrect": true },
                    { "text": "B. She asked me what was my favorite TV program.", "rationale": "**Sai:** Đảo ngữ trong câu gián tiếp là sai.", "isCorrect": false },
                    { "text": "C. She asked me which my favorite TV program.", "rationale": "**Sai:** Thiếu động từ.", "isCorrect": false },
                    { "text": "D. She asked me is what my favorite TV program.", "rationale": "**Sai:** Sai cấu trúc.", "isCorrect": false }
                ],
                "hint": "Câu tường thuật: What + S + V."
            },
            {
                "questionNumber": 30,
                "question": "Ex 19A-5: Wh-Question: The remote control is **on the coffee table**.",
                "answerOptions": [
                    { "text": "A. Where is the remote control?", "rationale": "**Dịch:** Cái điều khiển ở đâu?<br>**Giải thích:** Hỏi vị trí -> Where.", "isCorrect": true },
                    { "text": "B. What is on the coffee table?", "rationale": "**Sai:** Nếu hỏi 'What', câu trả lời là 'The remote control'. Nhưng đề bài thường gạch chân cụm từ chỉ nơi chốn.", "isCorrect": false },
                    { "text": "C. When is the remote control?", "rationale": "**Sai:** Hỏi thời gian.", "isCorrect": false },
                    { "text": "D. How is the remote control?", "rationale": "**Sai:** Hỏi tính chất.", "isCorrect": false }
                ],
                "hint": "Hỏi nơi chốn: Where."
            },
            {
                "questionNumber": 31,
                "question": "Ex 19B-1: Conjunction: I wanted to watch the movie. I had too much homework.",
                "answerOptions": [
                    { "text": "A. I wanted to watch the movie, and I had too much homework.", "rationale": "**Sai:** Không hợp nghĩa.", "isCorrect": false },
                    { "text": "B. I wanted to watch the movie, but I had too much homework.", "rationale": "**Dịch:** Tôi muốn xem phim, nhưng tôi có quá nhiều bài tập.<br>**Giải thích:** Hai vế đối lập (muốn xem >< phải làm bài) -> dùng 'but'.", "isCorrect": true },
                    { "text": "C. I wanted to watch the movie, so I had too much homework.", "rationale": "**Sai:** Sai quan hệ nhân quả.", "isCorrect": false },
                    { "text": "D. I wanted to watch the movie, or I had too much homework.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false }
                ],
                "hint": "Hai vế đối lập nhau -> But."
            },
            {
                "questionNumber": 32,
                "question": "Ex 19B-2: Conjunction: The show was boring. We changed the channel.",
                "answerOptions": [
                    { "text": "A. The show was boring, but we changed the channel.", "rationale": "**Sai:** Không đối lập.", "isCorrect": false },
                    { "text": "B. The show was boring, because we changed the channel.", "rationale": "**Sai:** Sai nhân quả.", "isCorrect": false },
                    { "text": "C. The show was boring, so we changed the channel.", "rationale": "**Dịch:** Chương trình chán, nên chúng tôi chuyển kênh.<br>**Giải thích:** Nguyên nhân (chán) -> Kết quả (chuyển kênh) => dùng 'so'.", "isCorrect": true },
                    { "text": "D. Although the show was boring, we changed the channel.", "rationale": "**Sai:** Although dùng cho mệnh đề nhượng bộ (mặc dù... nhưng...).", "isCorrect": false }
                ],
                "hint": "Chỉ kết quả -> So."
            },
            {
                "questionNumber": 33,
                "question": "Ex 19B-3: Conjunction: Turn off the TV. You won't be able to sleep well.",
                "answerOptions": [
                    { "text": "A. Turn off the TV, and you won't be able to sleep well.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false },
                    { "text": "B. Turn off the TV, so you won't be able to sleep well.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false },
                    { "text": "C. Turn off the TV, or you won't be able to sleep well.", "rationale": "**Dịch:** Tắt TV đi, nếu không bạn sẽ không ngủ ngon đâu.<br>**Giải thích:** Cảnh báo hậu quả (hoặc là/nếu không thì) -> dùng 'or'.", "isCorrect": true },
                    { "text": "D. Turn off the TV, but you won't be able to sleep well.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false }
                ],
                "hint": "Nếu không thì -> Or."
            },
            {
                "questionNumber": 34,
                "question": "Ex 19B-4: Conjunction: My sister loves cartoons. She doesn't watch them during exams.",
                "answerOptions": [
                    { "text": "A. My sister loves cartoons, so she doesn't watch them during exams.", "rationale": "**Chưa chính xác:** Không hẳn là quan hệ nhân quả trực tiếp.", "isCorrect": false },
                    { "text": "B. My sister loves cartoons; however, she doesn't watch them during exams.", "rationale": "**Dịch:** Chị tôi thích hoạt hình; tuy nhiên, chị ấy không xem trong kỳ thi.<br>**Giải thích:** Hai vế đối lập mạnh, dùng 'however' (tuy nhiên) rất phù hợp.", "isCorrect": true },
                    { "text": "C. My sister loves cartoons, or she doesn't watch them during exams.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false },
                    { "text": "D. My sister loves cartoons because she doesn't watch them during exams.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false }
                ],
                "hint": "Chỉ sự tương phản, đối lập -> However (Tuy nhiên)."
            },
            {
                "questionNumber": 35,
                "question": "Ex 19B-5: Conjunction: Children enjoy this program. It has funny characters.",
                "answerOptions": [
                    { "text": "A. Children enjoy this program, but it has funny characters.", "rationale": "**Sai:** Không đối lập.", "isCorrect": false },
                    { "text": "B. Children enjoy this program because it has funny characters.", "rationale": "**Dịch:** Trẻ em thích chương trình này vì nó có các nhân vật hài hước.<br>**Giải thích:** Chỉ nguyên nhân (tại sao thích?) -> dùng 'because'.", "isCorrect": true },
                    { "text": "C. Children enjoy this program, so it has funny characters.", "rationale": "**Sai:** Sai nhân quả (Thích không làm cho nhân vật trở nên hài hước).", "isCorrect": false },
                    { "text": "D. Children enjoy this program, or it has funny characters.", "rationale": "**Sai:** Sai nghĩa.", "isCorrect": false }
                ],
                "hint": "Chỉ nguyên nhân -> Because."
            }
        ]
    };

    let userScore = 0;
    const totalQuestions = quizData.questions.length;

    // --- AUDIO CONTEXT (Generated Sounds) ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playSound(type) {
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'correct') {
            // Ding sound
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.6);
        } else if (type === 'wrong') {
            // Buzz sound
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }
    }

    // --- RENDER QUIZ ---
    function renderQuiz() {
        const container = document.getElementById('quiz-content');
        container.innerHTML = '';

        quizData.questions.forEach((q, index) => {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `q-card-${index}`;

            // Header
            const header = document.createElement('div');
            header.className = 'question-header';
            header.innerHTML = `
                <div class="q-number">Câu ${q.questionNumber}</div>
            `;
            
            // Question Text (Handle Phonetics underlining if needed, though this data is mostly grammar)
            // Formatting bold text from markdown **text** to <strong>text</strong>
            let formattedQuestion = q.question.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            const qText = document.createElement('div');
            qText.className = 'question-text';
            qText.innerHTML = formattedQuestion;

            // Options
            const optionsGrid = document.createElement('div');
            optionsGrid.className = 'options-grid';
            optionsGrid.style.marginTop = '20px';

            q.answerOptions.forEach((opt, optIndex) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerHTML = opt.text;
                btn.onclick = () => checkAnswer(index, optIndex, btn, q);
                optionsGrid.appendChild(btn);
            });

            // Hint
            const hint = document.createElement('div');
            hint.className = 'hint-text';
            hint.innerHTML = `💡 Gợi ý: ${q.hint}`;

            // Explanation Box
            const explanationBox = document.createElement('div');
            explanationBox.className = 'explanation-box';
            explanationBox.id = `explanation-${index}`;

            // Generate detailed explanation content list
            let detailListHTML = '<ul class="explanation-detail-list">';
            q.answerOptions.forEach(opt => {
                // Extract clean text (remove A., B. prefix if standard)
                const optLabel = opt.text.split('.')[0]; 
                
                // Format rationale from Markdown ** to HTML <strong>
                let formattedRationale = opt.rationale.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                
                detailListHTML += `
                    <li class="explanation-detail-item">
                        <strong>${optLabel}:</strong> ${formattedRationale}
                    </li>
                `;
            });
            detailListHTML += '</ul>';

            explanationBox.innerHTML = `
                <div class="explanation-title">
                    <span>👩‍🏫</span> Giải thích chi tiết từ Ms Mai An:
                </div>
                <div class="explanation-content">
                    ${detailListHTML}
                </div>
            `;

            card.appendChild(header);
            card.appendChild(qText);
            card.appendChild(optionsGrid);
            card.appendChild(hint);
            card.appendChild(explanationBox);
            container.appendChild(card);
        });
    }

    // --- CHECK ANSWER ---
    function checkAnswer(qIndex, optIndex, btnElement, questionData) {
        // Prevent re-answering
        const card = document.getElementById(`q-card-${qIndex}`);
        if (card.classList.contains('answered')) return;
        card.classList.add('answered');

        const selectedOption = questionData.answerOptions[optIndex];
        const allBtns = card.querySelectorAll('.option-btn');

        // Disable all buttons
        allBtns.forEach(btn => btn.classList.add('disabled'));

        if (selectedOption.isCorrect) {
            // Correct
            btnElement.classList.add('correct');
            playSound('correct');
            triggerConfetti();
            userScore++;
        } else {
            // Wrong
            btnElement.classList.add('wrong');
            playSound('wrong');
            // Highlight correct answer
            questionData.answerOptions.forEach((opt, idx) => {
                if (opt.isCorrect) {
                    allBtns[idx].classList.add('correct');
                }
            });
        }

        // Show explanation
        const expBox = document.getElementById(`explanation-${qIndex}`);
        expBox.style.display = 'block';
    }

    // --- CONFETTI EFFECT ---
    function triggerConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const pieces = [];
        const numberOfPieces = 100;
        const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];

        for (let i = 0; i < numberOfPieces; i++) {
            pieces.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                color: colors[Math.floor(Math.random() * colors.length)],
                size: Math.random() * 10 + 5,
                speed: Math.random() * 5 + 2,
                angle: Math.random() * 360
            });
        }

        let animationFrame;

        function updateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let activePieces = 0;

            pieces.forEach(p => {
                p.y += p.speed;
                p.angle += 2;
                if (p.y < canvas.height) {
                    activePieces++;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.angle * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                    ctx.restore();
                }
            });

            if (activePieces > 0) {
                animationFrame = requestAnimationFrame(updateConfetti);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        updateConfetti();
    }

    // --- FINISH QUIZ ---
    function finishQuiz() {
        const modal = document.getElementById('resultModal');
        const scoreDisplay = document.getElementById('finalScore');
        const msgDisplay = document.getElementById('finalMessage');

        scoreDisplay.innerText = `${userScore}/${totalQuestions}`;

        const percentage = (userScore / totalQuestions) * 100;
        let message = "";
        if (percentage === 100) message = "Tuyệt vời! Bạn là một thiên tài tiếng Anh! 🌟🏆";
        else if (percentage >= 80) message = "Làm rất tốt! Cố gắng thêm chút nữa để đạt điểm tuyệt đối nhé! 🌈";
        else if (percentage >= 50) message = "Khá tốt! Hãy xem lại các lỗi sai để tiến bộ hơn nha! 💪";
        else message = "Đừng buồn nhé! Hãy ôn lại bài và thử lại lần sau nào! 📚";

        msgDisplay.innerText = message;
        modal.style.display = 'flex';
        playSound('correct'); // Celebration sound
        triggerConfetti(); // Final confetti
    }

    function closeModal() {
        document.getElementById('resultModal').style.display = 'none';
    }

    // --- INIT ---
    window.onload = function() {
        renderQuiz();
    };

</script>
</body>
</html>
