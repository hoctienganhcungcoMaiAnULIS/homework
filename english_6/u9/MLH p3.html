<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i T·∫≠p Ti·∫øng Anh - Ms Mai An ULIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8854C0; /* H·ªìng t√≠m nh·∫°t */
            --secondary: #00C9A7; /* Xanh ng·ªçc */
            --correct: #00D26A; /* Xanh l√° */
            --wrong: #FF4757; /* ƒê·ªè cam */
            --bg-color: #F0F3F8;
            --card-bg: #ffffff;
            --text: #2f3542;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#8854c0 0.5px, transparent 0.5px), radial-gradient(#00c9a7 0.5px, var(--bg-color) 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: var(--text);
            margin: 0;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            border: 2px solid var(--primary);
        }

        h1 {
            color: var(--primary);
            margin: 0;
            font-size: 1.5rem;
            font-weight: 800;
            text-transform: uppercase;
        }

        h2 {
            font-size: 1rem;
            color: #747d8c;
            margin-top: 5px;
            font-weight: 600;
        }

        /* CARD STYLE */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 0 #dfe4ea, 0 5px 10px rgba(0,0,0,0.1);
            position: relative;
            border: 2px solid #f1f2f6;
            transition: transform 0.2s;
        }

        .section-title {
            background: var(--secondary);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            display: inline-block;
            font-weight: 700;
            margin-bottom: 20px;
            box-shadow: 0 4px 0 #00967d;
        }

        /* READING TEXT */
        .reading-text {
            background: #fff0f3;
            padding: 20px;
            border-radius: 15px;
            border: 2px dashed var(--primary);
            line-height: 1.8;
            margin-bottom: 20px;
            font-family: 'Quicksand', sans-serif;
            font-size: 1.1rem;
        }

        /* GAP FILL STYLES */
        .gap-box {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #eccc68;
            border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        .word-option {
            background: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-weight: bold;
            color: var(--text);
            border: 2px solid #ffa502;
            cursor: grab;
        }

        .gap-input {
            display: inline-block;
            min-width: 80px;
            height: 30px;
            border-bottom: 3px solid var(--primary);
            margin: 0 5px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
            cursor: pointer;
            background: #f3e8ff;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .gap-input.correct {
            background: var(--correct);
            color: white;
            border-color: #00b85c;
        }

        .gap-input.wrong {
            background: var(--wrong);
            color: white;
            border-color: #d63031;
            animation: shake 0.5s;
        }

        /* MULTIPLE CHOICE & TRUE/FALSE */
        .question-block {
            margin-bottom: 25px;
            border-bottom: 2px dashed #eee;
            padding-bottom: 20px;
        }

        .question-text {
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-option {
            background: white;
            border: 2px solid #e1e1e1;
            padding: 15px;
            border-radius: 15px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 0 #d1d1d1;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .btn-option:hover {
            transform: scale(1.02);
            border-color: var(--primary);
        }

        .btn-option:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #d1d1d1;
        }

        .btn-option.correct {
            background: var(--correct);
            color: white;
            border-color: #00b85c;
            box-shadow: 0 5px 0 #00944a;
        }

        .btn-option.wrong {
            background: var(--wrong);
            color: white;
            border-color: #e84118;
            box-shadow: 0 5px 0 #c23616;
            animation: shake 0.4s;
        }

        /* REARRANGE SENTENCES */
        .scrambled-words {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .scramble-chip {
            background: white;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 3px 0 #00967d;
        }

        .scramble-chip.used {
            opacity: 0.3;
            pointer-events: none;
            background: #eee;
            box-shadow: none;
            border-color: #ccc;
        }

        .answer-line {
            min-height: 50px;
            background: #f1f2f6;
            border-radius: 15px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            border: 2px inset #ddd;
        }

        .answer-chip {
            background: var(--secondary);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        /* EXPLANATION BOX (THE TEACHER) */
        .explanation {
            margin-top: 15px;
            background: #fdf2f8; /* Light Pink for explanation */
            border-radius: 15px;
            padding: 15px;
            border-left: 5px solid var(--primary);
            display: none; /* Hidden by default */
            font-size: 0.95rem;
        }

        .explanation.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .teacher-avatar {
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .teacher-avatar::before {
            content: 'üë©‚Äçüè´';
            font-size: 1.5rem;
        }

        .exp-detail p {
            margin: 5px 0;
        }

        .exp-detail strong {
            color: #d63031;
        }
        
        .exp-detail .correct-text {
            color: var(--correct);
            font-weight: bold;
        }

        /* GLOSSARY TABLE */
        .glossary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .glossary-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .glossary-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        /* FOOTER & BUTTONS */
        .submit-btn {
            display: block;
            width: 100%;
            padding: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1.5rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 8px 0 #6c4299;
            transition: all 0.2s;
            margin-top: 40px;
        }

        .submit-btn:hover {
            transform: scale(1.02);
        }

        .submit-btn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #6c4299;
        }

        /* POPUP MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            animation: zoomIn 0.3s;
            border: 4px solid var(--secondary);
        }

        /* ANIMATIONS */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px) rotate(-5deg); }
            75% { transform: translateX(10px) rotate(5deg); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* CONFETTI CANVAS */
        #confetti-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        /* GAP SELECT MODAL */
        #gap-options-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1100;
            align-items: center;
            justify-content: center;
        }
        .gap-options-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-width: 300px;
        }
        .gap-option-btn {
            background: #f1f2f6;
            border: none;
            padding: 10px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            color: var(--primary);
        }
        .gap-option-btn:hover {
            background: var(--secondary);
            color: white;
        }

        /* RESPONSIVE */
        @media (max-width: 600px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>B√†i Ki·ªÉm Tra Ti·∫øng Anh</h1>
            <h2>Gi√°o vi√™n t·∫°o: Ms Mai An ULIS</h2>
        </header>

        <div class="card">
            <div class="section-title">Part I: GAP FILLING (ROME)</div>
            <p style="margin-bottom: 10px; font-style: italic;">Click v√†o √¥ tr·ªëng ƒë·ªÉ ch·ªçn t·ª´ th√≠ch h·ª£p.</p>
            
            <div class="gap-box">
                <span class="word-option">most</span>
                <span class="word-option">walking</span>
                <span class="word-option">tourist</span>
                <span class="word-option">ever</span>
                <span class="word-option">explore</span>
                <span class="word-option">must</span>
                <span class="word-option">around</span>
                <span class="word-option">sunny</span>
            </div>

            <div class="reading-text">
                Hi Steve,<br>
                <strong>ROME</strong><br>
                Greetings from Rome! We arrived at 8:30 this morning and are staying in a lovely hotel in the city centre. It is near all the (1) <span class="gap-input" data-id="1" onclick="openGapModal(1)">___</span> attractions. The weather is warm and (2) <span class="gap-input" data-id="2" onclick="openGapModal(2)">___</span>! The city looks really amazing. We can't wait to (3) <span class="gap-input" data-id="3" onclick="openGapModal(3)">___</span> everything! This afternoon, we are going to take a stroll (4) <span class="gap-input" data-id="4" onclick="openGapModal(4)">___</span> the Centro Storico, which (5) has <span class="gap-input" data-id="5" onclick="openGapModal(5)">___</span> beautiful historic squares. Tomorrow morning, we are going to visit Colosseum, the largest amphitheater (6) <span class="gap-input" data-id="6" onclick="openGapModal(6)">___</span> built in Roman Empire, and then we are (7) <span class="gap-input" data-id="7" onclick="openGapModal(7)">___</span> up the Palatine Hill. I (8) <span class="gap-input" data-id="8" onclick="openGapModal(8)">___</span> go now. See you when I come back.<br>
                Love,<br>Army
            </div>

            <div id="gap-explanations"></div>
            
            <table class="glossary-table">
                <thead><tr><th>Word</th><th>Type</th><th>Meaning</th></tr></thead>
                <tbody>
                    <tr><td>Attractions</td><td>(n)</td><td>ƒêi·ªÉm tham quan</td></tr>
                    <tr><td>Stroll</td><td>(n/v)</td><td>ƒêi d·∫°o</td></tr>
                    <tr><td>Amphitheater</td><td>(n)</td><td>ƒê·∫•u tr∆∞·ªùng</td></tr>
                    <tr><td>Empire</td><td>(n)</td><td>ƒê·∫ø ch·∫ø</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="section-title">Part II: READING (LOS ANGELES)</div>
            
            <div class="reading-text">
                <strong>LOS ANGELES</strong><br>
                Los Angeles, California is the most exciting city in the USA. It's got Hollywood, Disneyland, fantastic beaches and the LA Dodgers baseball team. But LA wasn't always exciting. In 1900 it was smaller and quieter, and Hollywood was a small village. Then film studios arrived, and the village of Hollywood changed. Today it is part of LA, and Hollywood's 'Walk of Fame' is the most famous place in the city. It's got more than 2,000 stars on it! It's always sunny in LA and there are lots of different attractions. You can go shopping on Sunset Boulevard (It's too expensive for me!), or you can surf on Venice Beach. There are theatres, museums, the biggest theme parks in the USA and the noisiest sports stadiums. LA is the best city in the world!
            </div>

            <h3 style="color: var(--primary);">A. True (T) or False (F)</h3>
            
            <div id="tf-questions">
                </div>

            <h3 style="color: var(--primary); margin-top: 30px;">B. Multiple Choice</h3>
            <div id="mcq-questions">
                 </div>

             <table class="glossary-table">
                <thead><tr><th>Word</th><th>Type</th><th>Meaning</th></tr></thead>
                <tbody>
                    <tr><td>Exciting</td><td>(adj)</td><td>Th√∫ v·ªã, n√°o nhi·ªát</td></tr>
                    <tr><td>Studios</td><td>(n)</td><td>Phim tr∆∞·ªùng</td></tr>
                    <tr><td>Walk of Fame</td><td>(n)</td><td>ƒê·∫°i l·ªô danh v·ªçng</td></tr>
                    <tr><td>Boulevard</td><td>(n)</td><td>ƒê·∫°i l·ªô</td></tr>
                    <tr><td>Theme parks</td><td>(n)</td><td>C√¥ng vi√™n gi·∫£i tr√≠</td></tr>
                    <tr><td>Stadiums</td><td>(n)</td><td>S√¢n v·∫≠n ƒë·ªông</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="section-title">Part III: REARRANGE SENTENCES</div>
            <p style="margin-bottom: 10px; font-style: italic;">B·∫•m v√†o c√°c t·ª´ ƒë·ªÉ s·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh.</p>
            
            <div id="rearrange-questions">
                </div>
        </div>

        <button class="submit-btn" onclick="finishQuiz()">N·ªòP B√ÄI & XEM ƒêI·ªÇM üèÜ</button>
    </div>

    <div id="gap-options-modal" onclick="closeGapModal()">
        <div class="gap-options-container" id="gap-options-list" onclick="event.stopPropagation()">
            </div>
    </div>

    <div id="result-modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 style="color: var(--primary); font-size: 2rem;">K·∫æT QU·∫¢</h2>
            <p id="score-text" style="font-size: 1.5rem; font-weight: bold; margin: 20px 0;">Wait...</p>
            <p id="praise-text" style="color: #555;">Review</p>
            <button onclick="document.getElementById('result-modal').style.display='none'" style="padding: 10px 20px; border-radius: 10px; border: none; background: var(--secondary); color: white; cursor: pointer;">ƒê√≥ng</button>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>

    <script>
        // --- DATA ---
        const gapData = {
            1: { answer: "tourist", explain: "Ta c√≥ c·ª•m t·ª´ gh√©p: 'tourist attractions' (c√°c ƒëi·ªÉm thu h√∫t kh√°ch du l·ªãch).<br>C√°c t·ª´ kh√°c: walking (ƒëi b·ªô), sunny (n·∫Øng), most (nh·∫•t) kh√¥ng gh√©p ƒë∆∞·ª£c nghƒ©a h·ª£p l√Ω ·ªü ƒë√¢y." },
            2: { answer: "sunny", explain: "D·ª±a v√†o ng·ªØ c·∫£nh 'The weather is warm and...' (Th·ªùi ti·∫øt ·∫•m v√†...).<br>C·∫ßn m·ªôt t√≠nh t·ª´ ch·ªâ th·ªùi ti·∫øt. 'Sunny' (c√≥ n·∫Øng) l√† ph√π h·ª£p nh·∫•t ƒë·ªÉ b·ªï sung cho 'warm'." },
            3: { answer: "explore", explain: "C·∫•u tr√∫c: 'Can't wait to + Verb' (N√≥ng l√≤ng l√†m g√¨ ƒë√≥).<br>'Explore' (kh√°m ph√°) l√† ƒë·ªông t·ª´ ph√π h·ª£p nghƒ©a: N√≥ng l√≤ng kh√°m ph√° m·ªçi th·ª©." },
            4: { answer: "around", explain: "C·ª•m ƒë·ªông t·ª´: 'take a stroll around' (ƒëi d·∫°o quanh...).<br>ƒê√¢y l√† collocation c·ªë ƒë·ªãnh." },
            5: { answer: "most", explain: "Ng·ªØ c·∫£nh: '...beautiful historic squares'. D√πng 'most' ƒë·ªÉ t·∫°o so s√°nh nh·∫•t: 'the most beautiful' (nh·ªØng qu·∫£ng tr∆∞·ªùng ƒë·∫πp nh·∫•t).<br>(L∆∞u √Ω: ƒê·ªÅ b√†i g·ªëc c√≥ ch√∫t l·∫Øt l√©o ·ªü v·ªã tr√≠ n√†y, nh∆∞ng 'most' l√† t·ª´ h·ª£p l√Ω nh·∫•t c√≤n l·∫°i ƒë·ªÉ ch·ªâ m·ª©c ƒë·ªô)." },
            6: { answer: "ever", explain: "C·∫•u tr√∫c so s√°nh nh·∫•t + ever + V3/ed: 'Largest amphitheater ever built' (ƒê·∫•u tr∆∞·ªùng l·ªõn nh·∫•t T·ª™NG ƒë∆∞·ª£c x√¢y d·ª±ng)." },
            7: { answer: "walking", explain: "C·∫•u tr√∫c th√¨ hi·ªán t·∫°i ti·∫øp di·ªÖn: 'are + V-ing'.<br>'Walking up' (ƒëi b·ªô l√™n) ƒë·ªìi Palatine." },
            8: { answer: "must", explain: "C·∫•u tr√∫c: Modal verb + V_inf.<br>'I must go now' (T√¥i ph·∫£i ƒëi b√¢y gi·ªù) ƒë·ªÉ ch√†o t·∫°m bi·ªát." }
        };

        const tfData = [
            { 
                q: "LA is the world's most exciting city.", 
                ans: "F", 
                explain: "D·ªãch: LA l√† th√†nh ph·ªë th√∫ v·ªã nh·∫•t th·∫ø gi·ªõi.<br>D·∫´n ch·ª©ng: B√†i ƒë·ªçc c√¢u ƒë·∫ßu ti√™n 'Los Angeles... is the most exciting city **in the USA**' (·ªü M·ªπ), kh√¥ng ph·∫£i 'in the world'." 
            },
            { 
                q: "Hollywood used to be a small village.", 
                ans: "T", 
                explain: "D·ªãch: Hollywood t·ª´ng l√† m·ªôt ng√¥i l√†ng nh·ªè.<br>D·∫´n ch·ª©ng: 'In 1900... Hollywood was a small village.'" 
            },
            { 
                q: "The weather is good in LA.", 
                ans: "T", 
                explain: "D·ªãch: Th·ªùi ti·∫øt ·ªü LA r·∫•t t·ªët.<br>D·∫´n ch·ª©ng: 'It's always sunny in LA' (Tr·ªùi lu√¥n c√≥ n·∫Øng)." 
            },
            { 
                q: "The shops on Sunset Boulevard are cheap.", 
                ans: "F", 
                explain: "D·ªãch: C√°c c·ª≠a h√†ng tr√™n ƒë·∫°i l·ªô Sunset r·∫•t r·∫ª.<br>D·∫´n ch·ª©ng: 'You can go shopping on Sunset Boulevard (It's **too expensive** for me!)' -> R·∫•t ƒë·∫Øt." 
            },
            { 
                q: "There are a lot of tourist attractions in LA.", 
                ans: "T", 
                explain: "D·ªãch: C√≥ r·∫•t nhi·ªÅu ƒëi·ªÉm thu h√∫t kh√°ch du l·ªãch ·ªü LA.<br>D·∫´n ch·ª©ng: 'there are lots of different attractions.'" 
            }
        ];

        const mcqData = [
            {
                q: "1. Where is Los Angeles?",
                options: { A: "In New York", B: "In the UK", C: "In California, USA", D: "In Canada" },
                correct: "C",
                explain: "D·∫´n ch·ª©ng ngay c√¢u ƒë·∫ßu ti√™n: 'Los Angeles, California... USA'.<br>A, B, D sai v√¨ sai ƒë·ªãa danh."
            },
            {
                q: "2. What is the most famous place in LA according to the text?",
                options: { A: "Disneyland", B: "Hollywood's 'Walk of Fame'", C: "Venice Beach", D: "Sunset Boulevard" },
                correct: "B",
                explain: "D·∫´n ch·ª©ng: 'Hollywood's Walk of Fame is the **most famous place** in the city'."
            },
            {
                q: "3. How many stars are there on the Hollywood Walk of Fame?",
                options: { A: "Less than 1,000", B: "Exactly 500", C: "More than 2,000", D: "About 100" },
                correct: "C",
                explain: "D·∫´n ch·ª©ng: 'It's got **more than 2,000 stars** on it!'."
            },
            {
                q: "4. What is the weather like in LA?",
                options: { A: "It is always sunny.", B: "It is usually rainy.", C: "It is cold and snowy.", D: "It is cloudy and windy." },
                correct: "A",
                explain: "D·∫´n ch·ª©ng: 'It's **always sunny** in LA'."
            }
        ];

        const rearrangeData = [
            { words: ["We", "are", "having", "a", "wonderful", "time", "in", "Hanoi."], full: "We are having a wonderful time in Hanoi.", trans: "Ch√∫ng t√¥i ƒëang c√≥ m·ªôt kho·∫£ng th·ªùi gian tuy·ªát v·ªùi ·ªü H√† N·ªôi." },
            { words: ["We", "have", "been", "here", "for", "two", "days."], full: "We have been here for two days.", trans: "Ch√∫ng t√¥i ƒë√£ ·ªü ƒë√¢y ƒë∆∞·ª£c hai ng√†y r·ªìi." },
            { words: ["Hanoi", "is", "a", "large", "city", "and", "it", "is", "also", "interesting."], full: "Hanoi is a large city and it is also interesting.", trans: "H√† N·ªôi l√† m·ªôt th√†nh ph·ªë l·ªõn v√† n√≥ c≈©ng r·∫•t th√∫ v·ªã." },
            { words: ["The people", "are", "very", "friendly", "and", "the weather", "has", "been", "warm", "and", "sunny."], full: "The people are very friendly and the weather has been warm and sunny.", trans: "Ng∆∞·ªùi d√¢n r·∫•t th√¢n thi·ªán v√† th·ªùi ti·∫øt ·∫•m √°p, c√≥ n·∫Øng." },
            { words: ["Yesterday", "we", "visited", "the", "Temple of Literature."], full: "Yesterday we visited the Temple of Literature.", trans: "H√¥m qua ch√∫ng t√¥i ƒë√£ ƒëi thƒÉm VƒÉn Mi·∫øu." },
            { words: ["It", "is", "one", "of", "the", "most", "popular", "tourist attractions", "in", "Vietnam."], full: "It is one of the most popular tourist attractions in Vietnam.", trans: "ƒê√≥ l√† m·ªôt trong nh·ªØng ƒëi·ªÉm du l·ªãch n·ªïi ti·∫øng nh·∫•t ·ªü Vi·ªát Nam." },
            { words: ["Today", "we", "are", "going", "to", "Bat Trang Pottery Village."], full: "Today we are going to Bat Trang Pottery Village.", trans: "H√¥m nay ch√∫ng t√¥i s·∫Ω ƒëi L√†ng g·ªëm B√°t Tr√†ng." },
            { words: ["I", "will", "buy", "some", "pottery", "to", "make", "a", "gift", "for", "my family and friends."], full: "I will buy some pottery to make a gift for my family and friends.", trans: "T√¥i s·∫Ω mua m·ªôt √≠t ƒë·ªì g·ªëm ƒë·ªÉ l√†m qu√† cho gia ƒë√¨nh v√† b·∫°n b√®." }
        ];

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.4);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        function fireConfetti() {
            // Simple CSS confetti bursts? No, let's use a very simple canvas logic
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            let particles = [];
            const colors = ['#8854C0', '#00C9A7', '#FF4757', '#FFD700'];
            
            for(let i=0; i<100; i++) {
                particles.push({
                    x: window.innerWidth/2,
                    y: window.innerHeight/2,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20,
                    color: colors[Math.floor(Math.random()*colors.length)],
                    life: 100
                });
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach((p, index) => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.5; // gravity
                    p.life--;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, 8, 8);
                    
                    if(p.life <= 0) particles.splice(index, 1);
                });
                
                if(particles.length > 0) requestAnimationFrame(animate);
                else ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            animate();
        }

        // --- RENDER FUNCTIONS ---
        
        // 1. Render T/F
        const tfContainer = document.getElementById('tf-questions');
        tfData.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'question-block';
            div.innerHTML = `
                <div class="question-text">${index + 1}. ${item.q}</div>
                <div class="options-grid">
                    <button class="btn-option" onclick="checkTF(${index}, 'T', this)">True</button>
                    <button class="btn-option" onclick="checkTF(${index}, 'F', this)">False</button>
                </div>
                <div class="explanation" id="tf-exp-${index}">
                    <div class="teacher-avatar">C√¥ Mai An gi·∫£i th√≠ch:</div>
                    <div class="exp-detail">${item.explain}</div>
                </div>
            `;
            tfContainer.appendChild(div);
        });

        // 2. Render MCQ
        const mcqContainer = document.getElementById('mcq-questions');
        mcqData.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'question-block';
            div.innerHTML = `
                <div class="question-text">${item.q}</div>
                <div class="options-grid">
                    ${Object.entries(item.options).map(([key, val]) => 
                        `<button class="btn-option" onclick="checkMCQ(${index}, '${key}', this)">${key}. ${val}</button>`
                    ).join('')}
                </div>
                <div class="explanation" id="mcq-exp-${index}">
                    <div class="teacher-avatar">C√¥ Mai An gi·∫£i th√≠ch:</div>
                    <div class="exp-detail">${item.explain}</div>
                </div>
            `;
            mcqContainer.appendChild(div);
        });

        // 3. Render Rearrange
        const rearrangeContainer = document.getElementById('rearrange-questions');
        rearrangeData.forEach((item, index) => {
            const shuffled = [...item.words].sort(() => Math.random() - 0.5);
            
            const div = document.createElement('div');
            div.className = 'question-block';
            div.innerHTML = `
                <div class="question-text">C√¢u ${index + 1}:</div>
                <div class="scrambled-words" id="source-${index}">
                    ${shuffled.map((word, i) => `<span class="scramble-chip" onclick="addToLine(${index}, '${word.replace(/'/g, "\\'")}', this)">${word}</span>`).join('')}
                </div>
                <div class="answer-line" id="target-${index}"></div>
                <button onclick="checkRearrange(${index})" style="margin-top:10px; padding:8px 15px; border-radius:10px; border:none; background:var(--primary); color:white; font-weight:bold; cursor:pointer;">Ki·ªÉm tra</button>
                <div class="explanation" id="rearrange-exp-${index}">
                    <div class="teacher-avatar">C√¥ Mai An gi·∫£i th√≠ch:</div>
                    <div class="exp-detail">
                        <p><strong>ƒê√°p √°n ƒë√∫ng:</strong> <span class="correct-text">${item.full}</span></p>
                        <p><strong>D·ªãch:</strong> ${item.trans}</p>
                    </div>
                </div>
            `;
            rearrangeContainer.appendChild(div);
        });

        // --- INTERACTION LOGIC ---

        // GAP FILL
        let currentGapId = null;
        function openGapModal(id) {
            currentGapId = id;
            const modal = document.getElementById('gap-options-modal');
            const list = document.getElementById('gap-options-list');
            list.innerHTML = '';
            
            const words = ["most", "walking", "tourist", "ever", "explore", "must", "around", "sunny"];
            words.forEach(word => {
                const btn = document.createElement('button');
                btn.className = 'gap-option-btn';
                btn.innerText = word;
                btn.onclick = () => fillGap(word);
                list.appendChild(btn);
            });
            modal.style.display = 'flex';
        }

        function closeGapModal() {
            document.getElementById('gap-options-modal').style.display = 'none';
        }

        function fillGap(word) {
            const input = document.querySelector(`.gap-input[data-id="${currentGapId}"]`);
            input.innerText = word;
            closeGapModal();
            
            // Check immediately
            const correctWord = gapData[currentGapId].answer;
            
            // Remove old explanations if any for this gap
            let oldExp = document.getElementById(`gap-exp-${currentGapId}`);
            if(oldExp) oldExp.remove();

            const expContainer = document.getElementById('gap-explanations');
            const expDiv = document.createElement('div');
            expDiv.id = `gap-exp-${currentGapId}`;
            expDiv.className = 'explanation show';
            expDiv.innerHTML = `
                <div class="teacher-avatar">C√¥ Mai An gi·∫£i th√≠ch (√î tr·ªëng ${currentGapId}):</div>
                <div class="exp-detail">
                    B·∫°n ch·ªçn: <strong>${word}</strong>. ƒê√°p √°n: <span class="correct-text">${correctWord}</span><br>
                    ${gapData[currentGapId].explain}
                </div>
            `;
            // Insert at top of explanation list
            expContainer.prepend(expDiv);

            if(word === correctWord) {
                input.className = 'gap-input correct';
                playSound('correct');
                fireConfetti();
            } else {
                input.className = 'gap-input wrong';
                playSound('wrong');
            }
        }

        // T/F CHECK
        function checkTF(index, choice, btn) {
            const parent = btn.parentElement;
            const buttons = parent.getElementsByClassName('btn-option');
            Array.from(buttons).forEach(b => {
                b.disabled = true;
                if(b !== btn) b.style.opacity = '0.5';
            });

            const correct = tfData[index].ans;
            const exp = document.getElementById(`tf-exp-${index}`);
            
            if(choice === correct) {
                btn.classList.add('correct');
                playSound('correct');
                fireConfetti();
            } else {
                btn.classList.add('wrong');
                playSound('wrong');
            }
            exp.classList.add('show');
        }

        // MCQ CHECK
        function checkMCQ(index, choice, btn) {
            const parent = btn.parentElement;
            const buttons = parent.getElementsByClassName('btn-option');
            Array.from(buttons).forEach(b => {
                b.disabled = true;
                if(b !== btn) b.style.opacity = '0.5';
            });

            const correct = mcqData[index].correct;
            const exp = document.getElementById(`mcq-exp-${index}`);
            
            if(choice === correct) {
                btn.classList.add('correct');
                playSound('correct');
                fireConfetti();
            } else {
                btn.classList.add('wrong');
                // Highlight correct one
                Array.from(buttons).forEach(b => {
                    if(b.innerText.startsWith(correct)) b.classList.add('correct');
                });
                playSound('wrong');
            }
            exp.classList.add('show');
        }

        // REARRANGE LOGIC
        let userSentences = {}; // store user attempts

        function addToLine(qIndex, word, chip) {
            if(chip.classList.contains('used')) return;
            
            chip.classList.add('used');
            const target = document.getElementById(`target-${qIndex}`);
            
            const ansChip = document.createElement('span');
            ansChip.className = 'answer-chip';
            ansChip.innerText = word;
            ansChip.onclick = () => {
                ansChip.remove();
                chip.classList.remove('used');
            };
            
            target.appendChild(ansChip);
        }

        function checkRearrange(index) {
            const target = document.getElementById(`target-${index}`);
            const words = Array.from(target.children).map(c => c.innerText);
            const userSentence = words.join(' ');
            const correctSentence = rearrangeData[index].full;
            
            const exp = document.getElementById(`rearrange-exp-${index}`);
            exp.classList.add('show');

            if(userSentence === correctSentence) {
                target.style.border = '2px solid var(--correct)';
                target.style.background = '#d1fae5';
                playSound('correct');
                fireConfetti();
            } else {
                target.style.border = '2px solid var(--wrong)';
                target.style.background = '#ffe5e5';
                playSound('wrong');
            }
        }

        // FINISH
        function finishQuiz() {
            // Simple check of how many green elements exist
            const correctCount = document.querySelectorAll('.correct').length;
            // Note: This is a loose count because GapFill adds .correct to input, MCQ to button.
            // Total items: 8 (Gap) + 5 (TF) + 4 (MCQ) + 8 (Rearrange) = 25.
            // But Rearrange logic applies style directly, not class 'correct'.
            
            // Let's count rearrange manually
            let rearrangeCorrect = 0;
            rearrangeData.forEach((item, idx) => {
                const target = document.getElementById(`target-${idx}`);
                const words = Array.from(target.children).map(c => c.innerText).join(' ');
                if(words === item.full) rearrangeCorrect++;
            });

            // Count class based correct (Gap + TF + MCQ)
            // Note: gap-input.correct is 1, btn-option.correct is 1.
            const otherCorrect = document.querySelectorAll('.correct').length;
            
            const totalScore = otherCorrect + rearrangeCorrect;
            const maxScore = 8 + 5 + 4 + 8; // 25

            const modal = document.getElementById('result-modal');
            const scoreText = document.getElementById('score-text');
            const praiseText = document.getElementById('praise-text');

            scoreText.innerText = `ƒêi·ªÉm c·ªßa con: ${totalScore} / ${maxScore}`;
            
            if(totalScore === maxScore) praiseText.innerText = "Xu·∫•t s·∫Øc! Con l√† thi√™n t√†i ti·∫øng Anh! üåü";
            else if(totalScore > 15) praiseText.innerText = "L√†m t·ªët l·∫Øm! C·ªë g·∫Øng th√™m ch√∫t n·ªØa nh√©! üí™";
            else praiseText.innerText = "ƒê·ª´ng bu·ªìn, h√£y xem l·∫°i ph·∫ßn gi·∫£i th√≠ch c·ªßa c√¥ Mai An nh√©! ‚ù§";

            modal.style.display = 'flex';
            fireConfetti();
            playSound('correct');
        }

    </script>
</body>
</html>