<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Tập Tiếng Anh - Ms. Mai An ULIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8854C0; /* Tím hồng */
            --secondary: #00C9A7; /* Xanh ngọc */
            --accent: #FF9F43; /* Cam nhạt */
            --correct: #00D26A; /* Xanh lá */
            --wrong: #FF4757; /* Đỏ cam */
            --bg-pattern: radial-gradient(#e6e6e6 1px, transparent 1px);
            --text-main: #2f3542;
            --card-bg: #ffffff;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* Ngăn bôi đen để trải nghiệm giống app */
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f0f3f5;
            background-image: var(--bg-pattern);
            background-size: 20px 20px;
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        /* HEADER */
        header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            border: 2px solid #eee;
        }

        header h1 {
            color: var(--primary);
            font-family: 'Quicksand', sans-serif;
            font-weight: 800;
            margin: 0;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        header p {
            color: #777;
            margin: 5px 0 0 0;
            font-weight: 600;
        }

        /* QUESTION CARD */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(136, 84, 192, 0.1);
            border: 2px solid #f1f2f6;
            position: relative;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            border-left: 5px solid var(--secondary);
            padding-left: 10px;
        }

        .question-content {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px dashed #ced6e0;
        }

        /* SENTENCE LIST STYLE */
        .sentence-list p {
            margin: 8px 0;
            padding: 8px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .sentence-list strong {
            color: var(--primary);
            margin-right: 5px;
        }

        /* OPTIONS GRID */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }

        .option-btn {
            background: white;
            border: 2px solid #e1e1e1;
            border-bottom: 6px solid #e1e1e1; /* 3D effect */
            border-radius: 15px;
            padding: 15px 20px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: #57606f;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            text-align: left;
        }

        .option-btn:hover:not(:disabled) {
            transform: scale(1.02);
            border-color: var(--primary);
            color: var(--primary);
        }

        .option-btn:active:not(:disabled) {
            transform: translateY(4px);
            border-bottom-width: 2px;
        }

        /* STATES */
        .option-btn.correct {
            background-color: var(--correct);
            color: white;
            border-color: #00b85c;
            border-bottom-color: #00944a;
        }

        .option-btn.wrong {
            background-color: var(--wrong);
            color: white;
            border-color: #ff2e40;
            border-bottom-color: #d63031;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }

        /* EXPLANATION BOX */
        .explanation-box {
            display: none; /* Hidden by default */
            margin-top: 20px;
            background: #f0fdf4;
            border: 2px solid var(--correct);
            border-radius: 15px;
            padding: 20px;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .explanation-box.wrong-choice {
            background: #fff0f1;
            border-color: var(--wrong);
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .exp-header {
            font-weight: 800;
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .exp-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .exp-content h4 {
            margin: 10px 0 5px 0;
            color: var(--primary);
            font-size: 1rem;
        }

        .exp-content p {
            margin: 5px 0;
            font-size: 0.95rem;
        }

        .exp-highlight {
            background: #dfe6e9;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* GLOSSARY TABLE */
        .glossary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .glossary-table th {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: left;
        }

        .glossary-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .tag-type {
            font-size: 0.7rem;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            color: #666;
            margin-left: 5px;
        }

        /* FOOTER / SUBMIT */
        .footer-controls {
            text-align: center;
            margin-top: 40px;
            margin-bottom: 60px;
        }

        .submit-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-bottom: 6px solid #e58e3c;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 800;
            font-family: 'Quicksand', sans-serif;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            transform: scale(1.05);
        }
        
        .submit-btn:active {
            transform: translateY(4px);
            border-bottom-width: 2px;
        }

        /* RESULT POPUP */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            animation: slideIn 0.5s;
            position: relative;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 800;
            margin: 0 auto 20px;
            border: 5px solid #fff;
            box-shadow: 0 0 0 5px var(--primary);
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Bài Thi Trắc Nghiệm Tương Tác</h1>
        <p>Giáo viên tạo: Ms. Mai An ULIS</p>
    </header>

    <div id="quiz-container">
        </div>

    <div class="footer-controls">
        <button class="submit-btn" onclick="submitQuiz()">Nộp Bài & Xem Điểm</button>
    </div>
</div>

<div id="resultModal" class="modal-overlay">
    <div class="modal-content">
        <div class="score-circle" id="finalScore">0/0</div>
        <h2 id="feedbackTitle" style="color: var(--primary);">Tuyệt vời!</h2>
        <p id="feedbackMsg">Bạn đã làm rất tốt!</p>
        <button class="submit-btn" style="background: var(--secondary); border-color: #00a88b; font-size: 1rem; margin-top:20px;" onclick="closeModal()">Xem lại bài làm</button>
    </div>
</div>

<canvas id="confetti" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999; display:none;"></canvas>

<script>
    // --- DATA ---
    const quizData = [
        {
            id: "q1",
            type: "ordering",
            title: "Exercise 20 - Question 1: Sắp xếp câu thành bức thư hoàn chỉnh",
            content: `
                <div class="sentence-list">
                    <p><strong>(1)</strong> Dear Jack,</p>
                    <p><strong>(a)</strong> Yesterday, our school team won the basketball championship and I scored 15 points!</p>
                    <p><strong>(b)</strong> How are you? I'm writing to tell you about the sports activities at my new school.</p>
                    <p><strong>(c)</strong> We also have swimming lessons twice a week at the school pool, which is really fun.</p>
                    <p><strong>(d)</strong> I joined the basketball club and we practice every Monday and Wednesday after school.</p>
                    <p><strong>(e)</strong> I hope you can visit me soon so we can play basketball together like old times!</p>
                    <p style="text-align: right; font-style: italic;">Best wishes, David</p>
                </div>
            `,
            options: [
                "A. a - b - d - c - e",
                "B. b - d - a - c - e",
                "C. b - a - d - c - e",
                "D. d - b - a - c - e"
            ],
            correct: 1, // Index B
            explanation: `
                <h4>1. Dịch câu hỏi & Đáp án:</h4>
                <p>Nhiệm vụ: Sắp xếp các câu để tạo thành bức thư có nghĩa.</p>
                <h4>2. Phân tích chi tiết (Ms. Mai An giải thích):</h4>
                <ul>
                    <li><strong>Bước 1 (Mở đầu):</strong> Sau "Dear Jack", ta cần lời chào hỏi và lý do viết thư. 
                        <br>-> <em>(b) "How are you? I'm writing to..."</em> (Bạn khỏe không? Tớ viết thư để kể về...) là hợp lý nhất.</li>
                    <li><strong>Bước 2 (Triển khai - Giới thiệu CLB):</strong> 
                        <br>-> <em>(d) "I joined the basketball club..."</em> (Tớ đã tham gia CLB bóng rổ...). Đây là thông tin nền tảng trước khi kể về thành tích.</li>
                    <li><strong>Bước 3 (Chi tiết - Thành tích):</strong> 
                        <br>-> <em>(a) "Yesterday... won the championship..."</em> (Hôm qua thắng giải vô địch...). Kể về sự kiện cụ thể liên quan đến CLB ở trên.</li>
                    <li><strong>Bước 4 (Thông tin thêm):</strong> 
                        <br>-> <em>(c) "We also have swimming..."</em> (Chúng tớ còn học bơi...). Dùng "also" để bổ sung thông tin khác.</li>
                    <li><strong>Bước 5 (Kết thư):</strong> 
                        <br>-> <em>(e) "I hope you can visit me..."</em> (Hy vọng bạn sớm đến thăm...). Lời nhắn gửi cuối thư.</li>
                </ul>
                <p><strong>Thứ tự đúng:</strong> b - d - a - c - e</p>
                <div class="glossary-section">
                    <h4>Từ vựng cần nhớ (Academic Vocab):</h4>
                    <table class="glossary-table">
                        <tr><th>Word</th><th>Type</th><th>Meaning</th></tr>
                        <tr><td>Championship</td><td>n</td><td>Giải vô địch</td></tr>
                        <tr><td>Participate</td><td>v</td><td>Tham gia (đồng nghĩa join)</td></tr>
                    </table>
                </div>
            `
        },
        {
            id: "q2",
            type: "ordering",
            title: "Exercise 20 - Question 2: Sắp xếp câu thành đoạn văn",
            content: `
                <div class="sentence-list">
                    <p><strong>(a)</strong> Football helps children develop teamwork skills and stay physically healthy.</p>
                    <p><strong>(b)</strong> However, players need proper equipment like shin guards and good shoes to avoid injuries.</p>
                    <p><strong>(c)</strong> Football is the most popular sport in the world with millions of fans everywhere.</p>
                    <p><strong>(d)</strong> In schools, many students join football clubs to practice and compete with other teams.</p>
                    <p><strong>(e)</strong> Therefore, parents should encourage their children to play sports safely with proper guidance.</p>
                </div>
            `,
            options: [
                "A. c - d - a - b - e",
                "B. a - c - d - b - e",
                "C. d - c - a - b - e",
                "D. c - a - d - b - e"
            ],
            correct: 0, // Index A
            explanation: `
                <h4>1. Phân tích logic đoạn văn:</h4>
                <ul>
                    <li><strong>Câu chủ đề (Introduction):</strong> Cần một câu giới thiệu chung nhất.
                        <br>-> <em>(c) "Football is the most popular sport..."</em> (Bóng đá là môn thể thao phổ biến nhất...).</li>
                    <li><strong>Phát triển ý (Context):</strong> Thu hẹp phạm vi vào trường học.
                        <br>-> <em>(d) "In schools, many students join..."</em> (Ở trường, nhiều học sinh tham gia...).</li>
                    <li><strong>Lợi ích (Benefit):</strong> Tại sao lại tham gia?
                        <br>-> <em>(a) "Football helps... develop teamwork..."</em> (Bóng đá giúp phát triển kỹ năng nhóm...).</li>
                    <li><strong>Phản biện/Lưu ý (Contrast):</strong> Từ nối "However" báo hiệu sự chuyển ý sang rủi ro.
                        <br>-> <em>(b) "However, players need proper equipment..."</em> (Tuy nhiên, người chơi cần thiết bị phù hợp...).</li>
                    <li><strong>Kết luận (Conclusion):</strong> Từ nối "Therefore" chỉ kết quả/lời khuyên.
                        <br>-> <em>(e) "Therefore, parents should encourage..."</em> (Vì vậy, cha mẹ nên khuyến khích...).</li>
                </ul>
                <p><strong>Thứ tự đúng:</strong> c - d - a - b - e</p>
                <div class="glossary-section">
                    <table class="glossary-table">
                        <tr><th>Word</th><th>Type</th><th>Meaning</th></tr>
                        <tr><td>Shin guards</td><td>n</td><td>Bảo vệ ống đồng</td></tr>
                        <tr><td>Injury</td><td>n</td><td>Chấn thương</td></tr>
                        <tr><td>Encourage</td><td>v</td><td>Khuyến khích, động viên</td></tr>
                    </table>
                </div>
            `
        },
        {
            id: "q3",
            type: "gapfill_order",
            title: "Exercise 21 - Q1.1: Sắp xếp và điền vào chỗ trống",
            content: `
                <div class="question-content">
                    <p><em>Playing sports is essential for children's development. Every morning, students at our school start with 15 minutes of exercise. __________.</em></p>
                    <hr>
                    <p><strong>(a)</strong> After lunch, we have PE class where we learn different sports like volleyball and badminton.</p>
                    <p><strong>(b)</strong> During break time, many students play football or basketball in the schoolyard.</p>
                    <p><strong>(c)</strong> Finally, after school, sports clubs like swimming and table tennis are available for interested students.</p>
                </div>
            `,
            options: [
                "A. b - a - c",
                "B. a - b - c",
                "C. c - b - a",
                "D. b - c - a"
            ],
            correct: 0, // Index A
            explanation: `
                <h4>Phân tích trình tự thời gian (Chronological Order):</h4>
                <p>Đoạn văn mô tả các hoạt động trong một ngày tại trường:</p>
                <ul>
                    <li><strong>Mở đầu:</strong> "Every morning..." (Mỗi sáng...) -> Đã cho sẵn.</li>
                    <li><strong>Tiếp theo:</strong> Sau buổi sáng là giờ ra chơi.
                        <br>-> <em>(b) "During break time..."</em> (Trong giờ ra chơi...).</li>
                    <li><strong>Tiếp theo:</strong> Sau giờ chơi là ăn trưa và học chiều.
                        <br>-> <em>(a) "After lunch..."</em> (Sau bữa trưa...).</li>
                    <li><strong>Cuối cùng:</strong> Kết thúc ngày học.
                        <br>-> <em>(c) "Finally, after school..."</em> (Cuối cùng, sau giờ học...).</li>
                </ul>
                <p><strong>Kết luận:</strong> Thứ tự thời gian hợp lý nhất là Sáng -> Giờ ra chơi (b) -> Trưa (a) -> Sau giờ học (c).</p>
                <p><strong>Đáp án đúng:</strong> A. b - a - c</p>
            `
        },
        {
            id: "q4",
            type: "text_end",
            title: "Exercise 21 - Q1.2: Chọn câu kết thúc (Ending Sentence)",
            content: `
                <div class="question-content">
                    <p>Dựa vào đoạn văn ở câu trên (Về các hoạt động thể thao cả ngày ở trường), hãy chọn câu kết bài phù hợp nhất:</p>
                </div>
            `,
            options: [
                "A. Therefore, students should focus more on studying than playing sports.",
                "B. With all these activities, our school helps students stay healthy and active throughout the day.",
                "C. However, playing video games is more popular than playing real sports.",
                "D. First, students must wear proper uniforms during sports activities."
            ],
            correct: 1, // Index B
            explanation: `
                <h4>Dịch và phân tích đáp án:</h4>
                <ul>
                    <li><strong>A.</strong> Vì vậy, học sinh nên tập trung học hơn là chơi thể thao. <span style="color:red">(Sai logic bài viết đang nói về lợi ích/hoạt động thể thao).</span></li>
                    <li><strong>B.</strong> Với tất cả các hoạt động này, trường chúng tôi giúp học sinh khỏe mạnh và năng động suốt cả ngày. <span style="color:green">(ĐÚNG - Tổng kết lại toàn bộ ý chính của đoạn văn).</span></li>
                    <li><strong>C.</strong> Tuy nhiên, chơi điện tử phổ biến hơn... <span style="color:red">(Sai - Lạc đề).</span></li>
                    <li><strong>D.</strong> Đầu tiên, học sinh phải mặc đồng phục... <span style="color:red">(Sai - Đây là chi tiết mở đầu, không phải kết luận).</span></li>
                </ul>
            `
        },
        {
            id: "q5",
            type: "gapfill_order",
            title: "Exercise 21 - Q2.1: Sắp xếp và điền vào chỗ trống",
            content: `
                <div class="question-content">
                    <p><em>Football is loved by millions of people around the world. In my neighborhood, children gather at the local park every weekend to play. __________.</em></p>
                    <hr>
                    <p><strong>(a)</strong> The winning team usually celebrates by going for ice cream together.</p>
                    <p><strong>(b)</strong> First, we divide into two teams and choose team captains fairly.</p>
                    <p><strong>(c)</strong> Then, we play for about an hour with a short break in the middle for water.</p>
                </div>
            `,
            options: [
                "A. a - b - c",
                "B. b - c - a",
                "C. c - a - b",
                "D. b - a - c"
            ],
            correct: 1, // Index B
            explanation: `
                <h4>Phân tích quy trình (Process):</h4>
                <p>Đoạn văn kể về quy trình một buổi đá bóng:</p>
                <ul>
                    <li><strong>Bước 1 (Chuẩn bị):</strong> Phải chia đội trước khi đá.
                        <br>-> <em>(b) "First, we divide into two teams..."</em> (Đầu tiên, chúng tôi chia làm 2 đội...). Từ khóa "First" là dấu hiệu bắt đầu.</li>
                    <li><strong>Bước 2 (Thực hiện):</strong> Bắt đầu chơi.
                        <br>-> <em>(c) "Then, we play for about an hour..."</em> (Sau đó, chúng tôi chơi khoảng 1 tiếng...). Từ khóa "Then".</li>
                    <li><strong>Bước 3 (Kết quả):</strong> Sau khi chơi xong thì ăn mừng.
                        <br>-> <em>(a) "The winning team usually celebrates..."</em> (Đội thắng thường ăn mừng...).</li>
                </ul>
                <p><strong>Đáp án đúng:</strong> B. b - c - a</p>
                <div class="glossary-section">
                    <table class="glossary-table">
                        <tr><th>Word</th><th>Type</th><th>Meaning</th></tr>
                        <tr><td>Celebrate</td><td>v</td><td>Ăn mừng</td></tr>
                        <tr><td>Fairly</td><td>adv</td><td>Một cách công bằng</td></tr>
                    </table>
                </div>
            `
        },
        {
            id: "q6",
            type: "text_end",
            title: "Exercise 21 - Q2.2: Chọn câu kết thúc (Ending Sentence)",
            content: `
                <div class="question-content">
                    <p>Dựa vào đoạn văn ở câu trên (Về trận bóng đá ở khu phố), hãy chọn câu kết bài phù hợp nhất:</p>
                </div>
            `,
            options: [
                "A. Before playing, everyone must bring their own football to the park.",
                "B. These friendly matches help us make friends and improve our football skills.",
                "C. Swimming is actually more interesting than playing football.",
                "D. Next week, we will stop playing football and start playing chess instead."
            ],
            correct: 1, // Index B
            explanation: `
                <h4>Dịch và phân tích đáp án:</h4>
                <ul>
                    <li><strong>A.</strong> Trước khi chơi, mọi người phải mang bóng... <span style="color:red">(Sai - Đây là câu chuẩn bị, không phải câu kết ý nghĩa).</span></li>
                    <li><strong>B.</strong> Những trận đấu giao hữu này giúp chúng tôi kết bạn và cải thiện kỹ năng bóng đá. <span style="color:green">(ĐÚNG - Nêu bật giá trị/ý nghĩa của hoạt động đã kể).</span></li>
                    <li><strong>C.</strong> Bơi lội thực ra thú vị hơn... <span style="color:red">(Sai - So sánh lạc đề).</span></li>
                    <li><strong>D.</strong> Tuần tới chúng tôi sẽ nghỉ đá bóng để chơi cờ... <span style="color:red">(Sai - Không liên quan mạch cảm xúc tích cực của bài).</span></li>
                </ul>
            `
        }
    ];

    // --- SOUND EFFECT LOGIC ---
    // Using AudioContext for synthesizing simple beeps prevents huge base64 strings and external dependency issues.
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        if (type === 'correct') {
            // Ding sound (High pitch, fading)
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.5);
        } else {
            // Wrong sound (Low pitch, sawtooth)
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            oscillator.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.4);
        }
    }

    // --- CONFETTI LOGIC ---
    // Minimal confetti implementation
    const confettiCanvas = document.getElementById('confetti');
    const ctx = confettiCanvas.getContext('2d');
    let particles = [];
    
    function resizeCanvas() {
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function createConfetti() {
        confettiCanvas.style.display = 'block';
        particles = [];
        const colors = ['#f1c40f', '#e74c3c', '#8e44ad', '#3498db', '#2ecc71'];
        for (let i = 0; i < 100; i++) {
            particles.push({
                x: Math.random() * confettiCanvas.width,
                y: Math.random() * confettiCanvas.height - confettiCanvas.height,
                color: colors[Math.floor(Math.random() * colors.length)],
                size: Math.random() * 10 + 5,
                speedY: Math.random() * 3 + 2,
                speedX: Math.random() * 2 - 1
            });
        }
        animateConfetti();
        setTimeout(() => { confettiCanvas.style.display = 'none'; }, 3000);
    }

    function animateConfetti() {
        if (confettiCanvas.style.display === 'none') return;
        ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        particles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, p.size, p.size);
            p.y += p.speedY;
            p.x += p.speedX;
            if (p.y > confettiCanvas.height) p.y = -20;
        });
        requestAnimationFrame(animateConfetti);
    }

    // --- QUIZ LOGIC ---
    let userAnswers = {}; // Store user choices

    function renderQuiz() {
        const container = document.getElementById('quiz-container');
        let html = '';

        quizData.forEach((q, index) => {
            html += `
                <div class="card" id="card-${q.id}">
                    <div class="question-title">${q.title}</div>
                    ${q.content}
                    <div class="options-grid">
                        ${q.options.map((opt, i) => `
                            <button class="option-btn" onclick="checkAnswer('${q.id}', ${i}, ${index})">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="explanation-box" id="exp-${q.id}">
                        <div class="exp-header">
                            <div class="exp-avatar">M</div>
                            <div>
                                <div style="font-size: 0.8rem; color: #777;">Giáo viên giải thích:</div>
                                <div style="color: var(--primary);">Ms. Mai An ULIS</div>
                            </div>
                        </div>
                        <div class="exp-content">
                            ${q.explanation}
                        </div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function checkAnswer(qId, selectedIndex, qIndex) {
        // Prevent re-answering
        if (userAnswers[qId] !== undefined) return;
        
        const qData = quizData[qIndex];
        userAnswers[qId] = (selectedIndex === qData.correct);

        const card = document.getElementById(`card-${qId}`);
        const buttons = card.getElementsByClassName('option-btn');
        const expBox = document.getElementById(`exp-${qId}`);

        // Disable all buttons in this card
        for (let btn of buttons) {
            btn.disabled = true;
            btn.style.cursor = 'default';
            btn.style.transform = 'none';
        }

        if (selectedIndex === qData.correct) {
            // CORRECT
            buttons[selectedIndex].classList.add('correct');
            playSound('correct');
            createConfetti();
            expBox.classList.remove('wrong-choice');
        } else {
            // WRONG
            buttons[selectedIndex].classList.add('wrong');
            buttons[qData.correct].classList.add('correct'); // Show correct answer
            playSound('wrong');
            expBox.classList.add('wrong-choice');
        }

        // Show Explanation
        expBox.style.display = 'block';
        
        // Auto scroll to explanation slightly
        expBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function submitQuiz() {
        const total = quizData.length;
        const answeredCount = Object.keys(userAnswers).length;
        let correctCount = 0;
        
        for (let key in userAnswers) {
            if (userAnswers[key]) correctCount++;
        }

        // Check if all questions are answered
        if (answeredCount < total) {
            alert(`Bạn mới làm ${answeredCount}/${total} câu. Hãy hoàn thành hết trước khi nộp nhé!`);
            return;
        }

        // Show Result Modal
        document.getElementById('finalScore').innerText = `${correctCount}/${total}`;
        const feedbackTitle = document.getElementById('feedbackTitle');
        const feedbackMsg = document.getElementById('feedbackMsg');

        if (correctCount === total) {
            feedbackTitle.innerText = "XUẤT SẮC!";
            feedbackMsg.innerText = "Cô Mai An rất tự hào về bạn! Điểm tuyệt đối!";
            createConfetti();
        } else if (correctCount >= total / 2) {
            feedbackTitle.innerText = "LÀM TỐT LẮM!";
            feedbackMsg.innerText = "Bạn đã nắm khá vững kiến thức. Hãy xem lại các lỗi sai nhé.";
        } else {
            feedbackTitle.innerText = "CỐ GẮNG HƠN NHÉ!";
            feedbackMsg.innerText = "Đừng nản lòng, hãy đọc kỹ phần giải thích chi tiết của cô nhé.";
        }

        document.getElementById('resultModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('resultModal').style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Initialize
    window.onload = renderQuiz;

</script>

</body>
</html>