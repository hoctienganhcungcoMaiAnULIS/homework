<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i Ki·ªÉm Tra Ti·∫øng Anh - Ms Mai An ULIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8854C0; /* T√≠m h·ªìng */
            --secondary: #00C9A7; /* Xanh ng·ªçc */
            --correct: #00D26A; /* Xanh l√° */
            --wrong: #FF4757; /* ƒê·ªè cam */
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --shadow: 0 8px 0 rgba(0,0,0,0.15);
            --shadow-click: 0 4px 0 rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: #E0F7FA;
            background-image: radial-gradient(#00C9A7 1px, transparent 1px), radial-gradient(#8854C0 1px, transparent 1px);
            background-position: 0 0, 25px 25px;
            background-size: 50px 50px;
            color: var(--text-main);
            margin: 0;
            padding-bottom: 100px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER */
        header {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-bottom: 5px solid var(--primary);
            position: relative;
            overflow: hidden;
        }
        
        header h1 {
            color: var(--primary);
            font-family: 'Quicksand', sans-serif;
            font-weight: 800;
            margin: 0;
            font-size: 2rem;
        }
        
        header p {
            color: #666;
            font-size: 1.1rem;
            margin-top: 5px;
        }

        /* CARD STYLE */
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 2px solid #eee;
            position: relative;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-3px);
            border-color: var(--secondary);
        }

        h2.section-title {
            color: var(--primary);
            background: #F3E5F5;
            display: inline-block;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 1.2rem;
            margin-bottom: 20px;
            box-shadow: 0 3px 0 rgba(136, 84, 192, 0.2);
        }

        h3.sub-title {
            color: var(--secondary);
            font-weight: 700;
            margin-top: 0;
        }

        /* TEXT PASSAGE & GLOSSARY */
        .passage {
            background: #F0FCF8;
            padding: 20px;
            border-radius: 15px;
            line-height: 1.8;
            font-size: 1.05rem;
            border-left: 5px solid var(--secondary);
            margin-bottom: 20px;
            text-align: justify;
        }

        .glossary {
            margin-top: 15px;
            border: 2px dashed var(--primary);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .glossary-header {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .glossary table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .glossary td, .glossary th {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        
        .glossary tr:last-child td { border-bottom: none; }
        .glossary .word { color: var(--primary); font-weight: bold; }
        .glossary .type { color: #888; font-style: italic; font-size: 0.9em; }

        /* QUESTIONS */
        .question-block {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ddd;
        }

        .question-text {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: baseline;
        }
        
        .q-num {
            background: var(--secondary);
            color: white;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 10px;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        /* OPTIONS (MCQ) */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .options-grid { grid-template-columns: 1fr; }
        }

        .option-btn {
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 12px 15px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 1rem;
            position: relative;
            box-shadow: 0 4px 0 #ddd;
        }

        .option-btn:hover {
            transform: scale(1.02);
            background: white;
            border-color: var(--secondary);
        }

        .option-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .option-btn.selected {
            background: #E0F2F1;
            border-color: var(--secondary);
            color: #00796B;
            box-shadow: 0 4px 0 #B2DFDB;
        }

        .option-btn.correct {
            background: #E8F5E9 !important;
            border-color: var(--correct) !important;
            color: #2E7D32 !important;
            box-shadow: 0 4px 0 #A5D6A7 !important;
        }

        .option-btn.wrong {
            background: #FFEBEE !important;
            border-color: var(--wrong) !important;
            color: #C62828 !important;
            box-shadow: 0 4px 0 #FFCDD2 !important;
            animation: shake 0.5s;
        }

        /* INPUTS & DROPDOWNS */
        select, input[type="text"] {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s;
        }
        
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-full { width: 100%; box-sizing: border-box; margin-top: 5px;}

        /* CHECK BUTTON PER QUESTION */
        .check-btn-mini {
            background: var(--primary);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            box-shadow: 0 3px 0 #5f3a8a;
            transition: all 0.2s;
        }
        .check-btn-mini:hover { filter: brightness(1.1); }
        .check-btn-mini:active { transform: translateY(3px); box-shadow: none; }
        
        /* EXPLANATION BOX */
        .explanation {
            display: none;
            margin-top: 15px;
            background: #FFF8E1;
            border: 2px solid #FFECB3;
            border-radius: 12px;
            padding: 15px;
            animation: slideDown 0.3s ease-out;
        }

        .explanation.visible { display: block; }
        
        .exp-header {
            font-weight: bold;
            color: #F57F17;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .exp-header::before { content: "üí°"; font-size: 1.2rem; }
        .exp-content p { margin: 5px 0; font-size: 0.95rem; }
        .exp-content strong { color: #d35400; }

        /* FOOTER & SUBMIT */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .submit-btn {
            background: var(--secondary);
            color: white;
            font-size: 1.2rem;
            font-weight: 800;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #009688;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .submit-btn:hover { transform: scale(1.05); }
        .submit-btn:active { transform: translateY(6px); box-shadow: none; }

        /* SORTING STRESS GAME */
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            background: #f4f4f4;
            padding: 15px;
            border-radius: 15px;
        }
        
        .draggable-word {
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            user-select: none;
            transition: 0.2s;
        }
        
        .draggable-word:hover { background: var(--primary); color: white; }
        .draggable-word.used { opacity: 0.3; pointer-events: none; border-color: #ccc; background: #eee; color: #aaa;}

        .drop-zones {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .zone {
            background: #E1F5FE;
            border: 3px dashed #29B6F6;
            border-radius: 15px;
            padding: 15px;
            min-height: 150px;
        }
        
        .zone h4 { margin-top: 0; color: #0277BD; text-align: center;}
        
        .zone-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .zone-item {
            background: #29B6F6;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .zone-item span { cursor: pointer; background: rgba(0,0,0,0.2); border-radius: 50%; width: 18px; height: 18px; text-align: center; line-height: 16px;}

        /* ANIMATIONS */
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* RESULT MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            position: relative;
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .score-circle {
            width: 150px; height: 150px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 3rem;
            font-weight: 800;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px auto;
            border: 8px solid #E1BEE7;
        }

        .close-modal {
            background: #ddd;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
        }
        
        /* PHONETICS */
        u { border-bottom: 2px solid var(--primary); text-decoration: none; font-weight: bold; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ENGLISH TEST</h1>
        <p>Expert: Ms. Mai An ULIS | Master's Level Explanation</p>
    </header>

    <div class="card" id="section-phonetics">
        <h2 class="section-title">A. PHONETICS</h2>
        
        <h3 class="sub-title">I. Sorting: Stress Pattern</h3>
        <p>Put the words into the correct column depending on the stressed syllable.</p>
        
        <div class="word-bank" id="stress-word-bank">
            </div>

        <div class="drop-zones">
            <div class="zone" id="zone-1" onclick="handleZoneClick(1)">
                <h4>Stress on 1st Syllable</h4>
                <div class="zone-items" id="items-1"></div>
            </div>
            <div class="zone" id="zone-2" onclick="handleZoneClick(2)">
                <h4>Stress on 2nd Syllable</h4>
                <div class="zone-items" id="items-2"></div>
            </div>
        </div>
        <button class="check-btn-mini" onclick="checkStressSort()">Check Sorting</button>
        <div class="explanation" id="exp-stress-sort"></div>

        <hr style="margin: 30px 0; border: 0; border-top: 1px dashed #ccc;">

        <h3 class="sub-title">II. Choose the word with a different stress pattern</h3>
        <div id="phonetics-mcq"></div>
    </div>

    <div class="card">
        <h2 class="section-title">D. READING</h2>
        <h3 class="sub-title">I. Gap Fill: Halloween</h3>
        <p>Complete the passage with the words from the box.</p>
        
        <div style="background: #e8eaf6; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--primary);">
            other | carved | trick-or-treating | fun | unwanted | comes | frightening | costumes
        </div>

        <div class="passage">
            Halloween is celebrated on October 31, and many people, including children, dress up in (1) <select id="gap1"><option value="">...</option><option value="costumes">costumes</option><option value="fun">fun</option><option value="other">other</option></select>. Children visit people's houses, and ask for candy. This is called (2) <select id="gap2"><option value="">...</option><option value="trick-or-treating">trick-or-treating</option><option value="frightening">frightening</option></select>. There are (3) <select id="gap3"><option value="">...</option><option value="other">other</option><option value="unwanted">unwanted</option></select> traditions at Halloween. People have parties in their houses. You can dress up in scary costumes for (4) <select id="gap4"><option value="">...</option><option value="fun">fun</option><option value="carved">carved</option></select> but your costume doesn't have to be scary. In the USA, many people wear costumes that aren't (5) <select id="gap5"><option value="">...</option><option value="frightening">frightening</option><option value="comes">comes</option></select>. People also tell scary stories at Halloween or play games like bobbing for apples. Some people make jack-o'-lanterns, (6) <select id="gap6"><option value="">...</option><option value="carved">carved</option><option value="unwanted">unwanted</option></select> pumpkins with candles inside, and put them inside or outside their houses. It's unclear where this tradition (7) <select id="gap7"><option value="">...</option><option value="comes">comes</option><option value="other">other</option></select> from. Some historians believe that in the past, they were used to scary away (8) <select id="gap8"><option value="">...</option><option value="unwanted">unwanted</option><option value="costumes">costumes</option></select> visitors or travelers. Jack-o'-lanterns are now chiefly associated with Halloween.
        </div>

        <div class="glossary">
            <div class="glossary-header">üìö ACADEMIC VOCABULARY (HALLOWEEN)</div>
            <table>
                <tr><td class="word">Celebrate</td><td class="type">(v)</td><td>T·ªï ch·ª©c l·ªÖ k·ª∑ ni·ªám</td></tr>
                <tr><td class="word">Tradition</td><td class="type">(n)</td><td>Truy·ªÅn th·ªëng</td></tr>
                <tr><td class="word">Historian</td><td class="type">(n)</td><td>Nh√† s·ª≠ h·ªçc</td></tr>
                <tr><td class="word">Associate with</td><td class="type">(phr.v)</td><td>G·∫Øn li·ªÅn v·ªõi, li√™n quan ƒë·∫øn</td></tr>
                <tr><td class="word">Chiefly</td><td class="type">(adv)</td><td>Ch·ªß y·∫øu l√†</td></tr>
            </table>
        </div>

        <button class="check-btn-mini" onclick="checkReading1()">Check Gap Fill</button>
        <div class="explanation" id="exp-reading1"></div>
    </div>

    <div class="card">
        <h3 class="sub-title">II. Reading Comprehension: Holi Festival</h3>
        <p>Read the text carefully, then do the tasks.</p>
        
        <div class="passage">
            Holi, known as the festival of colours, is the Hindu festival celebrated by Hindus all over Asia and also by the people from some parts of Europe and North America. It is mainly observed in India and Nepal. Holi commemorates the victory of good over evil, marks the arrival of Spring, and a time to give thanks for the good harvest. The dates change each year according to the full moon, but it is normally in March and sometimes in late February and lasts for a night and a day.<br><br>
            Traditional Holi celebrations start the night before Holi with a Holika Dahan where people gather around a bonfire and perform religious rituals praying that evil will be destroyed. The next morning is a free-for-all festival of colours. People chase each other, smear each other with paint, throw coloured paint powder over each other, and drench each other with coloured water. Some people carry water guns and coloured water-filled balloons for their water fight. In the evening, people visit the houses of their friends and relatives and share sweets and other food items.
        </div>

        <div class="glossary">
            <div class="glossary-header">üìö ACADEMIC VOCABULARY (HOLI)</div>
            <table>
                <tr><td class="word">Commemorate</td><td class="type">(v)</td><td>T∆∞·ªüng nh·ªõ, k·ª∑ ni·ªám</td></tr>
                <tr><td class="word">Victory</td><td class="type">(n)</td><td>Chi·∫øn th·∫Øng</td></tr>
                <tr><td class="word">Observe</td><td class="type">(v)</td><td>T·ªï ch·ª©c, ƒÉn m·ª´ng (l·ªÖ h·ªôi)</td></tr>
                <tr><td class="word">Ritual</td><td class="type">(n)</td><td>Nghi th·ª©c t√¥n gi√°o</td></tr>
                <tr><td class="word">Drench</td><td class="type">(v)</td><td>L√†m ∆∞·ªõt s≈©ng</td></tr>
                <tr><td class="word">Smear</td><td class="type">(v)</td><td>B√¥i, tr√©t (s∆°n/m√†u)</td></tr>
            </table>
        </div>

        <div style="margin-top:20px;">
            <h4>A. Decide if statements are True (T) or False (F)</h4>
            <div id="reading2-tf"></div>
        </div>

        <div style="margin-top:20px;">
            <h4>B. Choose the best answer</h4>
            <div id="reading2-mcq"></div>
        </div>
    </div>

    <div class="card">
        <h2 class="section-title">E. WRITING</h2>
        
        <h3 class="sub-title">I. Arrange the words</h3>
        <p>Reorder the words to make meaningful sentences. (Type the full sentence below)</p>
        <div id="writing-arrange"></div>

        <hr style="margin: 30px 0; border: 0; border-top: 1px dashed #ccc;">

        <h3 class="sub-title">II. Rewrite the sentences</h3>
        <p>Write the second sentence so that it has the same meaning as the first one.</p>
        <div id="writing-rewrite"></div>
    </div>

</div>

<div class="sticky-footer">
    <button class="submit-btn" onclick="submitTest()">N·ªòP B√ÄI (SUBMIT)</button>
</div>

<div class="modal" id="resultModal">
    <div class="modal-content">
        <h2 style="color: var(--primary);">K·∫æT QU·∫¢ B√ÄI THI</h2>
        <div class="score-circle" id="finalScore">0</div>
        <p id="feedbackText">B·∫°n h√£y c·ªë g·∫Øng h∆°n nh√©!</p>
        <button class="close-modal" onclick="closeModal()">Xem l·∫°i b√†i l√†m (Review)</button>
    </div>
</div>

<canvas id="confetti" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;display:none;"></canvas>

<script>
    /* ================= DATA SOURCE ================= */
    const phoneticWords = [
        "perform", "culture", "describe", "manner", "machine", "country", "relax", "prefer", "village", "beauty", 
        "compete", "happy", "begin", "season", "parade", "dancer", "prepare", "turkey", "gather", "abroad", 
        "amazed", "candle", "expect", "listen", "answer", "alone", "costume", "attend", "tulip", "discuss"
    ];

    // Stress Key: 1 = First Syllable, 2 = Second Syllable
    const stressKey = {
        "culture":1, "manner":1, "country":1, "village":1, "beauty":1, "happy":1, "season":1, "dancer":1, "turkey":1, "gather":1, "candle":1, "listen":1, "answer":1, "costume":1, "tulip":1,
        "perform":2, "describe":2, "machine":2, "relax":2, "prefer":2, "compete":2, "begin":2, "parade":2, "prepare":2, "abroad":2, "amazed":2, "expect":2, "alone":2, "attend":2, "discuss":2
    };

    const phoneticMCQ = [
        {
            q: "Circle the word with different stress pattern:",
            options: ["happen", "enter", "award", "ridden"],
            correct: 2, // 0-based index: award (2) others (1)
            expl: "<b>A. hap</b>pen (1) | <b>B. en</b>ter (1) | <b>C. a-ward</b> (2) | <b>D. rid</b>den (1). <br>üëâ Ch·ªçn C v√¨ tr·ªçng √¢m r∆°i v√†o √¢m 2, c√°c t·ª´ c√≤n l·∫°i √¢m 1."
        },
        {
            q: "Circle the word with different stress pattern:",
            options: ["culture", "parade", "weather", "cannon"],
            correct: 1, // parade (2) others (1)
            expl: "<b>A. cul</b>ture (1) | <b>B. pa-rade</b> (2) | <b>C. wea</b>ther (1) | <b>D. can</b>non (1). <br>üëâ Ch·ªçn B v√¨ tr·ªçng √¢m r∆°i v√†o √¢m 2."
        },
        {
            q: "Circle the word with different stress pattern:",
            options: ["receive", "finish", "direct", "compete"],
            correct: 1, // finish (1) others (2)
            expl: "<b>A. re-ceive</b> (2) | <b>B. fi</b>nish (1) | <b>C. di-rect</b> (2) | <b>D. com-pete</b> (2). <br>üëâ Ch·ªçn B."
        },
        {
            q: "Circle the word with different stress pattern:",
            options: ["visit", "famous", "wonder", "protect"],
            correct: 3, // protect (2) others (1)
            expl: "<b>A. vi</b>sit (1) | <b>B. fa</b>mous (1) | <b>C. won</b>der (1) | <b>D. pro-tect</b> (2). <br>üëâ Ch·ªçn D."
        },
        {
            q: "Circle the word with different stress pattern:",
            options: ["critic", "event", "machine", "mistake"],
            correct: 0, // critic (1) others (2)
            expl: "<b>A. cri</b>tic (1) | <b>B. e-vent</b> (2) | <b>C. ma-chine</b> (2) | <b>D. mis-take</b> (2). <br>üëâ Ch·ªçn A."
        }
    ];

    const reading1Key = {
        gap1: { ans: "costumes", expl: "Dress up in costumes: H√≥a trang trong c√°c b·ªô trang ph·ª•c." },
        gap2: { ans: "trick-or-treating", expl: "H√†nh ƒë·ªông ƒëi xin k·∫πo g·ªçi l√† 'trick-or-treating' (Cho k·∫πo hay b·ªã gh·∫πo)." },
        gap3: { ans: "other", expl: "Other traditions: C√°c truy·ªÅn th·ªëng kh√°c." },
        gap4: { ans: "fun", expl: "For fun: ƒê·ªÉ cho vui." },
        gap5: { ans: "frightening", expl: "Aren't frightening: Kh√¥ng ƒë√°ng s·ª£ (ng·ªØ c·∫£nh: ·ªü M·ªπ nhi·ªÅu ng∆∞·ªùi m·∫∑c ƒë·ªì kh√¥ng s·ª£)." },
        gap6: { ans: "carved", expl: "Carved pumpkins: B√≠ ng√¥ ƒë∆∞·ª£c ch·∫°m kh·∫Øc." },
        gap7: { ans: "comes", expl: "Tradition comes from: Truy·ªÅn th·ªëng b·∫Øt ngu·ªìn t·ª´ ƒë√¢u." },
        gap8: { ans: "unwanted", expl: "Scare away unwanted visitors: Xua ƒëu·ªïi nh·ªØng v·ªã kh√°ch kh√¥ng m·ªùi." }
    };

    const reading2TF = [
        { q: "The 'festival of colours' is another name for Holi.", ans: true, expl: "D·∫´n ch·ª©ng: 'Holi, known as the festival of colours...'" },
        { q: "Only Hindus celebrate Holi.", ans: false, expl: "D·∫´n ch·ª©ng: '...also by the people from some parts of Europe and North America.' (Kh√¥ng ch·ªâ ng∆∞·ªùi Hindu)." },
        { q: "Holi is celebrated on 1 March.", ans: false, expl: "D·∫´n ch·ª©ng: 'The dates change each year... normally in March and sometimes in late February'." },
        { q: "Holi activities start early in the morning.", ans: false, expl: "D·∫´n ch·ª©ng: 'start the night before Holi with a Holika Dahan'." },
        { q: "The famous festival of colours is the second day of Holi.", ans: true, expl: "D·∫´n ch·ª©ng: 'The next morning is a free-for-all festival of colours.' (S√°ng h√¥m sau t·ª©c l√† ng√†y th·ª© 2)." },
        { q: "Water guns and water-filled balloons are used.", ans: true, expl: "D·∫´n ch·ª©ng: 'Some people carry water guns and coloured water-filled balloons...'" }
    ];

    const reading2MCQ = [
        {
            q: "Where is Holi mainly celebrated?",
            options: ["Only in North America", "Mainly in India and Nepal", "Only in Europe", "All over the world"],
            correct: 1,
            expl: "D·∫´n ch·ª©ng: 'It is mainly observed in India and Nepal.' (N√≥ ch·ªß y·∫øu ƒë∆∞·ª£c t·ªï ch·ª©c ·ªü ·∫§n ƒê·ªô v√† Nepal)."
        },
        {
            q: "When does Holi take place?",
            options: ["Every March 1st", "Depends on full moon, usually March/late Feb", "First day of Winter", "Every late January"],
            correct: 1,
            expl: "D·∫´n ch·ª©ng: 'change each year according to the full moon, but it is normally in March and sometimes in late February'."
        },
        {
            q: "How long does the festival last?",
            options: ["A whole week", "Three days", "For a night and a day", "One morning only"],
            correct: 2,
            expl: "D·∫´n ch·ª©ng: 'lasts for a night and a day'."
        },
        {
            q: "Why is Holi celebrated?",
            options: ["Celebrate a new King", "Victory of good over evil & arrival of Spring", "Pray for rain", "End of a year"],
            correct: 1,
            expl: "D·∫´n ch·ª©ng: 'commemorates the victory of good over evil, marks the arrival of Spring'."
        },
        {
            q: "How do people celebrate Holika Dahan?",
            options: ["Throwing paint", "Gather around bonfire & rituals", "Visiting relatives", "Playing with balloons"],
            correct: 1,
            expl: "D·∫´n ch·ª©ng: 'gather around a bonfire and perform religious rituals'."
        },
        {
            q: "What do people do on the day of Holi?",
            options: ["Stay home", "Go to work", "Chase each other & use paint/water", "Pray at temple"],
            correct: 2,
            expl: "D·∫´n ch·ª©ng: 'People chase each other, smear each other with paint...'"
        }
    ];

    const writingArrange = [
        { words: "carnival/ Rio/ has/ famous / the/ most/ in/ the/ world.", ans: "Rio has the most famous carnival in the world.", expl: "C·∫•u tr√∫c So s√°nh nh·∫•t: S + has + the + most + adj + noun." },
        { words: "festival/ when/ the / starts/ people/ square/ gather/ in/ the/ town.", ans: "When the festival starts, people gather in the town square.", expl: "M·ªánh ƒë·ªÅ tr·∫°ng ng·ªØ ch·ªâ th·ªùi gian (When...) ƒë·ª©ng tr∆∞·ªõc, ngƒÉn c√°ch b·ªüi d·∫•u ph·∫©y." },
        { words: "the/ starts/ festival/ with / opening/ parade / an/ where/ walk / people / the / streets/ through.", ans: "The festival starts with an opening parade where people walk through the streets.", expl: "M·ªánh ƒë·ªÅ quan h·ªá v·ªõi 'where' b·ªï nghƒ©a cho 'parade'." },
        { words: "than/ 2 million / there/ people/ in/ are/ more/ the / streets / on / during / Rio / the/ carnival.", ans: "There are more than 2 million people on the streets during the Rio carnival.", expl: "C·∫•u tr√∫c There are + number + people + place + time." },
        { words: "gathering/ Is/ the/ the/ for/ the/ twins/ in/ largest/ Twins Day Festival/ world?", ans: "Is the Twins Day Festival the largest gathering for twins in the world?", expl: "C√¢u h·ªèi Yes/No v·ªõi so s√°nh nh·∫•t." },
        { words: "we/ have/ and/ parties/ other/ throughout/ festival/ celebrations / the.", ans: "We have parties and other celebrations throughout the festival.", expl: "Have parties (t·ªï ch·ª©c ti·ªác). Throughout (xuy√™n su·ªët)." },
        { words: "listen/ Did/ people/ to/ traditional songs/ Hoi Mua Festival/ at/ the/ last year?", ans: "Did people listen to traditional songs at the Hoi Mua Festival last year?", expl: "C√¢u h·ªèi qu√° kh·ª© ƒë∆°n: Did + S + V(inf)...?" },
        { words: "lunar month/ celebrate/ the/ middle/ Mid-Autumn Festival/ in/ of/ the/ the/ eighth/ We", ans: "We celebrate the Mid-Autumn Festival in the middle of the eighth lunar month.", expl: "Time phrase ƒë·∫∑t cu·ªëi c√¢u: in the middle of..." }
    ];

    const writingRewrite = [
        { q: "Would you like to decorate the Christmas tree with me? (want)", start: "Do", ans: "Do you want to decorate the Christmas tree with me?", expl: "Would you like to V = Do you want to V." },
        { q: "More than 70 samba schools participated in the five-day carnival. (part)", start: "More than 70 samba schools", ans: "More than 70 samba schools took part in the five-day carnival.", expl: "Participate in = Take part in (Qu√° kh·ª©: took part in)." },
        { q: "Omizutori is the oldest festival in Japan. (as)", start: "No festival", ans: "No festival in Japan is as old as Omizutori.", expl: "So s√°nh nh·∫•t chuy·ªÉn sang so s√°nh b·∫±ng: No... is as + adj + as..." },
        { q: "There was a great storm, so they cancelled the music festival. (because)", start: "They", ans: "They cancelled the music festival because there was a great storm.", expl: "So (k·∫øt qu·∫£) -> Because (nguy√™n nh√¢n)." },
        { q: "I can't wait to watch the samba parade in Rio Carnival. (forward)", start: "I am", ans: "I am looking forward to watching the samba parade in Rio Carnival.", expl: "Can't wait to V = Look forward to V-ing (Mong ch·ªù)." },
        { q: "The date for La Tomatina is the last Wednesday of August. (place)", start: "La Tomatina", ans: "La Tomatina takes place on the last Wednesday of August.", expl: "Be (is) -> Take place (di·ªÖn ra) + on + time." },
        { q: "Thousands of people lined the streets because they wanted to watch the massive colourful parade. (in order to)", start: "Thousands of people", ans: "Thousands of people lined the streets in order to watch the massive colourful parade.", expl: "Because S + wanted to V -> in order to V (ƒë·ªÉ l√†m g√¨)." },
        { q: "The festival took place in a remote area. However, a lot of people attended it. (although)", start: "A lot of people", ans: "A lot of people attended the festival although it took place in a remote area.", expl: "However (Tuy nhi√™n - n·ªëi 2 c√¢u) -> Although (M·∫∑c d√π - n·ªëi 2 m·ªánh ƒë·ªÅ)." }
    ];

    /* ================= INITIALIZATION ================= */
    let currentDragWord = null;

    window.onload = function() {
        initPhoneticsSorting();
        initPhoneticsMCQ();
        initReading2();
        initWriting();
    };

    function playSound(type) {
        // Simple Audio using Oscillator to verify action
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        if (type === 'correct') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
            launchConfetti();
        } else {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        }
    }

    /* ================= PHONETICS SORTING ================= */
    function initPhoneticsSorting() {
        const bank = document.getElementById('stress-word-bank');
        phoneticWords.forEach(word => {
            let el = document.createElement('div');
            el.className = 'draggable-word';
            el.innerText = word;
            el.onclick = () => selectWord(el, word);
            bank.appendChild(el);
        });
    }

    let selectedWordEl = null;
    let selectedWordText = "";

    function selectWord(el, word) {
        if(el.classList.contains('used')) return;
        
        if (selectedWordEl) selectedWordEl.style.backgroundColor = 'white';
        if (selectedWordEl) selectedWordEl.style.color = 'var(--primary)';

        selectedWordEl = el;
        selectedWordText = word;
        el.style.backgroundColor = 'var(--secondary)';
        el.style.color = 'white';
    }

    function handleZoneClick(zoneId) {
        if (!selectedWordText) return;
        
        const container = document.getElementById(`items-${zoneId}`);
        const item = document.createElement('div');
        item.className = 'zone-item';
        item.innerHTML = `${selectedWordText} <span onclick="removeWord(this, '${selectedWordText}')">√ó</span>`;
        item.dataset.word = selectedWordText;
        container.appendChild(item);

        selectedWordEl.classList.add('used');
        selectedWordEl.style.backgroundColor = '#eee';
        selectedWordEl = null;
        selectedWordText = "";
    }

    function removeWord(span, word) {
        span.parentElement.remove();
        // Reactivate in bank
        const bank = document.getElementById('stress-word-bank');
        Array.from(bank.children).forEach(child => {
            if (child.innerText === word) {
                child.classList.remove('used');
                child.style.backgroundColor = 'white';
                child.style.color = 'var(--primary)';
            }
        });
    }

    function checkStressSort() {
        let correctCount = 0;
        let total = 0;
        
        // Check Zone 1
        const items1 = document.getElementById('items-1').children;
        Array.from(items1).forEach(item => {
            const w = item.dataset.word;
            total++;
            if (stressKey[w] === 1) {
                item.style.background = 'var(--correct)';
                correctCount++;
            } else {
                item.style.background = 'var(--wrong)';
            }
        });

        // Check Zone 2
        const items2 = document.getElementById('items-2').children;
        Array.from(items2).forEach(item => {
            const w = item.dataset.word;
            total++;
            if (stressKey[w] === 2) {
                item.style.background = 'var(--correct)';
                correctCount++;
            } else {
                item.style.background = 'var(--wrong)';
            }
        });

        const exp = document.getElementById('exp-stress-sort');
        exp.classList.add('visible');
        if(correctCount === total && total > 0) playSound('correct');
        else playSound('wrong');

        let html = `<div class="exp-header">Ms. Mai An Explains:</div><div class="exp-content">`;
        html += `<p><b>Stress on 1st:</b> culture, manner, country, village, beauty, happy, season, dancer, turkey, gather, candle, listen, answer, costume, tulip.</p>`;
        html += `<p><b>Stress on 2nd:</b> perform, describe, machine, relax, prefer, compete, begin, parade, prepare, abroad, amazed, expect, alone, attend, discuss.</p>`;
        html += `</div>`;
        exp.innerHTML = html;
    }

    /* ================= PHONETICS MCQ ================= */
    function initPhoneticsMCQ() {
        const container = document.getElementById('phonetics-mcq');
        phoneticMCQ.forEach((item, idx) => {
            const block = document.createElement('div');
            block.className = 'question-block';
            block.innerHTML = `
                <div class="question-text"><span class="q-num">${idx+1}</span> ${item.q}</div>
                <div class="options-grid" id="p-mcq-${idx}">
                    ${item.options.map((opt, oIdx) => `<button class="option-btn" onclick="checkMCQ('p', ${idx}, ${oIdx})">${String.fromCharCode(65+oIdx)}. ${opt}</button>`).join('')}
                </div>
                <div class="explanation" id="exp-p-${idx}"></div>
            `;
            container.appendChild(block);
        });
    }

    /* ================= READING 1 ================= */
    function checkReading1() {
        let correct = 0;
        for(let i=1; i<=8; i++) {
            const select = document.getElementById(`gap${i}`);
            const key = reading1Key[`gap${i}`];
            const val = select.value;
            
            // Reset style
            select.style.borderColor = '#ddd';
            select.style.background = 'white';

            if(val === key.ans) {
                select.style.borderColor = 'var(--correct)';
                select.style.background = '#E8F5E9';
                correct++;
            } else {
                select.style.borderColor = 'var(--wrong)';
                select.style.background = '#FFEBEE';
            }
        }

        const exp = document.getElementById('exp-reading1');
        exp.classList.add('visible');
        if (correct === 8) playSound('correct'); else playSound('wrong');

        let html = `<div class="exp-header">Ms. Mai An Explains:</div><div class="exp-content">`;
        for(let i=1; i<=8; i++) {
            const key = reading1Key[`gap${i}`];
            html += `<p><b>(${i}) ${key.ans}:</b> ${key.expl}</p>`;
        }
        html += `</div>`;
        exp.innerHTML = html;
    }

    /* ================= READING 2 ================= */
    function initReading2() {
        // T/F
        const tfContainer = document.getElementById('reading2-tf');
        reading2TF.forEach((item, idx) => {
            const block = document.createElement('div');
            block.className = 'question-block';
            block.innerHTML = `
                <div class="question-text"><span class="q-num">${idx+1}</span> ${item.q}</div>
                <div style="display:flex; gap:20px;">
                    <label><input type="radio" name="tf-${idx}" value="true"> TRUE</label>
                    <label><input type="radio" name="tf-${idx}" value="false"> FALSE</label>
                </div>
                <button class="check-btn-mini" onclick="checkTF(${idx})">Check</button>
                <div class="explanation" id="exp-tf-${idx}"></div>
            `;
            tfContainer.appendChild(block);
        });

        // MCQ
        const mcqContainer = document.getElementById('reading2-mcq');
        reading2MCQ.forEach((item, idx) => {
            const block = document.createElement('div');
            block.className = 'question-block';
            block.innerHTML = `
                <div class="question-text"><span class="q-num">${idx+1}</span> ${item.q}</div>
                <div class="options-grid" id="r-mcq-${idx}">
                    ${item.options.map((opt, oIdx) => `<button class="option-btn" onclick="checkMCQ('r', ${idx}, ${oIdx})">${String.fromCharCode(65+oIdx)}. ${opt}</button>`).join('')}
                </div>
                <div class="explanation" id="exp-r-${idx}"></div>
            `;
            mcqContainer.appendChild(block);
        });
    }

    function checkTF(idx) {
        const item = reading2TF[idx];
        const radios = document.getElementsByName(`tf-${idx}`);
        let selected = null;
        let container = radios[0].parentElement.parentElement;
        
        for(let r of radios) { if(r.checked) selected = (r.value === 'true'); }
        
        const exp = document.getElementById(`exp-tf-${idx}`);
        exp.classList.add('visible');

        if(selected === item.ans) {
            playSound('correct');
            exp.innerHTML = `<div class="exp-header" style="color:var(--correct)">‚úÖ Ch√≠nh x√°c!</div><div class="exp-content">${item.expl}</div>`;
        } else {
            playSound('wrong');
            exp.innerHTML = `<div class="exp-header" style="color:var(--wrong)">‚ùå Sai r·ªìi!</div><div class="exp-content">ƒê√°p √°n ƒë√∫ng: <b>${item.ans ? 'TRUE' : 'FALSE'}</b>. <br> ${item.expl}</div>`;
        }
    }

    function checkMCQ(type, qIdx, optIdx) {
        const data = type === 'p' ? phoneticMCQ : reading2MCQ;
        const item = data[qIdx];
        const btnContainer = document.getElementById(`${type}-mcq-${qIdx}`);
        const btns = btnContainer.getElementsByClassName('option-btn');
        const exp = document.getElementById(`exp-${type}-${qIdx}`);

        // Reset
        for(let btn of btns) { btn.className = 'option-btn'; }

        if(optIdx === item.correct) {
            btns[optIdx].classList.add('correct');
            playSound('correct');
        } else {
            btns[optIdx].classList.add('wrong');
            btns[item.correct].classList.add('correct'); // Show correct one
            playSound('wrong');
        }

        exp.classList.add('visible');
        exp.innerHTML = `<div class="exp-header">Ms. Mai An Explains:</div><div class="exp-content">${item.expl}</div>`;
    }

    /* ================= WRITING ================= */
    function initWriting() {
        const arrangeContainer = document.getElementById('writing-arrange');
        writingArrange.forEach((item, idx) => {
            const block = document.createElement('div');
            block.className = 'question-block';
            block.innerHTML = `
                <div class="question-text"><span class="q-num">${idx+1}</span></div>
                <p style="background:#e1bee7; padding:10px; border-radius:5px; font-weight:bold;">${item.words}</p>
                <input type="text" class="input-full" id="w-arr-${idx}" placeholder="Type your sentence here...">
                <button class="check-btn-mini" onclick="checkWriting('arr', ${idx})">Check</button>
                <div class="explanation" id="exp-arr-${idx}"></div>
            `;
            arrangeContainer.appendChild(block);
        });

        const rewriteContainer = document.getElementById('writing-rewrite');
        writingRewrite.forEach((item, idx) => {
            const block = document.createElement('div');
            block.className = 'question-block';
            block.innerHTML = `
                <div class="question-text"><span class="q-num">${idx+1}</span> ${item.q}</div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <b>${item.start}</b>
                    <input type="text" class="input-full" id="w-rew-${idx}" placeholder="...">
                </div>
                <button class="check-btn-mini" onclick="checkWriting('rew', ${idx})">Check</button>
                <div class="explanation" id="exp-rew-${idx}"></div>
            `;
            rewriteContainer.appendChild(block);
        });
    }

    function checkWriting(type, idx) {
        const data = type === 'arr' ? writingArrange : writingRewrite;
        const item = data[idx];
        const inputId = type === 'arr' ? `w-arr-${idx}` : `w-rew-${idx}`;
        const input = document.getElementById(inputId);
        const exp = document.getElementById(`exp-${type}-${idx}`);

        // Normalize strings for comparison (remove extra spaces, punctuation, case)
        const userVal = input.value.trim().toLowerCase().replace(/[.,?!]/g, '').replace(/\s+/g, ' ');
        const correctVal = type === 'arr' 
            ? item.ans.trim().toLowerCase().replace(/[.,?!]/g, '').replace(/\s+/g, ' ')
            : item.ans.substring(item.start.length).trim().toLowerCase().replace(/[.,?!]/g, '').replace(/\s+/g, ' ');

        // Note: For Rewrite, we compare full sentence logic
        const fullAns = item.ans.trim().toLowerCase().replace(/[.,?!]/g, '').replace(/\s+/g, ' ');
        const fullUser = type === 'arr' ? userVal : (item.start + " " + input.value).trim().toLowerCase().replace(/[.,?!]/g, '').replace(/\s+/g, ' ');

        let isCorrect = fullUser === fullAns;

        // Visual feedback
        if (isCorrect) {
            input.style.borderColor = 'var(--correct)';
            input.style.background = '#E8F5E9';
            playSound('correct');
            exp.innerHTML = `<div class="exp-header" style="color:var(--correct)">‚úÖ Xu·∫•t s·∫Øc!</div><div class="exp-content"><b>ƒê√°p √°n:</b> ${item.ans}<br>üëâ ${item.expl}</div>`;
        } else {
            input.style.borderColor = 'var(--wrong)';
            input.style.background = '#FFEBEE';
            playSound('wrong');
            exp.innerHTML = `<div class="exp-header" style="color:var(--wrong)">‚ö†Ô∏è Xem l·∫°i nh√©</div><div class="exp-content"><b>ƒê√°p √°n ƒë√∫ng:</b> ${item.ans}<br>üëâ ${item.expl}</div>`;
        }
        exp.classList.add('visible');
    }


    /* ================= SUBMIT & SCORING ================= */
    function submitTest() {
        // Calculate a rough score based on interacted elements
        // This is a "fun" score for the student
        let score = 0;
        let total = 0;

        // Just checking correctness classes presence
        const correctElements = document.querySelectorAll('.correct, [style*="rgb(0, 210, 106)"]'); // RGB for #00D26A
        score = correctElements.length; // Approximate
        
        // Manual calc to be accurate
        // Not implementing full state tracking for simplicity in single file, 
        // relying on the user having clicked "Check". 
        // If "Submit" is clicked, we force check all.
        
        forceCheckAll();
        
        // Count again after force check
        let finalScore = 0;
        // Phonetics MCQ
        phoneticMCQ.forEach((_, i) => { if(document.querySelector(`#p-mcq-${i} .correct`)) finalScore++; });
        // Reading 1 (8 gaps)
        for(let i=1; i<=8; i++) { if(document.getElementById(`gap${i}`).value === reading1Key[`gap${i}`].ans) finalScore++; }
        // Reading 2 TF (6 qs)
        reading2TF.forEach((item, i) => { 
             const radios = document.getElementsByName(`tf-${i}`);
             let val = null; for(let r of radios) if(r.checked) val = (r.value === 'true');
             if(val === item.ans) finalScore++;
        });
        // Reading 2 MCQ (6 qs)
        reading2MCQ.forEach((_, i) => { if(document.querySelector(`#r-mcq-${i} .correct`)) finalScore++; });
        // Writing (16 qs) - Logic check handled by button, let's assume if input is green
        const greenInputs = document.querySelectorAll('input[style*="rgb(232, 245, 233)"]'); // light green bg
        finalScore += greenInputs.length;
        
        // Sorting? Hard to calc in this loop without state. Let's give bonus points.

        const modal = document.getElementById('resultModal');
        const scoreCircle = document.getElementById('finalScore');
        const msg = document.getElementById('feedbackText');
        
        scoreCircle.innerText = finalScore;
        if(finalScore > 30) msg.innerText = "Wow! Tuy·ªát v·ªùi √¥ng m·∫∑t tr·ªùi! üåü";
        else if(finalScore > 20) msg.innerText = "L√†m t·ªët l·∫Øm! C·ªë g·∫Øng th√™m x√≠u n·ªØa!";
        else msg.innerText = "ƒê·ª´ng n·∫£n ch√≠! H√£y xem k·ªπ ph·∫ßn gi·∫£i th√≠ch nh√©! üí™";

        modal.style.display = 'flex';
        playSound('correct');
    }

    function forceCheckAll() {
        // Trigger all check buttons
        const btns = document.querySelectorAll('.check-btn-mini');
        btns.forEach(b => b.click());
        // For Gap fills that don't have individual check buttons but one main one
        checkReading1(); 
        checkStressSort();
    }

    function closeModal() {
        document.getElementById('resultModal').style.display = 'none';
    }

    /* ================= CONFETTI UTILS ================= */
    function launchConfetti() {
        const canvas = document.getElementById('confetti');
        canvas.style.display = 'block';
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const pieces = [];
        for(let i=0; i<100; i++) {
            pieces.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                w: 10 + Math.random() * 10,
                h: 10 + Math.random() * 10,
                col: `hsl(${Math.random()*360}, 100%, 50%)`,
                vy: 2 + Math.random() * 4,
                rot: Math.random() * 360
            });
        }

        let frame = 0;
        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            pieces.forEach(p => {
                p.y += p.vy;
                p.rot += 2;
                ctx.fillStyle = p.col;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rot * Math.PI / 180);
                ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
                ctx.restore();
            });
            frame++;
            if(frame < 100) requestAnimationFrame(loop);
            else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                canvas.style.display = 'none';
            }
        }
        loop();
    }

</script>

</body>
</html>