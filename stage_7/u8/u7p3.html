<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán t·∫≠p: Past Simple vs. Present Perfect - Ms Mai An ULIS</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8854C0;       /* T√≠m Pastel */
            --secondary: #00C9A7;     /* Xanh Ng·ªçc */
            --correct: #00D26A;       /* Xanh l√° chu·∫©n */
            --correct-dark: #00b359;
            --wrong: #FF4757;         /* ƒê·ªè cam */
            --wrong-dark: #e03e4d;
            --bg-pattern: #f0f4f8;
            --text-main: #2d3436;
            --card-bg: #ffffff;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* Ch·ªëng b√¥i ƒëen ƒë·ªÉ tr·∫£i nghi·ªám gi·ªëng app */
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-pattern);
            background-image: radial-gradient(#8854C0 0.5px, transparent 0.5px), radial-gradient(#00C9A7 0.5px, #f0f4f8 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* --- Layout Containers --- */
        .container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .card {
            background: var(--card-bg);
            border-radius: 25px;
            box-shadow: 0 10px 0 rgba(0,0,0,0.1), 0 20px 25px rgba(0,0,0,0.05);
            padding: 30px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 2px solid #fff;
            animation: slideIn 0.5s ease-out;
        }

        /* --- Header & Progress --- */
        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--primary);
            font-weight: 800;
            margin: 0;
            font-size: 1.8rem;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        .teacher-name {
            font-size: 1rem;
            color: #666;
            font-weight: 600;
            margin-top: 5px;
            display: inline-block;
            background: #eee;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .progress-container {
            width: 100%;
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
            border: 2px solid #fff;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
        }

        /* --- Question Section --- */
        .question-text {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        /* --- Options Grid --- */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
            .question-text {
                font-size: 1.2rem;
            }
        }

        .btn-option {
            background-color: #fff;
            border: 2px solid #e0e0e0;
            border-bottom: 6px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            color: #555;
            cursor: pointer;
            transition: all 0.1s ease;
            position: relative;
            text-align: left;
            outline: none;
        }

        .btn-option:hover:not(:disabled) {
            transform: translateY(-2px);
            border-color: var(--secondary);
            border-bottom-color: #00a388;
            color: var(--secondary);
        }

        .btn-option:active:not(:disabled) {
            transform: translateY(4px);
            border-bottom-width: 2px;
            margin-top: 4px; /* offset for visual balance */
        }

        .btn-option.correct {
            background-color: var(--correct);
            border-color: var(--correct-dark);
            border-bottom-color: var(--correct-dark);
            color: white;
            animation: pop 0.3s ease;
        }

        .btn-option.wrong {
            background-color: var(--wrong);
            border-color: var(--wrong-dark);
            border-bottom-color: var(--wrong-dark);
            color: white;
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* --- Explanation Box --- */
        .explanation-box {
            margin-top: 25px;
            background-color: #f8f9fa;
            border: 2px dashed var(--primary);
            border-radius: 15px;
            padding: 20px;
            display: none; /* Hidden by default */
            animation: slideDown 0.4s ease-out;
            text-align: left;
        }

        .exp-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }

        .exp-content {
            font-size: 1rem;
            line-height: 1.6;
            color: #444;
        }
        
        .exp-content b {
            color: #2d3436;
        }
        
        .exp-content ul {
            padding-left: 20px;
            margin: 5px 0;
        }

        /* --- Navigation Button --- */
        .nav-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-bottom: 6px solid #6c429c;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            display: none; /* Hidden initially */
            width: 100%;
            transition: all 0.2s;
            font-family: 'Nunito', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }
        
        .nav-btn:active {
            transform: translateY(4px);
            border-bottom-width: 2px;
        }

        /* --- Start Screen & Result Popup --- */
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .popup-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border: 4px solid var(--secondary);
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .popup-title {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 900;
        }

        .score-display {
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--secondary);
            margin: 20px 0;
            text-shadow: 3px 3px 0 #eee;
        }
        
        .popup-msg {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: #555;
        }

        /* --- Canvas for Confetti --- */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99;
        }

        /* --- Animations --- */
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .hidden { display: none !important; }

    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <!-- Start Screen -->
    <div id="start-screen" class="overlay">
        <div class="popup-content">
            <h1 class="popup-title">S·∫µn s√†ng ch∆∞a? üöÄ</h1>
            <p class="popup-msg">
                Ch√†o m·ª´ng ƒë·∫øn v·ªõi l·ªõp h·ªçc c·ªßa <b>C√¥ Mai An (ULIS)</b>!<br>
                B√†i ki·ªÉm tra g·ªìm 20 c√¢u v·ªÅ th√¨ <br><b>Qu√° Kh·ª© ƒê∆°n & Hi·ªán T·∫°i Ho√†n Th√†nh</b>.
            </p>
            <button class="nav-btn" style="display:inline-block" onclick="startGame()">B·∫Øt ƒê·∫ßu L√†m B√†i</button>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="overlay hidden">
        <div class="popup-content">
            <div class="popup-title">T·ªïng K·∫øt ƒêi·ªÉm üèÜ</div>
            <div class="score-display" id="final-score">0/20</div>
            <p class="popup-msg" id="final-msg">B·∫°n l√†m r·∫•t t·ªët!</p>
            <button class="nav-btn" style="display:inline-block; background-color: var(--secondary); border-bottom-color: #008f7a;" onclick="location.reload()">L√†m L·∫°i B√†i Thi üîÑ</button>
        </div>
    </div>

    <div class="container" id="game-container" style="opacity: 0.3; pointer-events: none;">
        <header>
            <h1>GRAMMAR CHALLENGE</h1>
            <span class="teacher-name">üë©‚Äçüè´ Gi√°o vi√™n: Ms Mai An ULIS</span>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div style="text-align: right; font-weight: bold; color: var(--primary);">
                C√¢u: <span id="current-q-num">1</span>/20
            </div>
        </header>

        <div class="card">
            <div class="question-text" id="question-text">
                Loading question...
            </div>

            <div class="options-grid" id="options-grid">
                <!-- Options will be injected here -->
            </div>

            <div class="explanation-box" id="explanation-box">
                <div class="exp-header">
                    <span>üí°</span> üë©‚Äçüè´ C√¥ Mai An gi·∫£i th√≠ch:
                </div>
                <div class="exp-content" id="explanation-content">
                    <!-- Detailed explanation injected here -->
                </div>
            </div>
        </div>

        <button class="nav-btn" id="next-btn" onclick="nextQuestion()">C√¢u Ti·∫øp Theo ‚ûî</button>
        <button class="nav-btn hidden" id="finish-btn" onclick="finishGame()" style="background-color: var(--secondary); border-bottom-color: #008f7a;">N·ªôp B√†i & Xem ƒêi·ªÉm üèÅ</button>
    </div>

<script>
    // --- D·ªÆ LI·ªÜU C√ÇU H·ªéI (20 C√¢u t·ª´ Context) ---
    // D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y ch√≠nh x√°c t·ª´ file g·ªëc, gi·ªØ nguy√™n Rationale.
    const originalQuestions = [
    {
      "question": "The weather _________________ (be) awful in the past few days.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- was (Verb - Past): ƒë√£ l√†/th√¨ (qu√° kh·ª© ƒë∆°n)\n- is (Verb - Present): l√†/th√¨ (hi·ªán t·∫°i)\n- has been (Verb - Pres. Perfect): ƒë√£ v√† ƒëang (hi·ªán t·∫°i ho√†n th√†nh)\n- had been (Verb - Past Perfect): ƒë√£ t·ª´ng (qu√° kh·ª© ho√†n th√†nh)\n\n**Gi·∫£i th√≠ch:** C·ª•m t·ª´ 'in the past few days' (trong v√†i ng√†y qua) di·ªÖn t·∫£ m·ªôt kho·∫£ng th·ªùi gian k√©o d√†i t·ª´ qu√° kh·ª© ƒë·∫øn hi·ªán t·∫°i, ƒë√¢y l√† d·∫•u hi·ªáu c·ªßa th√¨ Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** Th·ªùi ti·∫øt th·∫≠t t·ªìi t·ªá trong v√†i ng√†y qua.",
      "options": ["was", "is", "has been", "had been"],
      "correct": "has been"
    },
    {
      "question": "We _________________ (wash) the dishes. They‚Äôre clean now.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- washed (Verb - Past): ƒë√£ r·ª≠a (qu√° kh·ª© ƒë∆°n)\n- have washed (Verb - Pres. Perfect): v·ª´a r·ª≠a xong (hi·ªán t·∫°i ho√†n th√†nh)\n- wash (Verb - Present): r·ª≠a (hi·ªán t·∫°i ƒë∆°n)\n- are washing (Verb - Pres. Cont.): ƒëang r·ª≠a (hi·ªán t·∫°i ti·∫øp di·ªÖn)\n\n**Gi·∫£i th√≠ch:** C√¢u sau 'They‚Äôre clean now' ch·ªâ k·∫øt qu·∫£ ·ªü hi·ªán t·∫°i c·ªßa m·ªôt h√†nh ƒë·ªông v·ª´a x·∫£y ra. Khi nh·∫•n m·∫°nh v√†o k·∫øt qu·∫£, ta d√πng th√¨ Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** Ch√∫ng t√¥i v·ª´a r·ª≠a b√°t xong. B√¢y gi·ªù ch√∫ng s·∫°ch bong r·ªìi.",
      "options": ["washed", "have washed", "wash", "are washing"],
      "correct": "have washed"
    },
    {
      "question": "_____________________________ (your course, start) yet?",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- Did... start (Verb - Past): ƒë√£ b·∫Øt ƒë·∫ßu (qu√° kh·ª© ƒë∆°n)\n- Has... started (Verb - Pres. Perfect): ƒë√£ b·∫Øt ƒë·∫ßu ch∆∞a (hi·ªán t·∫°i ho√†n th√†nh)\n- Does... start (Verb - Present): c√≥ b·∫Øt ƒë·∫ßu (hi·ªán t·∫°i ƒë∆°n)\n- Was... starting (Verb - Past Cont.): ƒëang b·∫Øt ƒë·∫ßu (qu√° kh·ª© ti·∫øp di·ªÖn)\n\n**Gi·∫£i th√≠ch:** T·ª´ 'yet' (ch∆∞a) trong c√¢u h·ªèi nghi v·∫•n l√† d·∫•u hi·ªáu ƒëi·ªÉn h√¨nh c·ªßa th√¨ Hi·ªán t·∫°i ho√†n th√†nh, d√πng ƒë·ªÉ h·ªèi xem m·ªôt vi·ªác ƒë√£ x·∫£y ra ch∆∞a t√≠nh ƒë·∫øn th·ªùi ƒëi·ªÉm n√≥i.\n\n**D·ªãch c√¢u:** Kh√≥a h·ªçc c·ªßa b·∫°n ƒë√£ b·∫Øt ƒë·∫ßu ch∆∞a?",
      "options": ["Did your course start", "Has your course started", "Does your course start", "Was your course starting"],
      "correct": "Has your course started"
    },
    {
      "question": "Emma _________________ (pack) her suitcase last night.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- has packed (Verb - Pres. Perfect): ƒë√£ ƒë√≥ng g√≥i (hi·ªán t·∫°i ho√†n th√†nh)\n- packed (Verb - Past): ƒë√£ ƒë√≥ng g√≥i (qu√° kh·ª© ƒë∆°n)\n- packs (Verb - Present): ƒë√≥ng g√≥i (hi·ªán t·∫°i ƒë∆°n)\n- was packing (Verb - Past Cont.): ƒëang ƒë√≥ng g√≥i (qu√° kh·ª© ti·∫øp di·ªÖn)\n\n**Gi·∫£i th√≠ch:** 'last night' (t·ªëi qua) l√† m·ªëc th·ªùi gian c·ª• th·ªÉ trong qu√° kh·ª©, n√™n ta ph·∫£i d√πng th√¨ Qu√° kh·ª© ƒë∆°n (Past Simple).\n\n**D·ªãch c√¢u:** Emma ƒë√£ ƒë√≥ng g√≥i h√†nh l√Ω c·ªßa c√¥ ·∫•y t·ªëi qua.",
      "options": ["has packed", "packed", "packs", "was packing"],
      "correct": "packed"
    },
    {
      "question": "They _________________ (close) the factory already. ‚Äì Really? When ______________________ (that happen)?",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- closed (V-Past) / happened (V-Past): ƒë√£ ƒë√≥ng / ƒë√£ x·∫£y ra\n- have closed (V-Pres Perf) / did that happen (V-Past): ƒë√£ ƒë√≥ng xong / vi·ªác ƒë√≥ ƒë√£ x·∫£y ra khi n√†o\n- have closed (V-Pres Perf) / has that happened (V-Pres Perf): ƒë√£ ƒë√≥ng / ƒë√£ x·∫£y ra\n- closed (V-Past) / has that happened (V-Pres Perf): ƒë√£ ƒë√≥ng / ƒë√£ x·∫£y ra\n\n**Gi·∫£i th√≠ch:** M·ªánh ƒë·ªÅ ƒë·∫ßu c√≥ 'already' (r·ªìi) -> d√πng Hi·ªán t·∫°i ho√†n th√†nh ƒë·ªÉ th√¥ng b√°o tin t·ª©c m·ªõi. M·ªánh ƒë·ªÅ sau c√≥ 'When' (khi n√†o) h·ªèi v·ªÅ th·ªùi ƒëi·ªÉm c·ª• th·ªÉ -> d√πng Qu√° kh·ª© ƒë∆°n.\n\n**D·ªãch c√¢u:** H·ªç ƒë√£ ƒë√≥ng c·ª≠a nh√† m√°y r·ªìi. ‚Äì Th·∫≠t ∆∞? Chuy·ªán ƒë√≥ x·∫£y ra khi n√†o v·∫≠y?",
      "options": ["closed / happened", "have closed / did that happen", "have closed / has that happened", "closed / has that happened"],
      "correct": "have closed / did that happen"
    },
    {
      "question": "Shall we play tennis? We _________________ (not play) since we were children.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- didn't play (Verb - Past): ƒë√£ kh√¥ng ch∆°i (qu√° kh·ª© ƒë∆°n)\n- haven't played (Verb - Pres. Perfect): ƒë√£ kh√¥ng ch∆°i (t√≠nh t·ªõi nay)\n- don't play (Verb - Present): kh√¥ng ch∆°i (hi·ªán t·∫°i ƒë∆°n)\n- hadn't played (Verb - Past Perfect): ƒë√£ kh√¥ng ch∆°i (tr∆∞·ªõc m·ªôt th·ªùi ƒëi·ªÉm qu√° kh·ª©)\n\n**Gi·∫£i th√≠ch:** T·ª´ 'since' (k·ªÉ t·ª´ khi) ch·ªâ m·ªëc th·ªùi gian b·∫Øt ƒë·∫ßu trong qu√° kh·ª© v√† k√©o d√†i ƒë·∫øn hi·ªán t·∫°i -> d√πng Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** Ch√∫ng ta ch∆°i qu·∫ßn v·ª£t nh√©? Ch√∫ng ta ƒë√£ kh√¥ng ch∆°i k·ªÉ t·ª´ khi c√≤n b√©.",
      "options": ["didn't play", "haven't played", "don't play", "hadn't played"],
      "correct": "haven't played"
    },
    {
      "question": "The airplane _______just__________ (land). The pilot is just getting out.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- just landed (Verb - Past): v·ª´a h·∫° c√°nh (thi·∫øu tr·ª£ ƒë·ªông t·ª´)\n- has just landed (Verb - Pres. Perfect): v·ª´a m·ªõi h·∫° c√°nh (hi·ªán t·∫°i ho√†n th√†nh)\n- just lands (Verb - Present): v·ª´a h·∫° c√°nh (chia sai th√¨)\n- was just landing (Verb - Past Cont.): ƒëang h·∫° c√°nh\n\n**Gi·∫£i th√≠ch:** 'Just' (v·ª´a m·ªõi) d√πng trong th√¨ Hi·ªán t·∫°i ho√†n th√†nh ƒë·ªÉ ch·ªâ h√†nh ƒë·ªông v·ª´a xong t·ª©c th√¨. C√¢u sau 'The pilot is just getting out' x√°c nh·∫≠n h√†nh ƒë·ªông n√†y v·ª´a k·∫øt th√∫c.\n\n**D·ªãch c√¢u:** M√°y bay v·ª´a m·ªõi h·∫° c√°nh. Phi c√¥ng ƒëang b∆∞·ªõc ra.",
      "options": ["just landed", "has just landed", "just lands", "was just landing"],
      "correct": "has just landed"
    },
    {
      "question": "Prices _________________ (go) up already. Everything is more expensive this year.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- went (Verb - Past): ƒë√£ tƒÉng (qu√° kh·ª© ƒë∆°n)\n- go (Verb - Present): tƒÉng (hi·ªán t·∫°i ƒë∆°n)\n- have gone (Verb - Pres. Perfect): ƒë√£ tƒÉng (hi·ªán t·∫°i ho√†n th√†nh)\n- were going (Verb - Past Cont.): ƒëang tƒÉng\n\n**Gi·∫£i th√≠ch:** 'Already' (r·ªìi) v√† k·∫øt qu·∫£ ·ªü hi·ªán t·∫°i 'Everything is more expensive' (M·ªçi th·ª© ƒë·∫Øt ƒë·ªè h∆°n) l√† d·∫•u hi·ªáu c·ªßa th√¨ Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** Gi√° c·∫£ ƒë√£ tƒÉng l√™n r·ªìi. M·ªçi th·ª© nƒÉm nay ƒë·ªÅu ƒë·∫Øt ƒë·ªè h∆°n.",
      "options": ["went", "have gone", "go", "were going"],
      "correct": "have gone"
    },
    {
      "question": "I‚Äôm tired. We _________________ (walk) 10 miles up to now.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- walked (Verb - Past): ƒë√£ ƒëi b·ªô\n- walk (Verb - Present): ƒëi b·ªô\n- have walked (Verb - Pres. Perfect): ƒë√£ ƒëi b·ªô (t√≠nh ƒë·∫øn nay)\n- are walking (Verb - Pres. Cont.): ƒëang ƒëi b·ªô\n\n**Gi·∫£i th√≠ch:** C·ª•m 'up to now' (cho ƒë·∫øn b√¢y gi·ªù) nh·∫•n m·∫°nh k·∫øt qu·∫£ c·ªßa h√†nh ƒë·ªông t√≠nh t·ª´ qu√° kh·ª© ƒë·∫øn hi·ªán t·∫°i -> d√πng Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** T√¥i m·ªát qu√°. Ch√∫ng ta ƒë√£ ƒëi b·ªô ƒë∆∞·ª£c 10 d·∫∑m t√≠nh ƒë·∫øn gi·ªù r·ªìi.",
      "options": ["walked", "have walked", "walk", "are walking"],
      "correct": "have walked"
    },
    {
      "question": "The Queen _________________ (arrive) in an RAF helicopter last night.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- has arrived (Verb - Pres. Perfect): ƒë√£ ƒë·∫øn (kh√¥ng r√µ th·ªùi gian)\n- arrived (Verb - Past): ƒë√£ ƒë·∫øn (th·ªùi gian c·ª• th·ªÉ)\n- arrives (Verb - Present): ƒë·∫øn\n- was arriving (Verb - Past Cont.): ƒëang ƒë·∫øn\n\n**Gi·∫£i th√≠ch:** 'last night' (t·ªëi qua) l√† m·ªëc th·ªùi gian c·ª• th·ªÉ ƒë√£ k·∫øt th√∫c trong qu√° kh·ª© -> d√πng Qu√° kh·ª© ƒë∆°n.\n\n**D·ªãch c√¢u:** N·ªØ ho√†ng ƒë√£ ƒë·∫øn b·∫±ng m·ªôt chi·∫øc tr·ª±c thƒÉng c·ªßa Kh√¥ng qu√¢n Ho√†ng gia v√†o t·ªëi qua.",
      "options": ["has arrived", "arrived", "arrives", "was arriving"],
      "correct": "arrived"
    },
    {
      "question": "How long ______________________ (Vicky, have) that camera? ‚Äì For about a month.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- Did... have (Verb - Past): ƒë√£ c√≥\n- Has... had (Verb - Pres. Perfect): ƒë√£ c√≥ (ƒë∆∞·ª£c bao l√¢u)\n- Does... have (Verb - Present): c√≥\n- Had... had (Verb - Past Perfect): ƒë√£ c√≥ (tr∆∞·ªõc qu√° kh·ª©)\n\n**Gi·∫£i th√≠ch:** C√¢u h·ªèi 'How long' (bao l√¢u) ƒëi k√®m c√¢u tr·∫£ l·ªùi 'For about a month' (kho·∫£ng 1 th√°ng nay) ch·ªâ m·ªôt tr·∫°ng th√°i b·∫Øt ƒë·∫ßu trong qu√° kh·ª© v√† v·∫´n c√≤n ·ªü hi·ªán t·∫°i -> d√πng Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** Vicky ƒë√£ c√≥ chi·∫øc m√°y ·∫£nh ƒë√≥ bao l√¢u r·ªìi? ‚Äì Kho·∫£ng m·ªôt th√°ng.",
      "options": ["Did Vicky have", "Has Vicky had", "Does Vicky have", "Had Vicky had"],
      "correct": "Has Vicky had"
    },
    {
      "question": "We ______________________ (just come) back from our holidays.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- just came (Verb - Past): v·ª´a ƒë·∫øn (thi·∫øu s·∫Øc th√°i ho√†n th√†nh)\n- have just come (Verb - Pres. Perfect): v·ª´a m·ªõi v·ªÅ (ho√†n t·∫•t)\n- just come (Verb - Present): v·ª´a v·ªÅ (sai ng·ªØ ph√°p)\n- came (Verb - Past): ƒë√£ v·ªÅ\n\n**Gi·∫£i th√≠ch:** 'Just' (v·ª´a m·ªõi) di·ªÖn t·∫£ h√†nh ƒë·ªông v·ª´a ho√†n t·∫•t ngay tr∆∞·ªõc th·ªùi ƒëi·ªÉm n√≥i -> d√πng Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** Ch√∫ng t√¥i v·ª´a m·ªõi ƒëi ngh·ªâ v·ªÅ.",
      "options": ["just came", "have just come", "just come", "came"],
      "correct": "have just come"
    },
    {
      "question": "Your parcel _________________ (just arrive). The postman _________________ (bring) it two hours ago.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- has just arrived (V-Pres Perf) / brought (V-Past): v·ª´a t·ªõi / ƒë√£ mang\n- just arrived (V-Past) / has brought (V-Pres Perf): v·ª´a t·ªõi / ƒë√£ mang\n- has just arrived (V-Pres Perf) / has brought (V-Pres Perf): v·ª´a t·ªõi / ƒë√£ mang\n- just arrived (V-Past) / brought (V-Past): v·ª´a t·ªõi / ƒë√£ mang\n\n**Gi·∫£i th√≠ch:** V·∫ø ƒë·∫ßu c√≥ 'just' (v·ª´a m·ªõi) -> Hi·ªán t·∫°i ho√†n th√†nh. V·∫ø sau c√≥ 'two hours ago' (2 ti·∫øng tr∆∞·ªõc - m·ªëc th·ªùi gian c·ª• th·ªÉ) -> Qu√° kh·ª© ƒë∆°n.\n\n**D·ªãch c√¢u:** B∆∞u ki·ªán c·ªßa b·∫°n v·ª´a m·ªõi t·ªõi. Ng∆∞·ªùi ƒë∆∞a th∆∞ ƒë√£ mang n√≥ ƒë·∫øn 2 ti·∫øng tr∆∞·ªõc.",
      "options": ["has just arrived / brought", "just arrived / has brought", "has just arrived / has brought", "just arrived / brought"],
      "correct": "has just arrived / brought"
    },
    {
      "question": "He _________________ (be) at his computer for two hours.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- was (Verb - Past): ƒë√£ ·ªü (ƒë√£ k·∫øt th√∫c)\n- is (Verb - Present): ƒëang ·ªü\n- has been (Verb - Pres. Perfect): ƒë√£ v√† ƒëang ·ªü (k√©o d√†i)\n- had been (Verb - Past Perfect): ƒë√£ t·ª´ng ·ªü (tr∆∞·ªõc qu√° kh·ª©)\n\n**Gi·∫£i th√≠ch:** 'For two hours' (ƒë∆∞·ª£c 2 ti·∫øng) v√† ng·ªØ c·∫£nh c√¢u n√†y th∆∞·ªùng h√†m √Ω anh ·∫•y v·∫´n ƒëang ng·ªìi ·ªü ƒë√≥ -> d√πng Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** Anh ·∫•y ƒë√£ ng·ªìi b√™n m√°y t√≠nh ƒë∆∞·ª£c 2 ti·∫øng ƒë·ªìng h·ªì r·ªìi.",
      "options": ["was", "is", "has been", "had been"],
      "correct": "has been"
    },
    {
      "question": "We _________________ (live) there for ten years but we _________________ (be) in Birmingham 20 years ago.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- have lived (V-Pres Perf) / were (V-Past): ƒë√£ s·ªëng (v·∫´n c√≤n s·ªëng) / ƒë√£ ·ªü\n- lived (V-Past) / were (V-Past): ƒë√£ s·ªëng (h·∫øt s·ªëng) / ƒë√£ ·ªü\n- have lived (V-Pres Perf) / have been (V-Pres Perf): ƒë√£ s·ªëng / ƒë√£ ·ªü\n- lived (V-Past) / have been (V-Pres Perf): ƒë√£ s·ªëng / ƒë√£ ·ªü\n\n**Gi·∫£i th√≠ch:** V·∫ø ƒë·∫ßu d√πng 'for ten years' v√† ng·ªØ c·∫£nh t∆∞∆°ng ph·∫£n 'but' v·ªõi qu√° kh·ª© '20 years ago' g·ª£i √Ω r·∫±ng v·∫ø ƒë·∫ßu l√† t√¨nh tr·∫°ng hi·ªán t·∫°i (ho·∫∑c k√©o d√†i t·ªõi nay) -> Hi·ªán t·∫°i ho√†n th√†nh. V·∫ø sau c√≥ '20 years ago' (20 nƒÉm tr∆∞·ªõc) -> Qu√° kh·ª© ƒë∆°n.\n\n**D·ªãch c√¢u:** Ch√∫ng t√¥i ƒë√£ s·ªëng ·ªü ƒë√≥ ƒë∆∞·ª£c 10 nƒÉm r·ªìi nh∆∞ng 20 nƒÉm tr∆∞·ªõc th√¨ ch√∫ng t√¥i ·ªü Birmingham.",
      "options": ["have lived / were", "lived / were", "have lived / have been", "lived / have been"],
      "correct": "have lived / were"
    },
    {
      "question": "We _________________ (not have) a party for ages.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- didn't have (Verb - Past): ƒë√£ kh√¥ng c√≥\n- haven't had (Verb - Pres. Perfect): ƒë√£ kh√¥ng c√≥ (t√≠nh t·ªõi nay)\n- don't have (Verb - Present): kh√¥ng c√≥\n- hadn't had (Verb - Past Perfect): ƒë√£ kh√¥ng c√≥ (tr∆∞·ªõc qu√° kh·ª©)\n\n**Gi·∫£i th√≠ch:** 'For ages' (ƒë√£ l√¢u l·∫Øm r·ªìi) ch·ªâ m·ªôt kho·∫£ng th·ªùi gian k√©o d√†i ƒë·∫øn hi·ªán t·∫°i -> d√πng Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** ƒê√£ l√¢u l·∫Øm r·ªìi ch√∫ng t√¥i kh√¥ng t·ªï ch·ª©c ti·ªác t√πng.",
      "options": ["didn't have", "haven't had", "don't have", "hadn't had"],
      "correct": "haven't had"
    },
    {
      "question": "My sister‚Äôs car is only a year old but she ___________________________ (already crash) it.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- already crashed (Verb - Past): ƒë√£ ƒë√¢m xe (thi·∫øu tr·ª£ ƒë·ªông t·ª´ ·ªü HTHT ho·∫∑c d√πng sai v·ªõi already)\n- has already crashed (Verb - Pres. Perfect): ƒë√£ ƒë√¢m xe r·ªìi\n- already crashes (Verb - Present): ƒë√¢m xe (th∆∞·ªùng xuy√™n)\n- had already crashed (Verb - Past Perfect): ƒë√£ ƒë√¢m xe (tr∆∞·ªõc qu√° kh·ª©)\n\n**Gi·∫£i th√≠ch:** 'Already' (r·ªìi) d√πng ƒë·ªÉ nh·∫•n m·∫°nh m·ªôt s·ª± vi·ªác ƒë√£ x·∫£y ra (c√≥ th·ªÉ s·ªõm h∆°n d·ª± ki·∫øn) v√† k·∫øt qu·∫£ c√≤n ·∫£nh h∆∞·ªüng -> d√πng Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** Xe c·ªßa ch·ªã g√°i t√¥i m·ªõi mua ƒë∆∞·ª£c m·ªôt nƒÉm nh∆∞ng ch·ªã ·∫•y ƒë√£ l√†m h·ªèng n√≥ r·ªìi.",
      "options": ["already crashed", "has already crashed", "already crashes", "had already crashed"],
      "correct": "has already crashed"
    },
    {
      "question": "Dinosaurs _________________ (roam) the earth millions of years ago.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- have roamed (Verb - Pres. Perfect): ƒë√£ lang thang (v·∫´n c√≤n)\n- roamed (Verb - Past): ƒë√£ lang thang (ƒë√£ tuy·ªát ch·ªßng/k·∫øt th√∫c)\n- roam (Verb - Present): lang thang\n- were roaming (Verb - Past Cont.): ƒëang lang thang\n\n**Gi·∫£i th√≠ch:** 'millions of years ago' (h√†ng tri·ªáu nƒÉm tr∆∞·ªõc) l√† th·ªùi gian c·ª• th·ªÉ trong qu√° kh·ª© v√† kh·ªßng long ƒë√£ tuy·ªát ch·ªßng -> d√πng Qu√° kh·ª© ƒë∆°n.\n\n**D·ªãch c√¢u:** Kh·ªßng long ƒë√£ ƒëi lang thang tr√™n tr√°i ƒë·∫•t h√†ng tri·ªáu nƒÉm tr∆∞·ªõc.",
      "options": ["have roamed", "roamed", "roam", "were roaming"],
      "correct": "roamed"
    },
    {
      "question": "It _____________________ (not rain) yet today.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- didn't rain (Verb - Past): ƒë√£ kh√¥ng m∆∞a\n- hasn't rained (Verb - Pres. Perfect): ch∆∞a m∆∞a (t√≠nh t·ªõi gi·ªù)\n- doesn't rain (Verb - Present): kh√¥ng m∆∞a\n- isn't raining (Verb - Pres. Cont.): ƒëang kh√¥ng m∆∞a\n\n**Gi·∫£i th√≠ch:** 'Yet' (ch∆∞a) trong c√¢u ph·ªß ƒë·ªãnh v√† 'today' (h√¥m nay - th·ªùi gian ch∆∞a k·∫øt th√∫c) l√† d·∫•u hi·ªáu c·ªßa th√¨ Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** H√¥m nay tr·ªùi v·∫´n ch∆∞a m∆∞a.",
      "options": ["didn't rain", "hasn't rained", "doesn't rain", "isn't raining"],
      "correct": "hasn't rained"
    },
    {
      "question": "__________________________ (you see) last week‚Äôs magazine? ‚Äì It must be here somewhere.",
      "rationale": "**D·ªãch & Lo·∫°i t·ª´:**\n- Did you see (Verb - Past): B·∫°n ƒë√£ th·∫•y (h·ªèi v·ªÅ qu√° kh·ª©)\n- Have you seen (Verb - Pres. Perfect): B·∫°n c√≥ th·∫•y (k·∫øt qu·∫£ li√™n quan hi·ªán t·∫°i)\n- Do you see (Verb - Present): B·∫°n c√≥ th·∫•y (hi·ªán t·∫°i)\n- Were you seeing (Verb - Past Cont.): B·∫°n ƒëang th·∫•y\n\n**Gi·∫£i th√≠ch:** M·∫∑c d√π c√≥ 'last week's magazine', c·ª•m n√†y l√† danh t·ª´ ch·ªâ ƒë·ªëi t∆∞·ª£ng (t·∫°p ch√≠ c·ªßa tu·∫ßn tr∆∞·ªõc) ch·ª© kh√¥ng ph·∫£i tr·∫°ng t·ª´ th·ªùi gian c·ªßa h√†nh ƒë·ªông 'see'. Ng∆∞·ªùi n√≥i ƒëang t√¨m n√≥ ·ªü hi·ªán t·∫°i ('It must be here somewhere'), n√™n c√¢u h·ªèi mang nghƒ©a 'B·∫°n c√≥ th·∫•y n√≥ ƒë√¢u kh√¥ng?' -> d√πng Hi·ªán t·∫°i ho√†n th√†nh.\n\n**D·ªãch c√¢u:** B·∫°n c√≥ th·∫•y cu·ªën t·∫°p ch√≠ tu·∫ßn tr∆∞·ªõc ƒë√¢u kh√¥ng? ‚Äì N√≥ ch·∫Øc ph·∫£i ·ªü quanh ƒë√¢y th√¥i.",
      "options": ["Did you see", "Have you seen", "Do you see", "Were you seeing"],
      "correct": "Have you seen"
    }
  ];

    // --- LOGIC TR√í CH∆†I ---

    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let audioCtx = null;

    // H√†m x√°o tr·ªôn m·∫£ng (Fisher-Yates)
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // Kh·ªüi t·∫°o Audio Context
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    // Ph√°t √¢m thanh (Synthesized)
    function playSound(type) {
        initAudio();
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        const now = audioCtx.currentTime;

        if (type === 'ding') {
            // √Çm thanh Ding (High sine wave)
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, now);
            oscillator.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            oscillator.start(now);
            oscillator.stop(now + 0.5);
        } else if (type === 'buzz') {
            // √Çm thanh Buzz (Low sawtooth)
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, now);
            oscillator.frequency.linearRampToValueAtTime(100, now + 0.3);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
            oscillator.start(now);
            oscillator.stop(now + 0.3);
        } else if (type === 'fanfare') {
             // Simple victory sequence
             // (Implemented simply by multiple oscillators or just skipped for brevity, opting for multiple 'dings')
        }
    }

    // B·∫Øt ƒë·∫ßu game
    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-container').style.opacity = '1';
        document.getElementById('game-container').style.pointerEvents = 'auto';
        
        // Clone v√† x√°o tr·ªôn c√¢u h·ªèi
        questions = JSON.parse(JSON.stringify(originalQuestions));
        shuffleArray(questions);
        
        currentQuestionIndex = 0;
        score = 0;
        showQuestion();
        initAudio(); // Chu·∫©n b·ªã √¢m thanh
    }

    // Hi·ªÉn th·ªã c√¢u h·ªèi
    function showQuestion() {
        const qData = questions[currentQuestionIndex];
        
        // C·∫≠p nh·∫≠t UI
        document.getElementById('current-q-num').innerText = currentQuestionIndex + 1;
        document.getElementById('progress-bar').style.width = `${((currentQuestionIndex) / questions.length) * 100}%`;
        document.getElementById('question-text').innerText = qData.question;
        
        // ·∫®n gi·∫£i th√≠ch v√† n√∫t Next
        document.getElementById('explanation-box').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('finish-btn').style.display = 'none';
        
        // X·ª≠ l√Ω Options
        const optionsContainer = document.getElementById('options-grid');
        optionsContainer.innerHTML = '';
        
        // T·∫°o n√∫t cho t·ª´ng ƒë√°p √°n
        qData.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(btn, opt, qData.correct, qData.rationale);
            optionsContainer.appendChild(btn);
        });
    }

    // ƒê·ªãnh d·∫°ng l·∫°i text markdown t·ª´ JSON ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp
    function formatRationale(text) {
        // Chuy·ªÉn **text** th√†nh <b>text</b>
        let formatted = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        // Chuy·ªÉn xu·ªëng d√≤ng th√†nh <br>
        formatted = formatted.replace(/\n/g, '<br>');
        return formatted;
    }

    // Ki·ªÉm tra ƒë√°p √°n
    function checkAnswer(selectedBtn, selectedText, correctText, rationale) {
        // V√¥ hi·ªáu h√≥a t·∫•t c·∫£ c√°c n√∫t ƒë·ªÉ kh√¥ng b·∫•m l·∫°i
        const buttons = document.querySelectorAll('.btn-option');
        buttons.forEach(btn => btn.disabled = true);
        
        let isCorrect = (selectedText === correctText);
        
        if (isCorrect) {
            selectedBtn.classList.add('correct');
            score++;
            playSound('ding');
            fireConfetti();
        } else {
            selectedBtn.classList.add('wrong');
            playSound('buzz');
            // Highlight ƒë√°p √°n ƒë√∫ng
            buttons.forEach(btn => {
                if (btn.innerText === correctText) {
                    btn.classList.add('correct');
                }
            });
        }
        
        // Hi·ªÉn th·ªã gi·∫£i th√≠ch
        const expBox = document.getElementById('explanation-box');
        const expContent = document.getElementById('explanation-content');
        
        expContent.innerHTML = formatRationale(rationale);
        expBox.style.display = 'block';
        
        // Cu·ªôn nh·∫π xu·ªëng ƒë·ªÉ xem gi·∫£i th√≠ch (tr√™n mobile)
        if (window.innerWidth < 600) {
            setTimeout(() => {
                expBox.scrollIntoView({behavior: "smooth", block: "nearest"});
            }, 300);
        }

        // Hi·ªÉn th·ªã n√∫t ƒëi·ªÅu h∆∞·ªõng
        if (currentQuestionIndex < questions.length - 1) {
            document.getElementById('next-btn').style.display = 'block';
        } else {
            document.getElementById('finish-btn').style.display = 'block';
        }
        
        // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh (ho√†n th√†nh c√¢u n√†y)
        document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / questions.length) * 100}%`;
    }

    function nextQuestion() {
        currentQuestionIndex++;
        showQuestion();
    }

    function finishGame() {
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = `${score}/${questions.length}`;
        
        let msg = "";
        const percentage = (score / questions.length) * 100;
        
        if (percentage === 100) msg = "Xu·∫•t s·∫Øc! B·∫°n l√† thi√™n t√†i ng·ªØ ph√°p! üåü";
        else if (percentage >= 80) msg = "R·∫•t t·ªët! B·∫°n n·∫Øm r·∫•t ch·∫Øc ki·∫øn th·ª©c! üéâ";
        else if (percentage >= 50) msg = "Kh√° l·∫Øm! C·ªë g·∫Øng th√™m ch√∫t n·ªØa nh√©! üí™";
        else msg = "ƒê·ª´ng n·∫£n! H√£y xem k·ªπ ph·∫ßn gi·∫£i th√≠ch v√† l√†m l·∫°i nh√©! üìö";
        
        document.getElementById('final-msg').innerText = msg;
        if (percentage >= 80) fireConfetti();
    }

    // --- CONFETTI LOGIC (Canvas) ---
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let particles = [];

    function fireConfetti() {
        const particleCount = 100;
        const colors = ['#8854C0', '#00C9A7', '#FF4757', '#FFD700', '#00D26A'];
        
        for (let i = 0; i < particleCount; i++) {
            particles.push({
                x: window.innerWidth / 2,
                y: window.innerHeight / 2,
                w: Math.random() * 10 + 5,
                h: Math.random() * 10 + 5,
                vx: (Math.random() - 0.5) * 20,
                vy: (Math.random() - 0.5) * 20,
                color: colors[Math.floor(Math.random() * colors.length)],
                gravity: 0.5,
                drag: 0.95,
                rotation: Math.random() * 360,
                rotationSpeed: (Math.random() - 0.5) * 10
            });
        }
        requestAnimationFrame(updateConfetti);
    }

    function updateConfetti() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach((p, index) => {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += p.gravity;
            p.vx *= p.drag;
            p.vy *= p.drag;
            p.rotation += p.rotationSpeed;
            
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate((p.rotation * Math.PI) / 180);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
            ctx.restore();
            
            // Remove particles off screen
            if (p.y > canvas.height) {
                particles.splice(index, 1);
            }
        });

        if (particles.length > 0) {
            requestAnimationFrame(updateConfetti);
        }
    }

    // Resize canvas on window resize
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });

</script>
</body>
</html>
